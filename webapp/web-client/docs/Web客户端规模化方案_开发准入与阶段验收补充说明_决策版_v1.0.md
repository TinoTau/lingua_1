# Web 客户端规模化方案 — 开发准入与阶段验收补充说明（决策版）v1.0

> 适用对象：Web 客户端开发团队 / Scheduler 后端团队 / 架构评审与决策层  
> 目标规模：10 万级 Web 用户并发  
> 本文档用于回答两个问题：  
> 1）当前方案是否可以立即开始开发  
> 2）开发过程中必须满足哪些“阻断项（Blockers）”与阶段性验收标准  

---

## 一、结论先行（供决策快速阅读）

**结论：可以立即开始开发。**

但必须满足以下前提：
- 开发按“阶段推进 + 明确阻断项”执行
- **背压（Backpressure）与静音过滤配置化**必须作为 Phase 1 的上线阻断项
- 二进制帧 / Opus 属于 Phase 2–3 的性能优化，不作为立即开工前置条件

如果在 Phase 1 未达成阻断项要求，则 **不允许进入联调或灰度**。

---

## 二、对开发部门评估的总体评价

开发部门在《SCALABILITY_PLAN_EVALUATION.md》中给出的判断是**专业且保守的**，其优先级排序基本合理：

- 优先解决客户端背压（R3）
- 再解决静音过滤参数化（R4）
- 补齐 Session Init 字段
- 二进制帧 / Opus 放在后续阶段

该判断在技术方向上**没有错误**，可以作为开发执行基础。

---

## 三、需要补充进开发方案的 3 个关键遗漏点

以下内容若不补充，容易在 10 万级规模下引发系统性风险。

---

### 补充点 A：背压不仅是“客户端能力”，还必须定义“服务端发送策略”

**问题**
- 目前评估聚焦客户端如何处理 BUSY / PAUSE / SLOW_DOWN
- 但未约束服务端背压消息的发送频率与恢复条件

**风险**
- 服务端在高负载下频繁发送背压消息
- 客户端反复降级 / 恢复，形成状态抖动与消息风暴

**补充约束（必须写入实现）**
- 服务端背压消息必须有最小发送间隔（如 ≥500ms / session）
- 背压消息需明确：
  - action（BUSY / PAUSE / SLOW_DOWN）
  - resume_after_ms 或恢复条件
- 客户端必须对背压消息做去抖（只处理最新状态）

---

### 补充点 B：静音过滤需加入迟滞 / 平滑，避免阈值抖动

**问题**
- 仅有 RMS threshold + window_ms 不足以应对噪声边界场景

**风险**
- 用户在阈值附近说话
- 客户端频繁启停音频发送
- 服务端收到大量碎片 chunk

**补充约束**
至少实现其一：
- Attack / Release（进入语音与退出语音使用不同阈值或窗口）
- 连续 N 帧语音才开始发送，连续 M 帧静音才停止发送

---

### 补充点 C：Binary Frame 可以延后，但协议字段必须立即预留

**问题**
- 若 Phase 1/2 未预留字段，Phase 3 将成为破坏性协议升级

**补充约束（立即做）**
- Session Init 必须包含：
  - audio_format
  - sample_rate
  - channel_count
- 音频帧必须定义：
  - sequence_no 的语义（是否单调、重连是否重置）
  - timestamp 的含义（采样起始 / 发送时间）

---

## 四、是否可以立即开始开发？

### 答案：可以，但必须明确“阻断项（Blockers）”

---

## Phase 1（立即开始）— 基础规模化能力

### Phase 1 允许开始的条件
- 无额外前置条件，可立即开工

---

### Phase 1 上线 / 联调阻断项（必须全部满足）

#### Blocker 1：客户端背压闭环（R3）
- 服务端可发送 BUSY / PAUSE / SLOW_DOWN
- 客户端能：
  - 降低发送速率
  - 暂停发送
  - 在恢复条件满足后继续
- 压测下服务端 backlog 不持续上升

#### Blocker 2：静音过滤配置化 + 平滑（R4）
- enabled / threshold / window_ms 可配置
- 支持关闭（调试）
- 已加入迟滞 / 平滑逻辑，避免频繁启停

#### Blocker 3：Session Init 字段补齐
- client_version / audio_format / sample_rate / channel_count / features
- Scheduler 返回协商结果并记录日志

> 未满足以上任一 Blocker，不得进入灰度或生产环境。

---

## Phase 2（性能优化）— 协议与带宽优化

### 目标
- 降低带宽与消息数
- 为 10 万级并发提供成本与性能余量

### 内容
- WebSocket Binary Frame
- Opus 编码
- 更高效的音频帧封装

### 说明
- Phase 2 不影响 Phase 1 正确性
- 可灰度、可回滚

---

## Phase 3（扩展能力）— 高级场景支持

- 多路音频 / 多会话
- 更复杂的客户端处理策略
- 针对弱网/低端设备的专项优化

---

## 五、建议你在评审/会议中的拍板用语

> 当前方案可以立即开始开发，  
> 但 **背压闭环、静音过滤配置化与 Session Init 补齐**  
> 是 Phase 1 的硬性阻断项。  
>  
> Binary Frame 与 Opus 作为性能优化后置推进，  
> 不影响当前开发启动。

---

## 六、最终总结

- 当前方案方向正确、评估合理
- 可以立即启动开发
- 必须以阻断项与阶段验收防止“做完但不可用”
- 本文档作为 Phase 1 的验收依据与责任边界

