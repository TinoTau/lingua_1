# 阶段一.1（1.1 调度服务器核心功能）单元测试

## 测试结构

本目录包含阶段一（1.1 调度服务器核心功能）的所有单元测试。

### 测试模块

- **session_test.rs**: 会话管理测试
  - 创建会话
  - 获取会话
  - 更新会话（配对节点、递增 utterance_index）
  - 删除会话
  - 多会话管理

- **dispatcher_test.rs**: 任务分发测试
  - 创建任务
  - 获取任务
  - 更新任务状态
  - 节点分配（包括首选节点）
  - 无可用节点的情况

- **node_registry_test.rs**: 节点注册表测试
  - 注册节点（自动生成ID和指定ID）
  - 节点可用性检查
  - 节点心跳更新
  - 节点选择（功能感知）
  - 节点离线标记

- **pairing_test.rs**: 配对服务测试
  - 生成配对码
  - 验证配对码
  - 配对码过期处理
  - 多配对码管理

- **connection_manager_test.rs**: 连接管理测试
  - 会话连接注册/注销
  - 节点连接注册/注销
  - 消息发送
  - 多连接管理

- **result_queue_test.rs**: 结果队列测试
  - 会话初始化
  - 结果添加（顺序和乱序）
  - 结果获取（按顺序）
  - 部分结果处理
  - 多会话管理

## 运行测试

```bash
# 运行所有阶段一.1测试
cargo test --test stage1_1

# 运行特定测试模块
cargo test --test stage1_1 session_test

# 运行特定测试
cargo test --test stage1_1 test_create_session

# 显示测试输出
cargo test --test stage1_1 -- --nocapture
```

## 测试覆盖率

当前测试覆盖了以下功能：

- ✅ 会话管理（创建、查询、更新、删除）
- ✅ 任务分发（创建、查询、状态更新）
- ✅ 节点注册（注册、心跳、可用性检查、选择）
- ✅ 配对服务（生成、验证、清理）
- ✅ 连接管理（注册、注销、消息发送）
- ✅ 结果队列（初始化、添加、获取、排序）

## 注意事项

1. 所有测试都是异步测试，使用 `#[tokio::test]`
2. 测试之间相互独立，不共享状态
3. 配对码生成基于时间戳，可能在极短时间内生成相同代码（已处理）

