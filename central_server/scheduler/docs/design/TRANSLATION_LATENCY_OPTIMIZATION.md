# 翻译延迟优化方案

## 问题描述

用户反馈：翻译效果和返回时间都比较稳定了，达到能够接受的效果，但是返回时间还是有点长，差不多需要10秒。

## 延迟来源分析

### 1. 结果检查循环间隔（主要延迟来源）⚠️

**位置**: `central_server/scheduler/src/main.rs:301`

**当前设置**:
```rust
let mut interval = tokio::time::interval(tokio::time::Duration::from_secs(10));
```

**问题**:
- 结果检查循环每 **10 秒** 才执行一次
- 即使结果已经准备好了，也可能需要等待最多 **10 秒** 才能被发送给客户端
- 这是导致 10 秒延迟的**主要原因**

**优化方案**:
- 将间隔从 10 秒降低到 **1 秒**
- 这样可以显著减少延迟，同时不会造成过大的性能开销

### 2. 补位等待超时

**位置**: `central_server/scheduler/src/managers/result_queue.rs:65`

**当前设置**:
```rust
const ACK_TIMEOUT_MS: i64 = 5 * 1000; // 5 秒
```

**问题**:
- 当收到后续 index 时，前面的 index 会进入等待补位状态
- 如果 5 秒内没有收到结果，才会核销
- 这可能导致最多 5 秒的额外延迟

**优化方案**:
- 将补位超时从 5 秒降低到 **2 秒**
- 正常 ASR 处理时间在 1-2 秒之间，2 秒足够等待延迟到达的结果
- 如果 2 秒内没有收到，很可能真的丢失了

### 3. Gap Timeout

**位置**: `central_server/scheduler/src/managers/result_queue.rs:58`

**当前设置**:
```rust
gap_timeout_ms: 5 * 1000, // 5 秒
```

**问题**:
- 如果 expected 未到且没有后续 index，会等待 5 秒才创建 Missing result
- 正常 ASR 处理时间在 1-2 秒之间，5 秒可能过长

**优化方案**:
- 将 gap_timeout 从 5 秒降低到 **3 秒**
- 正常处理时间在 1-2 秒之间，3 秒足够

## 优化效果预期

### 优化前
- 结果检查循环间隔：10 秒
- 补位等待超时：5 秒
- Gap timeout：5 秒
- **总延迟**：最多 10 秒（主要来自结果检查循环）

### 优化后
- 结果检查循环间隔：**1 秒** ⬇️
- 补位等待超时：**2 秒** ⬇️
- Gap timeout：**3 秒** ⬇️
- **总延迟**：最多 3 秒（主要来自 gap_timeout，但通常会在 1-2 秒内返回）

### 预期改进
- **延迟减少**：从 10 秒降低到 1-3 秒
- **用户体验**：显著提升，响应更快
- **性能影响**：结果检查循环从 10 秒降到 1 秒，会增加一些 CPU 开销，但影响很小（只是检查队列，不涉及网络或 I/O）

## 实施步骤

1. ✅ 缩短结果检查循环间隔：10 秒 → 1 秒
2. ✅ 缩短补位等待超时：5 秒 → 2 秒
3. ✅ 缩短 Gap Timeout：5 秒 → 3 秒

## 注意事项

1. **结果检查循环频率**：
   - 从 10 秒降到 1 秒会增加检查频率
   - 但检查操作本身很轻量（只是读取队列和发送消息）
   - 不会造成明显的性能问题

2. **补位等待时间**：
   - 从 5 秒降到 2 秒可能会略微增加丢失结果的风险
   - 但正常处理时间在 1-2 秒之间，2 秒足够
   - 如果真的需要更长时间，可以通过其他机制处理（如重试）

3. **Gap Timeout**：
   - 从 5 秒降到 3 秒可能会略微增加 Missing result 的创建
   - 但正常处理时间在 1-2 秒之间，3 秒足够
   - 如果真的需要更长时间，说明可能有问题，应该创建 Missing result

## 验证方法

1. **测试场景 1**：正常翻译流程
   - 预期：结果在 1-3 秒内返回（而不是 10 秒）

2. **测试场景 2**：网络延迟情况
   - 预期：即使有网络延迟，结果也能在 2-3 秒内返回

3. **测试场景 3**：补位机制
   - 预期：如果后续 index 先到达，前面的 index 会在 2 秒内核销（而不是 5 秒）

## 相关文档

- [Utterance 核销机制改进](./UTTERANCE_ACKNOWLEDGMENT_IMPROVEMENT.md)
- [翻译延迟分析](./TRANSLATION_DELAY_ANALYSIS.md)

