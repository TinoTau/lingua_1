# æç®€æ— é”è°ƒåº¦æœåŠ¡å®æ–½çŠ¶æ€

## æ–‡æ¡£ä¿¡æ¯

- **ç‰ˆæœ¬**: v1.0
- **æ—¥æœŸ**: 2026-01-11
- **çŠ¶æ€**: âœ… æ ¸å¿ƒåŠŸèƒ½å·²å®ç°ï¼Œå¾…é›†æˆæµ‹è¯•
- **å‚è€ƒè§„èŒƒ**: `LOCKLESS_MINIMAL_SCHEDULER_SPEC_v1.md`

---

## ä¸€ã€å®æ–½å®Œæˆæƒ…å†µ

### âœ… å·²å®Œæˆï¼ˆ100%ï¼‰

#### 1. Lua è„šæœ¬å®ç°

| è„šæœ¬ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | è¯´æ˜ |
|------|---------|------|------|
| `register_node.lua` | `scripts/lua/register_node.lua` | âœ… å®Œæˆ | èŠ‚ç‚¹æ³¨å†ŒåŸå­æ“ä½œ |
| `heartbeat.lua` | `scripts/lua/heartbeat.lua` | âœ… å®Œæˆ | èŠ‚ç‚¹å¿ƒè·³åŸå­æ“ä½œ |
| `dispatch_task.lua` | `scripts/lua/dispatch_task.lua` | âœ… å®Œæˆ | ä»»åŠ¡è°ƒåº¦åŸå­æ“ä½œ |
| `complete_task.lua` | `scripts/lua/complete_task.lua` | âœ… å®Œæˆ | ä»»åŠ¡å®ŒæˆåŸå­æ“ä½œ |

**ç‰¹ç‚¹**:
- âœ… æ‰€æœ‰æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ï¼ˆRedis Lua è„šæœ¬ï¼‰
- âœ… å®Œå…¨æ— é”ï¼ˆæ—  Rust å±‚é¢çš„é”ï¼‰
- âœ… æ”¯æŒ JSON è§£æï¼ˆå…¼å®¹ cjson å’Œæ‰‹åŠ¨è§£æï¼‰

---

#### 2. Rust æœåŠ¡æ¨¡å—å®ç°

| æ¨¡å— | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | è¯´æ˜ |
|------|---------|------|------|
| `MinimalSchedulerService` | `src/services/minimal_scheduler.rs` | âœ… å®Œæˆ | æ ¸å¿ƒæœåŠ¡ç»“æ„ |
| `register_node()` | `src/services/minimal_scheduler.rs` | âœ… å®Œæˆ | èŠ‚ç‚¹æ³¨å†Œ API |
| `heartbeat()` | `src/services/minimal_scheduler.rs` | âœ… å®Œæˆ | èŠ‚ç‚¹å¿ƒè·³ API |
| `dispatch_task()` | `src/services/minimal_scheduler.rs` | âœ… å®Œæˆ | ä»»åŠ¡è°ƒåº¦ API |
| `complete_task()` | `src/services/minimal_scheduler.rs` | âœ… å®Œæˆ | ä»»åŠ¡å®Œæˆ API |

**ç‰¹ç‚¹**:
- âœ… å®Œå…¨æ— é”ï¼ˆæ— ä¸šåŠ¡å±‚é¢çš„ Mutex/RwLockï¼‰
- âœ… æ‰€æœ‰çŠ¶æ€å­˜å‚¨åœ¨ Redis
- âœ… æ‰€æœ‰å¹¶å‘æ§åˆ¶é€šè¿‡ Redis åŸå­æ“ä½œ
- âœ… ä»£ç ç®€æ´ï¼Œé€»è¾‘æ¸…æ™°

---

#### 3. æ•°æ®ç»“æ„å®ç°

| ç»“æ„ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| `RegisterNodeRequest` | âœ… å®Œæˆ | èŠ‚ç‚¹æ³¨å†Œè¯·æ±‚ |
| `HeartbeatRequest` | âœ… å®Œæˆ | èŠ‚ç‚¹å¿ƒè·³è¯·æ±‚ |
| `DispatchRequest` | âœ… å®Œæˆ | ä»»åŠ¡è°ƒåº¦è¯·æ±‚ |
| `DispatchResponse` | âœ… å®Œæˆ | ä»»åŠ¡è°ƒåº¦å“åº” |
| `CompleteTaskRequest` | âœ… å®Œæˆ | ä»»åŠ¡å®Œæˆè¯·æ±‚ |

---

### â³ å¾…å®Œæˆ

#### 1. é›†æˆåˆ°ç°æœ‰ä»£ç 

- [ ] åœ¨ `AppState` ä¸­æ·»åŠ  `minimal_scheduler` å­—æ®µ
- [ ] åœ¨å¯åŠ¨æ—¶åˆå§‹åŒ–æœåŠ¡
- [ ] åˆ›å»º HTTP API è·¯ç”±
- [ ] é›†æˆåˆ° WebSocket æ¶ˆæ¯å¤„ç†

#### 2. æµ‹è¯•

- [ ] å•å…ƒæµ‹è¯•ï¼ˆLua è„šæœ¬æµ‹è¯•ï¼‰
- [ ] é›†æˆæµ‹è¯•ï¼ˆå®Œæ•´æµç¨‹æµ‹è¯•ï¼‰
- [ ] æ€§èƒ½æµ‹è¯•ï¼ˆå¹¶å‘åœºæ™¯æµ‹è¯•ï¼‰

#### 3. æ–‡æ¡£

- [ ] API æ–‡æ¡£
- [ ] ä½¿ç”¨ç¤ºä¾‹
- [ ] æ•…éšœæ’æŸ¥æŒ‡å—

---

## äºŒã€ä»£ç ç»“æ„

```
central_server/scheduler/
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ lua/
â”‚       â”œâ”€â”€ register_node.lua    âœ… èŠ‚ç‚¹æ³¨å†Œè„šæœ¬
â”‚       â”œâ”€â”€ heartbeat.lua         âœ… èŠ‚ç‚¹å¿ƒè·³è„šæœ¬
â”‚       â”œâ”€â”€ dispatch_task.lua     âœ… ä»»åŠ¡è°ƒåº¦è„šæœ¬
â”‚       â””â”€â”€ complete_task.lua     âœ… ä»»åŠ¡å®Œæˆè„šæœ¬
â”‚
â””â”€â”€ src/
    â””â”€â”€ services/
        â”œâ”€â”€ mod.rs                âœ… æ¨¡å—å¯¼å‡º
        â””â”€â”€ minimal_scheduler.rs  âœ… æç®€è°ƒåº¦æœåŠ¡
```

---

## ä¸‰ã€æ ¸å¿ƒç‰¹æ€§

### 3.1 å®Œå…¨æ— é”

- âœ… **æ—  Rust å±‚é¢çš„é”**: ä¸ä½¿ç”¨ `Mutex`ã€`RwLock` ç­‰
- âœ… **Redis åŸå­æ“ä½œ**: æ‰€æœ‰å¹¶å‘æ§åˆ¶é€šè¿‡ Redis Lua è„šæœ¬
- âœ… **æ— æœ¬åœ°çŠ¶æ€**: æ‰€æœ‰çŠ¶æ€å­˜å‚¨åœ¨ Redis

### 3.2 æ¶æ„ç®€å•

- âœ… **4 ä¸ªæ ¸å¿ƒæµç¨‹**: æ³¨å†Œã€å¿ƒè·³ã€è°ƒåº¦ã€å®Œæˆ
- âœ… **4 ä¸ª Lua è„šæœ¬**: æ¯ä¸ªæµç¨‹å¯¹åº”ä¸€ä¸ªè„šæœ¬
- âœ… **ä»£ç ç›´çº¿åŒ–**: é€»è¾‘æ¸…æ™°ï¼Œæ˜“äºæ’æŸ¥é—®é¢˜

### 3.3 Redis ä¸ºçœŸç›¸æº

- âœ… **èŠ‚ç‚¹ä¿¡æ¯**: `scheduler:node:info:{node_id}`
- âœ… **èŠ‚ç‚¹è¿è¡ŒçŠ¶æ€**: `scheduler:node:runtime:{node_id}`
- âœ… **Pool æˆå‘˜**: `scheduler:pool:{pool_id}:members`
- âœ… **è¯­è¨€ç´¢å¼•**: `scheduler:lang:{src}:{tgt}`
- âœ… **ä»»åŠ¡**: `scheduler:job:{job_id}`
- âœ… **ä¼šè¯**: `scheduler:session:{session_id}`

---

## å››ã€ä½¿ç”¨ç¤ºä¾‹

### 4.1 åˆå§‹åŒ–æœåŠ¡

```rust
use crate::services::MinimalSchedulerService;
use crate::phase2::RedisHandle;
use std::sync::Arc;

// ä» Phase2Runtime è·å– RedisHandle
let redis = Arc::new(phase2_runtime.redis.clone());

// åˆ›å»ºæœåŠ¡
let scheduler = MinimalSchedulerService::new(redis).await?;
```

### 4.2 èŠ‚ç‚¹æ³¨å†Œ

```rust
let req = RegisterNodeRequest {
    node_id: "node-1".to_string(),
    cap_json: r#"{"services":["ASR","NMT"]}"#.to_string(),
    max_jobs: 4,
    pools_json: Some(r#"[1,2]"#.to_string()),
};

scheduler.register_node(req).await?;
```

### 4.3 ä»»åŠ¡è°ƒåº¦

```rust
let req = DispatchRequest {
    session_id: "session-1".to_string(),
    src_lang: "zh".to_string(),
    tgt_lang: "en".to_string(),
    payload_json: r#"{"audio":"..."}"#.to_string(),
};

let response = scheduler.dispatch_task(req).await?;
// response.node_id, response.job_id
```

---

## äº”ã€ä¸‹ä¸€æ­¥å·¥ä½œ

### 5.1 ç«‹å³ä»»åŠ¡ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

1. **é›†æˆåˆ° AppState**
   ```rust
   pub struct AppState {
       // ... ç°æœ‰å­—æ®µ
       pub minimal_scheduler: Option<Arc<MinimalSchedulerService>>,
   }
   ```

2. **åœ¨å¯åŠ¨æ—¶åˆå§‹åŒ–**
   ```rust
   // src/app/startup.rs
   if let Some(phase2) = &state.phase2 {
       let redis = Arc::new(phase2.redis.clone());
       let scheduler = MinimalSchedulerService::new(redis).await?;
       state.minimal_scheduler = Some(Arc::new(scheduler));
   }
   ```

3. **åˆ›å»º HTTP API è·¯ç”±**
   ```rust
   // src/app/routes/routes_api.rs
   router.route("/api/v1/minimal/dispatch", post(dispatch_task_minimal))
   ```

### 5.2 åç»­ä»»åŠ¡ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

1. **å•å…ƒæµ‹è¯•**
   - æµ‹è¯•æ¯ä¸ª Lua è„šæœ¬
   - æµ‹è¯•æ¯ä¸ª API æ–¹æ³•

2. **é›†æˆæµ‹è¯•**
   - å®Œæ•´æµç¨‹æµ‹è¯•
   - å¹¶å‘åœºæ™¯æµ‹è¯•

3. **æ€§èƒ½ä¼˜åŒ–**
   - ä½¿ç”¨ `EVALSHA` ä»£æ›¿ `EVAL`
   - æ·»åŠ æœ¬åœ°åªè¯»ç¼“å­˜ï¼ˆå¯é€‰ï¼‰

---

## å…­ã€ä¸ç°æœ‰æ¶æ„çš„å…³ç³»

### 6.1 å…¼å®¹æ€§

- âœ… **å¯ä»¥å¹¶è¡Œè¿è¡Œ**: æç®€è°ƒåº¦æœåŠ¡å¯ä»¥ä¸ç°æœ‰è°ƒåº¦æœåŠ¡å¹¶è¡Œè¿è¡Œ
- âœ… **å…±äº« Redis**: ä½¿ç”¨ç›¸åŒçš„ Redis å®ä¾‹å’Œ key å‘½åç©ºé—´
- âœ… **ç‹¬ç«‹æ¨¡å—**: ä¸ä¾èµ–ç°æœ‰ä»£ç ï¼Œå¯ä»¥ç‹¬ç«‹ä½¿ç”¨

### 6.2 è¿ç§»è·¯å¾„

1. **é˜¶æ®µ 1**: å¹¶è¡Œè¿è¡Œï¼ŒéªŒè¯åŠŸèƒ½
2. **é˜¶æ®µ 2**: é€æ­¥è¿ç§»æµé‡åˆ°æç®€è°ƒåº¦æœåŠ¡
3. **é˜¶æ®µ 3**: å®Œå…¨åˆ‡æ¢åˆ°æç®€è°ƒåº¦æœåŠ¡
4. **é˜¶æ®µ 4**: ç§»é™¤æ—§ä»£ç 

---

## ä¸ƒã€å·²çŸ¥é—®é¢˜å’Œé™åˆ¶

### 7.1 JSON è§£æ

- âš ï¸ **Redis cjson æ”¯æŒ**: å¦‚æœ Redis ä¸æ”¯æŒ cjsonï¼Œéœ€è¦æ‰‹åŠ¨è§£æ JSON
- âœ… **å·²å¤„ç†**: Lua è„šæœ¬å·²æ·»åŠ é™çº§å¤„ç†ï¼ˆæ‰‹åŠ¨è§£æï¼‰

### 7.2 Pool é€‰æ‹©ç­–ç•¥

- âš ï¸ **å½“å‰å®ç°**: ç®€å•é€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨èŠ‚ç‚¹
- ğŸ’¡ **å¯æ‰©å±•**: å¯ä»¥æ·»åŠ å¥åº·è¯„åˆ†ã€è´Ÿè½½å‡è¡¡ç­‰ç­–ç•¥

### 7.3 é”™è¯¯å¤„ç†

- âš ï¸ **å½“å‰å®ç°**: è¿”å›é”™è¯¯å­—ç¬¦ä¸²
- ğŸ’¡ **å¯æ‰©å±•**: å¯ä»¥æ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯ç å’Œé”™è¯¯ä¿¡æ¯

---

## å…«ã€æ€§èƒ½é¢„æœŸ

### 8.1 å»¶è¿Ÿ

| æ“ä½œ | é¢„æœŸå»¶è¿Ÿ | è¯´æ˜ |
|------|---------|------|
| èŠ‚ç‚¹æ³¨å†Œ | 5-20ms | Redis Lua è„šæœ¬æ‰§è¡Œ |
| èŠ‚ç‚¹å¿ƒè·³ | 2-10ms | Redis Lua è„šæœ¬æ‰§è¡Œ |
| ä»»åŠ¡è°ƒåº¦ | 10-50ms | Redis Lua è„šæœ¬ + èŠ‚ç‚¹é€‰æ‹© |
| ä»»åŠ¡å®Œæˆ | 2-10ms | Redis Lua è„šæœ¬æ‰§è¡Œ |

### 8.2 ååé‡

- **æ— é”ä¼˜åŠ¿**: ç†è®ºä¸Šå¯ä»¥æ”¯æŒæ›´é«˜çš„å¹¶å‘
- **Redis ç“¶é¢ˆ**: å®é™…ååé‡å–å†³äº Redis æ€§èƒ½
- **é¢„æœŸ**: 1000+ QPSï¼ˆå–å†³äº Redis é…ç½®ï¼‰

---

## ä¹ã€æ€»ç»“

### âœ… å·²å®Œæˆ

1. âœ… 4 ä¸ªæ ¸å¿ƒ Lua è„šæœ¬ï¼ˆå®Œå…¨æ— é”ï¼‰
2. âœ… æç®€è°ƒåº¦æœåŠ¡æ¨¡å—ï¼ˆå®Œå…¨æ— é”ï¼‰
3. âœ… è¯·æ±‚/å“åº”æ•°æ®ç»“æ„
4. âœ… é›†æˆæ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹

### â³ å¾…å®Œæˆ

1. â³ é›†æˆåˆ°ç°æœ‰ä»£ç 
2. â³ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
3. â³ æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–

### ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

1. âœ… **å®Œå…¨æ— é”**: æ—  Rust å±‚é¢çš„é”ï¼Œæ— é”ç«äº‰
2. âœ… **æ¶æ„ç®€å•**: 4 ä¸ªæ ¸å¿ƒæµç¨‹ï¼Œä»£ç æ¸…æ™°
3. âœ… **æ˜“äºæ’æŸ¥**: æ‰€æœ‰çŠ¶æ€åœ¨ Redisï¼Œå¯è§å¯æŸ¥
4. âœ… **æ˜“äºæ‰©å±•**: å¯ä»¥é€æ­¥æ·»åŠ åŠŸèƒ½ï¼ˆç¼“å­˜ã€ç›‘æ§ç­‰ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-01-11  
**çŠ¶æ€**: âœ… æ ¸å¿ƒåŠŸèƒ½å·²å®ç°ï¼Œå¾…é›†æˆæµ‹è¯•
