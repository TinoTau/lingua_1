# èŠ‚ç‚¹ç®¡ç†å’Œä»»åŠ¡ç®¡ç†æµç¨‹å†³ç­–æ‘˜è¦

## æ–‡æ¡£ä¿¡æ¯

- **ç‰ˆæœ¬**: v1.0
- **æ—¥æœŸ**: 2026-01-11
- **ç›®æ ‡å—ä¼—**: å†³ç­–éƒ¨é—¨
- **è¯¦ç»†æ–‡æ¡£**: `NODE_AND_TASK_MANAGEMENT_FLOW_DECISION.md`

---

## ä¸€ã€æ ¸å¿ƒå†³ç­–

### 1.1 æ¶æ„é€‰æ‹©

é‡‡ç”¨**æç®€æ— é”è°ƒåº¦æœåŠ¡**ï¼ˆMinimal Lockless Schedulerï¼‰æ¶æ„ï¼š

- âœ… **æ— é”è®¾è®¡**: ä¸ä¾èµ–ä»»ä½•ä¸šåŠ¡å±‚é¢çš„ `Mutex`/`RwLock`
- âœ… **çŠ¶æ€é›†ä¸­**: æ‰€æœ‰å…±äº«çŠ¶æ€ç»Ÿä¸€å­˜å…¥ Redis
- âœ… **åŸå­æ“ä½œ**: æ‰€æœ‰å¹¶å‘æ§åˆ¶é€šè¿‡ Redis Lua è„šæœ¬åŸå­æ‰§è¡Œ
- âœ… **ç®€åŒ–æµç¨‹**: èŠ‚ç‚¹ç®¡ç†å’Œä»»åŠ¡ç®¡ç†æµç¨‹ç²¾ç®€ï¼Œé¿å…å¤æ‚çš„çŠ¶æ€åŒæ­¥

### 1.2 å®ç°çŠ¶æ€

| ç»„ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| æ–°å®ç° | âœ… å·²å®Œæˆ | `MinimalSchedulerService` åŠå…¶ 4 ä¸ªæ ¸å¿ƒæ–¹æ³• |
| Lua è„šæœ¬ | âœ… å·²å®Œæˆ | 4 ä¸ªæ ¸å¿ƒ Lua è„šæœ¬å·²å®ç°å¹¶æµ‹è¯• |
| å•å…ƒæµ‹è¯• | âœ… å·²å®Œæˆ | 7/7 æµ‹è¯•é€šè¿‡ |
| æ—§å®ç° | âš ï¸ å·²åºŸå¼ƒ | æ—§æ–¹æ³•å·²æ³¨é‡Šï¼Œç­‰å¾…è¿ç§» |
| é›†æˆè¿ç§» | ğŸ”„ å¾…å®Œæˆ | WebSocket å¤„ç†å™¨éœ€è¦è°ƒç”¨æ–°å®ç° |

---

## äºŒã€èŠ‚ç‚¹ç®¡ç†æµç¨‹

### 2.1 èŠ‚ç‚¹æ³¨å†Œ

**æµç¨‹**: WebSocket æ¶ˆæ¯ â†’ `handle_node_register()` ã€å·²åºŸå¼ƒã€‘ â†’ `MinimalSchedulerService::register_node()` â†’ `register_node.lua` â†’ Redis

**æ–¹æ³•è°ƒç”¨**:
1. `websocket/node_handler/message/mod.rs::handle_message()` âœ…
2. `register::handle_node_register()` âš ï¸ **å·²åºŸå¼ƒ**
3. `MinimalSchedulerService::register_node()` âœ… **æ–°å®ç°**
4. `register_node.lua` âœ…

**Redis æ“ä½œ**:
- å†™å…¥èŠ‚ç‚¹ä¿¡æ¯ (`scheduler:node:info:{node_id}`)
- åˆå§‹åŒ–è¿è¡ŒçŠ¶æ€ (`scheduler:node:runtime:{node_id}`)
- æ›´æ–° Pool æˆå‘˜ (`scheduler:pool:{pool_id}:members`)
- æ›´æ–°è¯­è¨€ç´¢å¼• (`scheduler:lang:{src}:{tgt}`)

### 2.2 èŠ‚ç‚¹å¿ƒè·³

**æµç¨‹**: WebSocket æ¶ˆæ¯ â†’ `handle_node_heartbeat()` ã€å·²åºŸå¼ƒã€‘ â†’ `MinimalSchedulerService::heartbeat()` â†’ `heartbeat.lua` â†’ Redis

**æ–¹æ³•è°ƒç”¨**:
1. `websocket/node_handler/message/mod.rs::handle_message()` âœ…
2. `register::handle_node_heartbeat()` âš ï¸ **å·²åºŸå¼ƒ**
3. `MinimalSchedulerService::heartbeat()` âœ… **æ–°å®ç°**
4. `heartbeat.lua` âœ…

**Redis æ“ä½œ**:
- æ›´æ–°èŠ‚ç‚¹çŠ¶æ€ (`scheduler:node:info:{node_id}`)
- æ›´æ–°å¿ƒè·³æ—¶é—´æˆ³
- æ›´æ–°è´Ÿè½½ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰

---

## ä¸‰ã€ä»»åŠ¡ç®¡ç†æµç¨‹

### 3.1 ä»»åŠ¡è°ƒåº¦

**æµç¨‹**: SessionActor â†’ `try_finalize()` â†’ `do_finalize()` â†’ `create_translation_jobs()` â†’ `JobDispatcher::create_job()` ã€å·²åºŸå¼ƒã€‘ â†’ `MinimalSchedulerService::dispatch_task()` â†’ `dispatch_task.lua` â†’ Redis

**æ–¹æ³•è°ƒç”¨**:
1. `SessionActor::handle_audio_chunk()` âœ…
2. `SessionActor::try_finalize()` âœ…
3. `SessionActor::do_finalize()` âœ…
4. `create_translation_jobs()` âœ…
5. `JobDispatcher::create_job()` âš ï¸ **å·²åºŸå¼ƒ**
6. `MinimalSchedulerService::dispatch_task()` âœ… **æ–°å®ç°**
7. `dispatch_task.lua` âœ…

**Redis æ“ä½œ**:
- è¯»å–ä¼šè¯ç»‘å®š (`scheduler:session:{session_id}`)
- æ ¹æ®è¯­è¨€å¯¹é€‰æ‹© Pool (`scheduler:lang:{src}:{tgt}`)
- ä» Pool é€‰æ‹©å¯ç”¨èŠ‚ç‚¹ (`scheduler:pool:{pool_id}:members`)
- å ç”¨èŠ‚ç‚¹å¹¶å‘æ§½ (`scheduler:node:runtime:{node_id}`)
- åˆ›å»ºä»»åŠ¡è®°å½• (`scheduler:job:{job_id}`)

### 3.2 ä»»åŠ¡å®Œæˆ

**æµç¨‹**: èŠ‚ç‚¹è¿”å›ç»“æœ â†’ `process_job_result()` â†’ `MinimalSchedulerService::complete_task()` â†’ `complete_task.lua` â†’ Redis

**æ–¹æ³•è°ƒç”¨**:
1. `websocket/node_handler/message/mod.rs::handle_message()` âœ…
2. `job_result::process_job_result()` âœ…
3. `MinimalSchedulerService::complete_task()` âœ… **æ–°å®ç°**
4. `complete_task.lua` âœ…

**Redis æ“ä½œ**:
- æ ¡éªŒä»»åŠ¡å½’å± (`scheduler:job:{job_id}`)
- æ›´æ–°ä»»åŠ¡çŠ¶æ€
- é‡Šæ”¾èŠ‚ç‚¹å¹¶å‘æ§½ (`scheduler:node:runtime:{node_id}`)

---

## å››ã€å…³é”®æŒ‡æ ‡

### 4.1 æ€§èƒ½æŒ‡æ ‡

- **èŠ‚ç‚¹æ³¨å†Œ**: å•æ¬¡ Redis è°ƒç”¨ï¼ˆLua è„šæœ¬åŸå­æ“ä½œï¼‰
- **èŠ‚ç‚¹å¿ƒè·³**: å•æ¬¡ Redis è°ƒç”¨ï¼ˆLua è„šæœ¬åŸå­æ“ä½œï¼‰
- **ä»»åŠ¡è°ƒåº¦**: å•æ¬¡ Redis è°ƒç”¨ï¼ˆLua è„šæœ¬åŸå­æ“ä½œï¼ŒåŒ…å« Pool é€‰æ‹©ã€èŠ‚ç‚¹é€‰æ‹©ã€å¹¶å‘æ§½å ç”¨ï¼‰
- **ä»»åŠ¡å®Œæˆ**: å•æ¬¡ Redis è°ƒç”¨ï¼ˆLua è„šæœ¬åŸå­æ“ä½œï¼ŒåŒ…å«çŠ¶æ€æ›´æ–°ã€å¹¶å‘æ§½é‡Šæ”¾ï¼‰

### 4.2 å¹¶å‘å¤„ç†

- âœ… **èŠ‚ç‚¹æ³¨å†Œ**: æ”¯æŒå¹¶å‘æ³¨å†Œï¼ŒLua è„šæœ¬ä¿è¯åŸå­æ€§
- âœ… **èŠ‚ç‚¹å¿ƒè·³**: æ”¯æŒå¹¶å‘å¿ƒè·³ï¼ŒLua è„šæœ¬ä¿è¯åŸå­æ€§
- âœ… **ä»»åŠ¡è°ƒåº¦**: æ”¯æŒå¹¶å‘è°ƒåº¦ï¼ŒLua è„šæœ¬ä¿è¯èŠ‚ç‚¹å¹¶å‘æ§½æ­£ç¡®å ç”¨
- âœ… **ä»»åŠ¡å®Œæˆ**: æ”¯æŒå¹¶å‘å®Œæˆï¼ŒLua è„šæœ¬ä¿è¯èŠ‚ç‚¹å¹¶å‘æ§½æ­£ç¡®é‡Šæ”¾

### 4.3 æµ‹è¯•è¦†ç›–

- âœ… **å•å…ƒæµ‹è¯•**: 7/7 æµ‹è¯•é€šè¿‡
- âœ… **èŠ‚ç‚¹æ³¨å†Œæµ‹è¯•**: é€šè¿‡
- âœ… **èŠ‚ç‚¹å¿ƒè·³æµ‹è¯•**: é€šè¿‡
- âœ… **ä»»åŠ¡è°ƒåº¦æµ‹è¯•**: é€šè¿‡
- âœ… **ä»»åŠ¡å®Œæˆæµ‹è¯•**: é€šè¿‡
- âœ… **å®Œæ•´æµç¨‹æµ‹è¯•**: é€šè¿‡

---

## äº”ã€è¿ç§»çŠ¶æ€

### 5.1 å·²å®Œæˆ

- âœ… æ–°å®ç°å·²å®Œæˆ (`MinimalSchedulerService`)
- âœ… Lua è„šæœ¬å·²å®Œæˆå¹¶æµ‹è¯•
- âœ… å•å…ƒæµ‹è¯•å·²å®Œæˆï¼ˆ7/7 é€šè¿‡ï¼‰
- âœ… æ—§å®ç°å·²åºŸå¼ƒï¼ˆå·²æ³¨é‡Šï¼‰

### 5.2 å¾…å®Œæˆ

- ğŸ”„ èŠ‚ç‚¹æ³¨å†Œè¿ç§»ï¼ˆ`handle_node_register`ï¼‰
- ğŸ”„ èŠ‚ç‚¹å¿ƒè·³è¿ç§»ï¼ˆ`handle_node_heartbeat`ï¼‰
- ğŸ”„ ä»»åŠ¡è°ƒåº¦è¿ç§»ï¼ˆ`create_translation_jobs`ï¼‰
- ğŸ”„ ä»»åŠ¡å®Œæˆè¿ç§»ï¼ˆ`process_job_result`ï¼‰

---

## å…­ã€å†³ç­–å»ºè®®

### 6.1 ä¼˜åŠ¿

1. **ç®€åŒ–è®¾è®¡**: æ— é”æ¶æ„ç®€åŒ–äº†å¹¶å‘æ§åˆ¶é€»è¾‘
2. **æ€§èƒ½æå‡**: é¿å…äº† Rust å±‚é¢çš„é”ç«äº‰
3. **æ˜“äºæ‰©å±•**: Redis ä½œä¸ºçŠ¶æ€ä¸­å¿ƒï¼Œä¾¿äºåˆ†å¸ƒå¼æ‰©å±•
4. **åŸå­æ€§ä¿è¯**: Lua è„šæœ¬ä¿è¯æ“ä½œçš„åŸå­æ€§

### 6.2 é£é™©

1. **Redis ä¾èµ–**: ç³»ç»Ÿä¾èµ– Redisï¼Œéœ€è¦ä¿è¯ Redis é«˜å¯ç”¨
2. **è¿ç§»é£é™©**: ä»æ—§å®ç°è¿ç§»åˆ°æ–°å®ç°éœ€è¦å……åˆ†æµ‹è¯•
3. **å…¼å®¹æ€§**: éœ€è¦ç¡®ä¿æ–°å®ç°ä¸ç°æœ‰ä¸šåŠ¡é€»è¾‘å…¼å®¹

### 6.3 å»ºè®®

1. **âœ… æ‰¹å‡†æ–°æ¶æ„**: æ–°å®ç°å·²å®Œæˆå¹¶æµ‹è¯•é€šè¿‡ï¼Œå»ºè®®æ‰¹å‡†é‡‡ç”¨
2. **ğŸ”„ åˆ†æ­¥è¿ç§»**: å…ˆè¿ç§»èŠ‚ç‚¹ç®¡ç†ï¼Œå†è¿ç§»ä»»åŠ¡ç®¡ç†
3. **âœ… å……åˆ†æµ‹è¯•**: è¿ç§»åè¿›è¡Œå……åˆ†æµ‹è¯•ï¼Œç¡®ä¿åŠŸèƒ½æ­£å¸¸

---

## ä¸ƒã€è¯¦ç»†æ–‡æ¡£

è¯¦ç»†æµç¨‹ã€æ–¹æ³•è°ƒç”¨é“¾ã€Redis æ•°æ®ç»“æ„ç­‰ä¿¡æ¯ï¼Œè¯·å‚è€ƒï¼š

**`docs/architecture/NODE_AND_TASK_MANAGEMENT_FLOW_DECISION.md`**

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-01-11  
**çŠ¶æ€**: âœ… æ–°å®ç°å·²å®Œæˆï¼Œå¾…è¿ç§»é›†æˆ
