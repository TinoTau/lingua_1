# éŸ³é¢‘æ¶ˆæ¯æ¶æ„åˆ†æ

**æ—¥æœŸ**: 2025-12-24  
**é—®é¢˜**: ä¸ºä»€ä¹ˆWebç«¯è¦å‘é€ä¸¤ç§æ•°æ®æµï¼ˆ`audio_chunk`å’Œ`utterance`ï¼‰ï¼Ÿ  
**çŠ¶æ€**: ğŸ“Š **æ¶æ„åˆ†æ**

---

## å½“å‰æ¶æ„

### ä¸¤ç§æ¶ˆæ¯ç±»å‹

1. **`audio_chunk`æ¶ˆæ¯**ï¼ˆæµå¼å‘é€ï¼‰
   - **ç”¨é€”**: å®æ—¶æµå¼ä¼ è¾“éŸ³é¢‘æ•°æ®
   - **å‘é€æ—¶æœº**: å½•éŸ³è¿‡ç¨‹ä¸­æŒç»­å‘é€ï¼ˆæ¯100msï¼‰
   - **å¤„ç†æ–¹å¼**: è°ƒåº¦æœåŠ¡å™¨ä½¿ç”¨`audio_buffer`ç´¯ç§¯ï¼Œåœ¨finalizeæ—¶åˆå¹¶

2. **`utterance`æ¶ˆæ¯**ï¼ˆä¸€æ¬¡æ€§å‘é€ï¼‰
   - **ç”¨é€”**: ä¸€æ¬¡æ€§å‘é€å®Œæ•´éŸ³é¢‘
   - **å‘é€æ—¶æœº**: ç”¨æˆ·æ‰‹åŠ¨è§¦å‘ï¼ˆ`sendCurrentUtterance()`ï¼‰
   - **å¤„ç†æ–¹å¼**: è°ƒåº¦æœåŠ¡å™¨ç›´æ¥åˆ›å»ºjobï¼Œä¸ç»è¿‡`audio_buffer`

---

## è®¾è®¡æ„å›¾åˆ†æ

### audio_chunkçš„è®¾è®¡æ„å›¾

**ä¼˜åŠ¿**ï¼š
1. **å®æ—¶æ€§**: æ”¯æŒæµå¼ä¼ è¾“ï¼Œå¯ä»¥å®æ—¶å¤„ç†éŸ³é¢‘
2. **ä½å»¶è¿Ÿ**: ä¸éœ€è¦ç­‰å¾…å®Œæ•´éŸ³é¢‘ï¼Œå¯ä»¥è¾¹å½•è¾¹å¤„ç†
3. **æµå¼ASR**: æ”¯æŒéƒ¨åˆ†ç»“æœè¾“å‡ºï¼ˆ`asr_partial`æ¶ˆæ¯ï¼‰
4. **è‡ªåŠ¨åˆ‡å¥**: è°ƒåº¦æœåŠ¡å™¨å¯ä»¥æ ¹æ®æš‚åœæ—¶é—´è‡ªåŠ¨åˆ‡å¥

**ä½¿ç”¨åœºæ™¯**ï¼š
- é•¿æ—¶é—´å½•éŸ³ï¼ˆå¦‚ä¼šè®®ã€è®²åº§ï¼‰
- éœ€è¦å®æ—¶åé¦ˆçš„åœºæ™¯
- éœ€è¦è‡ªåŠ¨åˆ‡å¥çš„åœºæ™¯

### utteranceçš„è®¾è®¡æ„å›¾

**ä¼˜åŠ¿**ï¼š
1. **ç®€å•ç›´æ¥**: ä¸€æ¬¡æ€§å‘é€ï¼Œä¸éœ€è¦ç´¯ç§¯
2. **ç²¾ç¡®æ§åˆ¶**: ç”¨æˆ·æ‰‹åŠ¨æ§åˆ¶å‘é€æ—¶æœº
3. **å‡å°‘å»¶è¿Ÿ**: ä¸ç»è¿‡`audio_buffer`ï¼Œç›´æ¥åˆ›å»ºjob

**ä½¿ç”¨åœºæ™¯**ï¼š
- çŸ­éŸ³é¢‘ç‰‡æ®µ
- ç”¨æˆ·æ‰‹åŠ¨æ§åˆ¶çš„åœºæ™¯
- ä¸éœ€è¦æµå¼å¤„ç†çš„åœºæ™¯

---

## ä»£ç ä¸­çš„å®é™…ä½¿ç”¨

### Webç«¯ä½¿ç”¨æƒ…å†µ

**`audio_chunk`ä½¿ç”¨**ï¼š
```typescript
// app.ts ç¬¬246è¡Œï¼šå½•éŸ³è¿‡ç¨‹ä¸­è‡ªåŠ¨å‘é€
if (this.audioBuffer.length >= 10) {
  const chunk = this.concatAudioBuffers(this.audioBuffer.splice(0, 10));
  this.wsClient.sendAudioChunk(chunk, false);  // æµå¼å‘é€
}

// app.ts ç¬¬263è¡Œï¼šé™éŸ³æ£€æµ‹åå‘é€å‰©ä½™æ•°æ®
this.wsClient.sendAudioChunk(chunk, false);
this.wsClient.sendFinal();  // å‘é€ç»“æŸå¸§
```

**`utterance`ä½¿ç”¨**ï¼š
```typescript
// app.ts ç¬¬966è¡Œï¼šç”¨æˆ·æ‰‹åŠ¨è§¦å‘
async sendCurrentUtterance(): Promise<void> {
  if (this.audioBuffer.length > 0) {
    const audioData = this.concatAudioBuffers(this.audioBuffer);
    await this.wsClient.sendUtterance(...);  // ä¸€æ¬¡æ€§å‘é€
  }
}
```

### è°ƒåº¦æœåŠ¡å™¨å¤„ç†å·®å¼‚

**`audio_chunk`å¤„ç†**ï¼š
```rust
// session_actor.rs: ç´¯ç§¯åˆ°audio_buffer
audio_buffer.add_chunk(session_id, utterance_index, chunk);
// finalizeæ—¶åˆå¹¶
let audio_data = audio_buffer.take_combined(session_id, utterance_index);
create_translation_jobs(..., audio_data, ...);
```

**`utterance`å¤„ç†**ï¼š
```rust
// utterance.rs: ç›´æ¥åˆ›å»ºjob
let audio_data = base64::decode(&audio)?;
create_translation_jobs(..., audio_data, ...);  // ä¸ç»è¿‡audio_buffer
```

---

## é—®é¢˜åˆ†æ

### é—®é¢˜1: åŠŸèƒ½é‡å 

**ç°çŠ¶**ï¼š
- ä¸¤ç§æ¶ˆæ¯ç±»å‹éƒ½èƒ½å®Œæˆç›¸åŒçš„ä»»åŠ¡ï¼ˆå‘é€éŸ³é¢‘å¹¶åˆ›å»ºjobï¼‰
- éƒ½æ”¯æŒæµå¼ASR
- éƒ½æ”¯æŒopusç¼–ç 

**é—®é¢˜**ï¼š
- å¢åŠ äº†ä»£ç å¤æ‚åº¦
- éœ€è¦ç»´æŠ¤ä¸¤å¥—é€»è¾‘
- å®¹æ˜“å‡ºç°ä¸ä¸€è‡´ï¼ˆå¦‚æ ¼å¼é—®é¢˜ï¼‰

### é—®é¢˜2: ä½¿ç”¨åœºæ™¯ä¸æ˜ç¡®

**ç°çŠ¶**ï¼š
- Webç«¯åŒæ—¶ä½¿ç”¨ä¸¤ç§æ¶ˆæ¯
- ä¸æ¸…æ¥šä»€ä¹ˆæ—¶å€™åº”è¯¥ç”¨å“ªç§
- å¯èƒ½å¯¼è‡´æ··ä¹±

**é—®é¢˜**ï¼š
- ç”¨æˆ·å¯èƒ½ä¸çŸ¥é“åº”è¯¥ä½¿ç”¨å“ªç§æ–¹å¼
- å¯èƒ½å¯¼è‡´æ„å¤–çš„è¡Œä¸º

### é—®é¢˜3: æ•°æ®æ ¼å¼ä¸ä¸€è‡´é£é™©

**ç°çŠ¶**ï¼š
- ä¸¤ç§æ¶ˆæ¯ä½¿ç”¨ä¸åŒçš„ç¼–ç æ–¹å¼ï¼ˆä¿®å¤å‰ï¼‰
- è°ƒåº¦æœåŠ¡å™¨å¤„ç†æ–¹å¼ä¸åŒ

**é—®é¢˜**ï¼š
- å®¹æ˜“å‡ºç°æ ¼å¼ä¸ä¸€è‡´
- éœ€è¦ç¡®ä¿ä¸¤ç§æ–¹å¼éƒ½æ­£ç¡®å®ç°

---

## ç»Ÿä¸€æ–¹æ¡ˆå»ºè®®

### æ–¹æ¡ˆ1: ç»Ÿä¸€ä½¿ç”¨`audio_chunk`ï¼ˆæ¨èï¼‰

**ä¼˜åŠ¿**ï¼š
1. **æ›´çµæ´»**: æ”¯æŒæµå¼ä¼ è¾“å’Œä¸€æ¬¡æ€§å‘é€
2. **æ›´ç»Ÿä¸€**: æ‰€æœ‰éŸ³é¢‘éƒ½ç»è¿‡ç›¸åŒçš„å¤„ç†æµç¨‹
3. **æ›´ç®€å•**: åªéœ€è¦ç»´æŠ¤ä¸€å¥—é€»è¾‘

**å®ç°**ï¼š
- Webç«¯ï¼šç§»é™¤`sendUtterance()`ï¼Œç»Ÿä¸€ä½¿ç”¨`sendAudioChunk()`
- è°ƒåº¦æœåŠ¡å™¨ï¼š`utterance`æ¶ˆæ¯ä¹Ÿä½¿ç”¨`audio_buffer`å¤„ç†
- æˆ–è€…ï¼š`utterance`æ¶ˆæ¯è½¬æ¢ä¸º`audio_chunk`æ¶ˆæ¯å¤„ç†

**ä¿®æ”¹ç‚¹**ï¼š
```typescript
// Webç«¯ï¼šç»Ÿä¸€ä½¿ç”¨sendAudioChunk
async sendCurrentUtterance(): Promise<void> {
  if (this.audioBuffer.length > 0) {
    const audioData = this.concatAudioBuffers(this.audioBuffer);
    // å‘é€æ‰€æœ‰æ•°æ®ï¼Œå¹¶æ ‡è®°ä¸ºfinal
    await this.wsClient.sendAudioChunk(audioData, true);  // isFinal = true
  }
}
```

### æ–¹æ¡ˆ2: ç»Ÿä¸€ä½¿ç”¨`utterance`

**ä¼˜åŠ¿**ï¼š
1. **æ›´ç®€å•**: ä¸éœ€è¦`audio_buffer`ç´¯ç§¯é€»è¾‘
2. **æ›´ç›´æ¥**: ä¸€æ¬¡æ€§å‘é€ï¼Œç›´æ¥åˆ›å»ºjob

**åŠ£åŠ¿**ï¼š
1. **å¤±å»æµå¼èƒ½åŠ›**: æ— æ³•æ”¯æŒå®æ—¶æµå¼ä¼ è¾“
2. **å¤±å»è‡ªåŠ¨åˆ‡å¥**: éœ€è¦Webç«¯è‡ªå·±æ§åˆ¶åˆ‡å¥

**å®ç°**ï¼š
- Webç«¯ï¼šç§»é™¤`sendAudioChunk()`ï¼Œç»Ÿä¸€ä½¿ç”¨`sendUtterance()`
- è°ƒåº¦æœåŠ¡å™¨ï¼šç§»é™¤`audio_buffer`ç›¸å…³é€»è¾‘

---

## æ¨èæ–¹æ¡ˆ

### æ¨èï¼šç»Ÿä¸€ä½¿ç”¨`audio_chunk`ï¼ˆä¿ç•™æµå¼èƒ½åŠ›ï¼‰

**ç†ç”±**ï¼š
1. **ä¿ç•™çµæ´»æ€§**: æ”¯æŒæµå¼å’Œä¸€æ¬¡æ€§å‘é€
2. **ç»Ÿä¸€å¤„ç†**: æ‰€æœ‰éŸ³é¢‘éƒ½ç»è¿‡ç›¸åŒçš„å¤„ç†æµç¨‹
3. **ç®€åŒ–ä»£ç **: åªéœ€è¦ç»´æŠ¤ä¸€å¥—é€»è¾‘
4. **å‘åå…¼å®¹**: å¯ä»¥ä¿ç•™`utterance`ä½œä¸ºå…¼å®¹æ¥å£ï¼Œå†…éƒ¨è½¬æ¢ä¸º`audio_chunk`

**å®ç°æ­¥éª¤**ï¼š
1. **Webç«¯**: ä¿®æ”¹`sendCurrentUtterance()`ï¼Œä½¿ç”¨`sendAudioChunk(audioData, true)`
2. **è°ƒåº¦æœåŠ¡å™¨**: ä¿®æ”¹`handle_utterance()`ï¼Œå°†æ•°æ®æ·»åŠ åˆ°`audio_buffer`å¹¶finalize
3. **æµ‹è¯•**: ç¡®ä¿ä¸¤ç§æ–¹å¼éƒ½èƒ½æ­£å¸¸å·¥ä½œ

---

## å½“å‰æ¶æ„çš„é—®é¢˜

### 1. åŠŸèƒ½é‡å¤

ä¸¤ç§æ¶ˆæ¯ç±»å‹åŠŸèƒ½é‡å ï¼Œå¢åŠ äº†ç»´æŠ¤æˆæœ¬ã€‚

### 2. å¤„ç†é€»è¾‘ä¸ä¸€è‡´

- `audio_chunk` â†’ `audio_buffer` â†’ finalize â†’ job
- `utterance` â†’ ç›´æ¥åˆ›å»ºjob

è¿™å¯èƒ½å¯¼è‡´ï¼š
- è¡Œä¸ºä¸ä¸€è‡´
- æ ¼å¼é—®é¢˜ï¼ˆå¦‚æˆ‘ä»¬é‡åˆ°çš„packetæ ¼å¼é—®é¢˜ï¼‰

### 3. ä½¿ç”¨åœºæ™¯ä¸æ˜ç¡®

ä¸æ¸…æ¥šä»€ä¹ˆæ—¶å€™åº”è¯¥ä½¿ç”¨å“ªç§æ–¹å¼ï¼Œå¯èƒ½å¯¼è‡´ï¼š
- ç”¨æˆ·å›°æƒ‘
- æ„å¤–çš„è¡Œä¸º

---

## æ€»ç»“

### å½“å‰çŠ¶æ€

- **ä¸¤ç§æ¶ˆæ¯ç±»å‹å¹¶å­˜**ï¼ŒåŠŸèƒ½é‡å 
- **å¤„ç†é€»è¾‘ä¸ä¸€è‡´**ï¼Œå¯èƒ½å¯¼è‡´é—®é¢˜
- **ä½¿ç”¨åœºæ™¯ä¸æ˜ç¡®**ï¼Œå¢åŠ å¤æ‚åº¦

### å»ºè®®

1. **çŸ­æœŸ**: ç¡®ä¿ä¸¤ç§æ–¹å¼éƒ½ä½¿ç”¨Plan Aæ ¼å¼ï¼ˆå·²å®Œæˆï¼‰
2. **ä¸­æœŸ**: ç»Ÿä¸€ä½¿ç”¨`audio_chunk`ï¼Œä¿ç•™æµå¼èƒ½åŠ›
3. **é•¿æœŸ**: è€ƒè™‘ç®€åŒ–æ¶æ„ï¼Œç§»é™¤å†—ä½™

### ä¼˜åŠ¿åˆ†æ

**ä¿ç•™ä¸¤ç§æ–¹å¼çš„ä¼˜åŠ¿**ï¼š
- çµæ´»æ€§ï¼šæ”¯æŒä¸åŒçš„ä½¿ç”¨åœºæ™¯
- å…¼å®¹æ€§ï¼šæ”¯æŒä¸åŒçš„å®¢æˆ·ç«¯å®ç°

**ç»Ÿä¸€æ–¹å¼çš„ä¼˜åŠ¿**ï¼š
- ç®€å•æ€§ï¼šåªéœ€è¦ç»´æŠ¤ä¸€å¥—é€»è¾‘
- ä¸€è‡´æ€§ï¼šæ‰€æœ‰éŸ³é¢‘éƒ½ç»è¿‡ç›¸åŒçš„å¤„ç†æµç¨‹
- å¯ç»´æŠ¤æ€§ï¼šå‡å°‘ä»£ç å¤æ‚åº¦

---

## ç›¸å…³æ–‡ä»¶

- `webapp/web-client/src/app.ts` - Webç«¯ä½¿ç”¨é€»è¾‘
- `webapp/web-client/src/websocket_client.ts` - Webç«¯å‘é€é€»è¾‘
- `central_server/scheduler/src/websocket/session_actor/actor.rs` - è°ƒåº¦æœåŠ¡å™¨Actorå¤„ç†
- `central_server/scheduler/src/websocket/session_message_handler/utterance.rs` - Utteranceå¤„ç†
- `central_server/scheduler/src/managers/audio_buffer.rs` - éŸ³é¢‘ç¼“å†²åŒºç®¡ç†

