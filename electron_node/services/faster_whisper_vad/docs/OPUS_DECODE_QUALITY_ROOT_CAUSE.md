# Opus 解码质量差的根本原因分析

**日期**: 2025-12-25  
**状态**: 🔍 **已定位可能原因**

---

## 问题确认

用户反馈：Opus 解码出来的音频质量很差，导致 ASR 无法识别。

**现象**:
- Opus 解码成功（3840 samples，0.24 秒）
- 但音频质量很差：
  - std（标准差）: 0.0121-0.0898（正常应该在 0.1-0.3）
  - RMS（能量）: 非常低
  - 动态范围: 很小

---

## 根本原因分析

### 1. 编码端比特率未设置 ⚠️ **最可能的原因**

**问题**:
```typescript
// webapp/web-client/src/websocket_client.ts:240
bitrate: undefined, // 使用 Opus 默认比特率
```

**影响**:
- Opus 默认比特率通常是 **64 kbps**（对于语音来说可能太高）
- 对于 VOIP 语音，推荐使用 **16-32 kbps**
- 比特率过高可能导致：
  - 编码器使用更激进的压缩算法
  - 音频质量下降
  - 特别是对于短音频（0.24 秒）

**修复建议**:
```typescript
bitrate: 16000, // 16 kbps for VOIP (推荐)
// 或
bitrate: 32000, // 32 kbps for VOIP (更高质量)
```

### 2. 编码器状态问题 ⚠️

**问题**:
- 编码器每次请求可能重新初始化
- 状态可能在请求之间丢失

**检查**:
- 编码器是否在每次请求时重新创建？
- 状态是否在请求之间保持？

### 3. 数据丢失或损坏 ⚠️

**可能原因**:
- Plan A 格式解析错误
- Packet 丢失
- 数据在传输过程中损坏

**检查**:
- 日志中是否有 `decode_fails`？
- Packet 数量是否匹配？
- 数据完整性如何？

### 4. 音频输入质量问题 ⚠️

**问题**:
- Web 端录音质量可能本身就有问题
- 麦克风输入可能不正常
- 可能有噪声或失真

**检查**:
- Web 端录音质量如何？
- 是否有噪声或失真？
- 原始音频质量如何？

---

## 参数匹配检查

### 编码端（Web）✅

- ✅ **采样率**: 16000 Hz
- ✅ **声道数**: 1（单声道）
- ✅ **Application**: VOIP
- ❌ **比特率**: undefined（使用默认值，可能不合适）
- ✅ **帧大小**: 20ms

### 解码端（节点）✅

- ✅ **采样率**: 16000 Hz
- ✅ **声道数**: 1（单声道）
- ✅ **解码器初始化**: 正常

**结论**: 参数基本匹配，但**比特率未设置**可能是问题所在。

---

## 修复方案

### 1. 设置合适的比特率（高优先级）✅

**修改文件**: `webapp/web-client/src/websocket_client.ts`

**修改内容**:
```typescript
const codecConfig: AudioCodecConfig = {
  codec: 'opus',
  sampleRate: ack.negotiated_sample_rate || 16000,
  channelCount: ack.negotiated_channel_count || 1,
  frameSizeMs: 20,
  application: 'voip',
  bitrate: 16000, // ✅ 设置 16 kbps for VOIP（推荐）
  // 或
  // bitrate: 32000, // ✅ 32 kbps for VOIP（更高质量）
};
```

**注意**: 需要检查 `OpusEncoder` 是否支持 `setBitrate()` 方法。

### 2. 检查编码器实现

**检查**: `webapp/web-client/src/audio_codec.ts`

**确认**:
- `OpusEncoder` 是否支持设置比特率？
- 如果支持，是否在初始化时设置了？

### 3. 增强日志记录

**在解码端记录更多信息**:
- 编码端参数（如果可用）
- Packet 数量和质量
- 解码失败的 packet
- 音频质量指标

---

## Opus 比特率推荐

### 语音（VOIP）

- **最低**: 6 kbps（质量较差）
- **推荐**: 16-32 kbps（平衡质量和带宽）
- **高质量**: 32-64 kbps（更高质量，但带宽更高）

### 当前问题

- **默认值**: 64 kbps（可能对短音频不友好）
- **建议**: 16-32 kbps（更适合 VOIP 语音）

---

## 下一步

### 立即行动

1. ✅ **检查 OpusEncoder 是否支持 setBitrate()**
   - 查看 `webapp/web-client/src/audio_codec.ts`
   - 确认是否可以在初始化后设置比特率

2. ✅ **设置合适的比特率**
   - 如果支持，设置为 16-32 kbps
   - 测试效果

3. ✅ **增强日志记录**
   - 记录编码端参数
   - 记录解码端参数
   - 记录音频质量指标

### 后续优化

1. **验证修复效果**
   - 测试音频质量是否改善
   - 测试 ASR 识别率是否提高

2. **优化其他参数**
   - 如果问题仍然存在，检查其他参数
   - 考虑调整帧大小或其他参数

---

**分析完成时间**: 2025-12-25  
**状态**: ✅ **已定位可能原因：编码端比特率未设置**

**建议**: 首先检查并设置合适的比特率（16-32 kbps for VOIP）

