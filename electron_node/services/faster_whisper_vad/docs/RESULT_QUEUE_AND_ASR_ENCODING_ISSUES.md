# ç»“æœé˜Ÿåˆ—å’ŒASRç¼–ç é—®é¢˜è¯Šæ–­

**æ—¥æœŸ**: 2025-12-25  
**çŠ¶æ€**: ğŸ” **é—®é¢˜å·²å®šä½ï¼Œéƒ¨åˆ†å·²ä¿®å¤**

---

## é—®é¢˜æ€»ç»“

### 1. ç»“æœé˜Ÿåˆ— expected_index ä¸åŒ¹é… âŒï¼ˆå·²ä¿®å¤ï¼‰

**ç°è±¡**ï¼š
- `expected_index` ä» 0 å¼€å§‹åˆå§‹åŒ–
- ä½†å®é™…æ”¶åˆ°çš„ç»“æœä» 1 å¼€å§‹ï¼ˆ`utterance_index=1, 2, 3...`ï¼‰
- å¯¼è‡´ `expected_index` ä¸€ç›´å°äºé˜Ÿåˆ—ä¸­çš„æœ€å° index
- 5ç§’åè¶…æ—¶ï¼Œç”Ÿæˆ `MissingResult(0)`
- `expected_index` å˜æˆ 1ï¼Œä½†å¦‚æœç»“æœè¿˜æ²¡åˆ°ï¼Œåˆä¼šè¶…æ—¶ç”Ÿæˆ `MissingResult(1)`
- è¿™æ ·å¾ªç¯ï¼Œ`expected_index` ä¸æ–­å¢é•¿ï¼Œä½†é˜Ÿåˆ—ä¸­çš„ç»“æœæ°¸è¿œè·Ÿä¸ä¸Š

**æ—¥å¿—è¯æ®**ï¼š
```
expected_index=12, queue_size=11, queue_indices=[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]
Gap timeout, creating Missing result, utterance_index=12
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- åœ¨ `get_ready_results()` å¼€å§‹æ—¶ï¼Œæ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º
- å¦‚æœé˜Ÿåˆ—ä¸ä¸ºç©ºä¸” `expected` å°äºé˜Ÿåˆ—ä¸­çš„æœ€å° indexï¼Œå°† `expected` è°ƒæ•´ä¸ºé˜Ÿåˆ—ä¸­çš„æœ€å° index
- è¿™æ ·å¯ä»¥ç¡®ä¿ `expected` å§‹ç»ˆä¸é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªç»“æœå¯¹é½

**ä¿®å¤ä»£ç **ï¼š
```rust
// å¦‚æœé˜Ÿåˆ—ä¸ä¸ºç©ºä¸” expected å°äºé˜Ÿåˆ—ä¸­çš„æœ€å° indexï¼Œè°ƒæ•´ expected
if !state.pending.is_empty() {
    if let Some(&min_index) = state.pending.keys().next() {
        if state.expected < min_index {
            warn!(
                session_id = %session_id,
                old_expected = state.expected,
                new_expected = min_index,
                "Adjusting expected_index to match first pending result"
            );
            state.expected = min_index;
            state.gap_wait_start_ms = now_ms;
        }
    }
}
```

---

### 2. ASR è¯†åˆ«ç»“æœä¹±ç  âš ï¸ï¼ˆå¾…ç¡®è®¤ï¼‰

**ç°è±¡**ï¼š
- ASR è¯†åˆ«ç»“æœåœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºä¸ºä¹±ç å­—ç¬¦
- ä¾‹å¦‚ï¼š`transcript_preview='æ©æ¬é‡œæ¶“ãˆ ç´”ç”¯æ­Œç˜‘é‘ºå‚œæ´°ç€›æ¨ºæ¹ªé¨å‹ªæ¢é”ï¼„åŠ§éšåº¢å¦¸æ©æ„¯æƒ€é¯ã„¥æ´–æ¾¶?'`
- è°ƒåº¦æœåŠ¡å™¨æ—¥å¿—ä¹Ÿæ˜¾ç¤ºä¹±ç ï¼š`"æ©æ¬é‡œæ¶“ãˆ ç´”ç”¯æ­Œç˜‘é‘ºå‚œæ´°ç€›æ¨ºæ¹ªé¨å‹ªæ¢é”ï¼„åŠ§éšåº¢å¦¸æ©æ„¯æƒ€é¯ã„¥æ´–æ¾¶?"`

**å¯èƒ½çš„åŸå› **ï¼š

1. **æ—¥å¿—ç¼–ç é—®é¢˜**ï¼ˆæœ€å¯èƒ½ï¼‰
   - Windows ç³»ç»Ÿé»˜è®¤ä½¿ç”¨ GBK ç¼–ç 
   - æ—¥å¿—æ–‡ä»¶å¯èƒ½ä»¥ GBK ç¼–ç ä¿å­˜
   - ä½† Python/Rust ä»£ç ä½¿ç”¨ UTF-8 ç¼–ç 
   - å¯¼è‡´ä¸­æ–‡å­—ç¬¦åœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºä¸ºä¹±ç 
   - **å®é™…æ–‡æœ¬å¯èƒ½æ˜¯æ­£ç¡®çš„**ï¼Œåªæ˜¯æ—¥å¿—æ˜¾ç¤ºé—®é¢˜

2. **Faster Whisper è¯†åˆ«é”™è¯¯**
   - éŸ³é¢‘è´¨é‡ä¸è¶³
   - æ¨¡å‹é…ç½®é—®é¢˜
   - å®é™…è¯†åˆ«ç»“æœå°±æ˜¯é”™è¯¯çš„

3. **æ–‡æœ¬ä¼ é€’è¿‡ç¨‹ä¸­çš„ç¼–ç æŸå**
   - åœ¨è¿›ç¨‹é—´ä¼ é€’ï¼ˆpickleï¼‰æ—¶ç¼–ç æŸå
   - åœ¨ WebSocket ä¼ è¾“æ—¶ç¼–ç æŸå

**éœ€è¦æ£€æŸ¥**ï¼š
1. **éªŒè¯å®é™…æ–‡æœ¬æ˜¯å¦æ­£ç¡®**ï¼š
   - æ£€æŸ¥ Web ç«¯æ”¶åˆ°çš„æ–‡æœ¬æ˜¯å¦ä¹Ÿæ˜¯ä¹±ç 
   - å¦‚æœ Web ç«¯æ˜¾ç¤ºæ­£å¸¸ï¼Œè¯´æ˜åªæ˜¯æ—¥å¿—ç¼–ç é—®é¢˜
   - å¦‚æœ Web ç«¯ä¹Ÿæ˜¯ä¹±ç ï¼Œè¯´æ˜æ˜¯è¯†åˆ«æˆ–ä¼ è¾“é—®é¢˜

2. **æ£€æŸ¥æ—¥å¿—ç¼–ç è®¾ç½®**ï¼š
   - Python æ—¥å¿—ï¼šæ£€æŸ¥ `logging` é…ç½®ï¼Œç¡®ä¿ä½¿ç”¨ UTF-8 ç¼–ç 
   - Rust æ—¥å¿—ï¼šæ£€æŸ¥ `tracing` é…ç½®ï¼Œç¡®ä¿ä½¿ç”¨ UTF-8 ç¼–ç 
   - æ—¥å¿—æ–‡ä»¶ï¼šç¡®ä¿ä»¥ UTF-8 ç¼–ç ä¿å­˜

3. **æ£€æŸ¥ Faster Whisper è¾“å‡º**ï¼š
   - åœ¨ ASR worker ä¸­ç›´æ¥æ‰“å°è¯†åˆ«ç»“æœï¼ˆä¸ä½¿ç”¨æ—¥å¿—ï¼‰
   - éªŒè¯è¯†åˆ«ç»“æœæ˜¯å¦æ­£ç¡®

**å»ºè®®çš„æ£€æŸ¥æ­¥éª¤**ï¼š
```python
# åœ¨ faster_whisper_vad_service.py ä¸­æ·»åŠ 
logger.info(f"[{trace_id}] ASR raw text (repr): {repr(full_text)}")
logger.info(f"[{trace_id}] ASR raw text (bytes): {full_text.encode('utf-8')}")
```

---

## ä¿®å¤çŠ¶æ€

### âœ… å·²ä¿®å¤
1. **ç»“æœé˜Ÿåˆ— expected_index ä¸åŒ¹é…** - å·²æ·»åŠ è‡ªåŠ¨è°ƒæ•´é€»è¾‘

### âš ï¸ å¾…ç¡®è®¤
1. **ASR è¯†åˆ«ç»“æœä¹±ç ** - éœ€è¦éªŒè¯æ˜¯æ—¥å¿—ç¼–ç é—®é¢˜è¿˜æ˜¯å®é™…è¯†åˆ«é—®é¢˜

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³**ï¼šé‡æ–°ç¼–è¯‘è°ƒåº¦æœåŠ¡å™¨ï¼Œæµ‹è¯• `expected_index` ä¿®å¤
2. **ç«‹å³**ï¼šæ£€æŸ¥ Web ç«¯æ”¶åˆ°çš„æ–‡æœ¬æ˜¯å¦æ­£å¸¸
3. **çŸ­æœŸ**ï¼šä¿®å¤æ—¥å¿—ç¼–ç é—®é¢˜ï¼ˆå¦‚æœç¡®è®¤æ˜¯ç¼–ç é—®é¢˜ï¼‰
4. **çŸ­æœŸ**ï¼šå¦‚æœå®é™…è¯†åˆ«å°±æ˜¯é”™è¯¯çš„ï¼Œéœ€è¦æ£€æŸ¥ Faster Whisper é…ç½®å’ŒéŸ³é¢‘è´¨é‡

---

## ç›¸å…³æ–‡æ¡£

- `RESULT_QUEUE_GAP_TOLERANCE_AND_ASR_UX_FIX_IMPLEMENTATION_GUIDE.md` - å®ç°æŒ‡å—
- `RESULT_QUEUE_FIX_IMPLEMENTATION_SUMMARY.md` - ä¿®å¤æ€»ç»“
- `ASR_ACCURACY_AND_QUEUE_ISSUES.md` - ASR å‡†ç¡®åº¦é—®é¢˜

