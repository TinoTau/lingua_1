# faster_whisper_vad 服务崩溃分析报告

**日期**: 2025-12-24  
**问题**: 服务在处理多个请求时出现连接问题

---

## 1. 问题分析

### 1.1 日志分析结果

通过分析服务日志 `logs/faster-whisper-vad-service.log`，发现以下关键信息：

#### ✅ 服务实际上没有崩溃

从日志看，服务实际上在正常处理请求：
- 所有请求都返回 `200 OK`
- 服务正常启动和运行
- 没有发现致命错误或异常退出

#### ⚠️ 发现的问题

1. **VAD状态输入名称错误**
   - **错误信息**: `Required inputs (['state']) are missing from input feed (['input', 'h', 'sr'])`
   - **原因**: 代码中使用 `'h'` 作为状态输入名称，但模型期望的是 `'state'`
   - **影响**: VAD检测失败，回退到完整音频进行ASR（不影响核心功能）

2. **测试脚本连接问题**
   - 测试脚本显示连接被拒绝，但日志显示服务正常运行
   - 可能原因：
     - 测试脚本运行太快，服务还没准备好
     - 测试脚本中的某些测试导致超时
     - 服务被节点端管理，在某些情况下被重启

---

## 2. 根本原因

### 2.1 VAD输入名称不匹配

**问题代码** (`vad.py` 第88行):
```python
inputs = {
    'input': input_array,
    'h': state_array,  # ❌ 错误：应该是 'state'
    'sr': sr_array
}
```

**ONNX模型实际输入名称**:
- `'input'` ✅
- `'state'` ❌ (代码中使用的是 `'h'`)
- `'sr'` ✅

**验证命令**:
```python
import onnxruntime as ort
session = ort.InferenceSession('models/vad/silero/silero_vad_official.onnx')
print([inp.name for inp in session.get_inputs()])
# 输出: ['input', 'state', 'sr']
```

---

## 3. 修复方案

### 3.1 修复VAD输入名称

**修复位置**: `vad.py` 第88行

**修复前**:
```python
inputs = {
    'input': input_array,
    'h': state_array,  # ❌ 错误
    'sr': sr_array
}
```

**修复后**:
```python
inputs = {
    'input': input_array,
    'state': state_array,  # ✅ 正确
    'sr': sr_array
}
```

### 3.2 验证修复

修复后，VAD应该能够正常工作，不再出现状态输入缺失的错误。

---

## 4. 服务稳定性分析

### 4.1 服务实际上很稳定

从日志分析：
- ✅ 服务正常启动
- ✅ 所有请求都成功处理（返回200 OK）
- ✅ 没有发现崩溃或异常退出
- ✅ 方案A Opus解码工作正常

### 4.2 测试脚本问题

测试脚本显示的问题可能是：
1. **测试脚本超时设置过短**: 某些测试的timeout=5秒可能不够
2. **测试脚本运行太快**: 连续发送多个请求，服务可能还在处理前一个请求
3. **节点端管理**: 服务可能被节点端管理，在某些情况下被重启

---

## 5. 已修复的问题

### ✅ VAD输入名称错误

- **问题**: 使用 `'h'` 而不是 `'state'`
- **修复**: 已修复为 `'state'`
- **影响**: VAD检测现在应该能正常工作

---

## 6. 建议

### 6.1 立即处理

1. ✅ **修复VAD输入名称** - 已完成
2. ⚠️ **增加测试超时时间** - 建议将某些测试的timeout从5秒增加到10-15秒
3. ⚠️ **添加请求间隔** - 测试脚本中在请求之间添加短暂延迟

### 6.2 后续改进

1. **添加健康检查重试机制**
2. **改进错误日志** - 更清晰地记录VAD错误
3. **添加性能监控** - 监控请求处理时间

---

## 7. 总结

### 7.1 主要发现

1. ✅ **服务实际上很稳定** - 没有真正崩溃
2. ⚠️ **VAD输入名称错误** - 已修复
3. ⚠️ **测试脚本问题** - 可能是超时或并发问题

### 7.2 修复状态

- ✅ VAD输入名称错误 - **已修复**
- ⚠️ 测试脚本超时 - **需要调整测试脚本**

### 7.3 验证

修复后，建议：
1. 重启服务
2. 重新运行测试
3. 验证VAD错误不再出现

---

**报告生成时间**: 2025-12-24  
**状态**: VAD输入名称错误已修复，等待验证

