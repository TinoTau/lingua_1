# -*- coding: utf-8 -*-
"""
Semantic Repair Service - Chinese - Prompt Templates
中文语义修复服务 - Prompt模板
P1-2: 增强的Prompt模板，防止误修复
"""

from typing import Optional


class PromptTemplate:
    """Prompt模板管理器"""
    
    @staticmethod
    def build_repair_prompt(
        text_in: str,
        micro_context: Optional[str] = None,
        quality_score: Optional[float] = None
    ) -> str:
        """
        构建修复Prompt
        
        Args:
            text_in: 输入文本
            micro_context: 微上下文（上一句尾部，可选）
            quality_score: 质量分数（可选）
        
        Returns:
            Prompt字符串
        """
        # 基础Prompt（提高敏感度，更积极地修复错误，强调语义分析）
        prompt = """你是语音识别后处理器。输入是一句ASR文本，可能有同音字、近音词、错别字。

核心任务：通过语义分析识别并修复同音字错误。

修复原则：
1) 语义优先：仔细分析每个词语在上下文中的语义合理性。如果词语在上下文中语义不通顺、不符合逻辑、不符合常见表达习惯，很可能是同音字错误，必须修复。
2) 积极修复：不要因为词语"看起来像中文"就认为它是正确的。ASR经常产生同音字错误，通过语义分析判断词语是否合理。即使一个词语本身是有效的中文词汇，如果它在上下文中语义不通，也可能是同音字错误。
3) 上下文理解：结合整个句子的语义来判断每个词语是否正确。如果一个词语在句子中语义不通，即使它本身是有效的中文词汇，也可能是同音字错误。
4) 最小改动：尽量少改动原文，但必须修复明显不合理或不符合语义的词。优先修复语义不通顺的词语。
5) 保持原意：不要扩写，不要添加新信息，不要改变语气，不改变原意。
6) 禁止新增：禁止新增实体、数字、专有名词（未在原文中出现的不得引入）。

输出要求：
- 输出只包含修正后的文本，不要解释，不要添加任何其他内容
- 如果发现同音字错误或语义不合理，必须修复
- 如果原文完全合理且语义通顺，才原样输出

原文：{text_in}"""
        
        # 添加微上下文（如果提供）- 增强上下文利用
        if micro_context:
            prompt += f"\n\n上下文信息（上一句片段）：{micro_context}\n请结合上下文理解当前句子的语义，上下文可以帮助你更准确地识别同音字错误。如果当前句子中的词语与上下文语义不连贯，很可能是同音字错误。"
        
        # 添加质量分数提示（降低阈值，提高敏感度：从0.7降到0.85）
        if quality_score is not None and quality_score < 0.85:
            prompt += f"\n⚠️ 注意：此文本质量分数较低（{quality_score:.2f}），很可能存在识别错误，请仔细检查并修复同音字错误。"
        
        prompt = prompt.format(text_in=text_in)
        
        return prompt
    
    @staticmethod
    def build_system_message() -> str:
        """构建系统消息"""
        return """你是一个专业的语音识别后处理器，专门修复ASR（自动语音识别）输出的中文文本中的同音字错误、错别字等问题。

核心能力：
- 语义分析：通过深入理解文本的语义来识别同音字错误，而不是依赖词汇表或规则
- 上下文理解：结合上下文信息判断词语的合理性
- 积极修复：当发现语义不合理、不符合逻辑、不符合常见表达习惯的词语时，积极识别并修复同音字错误

修复原则：
- 通过语义分析发现同音字错误或语义不合理时，必须修复
- 保持原文的语义和语气不变，不添加新信息，不扩写，不改变原意
- 只有原文完全合理且语义通顺时才保持原样

重要提示：ASR系统经常产生同音字错误，即使词语本身是有效的中文词汇，如果它在上下文中语义不通顺，也很可能是同音字错误，需要修复。"""
