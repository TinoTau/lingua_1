# 任务链日志说明

## 概述

已为三个新服务添加了任务链日志记录功能，用于跟踪任务在服务链中的流转情况。

## 已添加日志的服务

### 1. 中文语义修复服务 (semantic_repair_zh)
- **端口**: 5013
- **服务ID**: `semantic-repair-zh`
- **日志前缀**: `SEMANTIC_REPAIR_ZH`

### 2. 英文语义修复服务 (semantic_repair_en)
- **端口**: 5011
- **服务ID**: `semantic-repair-en`
- **日志前缀**: `SEMANTIC_REPAIR_EN`

### 3. 英文标准化服务 (en_normalize)
- **端口**: 5012
- **服务ID**: `en-normalize`
- **日志前缀**: `EN_NORMALIZE`

## 日志格式

### INPUT 日志（收到请求时）

记录服务收到的请求内容：

```
[SERVICE_NAME] INPUT: Received [operation] request | job_id=xxx | session_id=xxx | utterance_index=xxx | lang=xxx | text_in=xxx | text_in_length=xxx | quality_score=xxx | micro_context=xxx
```

**示例**：
```
[2025-01-02 10:30:15] [INFO] [Semantic Repair ZH] SEMANTIC_REPAIR_ZH INPUT: Received repair request | job_id=job_123 | session_id=session_456 | utterance_index=0 | lang=zh | text_in='你好，这是一个测试。' | text_in_length=10 | quality_score=0.85 | micro_context=None
```

### OUTPUT 日志（完成处理后）

记录服务输出的结果内容：

```
[SERVICE_NAME] OUTPUT: [Operation] completed | job_id=xxx | session_id=xxx | utterance_index=xxx | decision=xxx | text_out=xxx | text_out_length=xxx | confidence=xxx | reason_codes=xxx | [time_field]=xxx | changed=xxx
```

**示例**：
```
[2025-01-02 10:30:15] [INFO] [Semantic Repair ZH] SEMANTIC_REPAIR_ZH OUTPUT: Repair completed | job_id=job_123 | session_id=session_456 | utterance_index=0 | decision=PASS | text_out='你好，这是一个测试。' | text_out_length=10 | confidence=0.85 | reason_codes=[] | repair_time_ms=349 | changed=False
```

## 日志字段说明

### 通用字段
- `job_id`: 任务ID
- `session_id`: 会话ID
- `utterance_index`: 话语索引
- `lang`: 语言代码（zh/en）

### 输入字段
- `text_in`: 输入文本（使用 repr 格式，包含引号）
- `text_in_length`: 输入文本长度
- `quality_score`: 质量分数（可选）
- `micro_context`: 微上下文（可选）

### 输出字段
- `decision`: 决策（PASS/REPAIR/REJECT）
- `text_out`: 输出文本（使用 repr 格式）
- `text_out_length`: 输出文本长度
- `confidence`: 置信度（0.0-1.0）
- `reason_codes`: 原因代码列表
- `[time_field]`: 耗时字段（repair_time_ms 或 normalize_time_ms）
- `changed`: 是否发生修改（布尔值）

## 日志用途

1. **任务追踪**: 通过 job_id 和 session_id 追踪任务在服务链中的流转
2. **性能监控**: 记录每个服务的处理时间
3. **问题诊断**: 记录输入输出，便于排查问题
4. **数据分析**: 统计修复率、决策分布等

## 日志级别

- **INFO**: 正常的输入输出日志
- **ERROR**: 错误日志（已有，未修改）

## 注意事项

1. 日志使用 Python 标准 logging 模块
2. 日志格式统一，便于解析和分析
3. 文本内容使用 `repr()` 格式，确保特殊字符正确显示
4. 所有日志都会输出到控制台（stdout），可通过重定向保存到文件

## 示例日志输出

### 中文语义修复服务
```
[2025-01-02 10:30:15] [INFO] [Semantic Repair ZH] SEMANTIC_REPAIR_ZH INPUT: Received repair request | job_id=job_123 | session_id=session_456 | utterance_index=0 | lang=zh | text_in='你好，这是一个测试。' | text_in_length=10 | quality_score=0.85 | micro_context=None
[2025-01-02 10:30:15] [INFO] [Semantic Repair ZH] SEMANTIC_REPAIR_ZH OUTPUT: Repair completed | job_id=job_123 | session_id=session_456 | utterance_index=0 | decision=PASS | text_out='你好，这是一个测试。' | text_out_length=10 | confidence=0.85 | reason_codes=[] | repair_time_ms=349 | changed=False
```

### 英文语义修复服务
```
[2025-01-02 10:30:20] [INFO] [Semantic Repair EN] SEMANTIC_REPAIR_EN INPUT: Received repair request | job_id=job_124 | session_id=session_456 | utterance_index=1 | lang=en | text_in='I want to buy a api' | text_in_length=19 | quality_score=0.75 | micro_context=None
[2025-01-02 10:30:20] [INFO] [Semantic Repair EN] SEMANTIC_REPAIR_EN OUTPUT: Repair completed | job_id=job_124 | session_id=session_456 | utterance_index=1 | decision=REPAIR | text_out='I want to buy a API' | text_out_length=20 | confidence=0.85 | reason_codes=['REPAIR_APPLIED'] | repair_time_ms=136 | changed=True
```

### 英文标准化服务
```
[2025-01-02 10:30:25] [INFO] [EN Normalize] EN_NORMALIZE INPUT: Received normalize request | job_id=job_125 | session_id=session_456 | utterance_index=2 | lang=en | text_in='The price is $100 USD' | text_in_length=21 | quality_score=0.9
[2025-01-02 10:30:25] [INFO] [EN Normalize] EN_NORMALIZE OUTPUT: Normalize completed | job_id=job_125 | session_id=session_456 | utterance_index=2 | decision=PASS | text_out='The price is $100 USD' | text_out_length=21 | confidence=1.0 | reason_codes=[] | normalize_time_ms=5 | changed=False
```

## 修改的文件

1. `electron_node/services/semantic_repair_zh/semantic_repair_zh_service.py`
2. `electron_node/services/semantic_repair_en/semantic_repair_en_service.py`
3. `electron_node/services/en_normalize/en_normalize_service.py`

## 使用建议

1. **查看实时日志**: 服务启动后，日志会直接输出到控制台
2. **保存日志**: 可以通过重定向保存日志到文件
   ```powershell
   python semantic_repair_zh_service.py 2>&1 | Tee-Object -FilePath "service.log"
   ```
3. **过滤日志**: 使用 grep 或 findstr 过滤特定任务的日志
   ```powershell
   # 查找特定 job_id 的日志
   findstr "job_123" service.log
   ```
