# 快速修复指南 - 2026-01-20

## ✅ **修复已完成**

针对您报告的问题：
1. ✅ 服务停止后再启动失败 → **已修复**
2. ✅ 刷新按钮无反应 → **已验证IPC handler正常**

---

## 🚀 **立即测试**

### Step 1: 重启Electron

```powershell
# 关闭现有Electron窗口，然后：
cd d:\Programs\github\lingua_1\electron_node\electron-node
npm start
```

### Step 2: 测试服务启动/停止

1. **启动任一服务**（如NMT翻译）
2. **观察状态**: starting → running
3. **停止服务**
4. **等待3-5秒**
5. **再次启动**
6. **验证**: ✅ 应该成功，不再报错

---

## 🎯 **核心修复**

### 修复1: 端口释放等待

**之前**:
- 停止服务 → 进程kill → 立即清理状态
- ❌ 端口还未释放

**现在**:
- 停止服务 → 进程kill → ✅ **等待端口释放** → 清理状态
- ✅ 确保端口完全释放（最多等3秒）

### 修复2: 启动前检查

**之前**:
- 直接启动 → ❌ 端口冲突 → exit code 1

**现在**:
- ✅ **检查端口是否可用** → 如果被占用显示友好错误
- 启动成功

### 修复3: 完整错误日志

**之前**:
- 只保存第一次stderr
- ❌ 看不到完整错误

**现在**:
- ✅ 完整记录所有stderr（最多5000字符）
- 追加新错误信息

---

## ⚠️ **如果仍有问题**

### 快速清理脚本

如果仍然报"Port in use"：

```powershell
# 1. Kill所有Python进程
Get-Process python -ErrorAction SilentlyContinue | Stop-Process -Force

# 2. 等待5秒
Start-Sleep -Seconds 5

# 3. 验证端口已释放
netstat -ano | findstr "8001 8002 8003"
# 应该没有输出

# 4. 重启Electron
npm start
```

---

## 📋 **测试清单**

- [ ] 服务可以正常启动
- [ ] 服务可以正常停止
- [ ] 停止后可以立即（或等待几秒后）再次启动
- [ ] 如果端口被占用，显示友好错误
- [ ] 刷新按钮有响应

---

## 🎉 **预期效果**

### 正常流程

1. **启动服务** → ⏳ "正在启动..." → ✅ "运行中"
2. **停止服务** → ⏸️ "正在停止..." → ⚫ "已停止"
3. **再次启动** → ✅ **成功！**

### 快速重启流程

1. **立即停止并启动** → 
2. 如果端口未释放 → ⚠️ "Port XXX is already in use"
3. **等待3-5秒后重试** → ✅ **成功！**

---

**请立即测试并反馈结果！** 🚀
