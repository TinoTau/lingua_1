# ğŸ”§ åº”ç”¨é—ªé€€ä¿®å¤ - 2026-01-20

## é—®é¢˜åˆ†æ

### å´©æºƒåŸå› 
```
Error: Failed to spawn process for faster-whisper-vad: no PID
```

**ä½ç½®**: `ServiceProcessRunner.ts` ç¬¬67è¡Œ

### é”™è¯¯ä»£ç 
```typescript
const proc = spawn(executable, args || [], { ... });

if (!proc.pid) {  // âŒ ç«‹å³æ£€æŸ¥PID
  throw new Error(`Failed to spawn process for ${serviceId}: no PID`);
}
```

### é—®é¢˜æ ¹æº
1. **spawnæ˜¯å¼‚æ­¥çš„**ï¼šè¿›ç¨‹å¯èƒ½è¿˜æ²¡å¯åŠ¨å°±æ£€æŸ¥PID
2. **PIDå¯èƒ½å»¶è¿Ÿèµ‹å€¼**ï¼šNode.jsçš„spawnä¸ä¿è¯ç«‹å³æœ‰PID
3. **é”™è¯¯æœªæ•è·**ï¼šå¼‚å¸¸ç›´æ¥å¯¼è‡´åº”ç”¨å´©æºƒ

---

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: å»¶è¿Ÿæ£€æŸ¥PID

**ä¿®æ”¹å‰**:
```typescript
const proc = spawn(...);

if (!proc.pid) {  // âŒ ç«‹å³æ£€æŸ¥
  throw new Error(`Failed to spawn process: no PID`);
}

this.processes.set(serviceId, proc);
```

**ä¿®æ”¹å**:
```typescript
const proc = spawn(...);

// âœ… ä¸ç«‹å³æ£€æŸ¥PIDï¼Œspawnæ˜¯å¼‚æ­¥çš„
this.processes.set(serviceId, proc);

// 5-8. è®¾ç½®äº‹ä»¶ç›‘å¬å™¨...

// 9. ç­‰å¾…500msåå†æ£€æŸ¥
await new Promise<void>((resolve, reject) => {
  const checkTimeout = setTimeout(() => {
    // âœ… 500msåæ£€æŸ¥PID
    if (!proc.pid) {
      reject(new Error(
        `Service process failed to start (no PID after 500ms). ` +
        `Command: ${executable} ${(args || []).join(' ')} ` +
        `CWD: ${workingDir}`
      ));
      return;
    }
    // è¿›ç¨‹æœ‰PIDä¸”è¿˜åœ¨è¿è¡Œï¼Œè®¤ä¸ºå¯åŠ¨æˆåŠŸ
    resolve();
  }, 500);

  // ç›‘å¬ç«‹å³é€€å‡º
  proc.on('exit', (code) => {
    clearTimeout(checkTimeout);
    reject(new Error(
      `Service process exited immediately with code ${code}. ` +
      `Check logs for details. ` +
      `Command: ${executable} ${(args || []).join(' ')} ` +
      `CWD: ${workingDir}`
    ));
  });

  // ç›‘å¬spawné”™è¯¯
  proc.on('error', (error) => {
    clearTimeout(checkTimeout);
    reject(new Error(
      `Failed to spawn process: ${error.message}. ` +
      `Command: ${executable} ${(args || []).join(' ')} ` +
      `CWD: ${workingDir}`
    ));
  });
});
```

---

## ä¿®å¤åçš„æµç¨‹

### å¯åŠ¨æµç¨‹

```
1. spawn(command, args, { cwd, env })
   â†“
2. è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
   - stdout.on('data')
   - stderr.on('data')
   - on('exit')
   - on('error')
   â†“
3. ç­‰å¾…500ms
   â”œâ”€ å¦‚æœè¿›ç¨‹é€€å‡º â†’ reject("exited immediately")
   â”œâ”€ å¦‚æœspawnå¤±è´¥ â†’ reject("spawn failed")
   â””â”€ å¦‚æœè¿˜åœ¨è¿è¡Œ â†’ æ£€æŸ¥PID
      â”œâ”€ æœ‰PID â†’ resolve() âœ… å¯åŠ¨æˆåŠŸ
      â””â”€ æ— PID â†’ reject("no PID after 500ms")
   â†“
4. æ›´æ–°runtimeçŠ¶æ€
   - status: 'running'
   - pid: proc.pid
   - startedAt: new Date()
```

---

## è¯¦ç»†é”™è¯¯ä¿¡æ¯

### é”™è¯¯ç±»å‹1: ç«‹å³é€€å‡º
```
Service process exited immediately with code 1.
Check logs for details.
Command: python faster_whisper_vad_service.py
CWD: D:/Programs/github/lingua_1/electron_node/services/faster_whisper_vad
```

**å¯èƒ½åŸå› **:
- Pythonè„šæœ¬æœ‰è¯­æ³•é”™è¯¯
- ç¼ºå°‘ä¾èµ–åŒ…
- Pythonç‰ˆæœ¬ä¸åŒ¹é…

### é”™è¯¯ç±»å‹2: Spawnå¤±è´¥
```
Failed to spawn process: spawn python ENOENT.
Command: python faster_whisper_vad_service.py
CWD: D:/Programs/github/lingua_1/electron_node/services/faster_whisper_vad
```

**å¯èƒ½åŸå› **:
- Pythonå‘½ä»¤ä¸åœ¨PATH
- æƒé™ä¸è¶³
- å‘½ä»¤æ‹¼å†™é”™è¯¯

### é”™è¯¯ç±»å‹3: è¶…æ—¶æ— PID
```
Service process failed to start (no PID after 500ms).
Command: python faster_whisper_vad_service.py
CWD: D:/Programs/github/lingua_1/electron_node/services/faster_whisper_vad
```

**å¯èƒ½åŸå› **:
- ç³»ç»Ÿèµ„æºä¸è¶³
- è¿›ç¨‹å¯åŠ¨ææ…¢
- Node.jså†…éƒ¨é”™è¯¯

---

## æµ‹è¯•æ¸…å•

### 1. åº”ç”¨ä¸å†é—ªé€€ âœ…
- [ ] ç‚¹å‡»"å¯åŠ¨"æŒ‰é’®
- [ ] åº”ç”¨ä¿æŒè¿è¡Œï¼ˆä¸é—ªé€€ï¼‰
- [ ] å‰ç«¯æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼ˆè€Œä¸æ˜¯å´©æºƒï¼‰

### 2. é”™è¯¯ä¿¡æ¯è¯¦ç»† âœ…
- [ ] ä¸»è¿›ç¨‹Consoleæ˜¾ç¤ºå®Œæ•´é”™è¯¯
- [ ] åŒ…å«commandã€cwdã€exit code
- [ ] å‰ç«¯èƒ½çœ‹åˆ°é”™è¯¯æç¤º

### 3. æ­£å¸¸å¯åŠ¨æƒ…å†µ âœ…
- [ ] å¦‚æœPythonå¯ç”¨ï¼ŒæœåŠ¡èƒ½æ­£å¸¸å¯åŠ¨
- [ ] æœåŠ¡çŠ¶æ€å˜ä¸º"è¿è¡Œä¸­"
- [ ] æ˜¾ç¤ºPID

---

## å¦‚æœä»ç„¶å¯åŠ¨å¤±è´¥

### æ£€æŸ¥Pythonç¯å¢ƒ

```powershell
# æ£€æŸ¥Pythonæ˜¯å¦åœ¨PATH
python --version

# å¦‚æœæ²¡æœ‰ï¼Œå°è¯•
python3 --version

# æˆ–è€…ä½¿ç”¨å®Œæ•´è·¯å¾„
D:\Programs\Anaconda\python.exe --version
```

### ä¿®æ”¹service.jsonæŒ‡å®šPythonè·¯å¾„

å¦‚æœç³»ç»ŸPythonä¸åœ¨PATHï¼Œå¯ä»¥ä¿®æ”¹`service.json`:

```json
{
  "id": "faster-whisper-vad",
  "exec": {
    "command": "D:/Programs/Anaconda/python.exe",  // âœ… ä½¿ç”¨ç»å¯¹è·¯å¾„
    "args": ["faster_whisper_vad_service.py"],
    "cwd": "."
  }
}
```

### æµ‹è¯•æ‰‹åŠ¨å¯åŠ¨

```powershell
# è¿›å…¥æœåŠ¡ç›®å½•
cd D:\Programs\github\lingua_1\electron_node\services\faster_whisper_vad

# æ‰‹åŠ¨è¿è¡ŒæœåŠ¡
python faster_whisper_vad_service.py

# æŸ¥çœ‹é”™è¯¯ä¿¡æ¯
```

---

## ä»£ç æ”¹åŠ¨æ€»ç»“

**ä¿®æ”¹æ–‡ä»¶**: 1ä¸ª
- `main/src/service-layer/ServiceProcessRunner.ts`

**ä¿®æ”¹è¡Œæ•°**: ~20è¡Œ
- ç§»é™¤ç«‹å³PIDæ£€æŸ¥ï¼ˆ3è¡Œï¼‰
- å¢å¼ºé”™è¯¯å¤„ç†é€»è¾‘ï¼ˆ~20è¡Œï¼‰

**å…³é”®æ”¹è¿›**:
- âœ… ä¸å†ç«‹å³æ£€æŸ¥PID
- âœ… ç­‰å¾…500msåå†éªŒè¯
- âœ… è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼ˆåŒ…å«commandã€cwdï¼‰
- âœ… æ•è·æ‰€æœ‰spawné”™è¯¯

---

## é¢„æœŸç»“æœ

### æˆåŠŸå¯åŠ¨
```
IPC: Starting Python service
  serviceId: "faster-whisper-vad"
  
ğŸš€ Starting service process
  serviceId: "faster-whisper-vad"
  executable: "python"
  args: ["faster_whisper_vad_service.py"]
  cwd: "D:/Programs/github/lingua_1/electron_node/services/faster_whisper_vad"
  
âœ… Service started successfully
  pid: 12345
```

### å¯åŠ¨å¤±è´¥ï¼ˆä¸å†é—ªé€€ï¼‰
```
IPC: Starting Python service
  serviceId: "faster-whisper-vad"
  
ğŸš€ Starting service process
  ...
  
âŒ Service process exited immediately with code 1
  Check logs for details.
  Command: python faster_whisper_vad_service.py
  CWD: D:/...
  
Error: Service process exited immediately...
```

**å…³é”®**: åº”ç”¨ä¸å†é—ªé€€ï¼Œé”™è¯¯æ˜¾ç¤ºåœ¨Console âœ…

---

**ç°åœ¨é‡æ–°æµ‹è¯•å¯åŠ¨æœåŠ¡ï¼** ğŸš€
