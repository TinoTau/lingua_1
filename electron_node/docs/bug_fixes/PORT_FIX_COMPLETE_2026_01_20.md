# ç«¯å£é…ç½®ä¿®å¤å®Œæˆ - 2026-01-20

## âœ… **é—®é¢˜å·²è§£å†³**

### æ ¹æœ¬åŸå› 

1. **service.jsonä¸­ç¼ºå°‘portå®šä¹‰** âŒ
   - å¤§éƒ¨åˆ†æœåŠ¡çš„service.jsonæ²¡æœ‰`port`å­—æ®µ
   - Pythonä»£ç ä¸­ç¡¬ç¼–ç äº†ç«¯å£
   - å¯¼è‡´ç«¯å£æ£€æŸ¥ä»£ç æ— æ³•å·¥ä½œ

2. **ç«¯å£ä¸ä¸€è‡´** âŒ
   - Pythonä»£ç ä½¿ç”¨çš„ç«¯å£ï¼ˆ5008, 6007ç­‰ï¼‰
   - service.jsonä¸­æ²¡æœ‰å®šä¹‰
   - æˆ‘çš„ä¿®å¤ä»£ç æ£€æŸ¥çš„ç«¯å£ä¸å­˜åœ¨

### ä¿®å¤ç»“æœ

âœ… **å·²ä¸ºæ‰€æœ‰æœåŠ¡æ·»åŠ portå®šä¹‰**:

| æœåŠ¡ | service.jsonä¸­çš„Port | çŠ¶æ€ |
|------|---------------------|------|
| nmt-m2m100 | 5008 | âœ… å·²æ·»åŠ  |
| faster-whisper-vad | 6007 | âœ… å·²æ·»åŠ  |
| piper_tts | 5009 | âœ… å·²æ·»åŠ  |
| en_normalize | 5012 | âœ… å·²æœ‰ |
| semantic_repair_zh | 5013 | âœ… å·²æœ‰ |
| speaker_embedding | 5014 | âœ… å·²æ·»åŠ  |
| semantic_repair_en_zh | 5015 | âœ… å·²æœ‰ |
| your_tts | 5016 | âœ… å·²æ·»åŠ  |

---

## ğŸ”§ **ä¿®å¤å†…å®¹**

### ä¿®å¤1: æ·»åŠ portåˆ°service.json

ä½¿ç”¨è„šæœ¬è‡ªåŠ¨æ·»åŠ äº†æ‰€æœ‰ç¼ºå¤±çš„portå®šä¹‰ï¼Œç°åœ¨ï¼š
- âœ… `entry.def.port` æœ‰å€¼
- âœ… ç«¯å£æ£€æŸ¥ä»£ç å¯ä»¥æ­£å¸¸å·¥ä½œ
- âœ… åœæ­¢æ—¶ç­‰å¾…ç«¯å£é‡Šæ”¾
- âœ… å¯åŠ¨å‰æ£€æŸ¥ç«¯å£æ˜¯å¦å¯ç”¨

### ä¿®å¤2: ç«¯å£æ˜ å°„è¡¨

```
Service Ports (all on 127.0.0.1):
- 5008: NMT Translation
- 5009: Piper TTS
- 5012: EN Normalize
- 5013: Semantic Repair ZH
- 5014: Speaker Embedding
- 5015: Semantic Repair EN-ZH (Unified)
- 5016: YourTTS
- 6007: Faster Whisper VAD
```

---

## ğŸš€ **ç«‹å³æµ‹è¯•**

### Step 1: é‡å¯Electron

```powershell
# å…³é—­ç°æœ‰Electronçª—å£
# ç„¶åé‡å¯ï¼š
cd d:\Programs\github\lingua_1\electron_node\electron-node
npm start
```

### Step 2: æµ‹è¯•æœåŠ¡å¯åŠ¨/åœæ­¢

1. **å¯åŠ¨ä»»ä¸€æœåŠ¡**ï¼ˆå¦‚NMTï¼‰
2. **è§‚å¯Ÿ**: 
   - â³ "æ­£åœ¨å¯åŠ¨..."
   - âœ… "è¿è¡Œä¸­"
3. **åœæ­¢æœåŠ¡**
4. **ç­‰å¾…3ç§’**ï¼ˆè§‚å¯Ÿæ—¥å¿—æ˜¾ç¤º"Port released"ï¼‰
5. **å†æ¬¡å¯åŠ¨**
6. **éªŒè¯**: âœ… åº”è¯¥æˆåŠŸï¼Œä¸å†æŠ¥ç«¯å£è¢«å ç”¨

### Step 3: éªŒè¯ç«¯å£æ£€æŸ¥

å¦‚æœå¿«é€Ÿé‡å¯ï¼ˆä¸ç­‰å¾…ï¼‰ï¼š
- **é¢„æœŸ**: çœ‹åˆ°å‹å¥½é”™è¯¯ï¼š`Port XXXX is already in use`
- **ç­‰å¾…å‡ ç§’å**: åº”è¯¥å¯ä»¥æˆåŠŸå¯åŠ¨

---

## ğŸ“Š **ä¿®å¤å‰åå¯¹æ¯”**

### ä¿®å¤å‰ âŒ

```
1. service.json: { "id": "nmt", ... }  // æ²¡æœ‰port
2. Pythonä»£ç : uvicorn.run(app, port=5008)  // ç¡¬ç¼–ç 
3. åœæ­¢ä»£ç : entry.def.port  // undefined
4. ç«¯å£æ£€æŸ¥: è·³è¿‡ï¼ˆæ²¡æœ‰portï¼‰
5. å†æ¬¡å¯åŠ¨: âŒ Port 5008 in use!
```

### ä¿®å¤å âœ…

```
1. service.json: { "id": "nmt", "port": 5008, ... }  // æœ‰port âœ…
2. Pythonä»£ç : uvicorn.run(app, port=5008)  // ä¸€è‡´ âœ…
3. åœæ­¢ä»£ç : entry.def.port = 5008  // æœ‰å€¼ âœ…
4. ç«¯å£æ£€æŸ¥: waitForPortRelease(5008)  // æ‰§è¡Œ âœ…
5. å†æ¬¡å¯åŠ¨: âœ… æˆåŠŸï¼
```

---

## ğŸ” **æ—¥å¿—éªŒè¯**

é‡å¯åï¼Œæ‚¨åº”è¯¥åœ¨æ—¥å¿—ä¸­çœ‹åˆ°ï¼š

### åœæ­¢æœåŠ¡æ—¶

```json
{"msg":"ğŸ›‘ Stopping service", "serviceId":"nmt-m2m100", "pid":12345}
{"msg":"Waiting for port to be released...", "port":5008}
{"msg":"âœ… Port released", "port":5008}
{"msg":"âœ… Service stopped and cleaned up"}
```

### å¯åŠ¨æœåŠ¡æ—¶

```json
{"msg":"ğŸš€ Starting service process", "serviceId":"nmt-m2m100"}
// å¦‚æœç«¯å£è¢«å ç”¨
{"level":50, "msg":"âŒ Port 5008 is already in use"}

// å¦‚æœç«¯å£å¯ç”¨
{"msg":"â³ Service process spawned, starting health check..."}
{"msg":"âœ… Service is now running"}
```

---

## âš¡ **å¦‚æœä»æœ‰é—®é¢˜**

### é—®é¢˜1: ä»ç„¶æŠ¥"Port in use"

**åŸå› **: å¯èƒ½æœ‰æ—§è¿›ç¨‹è¿˜åœ¨è¿è¡Œ

**è§£å†³**:
```powershell
# å¼ºåˆ¶æ¸…ç†
Get-Process python -ErrorAction SilentlyContinue | Stop-Process -Force
Start-Sleep -Seconds 5

# éªŒè¯
netstat -ano | findstr "5008 5009 5012 5013 5014 5015 5016 6007"
# åº”è¯¥æ²¡æœ‰è¾“å‡º

# é‡å¯
npm start
```

### é—®é¢˜2: æœåŠ¡å¯åŠ¨åˆ°ä¸€åŠå°±é€€å‡º

**æ£€æŸ¥**:
- æ‰“å¼€DevTools (F12)
- æŸ¥çœ‹å®Œæ•´é”™è¯¯ä¿¡æ¯ï¼ˆç°åœ¨ä¼šæ˜¾ç¤ºå®Œæ•´çš„stderrï¼‰
- ç¡®è®¤æ˜¯å¦æ˜¯å…¶ä»–é—®é¢˜ï¼ˆæ¨¡å‹åŠ è½½ã€ä¾èµ–ç­‰ï¼‰

---

## ğŸ“š **ç›¸å…³æ–‡æ¡£**

- `CRITICAL_PORT_ISSUE_2026_01_20.md` - é—®é¢˜è¯Šæ–­
- `BUG_FIX_COMPLETE_2026_01_20.md` - ä¹‹å‰çš„ç«¯å£ä¿®å¤
- `PORT_FIX_COMPLETE_2026_01_20.md` - æœ¬æ–‡æ¡£

---

## âœ… **å®Œæˆæ¸…å•**

- [x] è¯Šæ–­é—®é¢˜ï¼šservice.jsonç¼ºå°‘port
- [x] æ‰¾å‡ºæ‰€æœ‰æœåŠ¡çš„å®é™…ç«¯å£
- [x] ä¿®å¤æ‰€æœ‰service.json
- [x] Killæ‰€æœ‰Pythonè¿›ç¨‹
- [ ] ç”¨æˆ·é‡å¯Electronæµ‹è¯•
- [ ] éªŒè¯æœåŠ¡å¯ä»¥æ­£å¸¸å¯åŠ¨/åœæ­¢/é‡å¯

---

**ä¿®å¤æ—¶é—´**: 2026-01-20  
**ä¿®å¤æ–‡ä»¶**: 8ä¸ªservice.json  
**æ ¸å¿ƒä¿®å¤**: æ·»åŠ ç¼ºå¤±çš„portå®šä¹‰  
**çŠ¶æ€**: âœ… **é…ç½®å·²ä¿®å¤ï¼Œç­‰å¾…ç”¨æˆ·æµ‹è¯•**

**ç°åœ¨è¯·é‡å¯Electronæµ‹è¯•ï¼** ğŸš€
