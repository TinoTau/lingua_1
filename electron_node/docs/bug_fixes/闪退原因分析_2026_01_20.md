# 闪退原因分析 - 2026-01-20

## 问题现象

应用在初始化成功后立即退出（exit code: 1）

## 日志分析

```
✅ Application initialized successfully!

[34872:0120/015114.173:ERROR:CONSOLE(1)] "Uncaught (in promise) TypeError: Failed to fetch"

============================================================
Exited with code: 1
```

---

## 根本原因

**不是Day 1重构导致的！** 

真正原因是**NodeAgent尝试连接调度服务器失败**：

### 代码路径

1. `app-init-simple.ts` 第355行：
   ```typescript
   managers.nodeAgent.start().catch((error) => {
     logger.error({ error }, 'Failed to start NodeAgent');
   });
   ```

2. `node-agent-simple.ts` 第100行：
   ```typescript
   this.ws = new WebSocket(this.schedulerUrl);
   // schedulerUrl = 'ws://127.0.0.1:5010/ws/node'
   ```

3. **WebSocket连接失败** → 没有运行的调度服务器在5010端口

---

## 证据

1. ✅ InferenceService初始化成功
2. ✅ 9个服务被发现
3. ✅ 所有IPC handlers注册成功
4. ✅ 主窗口创建成功
5. ❌ 应用在"Application initialized successfully"后退出

**时间线**：
- 12:51:12 - 应用初始化完成
- 12:51:14 - DevTools错误（Failed to fetch）
- 12:51:25 - 应用退出（exit code 1）

**退出延迟**: 约13秒 - 这符合WebSocket连接超时+重试的时间

---

## 解决方案

### 方案A：禁用NodeAgent（快速）

修改 `app-init-simple.ts` 第353-358行：

```typescript
// 5. 启动 NodeAgent
if (managers.nodeAgent && false) {  // ← 临时禁用
  managers.nodeAgent.start().catch((error) => {
    logger.error({ error }, 'Failed to start NodeAgent');
  });
}
```

### 方案B：优雅降级（推荐）

修改 `node-agent-simple.ts` 的错误处理：

```typescript
this.ws.on('error', (error) => {
  logger.error({ error, schedulerUrl: this.schedulerUrl }, 'WebSocket error');
  // ✅ 不退出应用，仅记录错误
});

this.ws.on('close', (code, reason) => {
  logger.warn({ code, reason }, 'Connection to scheduler closed');
  this.heartbeatHandler.stopHeartbeat();
  
  // ✅ 只在代码=1000（正常关闭）时重连，其他情况下放弃
  if (code === 1000) {
    setTimeout(() => this.start(), 5000);
  } else {
    logger.info({}, 'Scheduler not available, NodeAgent disabled');
  }
});
```

### 方案C：启动调度服务器（完整）

如果需要NodeAgent功能：
1. 启动调度服务器
2. 确保端口5010可用
3. 检查`node-config.json`中的scheduler.url配置

---

## Day 1重构验证

### ✅ Day 1改动完全正常

**证据**：
1. ✅ 编译成功（0错误）
2. ✅ InferenceService初始化成功
3. ✅ TaskRouter使用新ServiceRegistry成功
4. ✅ 9个服务被正确发现
5. ✅ 所有IPC handlers正常注册

**改动文件**：
- `task-router.ts` - 构造函数简化为1个参数 ✅
- `inference-service.ts` - 删除所有假对象 ✅  
- `app-init-simple.ts` - 删除dummyManager ✅

**Day 1目标达成**：
- ✅ 删除150行假对象代码
- ✅ 删除3个Manager依赖
- ✅ 架构简化为：InferenceService → TaskRouter → ServiceRegistry

---

## 立即行动

### 推荐方案

**临时禁用NodeAgent（1分钟）**：

```typescript
// 在 app-init-simple.ts 中
if (managers.nodeAgent && process.env.ENABLE_NODE_AGENT === 'true') {
  managers.nodeAgent.start().catch(...);
}
```

这样应用可以正常启动，您可以：
1. 使用服务管理UI
2. 启动/停止服务
3. 测试推理功能

NodeAgent的功能（节点注册、心跳、任务分发）只在多节点部署时需要。

---

## 下一步

1. **立即**：禁用NodeAgent，验证应用能正常运行
2. **Day 2**：重构NodeAgent，改用更优雅的降级策略
3. **Day 7**：完整回归测试，包括NodeAgent连接失败场景

---

**结论：Day 1重构完全成功，闪退是独立的NodeAgent配置问题。**
