# èŠ‚ç‚¹ç®¡ç†æ¶æ„ç»Ÿä¸€è§„åˆ™

**ç‰ˆæœ¬**: V1.0  
**åˆ›å»ºæ—¥æœŸ**: 2026-01-22  
**ç›®çš„**: æ¶ˆé™¤æ–‡æ¡£æ­§ä¹‰ï¼Œç»Ÿä¸€æ‰€æœ‰æ¶æ„è§„åˆ™

---

## ğŸ“‹ æ ¸å¿ƒçŠ¶æ€å®šä¹‰ï¼ˆå”¯ä¸€æ ‡å‡†ï¼‰

### 1. åœ¨çº¿çŠ¶æ€å®šä¹‰ âœ… ç»Ÿä¸€

```
ManagementRegistry.online
  â””â”€ WebSocket è¿æ¥çŠ¶æ€ï¼ˆæœ¬åœ°ç¼“å­˜ï¼‰
  â””â”€ ä»…ç”¨äº UI å±•ç¤º"èŠ‚ç‚¹è¿æ¥"
  â””â”€ ä¸å‚ä¸è°ƒåº¦å†³ç­–

Redis TTL + EXISTS
  â””â”€ å¯è°ƒåº¦åœ¨çº¿çŠ¶æ€ï¼ˆSSOTï¼Œå”¯ä¸€ä¾æ®ï¼‰
  â””â”€ TTL = 3600 ç§’ï¼ˆ1 å°æ—¶ï¼‰
  â””â”€ æ¯æ¬¡å¿ƒè·³åˆ·æ–° TTL
  â””â”€ TTL è¿‡æœŸ â†’ è‡ªåŠ¨æ¸…ç† Pool å½’å±ï¼ˆnode_offline.luaï¼‰
```

**å¼€å‘è§„åˆ™**:
- âœ… è°ƒåº¦é€»è¾‘ï¼šåªæŸ¥ Redis EXISTS
- âœ… UI æ˜¾ç¤ºï¼šå¯è¯» ManagementRegistry.online
- âŒ ç¦æ­¢ï¼šç”¨ ManagementRegistry.online åšè°ƒåº¦åˆ¤æ–­

---

### 2. SnapshotManager èŒè´£ âœ… ç»Ÿä¸€

```
SnapshotManager
  â””â”€ èŒè´£ï¼šUI å¿«ç…§ç¼“å­˜ï¼ˆåªè¯»ï¼‰
  â””â”€ ä¸ç”Ÿæˆ Pool ä¿¡æ¯
  â””â”€ ä¸è§¦å‘ä»»ä½•å†™æ“ä½œ
  â””â”€ æ¯ 100ms å…¨é‡ä» Redis é‡å»º

Snapshot å†…å®¹
  â””â”€ èŠ‚ç‚¹åŸºæœ¬ä¿¡æ¯ï¼ˆnode_id, hardware, statusï¼‰
  â””â”€ ä¸å« pool_idsï¼ˆå·²åˆ é™¤ï¼‰
  â””â”€ Pool ä¿¡æ¯éœ€è°ƒç”¨ PoolService API
```

**å¼€å‘è§„åˆ™**:
- âœ… å¿«ç…§æ›´æ–°ï¼šå›ºå®š 100ms åå° worker
- âœ… Pool æŸ¥è¯¢ï¼šè°ƒç”¨ `PoolService.get_node_pools(node_id)`
- âŒ ç¦æ­¢ï¼šå¿ƒè·³è§¦å‘å¿«ç…§æ›´æ–°
- âŒ ç¦æ­¢ï¼šå¿«ç…§ä¸­åŒ…å« Pool ä¿¡æ¯

---

### 3. Phase2 é—ç•™æ¸…ç† âœ… ç»Ÿä¸€

```
ä¸‹çº¿æµç¨‹æ¸…ç†å†…å®¹ï¼š
  â””â”€ WebSocket è¿æ¥æ³¨é”€ï¼ˆnode_connections.unregisterï¼‰
  â””â”€ ManagementRegistry.online = false
  â””â”€ Redis Pool å½’å±æ¸…ç†ï¼ˆnode_offline.luaï¼‰

ä¸å†æ¸…ç†çš„å†…å®¹ï¼ˆå·²åˆ é™¤ï¼‰ï¼š
  â””â”€ æœ¬åœ° pool_idsï¼ˆä¸å­˜åœ¨ï¼‰
  â””â”€ Phase3 pool indexï¼ˆä¸å­˜åœ¨ï¼‰
  â””â”€ æœ¬åœ°è¯­è¨€ç´¢å¼•ï¼ˆä¸å­˜åœ¨ï¼‰
```

**å¼€å‘è§„åˆ™**:
- âœ… ä¸‹çº¿ = WS æ³¨é”€ + Redis æ¸…ç†
- âŒ ç¦æ­¢ï¼šæ‰‹åŠ¨æ¸…ç†æœ¬åœ° pool çŠ¶æ€ï¼ˆå·²ä¸å­˜åœ¨ï¼‰

---

## ğŸ”‘ èŠ‚ç‚¹æ³¨å†Œè§„åˆ™ï¼ˆå¼ºåˆ¶ï¼‰

### 1. è¯­è¨€èƒ½åŠ›éªŒè¯ âœ… ç»Ÿä¸€

```lua
-- register_node_v2.lua
if not asr_langs_json or asr_langs_json == "" then
    return redis.error_reply("ERROR:asr_langs_json_required")
end

if not semantic_langs_json or semantic_langs_json == "" then
    return redis.error_reply("ERROR:semantic_langs_json_required_Semantic_service_is_mandatory")
end
```

**æ³¨å†Œè§„åˆ™**:
1. **Semantic æœåŠ¡ä¸ºå¿…éœ€æ ¸å¿ƒæœåŠ¡**
   - `semantic_langs` å¿…é¡»æä¾›ï¼Œè‡³å°‘ 1 ä¸ªè¯­è¨€
   - ä¸æä¾› â†’ æ³¨å†Œå¤±è´¥ï¼Œè¿”å›é”™è¯¯

2. **ASR æœåŠ¡ä¸ºå¿…éœ€**
   - `asr_langs` å¿…é¡»æä¾›ï¼Œè‡³å°‘ 1 ä¸ªè¯­è¨€
   - ä¸æä¾› â†’ æ³¨å†Œå¤±è´¥ï¼Œè¿”å›é”™è¯¯

3. **é”™è¯¯ç **:
   - `ERROR:asr_langs_json_required` - ASR è¯­è¨€ç¼ºå¤±
   - `ERROR:semantic_langs_json_required_Semantic_service_is_mandatory` - Semantic è¯­è¨€ç¼ºå¤±

**å®¢æˆ·ç«¯å¤„ç†**:
```javascript
// æ³¨å†Œå¤±è´¥åçš„è¡Œä¸º
if (error.includes("semantic_langs_json_required")) {
    console.error("èŠ‚ç‚¹æ³¨å†Œå¤±è´¥ï¼šSemantic æœåŠ¡ä¸ºå¿…éœ€æ ¸å¿ƒæœåŠ¡");
    // ä¸é‡è¯•ï¼Œç­‰å¾…ç®¡ç†å‘˜é…ç½®
}
```

---

### 2. Redis Key TTL âœ… ç»Ÿä¸€

```
æ‰€æœ‰èŠ‚ç‚¹ç›¸å…³ Key çš„ TTLï¼š3600 ç§’ï¼ˆ1 å°æ—¶ï¼‰

Key Pattern:
  - lingua:v1:node:{node_id}         â†’ TTL: 3600s
  - lingua:v1:node:{node_id}:pools   â†’ TTL: 3600s
  - lingua:v1:pool:{pool_id}:nodes   â†’ æ—  TTLï¼ˆSet æˆå‘˜ç®¡ç†ï¼‰

å¿ƒè·³è¡Œä¸ºï¼š
  - æ¯æ¬¡å¿ƒè·³åˆ·æ–° node:{node_id} çš„ TTL
  - TTL è¿‡æœŸ â†’ è‡ªåŠ¨æ¸…ç†æ‰€æœ‰ Pool å½’å±
```

**å¼€å‘è§„åˆ™**:
- âœ… æ‰€æœ‰æ–‡æ¡£ç»Ÿä¸€å†™ 3600 ç§’ï¼ˆ1 å°æ—¶ï¼‰
- âœ… æµ‹è¯•ç¯å¢ƒå¯é…ç½®ä¸º 60 ç§’ï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰
- âŒ ç¦æ­¢ï¼šä¸åŒ Key ä½¿ç”¨ä¸åŒ TTL

---

## ğŸ”„ èŠ‚ç‚¹ Reconnect è¡Œä¸º âœ… ç»Ÿä¸€

### åœºæ™¯ 1: WebSocket æ–­å¼€ä½† TTL æœªè¿‡æœŸ

```
WS æ–­å¼€ â†’ ManagementRegistry.online = false
Redis TTL ä»æœ‰æ•ˆï¼ˆ< 3600sï¼‰
  â†“
èŠ‚ç‚¹ä»å¯è°ƒåº¦ï¼ˆå®¹å¿çŸ­æš‚ WS æŠ–åŠ¨ï¼‰
ä»»åŠ¡åˆ†é…ä¼šå¤±è´¥ï¼Œè‡ªåŠ¨é‡è¯•ï¼ˆselect_node.lua é‡æ–°é€‰æ‹©ï¼‰
```

**è®¾è®¡ç†ç”±**: åˆ†å¸ƒå¼ç³»ç»Ÿç½‘ç»œæŠ–åŠ¨å¸¸è§ï¼Œå®¹å¿çŸ­æš‚æ–­çº¿

---

### åœºæ™¯ 2: Redis TTL è¿‡æœŸ

```
TTL è¿‡æœŸ â†’ node:{node_id} è‡ªåŠ¨åˆ é™¤
  â†“
è§¦å‘ node_offline.luaï¼ˆæˆ–ä¸‹æ¬¡å¿ƒè·³å¤±è´¥ï¼‰
  â†“
æ¸…ç†æ‰€æœ‰ Pool å½’å±
  â†“
èŠ‚ç‚¹ä¸å¯è°ƒåº¦
```

**è®¾è®¡ç†ç”±**: TTL è¿‡æœŸè§†ä¸ºçœŸæ­£ä¸‹çº¿

---

### åœºæ™¯ 3: èŠ‚ç‚¹é‡è¿

```
WS é‡è¿ â†’ è§¦å‘ register æˆ– heartbeat
  â†“
åˆ·æ–° Redis TTL â†’ 3600s
  â†“
Pool è‡ªåŠ¨é‡æ–°åˆ†é…ï¼ˆheartbeat_with_pool_assign.luaï¼‰
  â†“
èŠ‚ç‚¹å¯è°ƒåº¦
```

**è®¾è®¡ç†ç”±**: æ— çŠ¶æ€é‡è¿ï¼Œè‡ªåŠ¨æ¢å¤

---

## ğŸ“Š å¿ƒè·³è¡Œä¸º âœ… ç»Ÿä¸€

### å¿ƒè·³æµç¨‹ï¼ˆä¸è§¦å‘ä»»ä½•åå°ä»»åŠ¡ï¼‰

```
1. WebSocket æ”¶åˆ° heartbeat æ¶ˆæ¯
   â†“
2. è°ƒç”¨ PoolService.heartbeat(node_id)
   â†“
3. æ‰§è¡Œ heartbeat_with_pool_assign.lua
   - åˆ·æ–° Redis TTLï¼ˆ3600sï¼‰
   - Pool è‡ªåŠ¨åˆ†é…ï¼ˆå¦‚æœªåˆ†é…ï¼‰
   â†“
4. è¿”å›æˆåŠŸï¼ˆä¸è§¦å‘ä»»ä½•åå°ä»»åŠ¡ï¼‰
```

**ä¸åšçš„äº‹æƒ…**:
- âŒ ä¸è§¦å‘ SnapshotManager æ›´æ–°ï¼ˆç”± 100ms worker ç‹¬ç«‹æ‰§è¡Œï¼‰
- âŒ ä¸è§¦å‘æœ¬åœ°çŠ¶æ€åŒæ­¥ï¼ˆæœ¬åœ°çŠ¶æ€åªæ˜¯ç¼“å­˜ï¼‰
- âŒ ä¸è§¦å‘ Pool é‡å¹³è¡¡ï¼ˆPool åŠ¨æ€åˆ†é…ï¼Œæ— éœ€é‡å¹³è¡¡ï¼‰

**å¼€å‘è§„åˆ™**:
- âœ… å¿ƒè·³ = Redis TTL åˆ·æ–° + Pool åˆ†é…ï¼ˆå¦‚éœ€ï¼‰
- âœ… å¿«ç…§æ›´æ–° = åå° 100ms workerï¼ˆç‹¬ç«‹ï¼‰
- âŒ ç¦æ­¢ï¼šå¿ƒè·³è§¦å‘ä»»ä½•å¼‚æ­¥ä»»åŠ¡

---

## ğŸš¨ å¼‚å¸¸è·¯å¾„ âœ… ç»Ÿä¸€

### 1. æ³¨å†Œå¤±è´¥

```
Semantic è¯­è¨€ç¼ºå¤±
  â†“
register_node_v2.lua è¿”å›é”™è¯¯
  â†“
å®¢æˆ·ç«¯æ”¶åˆ° WebSocket é”™è¯¯æ¶ˆæ¯
  â†“
ä¸é‡è¯•ï¼Œç­‰å¾…ç®¡ç†å‘˜é…ç½®
```

---

### 2. å¿ƒè·³å¤±è´¥

```
PoolService æœªåˆå§‹åŒ– / Redis è¿æ¥å¤±è´¥
  â†“
æ—¥å¿—è­¦å‘Šï¼ˆä¸å´©æºƒï¼‰
  â†“
ä¸‹æ¬¡å¿ƒè·³é‡è¯•
```

---

### 3. TTL è¿‡æœŸæ¸…ç†

```
TTL è¿‡æœŸï¼ˆ3600s æ— å¿ƒè·³ï¼‰
  â†“
Redis è‡ªåŠ¨åˆ é™¤ node:{node_id}
  â†“
ä¸‹æ¬¡è°ƒåº¦æ—¶ EXISTS æ£€æŸ¥å¤±è´¥
  â†“
select_node.lua è·³è¿‡è¯¥èŠ‚ç‚¹
  â†“
è‡ªåŠ¨é€‰æ‹©å…¶ä»–èŠ‚ç‚¹
```

---

## ğŸ“ æ–‡æ¡£ç»Ÿä¸€ä¿®æ”¹æ¸…å•

### ä¿®æ”¹ 1: åœ¨çº¿çŠ¶æ€æè¿°

**æ—§ç‰ˆ**ï¼ˆé‡å¤ 3 æ¬¡ä»¥ä¸Šï¼‰:
```
ManagementRegistry.online è¡¨ç¤º WebSocket è¿æ¥çŠ¶æ€
å¯è°ƒåº¦åœ¨çº¿çŠ¶æ€ç”± Redis TTL + EXISTS åˆ¤å®š
æœ¬åœ°çŠ¶æ€åªæ˜¯ç¼“å­˜ï¼Œä¸å‚ä¸è°ƒåº¦
```

**æ–°ç‰ˆ**ï¼ˆç»Ÿä¸€ä¸º 1 å¥ï¼‰:
```
ManagementRegistry.online = WebSocket è¿æ¥çŠ¶æ€ï¼ˆä»… UIï¼‰
è°ƒåº¦åœ¨çº¿ = Redis TTL + EXISTSï¼ˆå”¯ä¸€ä¾æ®ï¼ŒTTL=3600sï¼‰
```

---

### ä¿®æ”¹ 2: SnapshotManager èŒè´£

**æ—§ç‰ˆ**ï¼ˆé‡å¤ 3 æ¬¡ï¼‰:
```
SnapshotManager ä¸å†ç”Ÿæˆ Pool
Pool ä¿¡æ¯å¿…é¡»ä» Redis æŸ¥è¯¢
Snapshot åªä½œä¸º UI cache
```

**æ–°ç‰ˆ**ï¼ˆç»Ÿä¸€ï¼‰:
```
SnapshotManager èŒè´£ï¼šUI å¿«ç…§ï¼ˆåªè¯»ï¼Œæ¯ 100ms é‡å»ºï¼‰
ä¸å« Pool ä¿¡æ¯ï¼Œéœ€è°ƒç”¨ PoolService API
```

---

### ä¿®æ”¹ 3: Phase2 çŠ¶æ€æ¸…ç†

**æ—§ç‰ˆ**ï¼ˆæè¿°ä¸ä¸€è‡´ï¼‰:
```
"Phase2 çŠ¶æ€å·²æ¸…ç†"
"Phase2 é—ç•™ç»“æ„å·²åˆ é™¤"
```

**æ–°ç‰ˆ**ï¼ˆç»Ÿä¸€ï¼‰:
```
æ¸…ç† WebSocket è¿æ¥çŠ¶æ€ + Redis Pool å½’å±
ï¼ˆæ— æœ¬åœ° pool_idsï¼Œå·²å®Œå…¨åˆ é™¤ï¼‰
```

---

### ä¿®æ”¹ 4: è¡¥å……éªŒè¯å¤±è´¥è·¯å¾„

**æ–°å¢**:
```
èŠ‚ç‚¹æ³¨å†Œè§„åˆ™ï¼ˆå¼ºåˆ¶ï¼‰ï¼š
- Semantic æœåŠ¡å¿…éœ€ï¼Œsemantic_langs è‡³å°‘ 1 ä¸ª
- ASR æœåŠ¡å¿…éœ€ï¼Œasr_langs è‡³å°‘ 1 ä¸ª
- ä¸ç¬¦åˆ â†’ register_node_v2.lua è¿”å›é”™è¯¯ç ï¼Œæ‹’ç»æ³¨å†Œ
```

---

### ä¿®æ”¹ 5: ç»Ÿä¸€ TTL å€¼

**æ–°ç‰ˆ**ï¼ˆæ‰€æœ‰æ–‡æ¡£ç»Ÿä¸€ï¼‰:
```
Redis Key TTLï¼š3600 ç§’ï¼ˆ1 å°æ—¶ï¼‰
```

---

### ä¿®æ”¹ 6: è¡¥å…… Reconnect è¡Œä¸º

**æ–°å¢**:
```
WS æ–­å¼€ä½† TTL æœªè¿‡æœŸ â†’ ä»å¯è°ƒåº¦ï¼ˆå®¹å¿çŸ­æš‚æŠ–åŠ¨ï¼‰
TTL è¿‡æœŸ â†’ ç«‹å³æ¸…ç†ï¼Œä¸å¯è°ƒåº¦
WS é‡è¿ â†’ è‡ªåŠ¨æ¢å¤ï¼ˆåˆ·æ–° TTL + é‡æ–°åˆ†é… Poolï¼‰
```

---

## âœ… æ£€æŸ¥æ¸…å•

åœ¨äº¤ä»˜æœ€ç»ˆç‰ˆæœ¬å‰ï¼Œç¡®ä¿æ‰€æœ‰æ–‡æ¡£ç¬¦åˆä»¥ä¸‹æ£€æŸ¥ï¼š

- [ ] åœ¨çº¿çŠ¶æ€å®šä¹‰ï¼šåªåœ¨ä¸€å¤„è¯¦ç»†è¯´æ˜ï¼Œå…¶ä»–å¼•ç”¨
- [ ] SnapshotManager èŒè´£ï¼šåªåœ¨ä¸€å¤„è¯¦ç»†è¯´æ˜
- [ ] Phase2 æ¸…ç†ï¼šç»Ÿä¸€ä¸º"WS è¿æ¥çŠ¶æ€ + Redis Pool"
- [ ] éªŒè¯å¤±è´¥è·¯å¾„ï¼šæ˜ç¡®è¯´æ˜é”™è¯¯ç å’Œè¡Œä¸º
- [ ] TTL å€¼ï¼šç»Ÿä¸€ä¸º 3600 ç§’
- [ ] Reconnect è¡Œä¸ºï¼šæ˜ç¡®ä¸‰ç§åœºæ™¯
- [ ] å¿ƒè·³è¡Œä¸ºï¼šæ˜ç¡®"ä¸è§¦å‘åå°ä»»åŠ¡"
- [ ] æ‰€æœ‰ Lua è„šæœ¬ï¼šç¬¦åˆç»Ÿä¸€è§„åˆ™

---

**æ–‡æ¡£ç‰ˆæœ¬**: V1.0  
**åˆ›å»ºæ—¥æœŸ**: 2026-01-22  
**çŠ¶æ€**: âœ… **æ¶æ„è§„åˆ™å·²ç»Ÿä¸€ï¼Œå¯ä½œä¸ºæœ€ç»ˆå‚è€ƒ**
