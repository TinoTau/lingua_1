# æ¶æ„ä¿®å¤éªŒè¯æŒ‡å— - 2026-01-20

## âœ… **ä¿®å¤å®Œæˆçš„é—®é¢˜**

### é—®é¢˜1ï¼šåŒRegistryä¸åŒæ­¥
- âœ… åˆ›å»ºå…¨å±€ServiceRegistryå•ä¾‹
- âœ… æ‰€æœ‰æ¨¡å—ä½¿ç”¨åŒä¸€ä¸ªregistryå¼•ç”¨
- âœ… çŠ¶æ€å®Œå…¨åŒæ­¥

### é—®é¢˜2ï¼šåˆ·æ–°æœåŠ¡åœæ­¢è¿è¡Œä¸­æœåŠ¡
- âœ… æ”¹ä¸ºéç ´åæ€§åˆå¹¶
- âœ… åªæ›´æ–°service.jsonå®šä¹‰
- âœ… ä¿ç•™runtimeçŠ¶æ€
- âœ… ä¸åœæ­¢è¿è¡Œä¸­çš„æœåŠ¡

---

## ğŸ§ª **éªŒè¯æ­¥éª¤**

### éªŒè¯1ï¼šè¯­ä¹‰ä¿®å¤æœåŠ¡æ˜¾ç¤º

1. **æŸ¥çœ‹Electronåº”ç”¨**
2. **ç¡®è®¤æœåŠ¡ç®¡ç†é¡µé¢æ˜¾ç¤º**ï¼š
   - âœ… èŠ‚ç‚¹æ¨ç†æœåŠ¡ï¼ˆRustï¼‰
   - âœ… **ç»Ÿä¸€è¯­ä¹‰ä¿®å¤æœåŠ¡ï¼ˆä¸­è‹±æ–‡+æ ‡å‡†åŒ–ï¼‰** â­ åº”è¯¥æ˜¾ç¤º
   - âœ… FastWhisperVadè¯­éŸ³è¯†åˆ«æœåŠ¡
   - âœ… NMTç¿»è¯‘æœåŠ¡
   - âœ… TTSè¯­éŸ³åˆæˆ

3. **æ£€æŸ¥è¯­ä¹‰ä¿®å¤æœåŠ¡çŠ¶æ€**ï¼š
   - æœåŠ¡ID: `semantic-repair-en-zh`
   - æ˜¾ç¤ºåç§°: "ç»Ÿä¸€è¯­ä¹‰ä¿®å¤æœåŠ¡ï¼ˆä¸­è‹±æ–‡+æ ‡å‡†åŒ–ï¼‰"
   - çŠ¶æ€ï¼šå·²åœæ­¢ï¼ˆé»˜è®¤ï¼‰æˆ–è¿è¡Œä¸­ï¼ˆå¦‚æœè‡ªåŠ¨å¯åŠ¨ï¼‰

### éªŒè¯2ï¼šå¯åŠ¨è¯­ä¹‰ä¿®å¤æœåŠ¡

1. **ç‚¹å‡»è¯­ä¹‰ä¿®å¤æœåŠ¡çš„å¯åŠ¨å¼€å…³**
2. **è§‚å¯ŸçŠ¶æ€å˜åŒ–**ï¼š
   - å·²åœæ­¢ â†’ æ­£åœ¨å¯åŠ¨... â†’ è¿è¡Œä¸­
3. **ç¡®è®¤è¯¦æƒ…æ˜¾ç¤º**ï¼š
   - ç«¯å£: 5015
   - PID: (è¿›ç¨‹ID)

### éªŒè¯3ï¼šåˆ·æ–°æœåŠ¡ä¸å½±å“è¿è¡Œä¸­æœåŠ¡

**æµ‹è¯•æ­¥éª¤**ï¼š

1. **å¯åŠ¨NMTç¿»è¯‘æœåŠ¡**ï¼ˆå¦‚æœæœªè¿è¡Œï¼‰
   - ç¡®è®¤çŠ¶æ€ï¼š"è¿è¡Œä¸­"
   - è®°å½•PIDï¼ˆä¾‹å¦‚ï¼š12345ï¼‰

2. **ç‚¹å‡»"ğŸ”„ åˆ·æ–°æœåŠ¡"æŒ‰é’®**

3. **éªŒè¯ç»“æœ**ï¼š
   - âœ… NMTæœåŠ¡**ä»ç„¶è¿è¡Œä¸­**
   - âœ… PID**æ²¡æœ‰å˜åŒ–**ï¼ˆä»æ˜¯12345ï¼‰
   - âœ… çŠ¶æ€**æ²¡æœ‰å˜ä¸º"å·²åœæ­¢"**
   - âœ… æœåŠ¡åˆ—è¡¨å¯èƒ½å¢åŠ ï¼ˆå¦‚æœæ·»åŠ äº†æ–°æœåŠ¡ï¼‰

4. **æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—**ï¼š
   ```
   âœ… IPC: services:refresh completed (non-destructive)
   - total: 9
   - added: 0
   - updated: 9
   - removed: 0
   ```

**é¢„æœŸè¡Œä¸º**ï¼š
- âœ… åˆ·æ–°æœåŠ¡åªæ›´æ–°é…ç½®å®šä¹‰
- âœ… ä¸åœæ­¢ä»»ä½•è¿è¡Œä¸­çš„æœåŠ¡
- âœ… ä¸å½±å“PIDå’ŒruntimeçŠ¶æ€

---

## ğŸ“ **ä¿®æ”¹çš„æ–‡ä»¶**

### æ–°æ–‡ä»¶

1. **`service-layer/ServiceRegistrySingleton.ts`**
   - å…¨å±€ServiceRegistryå•ä¾‹ç®¡ç†
   - `setServiceRegistry()` - è®¾ç½®å…¨å±€registry
   - `getServiceRegistry()` - è·å–å…¨å±€registry
   - `isServiceRegistryInitialized()` - æ£€æŸ¥åˆå§‹åŒ–çŠ¶æ€

### ä¿®æ”¹çš„æ–‡ä»¶

2. **`service-layer/service-ipc-handlers.ts`**
   - åˆ é™¤å†…éƒ¨`serviceRegistry`å˜é‡
   - ä½¿ç”¨å…¨å±€å•ä¾‹`getServiceRegistry()`
   - `initServiceLayer()`è°ƒç”¨`setServiceRegistry()`
   - `services:refresh`æ”¹ä¸ºéç ´åæ€§åˆå¹¶

3. **`service-layer/index.ts`**
   - å¯¼å‡º`ServiceRegistrySingleton`æ¨¡å—

4. **`app/app-init-simple.ts`**
   - å¯¼å…¥å…¨å±€`getServiceRegistry()`
   - æ‰€æœ‰ç»„ä»¶ä½¿ç”¨å…¨å±€å•ä¾‹åˆ›å»ºï¼š
     - ServiceProcessRunner
     - ServiceEndpointResolver
     - InferenceService
     - NodeAgentçš„registry getter

---

## ğŸ¯ **æ¶æ„æ”¹è¿›**

### ä¹‹å‰ï¼ˆé”™è¯¯ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Registry 1  â”‚      â”‚ Registry 2  â”‚
â”‚ (app-init)  â”‚      â”‚ (ipc-hndlr) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                    â”‚
   ServiceProc          Supervisor
    Runner               listServices
       â”‚                    â”‚
     æ›´æ–°çŠ¶æ€             æŸ¥è¯¢çŠ¶æ€
       
âŒ çŠ¶æ€ä¸åŒæ­¥ï¼
```

### ä¹‹åï¼ˆæ­£ç¡®ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Global ServiceRegistry     â”‚
â”‚  (å•ä¾‹ï¼Œæ‰€æœ‰æ¨¡å—å…±äº«)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ å…±äº«å¼•ç”¨
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚          â”‚
ServiceProc      Supervisor  IPCæŸ¥è¯¢
  Runner         listServices    â”‚
    â”‚                 â”‚          â”‚
  æ›´æ–°çŠ¶æ€         æŸ¥è¯¢çŠ¶æ€    æŸ¥è¯¢çŠ¶æ€
    
âœ… çŠ¶æ€å®Œå…¨åŒæ­¥ï¼
```

---

## ğŸ’¡ **å…³é”®æ”¹è¿›ç‚¹**

### 1. å•ä¸€æ•°æ®æºï¼ˆSingle Source of Truthï¼‰

- âœ… æ•´ä¸ªåº”ç”¨åªæœ‰ä¸€ä¸ªServiceRegistryå®ä¾‹
- âœ… é€šè¿‡å…¨å±€å•ä¾‹è®¿é—®ï¼Œç¦æ­¢é‡å¤åˆ›å»º
- âœ… ä»»ä½•æ¨¡å—æ›´æ–°runtimeçŠ¶æ€ï¼Œå…¶ä»–æ¨¡å—ç«‹å³å¯è§

### 2. éç ´åæ€§åˆ·æ–°

**æ—§é€»è¾‘**ï¼ˆé”™è¯¯ï¼‰ï¼š
```typescript
// âŒ åœæ­¢æ‰€æœ‰æœåŠ¡
await serviceSupervisor.stopAllServices();

// âŒ åˆ›å»ºæ–°registryï¼ˆæŠ›å¼ƒæ—§æ•°æ®ï¼‰
serviceRegistry = await scanServices(servicesRoot);

// âŒ é‡å»ºsupervisorï¼ˆè¿›ç¨‹å¼•ç”¨ä¸¢å¤±ï¼‰
serviceSupervisor = new NodeServiceSupervisor(serviceRegistry);
```

**æ–°é€»è¾‘**ï¼ˆæ­£ç¡®ï¼‰ï¼š
```typescript
// âœ… 1. é‡æ–°æ‰«æservice.json
const freshRegistry = await scanServices(servicesRoot);

// âœ… 2. åˆå¹¶åˆ°ç°æœ‰registry
for (const [serviceId, freshEntry] of freshRegistry.entries()) {
  const currentEntry = currentRegistry.get(serviceId);
  if (currentEntry) {
    // æ›´æ–°å®šä¹‰ï¼Œä¿ç•™runtimeçŠ¶æ€
    currentEntry.def = freshEntry.def;
    // âœ… currentEntry.runtime ä¸å˜ï¼
  } else {
    // æ–°æœåŠ¡ï¼Œæ·»åŠ 
    currentRegistry.set(serviceId, freshEntry);
  }
}

// âœ… 3. ä¸é‡å»ºsupervisorï¼Œä½¿ç”¨ç°æœ‰å¼•ç”¨
```

### 3. æ˜ç¡®çš„æ¨¡å—èŒè´£

- **ServiceRegistry**: æ•°æ®å­˜å‚¨ï¼ˆå•ä¸€æ•°æ®æºï¼‰
- **ServiceProcessRunner**: è¿›ç¨‹ç®¡ç†ï¼ˆå¯åŠ¨/åœæ­¢/çŠ¶æ€æ›´æ–°ï¼‰
- **NodeServiceSupervisor**: æœåŠ¡ç›‘ç£ï¼ˆé«˜å±‚APIï¼‰
- **IPC Handlers**: å‰åç«¯é€šä¿¡æ¡¥æ¢

---

## ğŸš€ **ä¸‹ä¸€æ­¥**

1. **éªŒè¯è¯­ä¹‰ä¿®å¤æœåŠ¡æ˜¾ç¤º**ï¼ˆåº”è¯¥å¯ä»¥çœ‹åˆ°äº†ï¼‰
2. **æµ‹è¯•åˆ·æ–°æœåŠ¡**ï¼ˆä¸åº”è¯¥åœæ­¢è¿è¡Œä¸­çš„æœåŠ¡ï¼‰
3. **ç¡®è®¤æ‰€æœ‰æœåŠ¡çŠ¶æ€åŒæ­¥æ­£å¸¸**

å¦‚æœæµ‹è¯•é€šè¿‡ï¼Œè¿™ä¸ªæ¶æ„é—®é¢˜å°±å½»åº•è§£å†³äº†ï¼
