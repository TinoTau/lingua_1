# è®¾è®¡ä¿®æ­£è¯´æ˜ï¼šåˆ é™¤ AudioBufferManager

**æ—¥æœŸ**: 2026-01-22  
**é—®é¢˜**: AudioBufferManager è®¾è®¡ä¸åˆç†  
**ä¿®æ­£äºº**: æ¶æ„å®¡æŸ¥ç»„

---

## é—®é¢˜åˆ†æ

### åŸè®¾è®¡çš„é—®é¢˜

åœ¨ `redis_job_storage_design.md` ä¸­ï¼Œæˆ‘è®¾è®¡äº† **AudioBufferManager** æ¥ç®¡ç†éŸ³é¢‘æ•°æ®ï¼š

```rust
// âŒ é”™è¯¯çš„è®¾è®¡
pub struct AudioBufferManager {
    buffer: Arc<RwLock<HashMap<String, (Vec<u8>, Instant)>>>,
}

// å­˜å‚¨éŸ³é¢‘
audio_buffer_manager.store(job_id, audio_data);

// è·å–éŸ³é¢‘
let audio_data = audio_buffer_manager.get(job_id);
```

**é—®é¢˜**ï¼š
1. **èŒè´£ä¸æ¸…**ï¼šè°ƒåº¦æœåŠ¡å™¨çš„èŒè´£æ˜¯ä»»åŠ¡è·¯ç”±ï¼Œä¸æ˜¯éŸ³é¢‘å­˜å‚¨
2. **å†…å­˜æµªè´¹**ï¼šéŸ³é¢‘æ•°æ®åœ¨å‘é€ååº”ç«‹å³é‡Šæ”¾ï¼Œä¸åº”é•¿æœŸä¿ç•™
3. **æ¶æ„å¤æ‚åŒ–**ï¼šå¼•å…¥äº†ä¸å¿…è¦çš„ç»„ä»¶

---

## å½“å‰æ¶æ„çš„å®é™…é—®é¢˜

æŸ¥çœ‹ä»£ç å‘ç°ï¼Œå½“å‰ `Job` ç»“æ„ä½“åŒ…å« `audio_data`:

```rust
pub struct Job {
    pub job_id: String,
    pub audio_data: Vec<u8>,  // âŒ é—®é¢˜ï¼šaudio ä¸€ç›´å ç”¨å†…å­˜
    pub status: JobStatus,
    // ...
}
```

**æµç¨‹**ï¼š
```
1. åˆ›å»º Jobï¼ˆåŒ…å« audio_dataï¼‰
2. å­˜å‚¨åˆ° JobDispatcherï¼ˆå†…å­˜ HashMapï¼‰
3. ä»»åŠ¡åˆ†å‘æ—¶ï¼Œè¯»å– Job è·å– audio_data
4. å‘é€éŸ³é¢‘åˆ°èŠ‚ç‚¹
5. âŒ Job å¯¹è±¡ä¿ç•™åœ¨å†…å­˜ä¸­ï¼Œaudio_data ä¸é‡Šæ”¾
```

**åæœ**ï¼š
- æ¯ä¸ª Job çš„éŸ³é¢‘æ•°æ®ï¼ˆå¯èƒ½å‡  MBï¼‰ä¸€ç›´å ç”¨å†…å­˜
- 1000 ä¸ª Job = å‡  GB å†…å­˜
- å†…å­˜æ³„æ¼é£é™©

---

## æ­£ç¡®çš„æ¶æ„è®¾è®¡

### æ ¸å¿ƒåŸåˆ™ä¿®æ­£

**è°ƒåº¦æœåŠ¡å™¨çš„èŒè´£**ï¼š
- âœ… ä»»åŠ¡è·¯ç”±å’Œè°ƒåº¦
- âœ… çŠ¶æ€è¿½è¸ªï¼ˆjob_id, status, assigned_node_idï¼‰
- âŒ **ä¸åº”è¯¥**å­˜å‚¨éŸ³é¢‘æ•°æ®

**æ•°æ®åˆ†ç¦»**ï¼š
```
éŸ³é¢‘æ•°æ®æµ:  Session â†’ Jobåˆ›å»ºå‡½æ•° â†’ ç«‹å³å‘é€ç»™Node â†’ é‡Šæ”¾
çŠ¶æ€æ•°æ®æµ:  Session â†’ Jobå…ƒæ•°æ® â†’ RedisçŠ¶æ€è¿½è¸ª
```

### æ–¹æ¡ˆä¸€ï¼šæœ€å°ä¿®æ”¹ï¼ˆæ¨èï¼‰âœ…

**ä¸æ”¹å˜å¤–éƒ¨æ¥å£**ï¼Œåªåœ¨å†…éƒ¨ä¼˜åŒ–ï¼š

```rust
// 1. Job ç»“æ„ä¿æŒä¸å˜ï¼ˆå¯¹å¤–å…¼å®¹ï¼‰
pub struct Job {
    pub audio_data: Vec<u8>,  // ä¿ç•™å­—æ®µï¼ˆå…¼å®¹æ€§ï¼‰
    // ...
}

// 2. åœ¨ä»»åŠ¡åˆ†å‘åï¼Œæ¸…ç©º audio_data
impl JobDispatcher {
    pub async fn mark_job_dispatched(&self, job_id: &str) -> bool {
        if let Some(mut job) = self.get_job_mut(job_id).await {
            job.dispatched_to_node = true;
            job.dispatched_at_ms = Some(now_ms());
            
            // âœ… å…³é”®ï¼šæ¸…ç©ºéŸ³é¢‘æ•°æ®ï¼Œé‡Šæ”¾å†…å­˜
            job.audio_data.clear();
            job.audio_data.shrink_to_fit();
            
            true
        } else {
            false
        }
    }
}
```

**ä¼˜ç‚¹**ï¼š
- ç®€å•ï¼Œåªéœ€ä¿®æ”¹ä¸€å¤„
- ä¿æŒæ¥å£å…¼å®¹
- ç«‹å³ç”Ÿæ•ˆ

**ç¼ºç‚¹**ï¼š
- `audio_data` å­—æ®µè¯­ä¹‰ä¸æ¸…æ™°

---

### æ–¹æ¡ˆäºŒï¼šå½»åº•é‡æ„ï¼ˆæ›´ä¼˜é›…ï¼Œä½†å·¥ä½œé‡å¤§ï¼‰

```rust
// 1. åˆ†ç¦» Job å…ƒæ•°æ®å’ŒéŸ³é¢‘æ•°æ®
pub struct JobMetadata {
    pub job_id: String,
    pub status: JobStatus,
    // ... ä¸åŒ…å« audio_data
}

// 2. ä»»åŠ¡åˆ›å»ºå’Œåˆ†å‘åˆ†ç¦»
async fn create_and_dispatch_job(
    state: &AppState,
    session_id: &str,
    audio_data: Vec<u8>,  // éŸ³é¢‘ä½œä¸ºå‚æ•°
    // ... å…¶ä»–å‚æ•°
) -> Result<JobMetadata> {
    // a. åˆ›å»ºå…ƒæ•°æ®ï¼ˆä¸å«éŸ³é¢‘ï¼‰
    let metadata = JobMetadata::new(...);
    
    // b. é€‰æ‹©èŠ‚ç‚¹
    let node_id = select_node(&metadata).await?;
    
    // c. ç«‹å³å‘é€éŸ³é¢‘åˆ°èŠ‚ç‚¹
    send_job_to_node(node_id, &metadata, audio_data).await?;
    
    // d. å­˜å‚¨å…ƒæ•°æ®åˆ° Redisï¼ˆä¸å«éŸ³é¢‘ï¼‰
    save_job_metadata_to_redis(&metadata).await?;
    
    Ok(metadata)
}
```

**ä¼˜ç‚¹**ï¼š
- æ¶æ„æ¸…æ™°
- è¯­ä¹‰æ˜ç¡®
- å†…å­˜å ç”¨æœ€å°

**ç¼ºç‚¹**ï¼š
- éœ€è¦å¤§é‡é‡æ„
- å½±å“èŒƒå›´å¹¿

---

## ä¿®æ­£åçš„ Redis Job å­˜å‚¨è®¾è®¡

### æ ¸å¿ƒä¿®æ”¹

#### ä¿®æ”¹å‰ï¼ˆé”™è¯¯ï¼‰
```
1. Job åŒ…å« audio_data
2. ä½¿ç”¨ AudioBufferManager å­˜å‚¨éŸ³é¢‘
3. éŸ³é¢‘æ•°æ®ç”Ÿå‘½å‘¨æœŸï¼š30 åˆ†é’Ÿ TTL
```

#### ä¿®æ”¹åï¼ˆæ­£ç¡®ï¼‰âœ…
```
1. Job ä¸é•¿æœŸå­˜å‚¨ audio_data
2. åˆ é™¤ AudioBufferManager
3. éŸ³é¢‘æ•°æ®ç”Ÿå‘½å‘¨æœŸï¼šåˆ›å»º â†’ å‘é€ â†’ ç«‹å³é‡Šæ”¾
```

### è®¾è®¡åŸåˆ™ä¿®æ­£

**åŸåˆ™ 1**: ~~éŸ³é¢‘æ•°æ®åˆ†ç¦»ï¼šRedis å­˜å…ƒæ•°æ®ï¼Œå†…å­˜å­˜éŸ³é¢‘æ•°æ®~~  
**ä¿®æ­£**: âœ… **éŸ³é¢‘æ•°æ®ä¸å­˜å‚¨ï¼šåˆ›å»ºä»»åŠ¡åç«‹å³å‘é€ï¼Œä¸ä¿ç•™**

**åŸåˆ™ 2**: Job çŠ¶æ€åªå­˜åœ¨äº Redis âœ…ï¼ˆä¿æŒä¸å˜ï¼‰

**åŸåˆ™ 3**: æœ¬åœ° LRU ç¼“å­˜ï¼Œå‡å°‘ Redis æŸ¥è¯¢ âœ…ï¼ˆä¿æŒä¸å˜ï¼‰

---

## å®æ–½å»ºè®®

### é˜¶æ®µ 1ï¼šç«‹å³ä¿®å¤ï¼ˆæœ¬å‘¨ï¼‰

ä½¿ç”¨ **æ–¹æ¡ˆä¸€**ï¼Œåœ¨ `mark_job_dispatched` ä¸­æ¸…ç©º audio_dataï¼š

```rust
// central_server/scheduler/src/core/dispatcher/job_management.rs

impl JobDispatcher {
    pub async fn mark_job_dispatched(&self, job_id: &str) -> bool {
        if let Some(mut job) = self.jobs.write().await.get_mut(job_id) {
            job.dispatched_to_node = true;
            job.dispatched_at_ms = Some(
                chrono::Utc::now().timestamp_millis()
            );
            
            // ğŸ“Œ æ–°å¢ï¼šæ¸…ç©ºéŸ³é¢‘æ•°æ®
            if !job.audio_data.is_empty() {
                let audio_size = job.audio_data.len();
                job.audio_data.clear();
                job.audio_data.shrink_to_fit();
                
                tracing::debug!(
                    job_id = %job_id,
                    audio_size_released = audio_size,
                    "éŸ³é¢‘æ•°æ®å·²é‡Šæ”¾"
                );
            }
            
            true
        } else {
            false
        }
    }
}
```

**é¢„æœŸæ•ˆæœ**ï¼š
- å†…å­˜å ç”¨ç«‹å³ä¸‹é™ > 80%
- æ— éœ€ä¿®æ”¹å¤–éƒ¨æ¥å£
- é£é™©æä½

### é˜¶æ®µ 2ï¼šRedis è¿ç§»ï¼ˆä¸‹å‘¨ï¼‰

ç»§ç»­æ‰§è¡Œ Job çŠ¶æ€è¿ç§»åˆ° Redisï¼Œä½† **åˆ é™¤ AudioBufferManager**ï¼š

**ä¿®æ”¹ç‚¹**ï¼š
1. âœ… `create_job.lua` - ä¿æŒä¸å˜ï¼ˆä¸æ¶‰åŠéŸ³é¢‘ï¼‰
2. âœ… `get_job.lua` - ä¿æŒä¸å˜
3. âœ… `update_job_status.lua` - ä¿æŒä¸å˜
4. âœ… `failover_job.lua` - ä¿æŒä¸å˜
5. âŒ **åˆ é™¤ AudioBufferManager**
6. âœ… JobDispatcher é‡æ„ - ä¸åŒ…å«éŸ³é¢‘ç®¡ç†

### é˜¶æ®µ 3ï¼šå½»åº•é‡æ„ï¼ˆå¯é€‰ï¼Œé•¿æœŸï¼‰

å¦‚æœæœ‰æ—¶é—´ï¼Œå¯ä»¥è€ƒè™‘ **æ–¹æ¡ˆäºŒ**ï¼Œä½†ä¼˜å…ˆçº§ä½ã€‚

---

## æ›´æ–°çš„æ¶æ„å›¾

### å½“å‰æ¶æ„ï¼ˆæœ‰é—®é¢˜ï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Session   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ audio_data (Vec<u8>)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  create_job         â”‚
â”‚  - åˆ›å»º Job         â”‚
â”‚  - audio_data å­˜å‚¨  â”‚ âŒ é—®é¢˜ï¼šaudio_data é•¿æœŸå ç”¨
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  JobDispatcher      â”‚
â”‚  HashMap<Job>       â”‚ âŒ æ¯ä¸ª Job å« audio_data
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  dispatch_job       â”‚
â”‚  - è¯»å– audio_data  â”‚
â”‚  - å‘é€åˆ° Node      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ audio_data ä»åœ¨å†…å­˜ä¸­ âŒ
```

### ä¿®æ­£åæ¶æ„ï¼ˆæ­£ç¡®ï¼‰âœ…
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Session   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ audio_data (Vec<u8>)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  create_and_dispatch_job    â”‚
â”‚  1. åˆ›å»ºå…ƒæ•°æ®              â”‚
â”‚  2. é€‰æ‹©èŠ‚ç‚¹                â”‚
â”‚  3. ç«‹å³å‘é€ audio_data     â”‚ âœ… å‘é€å audio_data è¢« Drop
â”‚  4. å­˜å‚¨å…ƒæ•°æ®ï¼ˆä¸å«éŸ³é¢‘ï¼‰  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Redis              â”‚
â”‚  JobMetadata åª     â”‚ âœ… åªå­˜å…ƒæ•°æ®
â”‚  (ä¸å« audio_data)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ€»ç»“

### é”™è¯¯çš„å‡è®¾
> "è°ƒåº¦æœåŠ¡å™¨éœ€è¦å­˜å‚¨éŸ³é¢‘æ•°æ®ä»¥ä¾¿é‡æ´¾"

### æ­£ç¡®çš„è®¤è¯†
> "è°ƒåº¦æœåŠ¡å™¨åªéœ€è¦å­˜å‚¨ä»»åŠ¡å…ƒæ•°æ®ï¼ŒéŸ³é¢‘åœ¨åˆ›å»ºæ—¶ç«‹å³å‘é€ç»™èŠ‚ç‚¹ï¼Œä¹‹åä¸éœ€è¦ä¿ç•™"

### ç«‹å³è¡ŒåŠ¨
1. âœ… **æœ¬å‘¨**ï¼šåœ¨ `mark_job_dispatched` ä¸­æ¸…ç©º audio_data
2. âœ… **ä¸‹å‘¨**ï¼šç»§ç»­ Job çŠ¶æ€ Redis è¿ç§»ï¼ˆåˆ é™¤ AudioBufferManagerï¼‰
3. â³ **æœªæ¥**ï¼šè€ƒè™‘å½»åº•é‡æ„ï¼ˆå¯é€‰ï¼‰

---

**ä¿®æ­£ç¡®è®¤**ï¼š
- [x] è¯†åˆ«äº†è®¾è®¡é—®é¢˜
- [x] æå‡ºäº†ä¿®æ­£æ–¹æ¡ˆ
- [x] æ›´æ–°äº†è®¾è®¡æ–‡æ¡£
- [ ] å®æ–½ä¿®å¤ä»£ç 
- [ ] éªŒè¯å†…å­˜å ç”¨

**è´Ÿè´£äºº**: ________________  
**å®¡æ‰¹æ—¥æœŸ**: 2026-01-22
