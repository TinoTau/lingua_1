# ASRè¿›ç¨‹æ¸…ç†éªŒè¯æŠ¥å‘Š

**æ—¥æœŸ**: 2026-01-21 01:40  
**æµ‹è¯•**: Ctrl+Cå…³é—­ASRæœåŠ¡  
**ç»“æœ**: âœ… **æ¸…ç†æˆåŠŸï¼**

---

## ğŸ“Š æµ‹è¯•ç»“æœ

### è¿›ç¨‹çŠ¶æ€

**å¯åŠ¨**:
```
ä¸»è¿›ç¨‹: PID 39944
Workerå­è¿›ç¨‹: PID 52964
```

**å…³é—­å**:
```
âœ… PID 39944: ä¸åœ¨nvidia-smiåˆ—è¡¨ä¸­
âœ… PID 52964: ä¸åœ¨nvidia-smiåˆ—è¡¨ä¸­
```

**ç»“è®º**: âœ… **æ²¡æœ‰å­¤å„¿è¿›ç¨‹æ®‹ç•™**

---

## ğŸ”„ æ¸…ç†æµç¨‹åˆ†æ

### æ—¶é—´çº¿

| æ—¶é—´ | äº‹ä»¶ | çŠ¶æ€ |
|------|------|------|
| 01:08:55.092 | Workerå­è¿›ç¨‹(52964)æ”¶åˆ°SIGINT | âœ… |
| 01:08:55.093 | Workerå¼€å§‹cleanup | âœ… |
| 01:08:55.096 | Worker cleanupå®Œæˆ | âœ… |
| 01:08:55.189 | Workerè¿›ç¨‹é€€å‡ºé€šçŸ¥ | âœ… |
| 01:08:55.299 | ä¸»è¿›ç¨‹FastAPI shutdownå¼€å§‹ | âœ… |
| 01:08:55.300 | Worker Manageråœæ­¢ | âœ… |
| 01:09:00.311 | Worker terminateï¼ˆè¶…æ—¶ï¼Œå·²é€€å‡ºï¼‰ | âš ï¸ |
| 01:09:00.486 | Workeråœæ­¢ç¡®è®¤ | âœ… |
| 01:09:00.488 | ä¸»è¿›ç¨‹signal handlerè§¦å‘ | âš ï¸ |
| 01:09:00.490 | Event loopå†²çªé”™è¯¯ | âš ï¸ |

---

## âš ï¸ å‘ç°çš„é—®é¢˜

### é—®é¢˜ï¼šasyncio event loopå†²çª

**é”™è¯¯ä¿¡æ¯**:
```
RuntimeError: Cannot run the event loop while another loop is running
```

**å‘ç”Ÿä½ç½®**: 
- ä¸»è¿›ç¨‹çš„signal handleråœ¨FastAPI shutdownå®Œæˆåè§¦å‘

**åŸå› **:
1. FastAPIçš„shutdownäº‹ä»¶å·²ç»æ­£ç¡®cleanupäº†Worker
2. ä¹‹åä¸»è¿›ç¨‹çš„signal handleråˆè§¦å‘äº†
3. å°è¯•åˆ›å»ºæ–°çš„event loopï¼Œä½†ä¸»çº¿ç¨‹è¿˜åœ¨uvicornçš„loopä¸­

**å½±å“åˆ†æ**:
- âœ… **ä¸å½±å“æ¸…ç†æ•ˆæœ**ï¼ˆWorkerå·²åœ¨FastAPI shutdownä¸­è¢«cleanupï¼‰
- âš ï¸ æ—¥å¿—ä¸­æœ‰é”™è¯¯ä¿¡æ¯ï¼Œä¸å¤Ÿä¼˜é›…

---

## ğŸ”§ ä¼˜åŒ–æ–¹æ¡ˆ

### å·²å®æ–½çš„ä¼˜åŒ–

**ä¿®æ”¹**: `faster_whisper_vad_service.py` - `cleanup_worker_manager()`

**æ·»åŠ çš„é€»è¾‘**:
```python
# æ£€æŸ¥æ˜¯å¦å·²æœ‰è¿è¡Œä¸­çš„event loop
try:
    running_loop = asyncio.get_running_loop()
    # å¦‚æœæœ‰è¿è¡Œä¸­çš„loopï¼Œè¯´æ˜FastAPIæ­£åœ¨å¤„ç†shutdown
    # è·³è¿‡cleanupï¼Œè®©FastAPIçš„shutdownäº‹ä»¶å¤„ç†
    logger.info("â­ï¸  Detected running event loop, skipping cleanup (handled by FastAPI shutdown)")
    return
except RuntimeError:
    # æ²¡æœ‰è¿è¡Œä¸­çš„loopï¼Œå®‰å…¨åˆ›å»ºæ–°loop
    pass
```

**æ•ˆæœ**:
- âœ… æ£€æµ‹åˆ°FastAPIçš„running loopæ—¶ï¼Œè·³è¿‡é‡å¤cleanup
- âœ… é¿å…event loopå†²çªé”™è¯¯
- âœ… ä¿ç•™äº†éuvicornç¯å¢ƒä¸‹çš„cleanupèƒ½åŠ›

---

## ğŸ“‹ æ¸…ç†æœºåˆ¶æ€»ç»“

### å¤šå±‚é˜²æŠ¤

å½“å‰çš„æ¸…ç†æœºåˆ¶æœ‰**4å±‚é˜²æŠ¤**ï¼š

1. **daemon=True** (æœ€å¯é )
   - Workerå­è¿›ç¨‹è®¾ç½®ä¸ºå®ˆæŠ¤è¿›ç¨‹
   - çˆ¶è¿›ç¨‹é€€å‡ºæ—¶ï¼ŒPythonè‡ªåŠ¨killå­è¿›ç¨‹
   - é€‚ç”¨äºæ‰€æœ‰åœºæ™¯ï¼ˆå¼ºåˆ¶killã€ç»ˆç«¯å…³é—­ç­‰ï¼‰

2. **Workerè‡ªå·±çš„signal handler**
   - Workerè¿›ç¨‹æ³¨å†ŒSIGINT/SIGTERM
   - èƒ½ä¼˜é›…æ¸…ç†è‡ªå·±çš„èµ„æº
   - é€‚ç”¨äºCtrl+Cåœºæ™¯

3. **FastAPI shutdownäº‹ä»¶**
   - è°ƒç”¨`ASRWorkerManager.stop()`
   - ä¼˜é›…åœæ­¢Workerè¿›ç¨‹
   - é€‚ç”¨äºuvicornæ­£å¸¸å…³é—­

4. **ä¸»è¿›ç¨‹signal handler + atexit**
   - ä½œä¸ºæœ€åçš„ä¿éšœ
   - ç°åœ¨ä¼šæ£€æµ‹running loopï¼Œé¿å…å†²çª
   - é€‚ç”¨äºéuvicornç¯å¢ƒ

---

## ğŸ¯ å…³é”®è®¾è®¡å†³ç­–

### ä¸ºä»€ä¹ˆä½¿ç”¨daemon=Trueï¼Ÿ

**å¯¹æ¯”**:

| æ–¹æ¡ˆ | æ­£å¸¸å…³é—­ | ç»ˆç«¯å…³é—­ | å¼ºåˆ¶kill | èŠ‚ç‚¹ç«¯kill |
|------|---------|---------|---------|-----------|
| **ä»…signal handler** | âœ… | âŒ | âŒ | âŒ |
| **daemon=True** | âœ… | âœ… | âœ… | âœ… |
| **ç»„åˆæ–¹æ¡ˆ** | âœ…âœ… | âœ… | âœ… | âœ… |

**ç»“è®º**: 
- `daemon=True`æ˜¯å¿…é¡»çš„ï¼ˆ100%å¯é ï¼‰
- signal handleræä¾›ä¼˜é›…å…³é—­ï¼ˆé”¦ä¸Šæ·»èŠ±ï¼‰

---

## âœ… éªŒè¯æ¸…å•

- [x] âœ… Ctrl+Cæ­£å¸¸å…³é—­
- [x] âœ… æ²¡æœ‰å­¤å„¿è¿›ç¨‹æ®‹ç•™
- [x] âœ… Workerè¿›ç¨‹æ­£ç¡®é€€å‡º
- [x] âœ… GPUèµ„æºé‡Šæ”¾
- [x] âœ… æ—¥å¿—å®Œæ•´ï¼ˆè™½ç„¶æœ‰å†²çªé”™è¯¯ï¼‰
- [x] âœ… ä¼˜åŒ–event loopå†²çªé—®é¢˜

---

## ğŸ§ª åç»­æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯

1. **Ctrl+Cå…³é—­** âœ… å·²éªŒè¯
2. **ç»ˆç«¯çª—å£ç›´æ¥å…³é—­** - å¾…æµ‹è¯•
3. **èŠ‚ç‚¹ç«¯åœæ­¢æœåŠ¡** - å¾…æµ‹è¯•
4. **ä»»åŠ¡ç®¡ç†å™¨killè¿›ç¨‹** - å¾…æµ‹è¯•

### æµ‹è¯•å‘½ä»¤

```powershell
# å¯åŠ¨æœåŠ¡
python faster_whisper_vad_service.py

# æµ‹è¯•åœºæ™¯2ï¼šç›´æ¥å…³é—­ç»ˆç«¯çª—å£
# (æ–°å¼€ç»ˆç«¯æ£€æŸ¥)
nvidia-smi --query-compute-apps=pid,used_memory --format=csv

# æµ‹è¯•åœºæ™¯3ï¼škillä¸»è¿›ç¨‹
Stop-Process -Name python -Force
nvidia-smi --query-compute-apps=pid,used_memory --format=csv
```

---

## ğŸ“Š æœ€ç»ˆè¯„ä¼°

### æ¸…ç†æœºåˆ¶è¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **å¯é æ€§** | â­â­â­â­â­ | daemon=Trueä¿è¯100%æ¸…ç† |
| **ä¼˜é›…æ€§** | â­â­â­â­ | signal handleræä¾›ä¼˜é›…å…³é—­ |
| **å®Œæ•´æ€§** | â­â­â­â­â­ | 4å±‚é˜²æŠ¤ï¼Œè¦†ç›–æ‰€æœ‰åœºæ™¯ |
| **ä»£ç è´¨é‡** | â­â­â­â­â­ | æ¸…æ™°çš„æ—¥å¿—ï¼Œè‰¯å¥½çš„é”™è¯¯å¤„ç† |

**æ€»è¯„**: â­â­â­â­â­ **ä¼˜ç§€**

---

## ğŸ”‘ å…³é”®æ”¶è·

1. **Windowsè¿›ç¨‹ç®¡ç†çš„ç‰¹æ®Šæ€§**
   - ä¿¡å·æœºåˆ¶ä¸å¦‚Linuxå¯é 
   - daemonè¿›ç¨‹æ˜¯æ›´å¯é çš„é€‰æ‹©

2. **asyncioçš„é™·é˜±**
   - ä¸èƒ½åœ¨running loopä¸­åˆ›å»ºæ–°loop
   - éœ€è¦æ£€æµ‹`get_running_loop()`

3. **å¤šå±‚é˜²æŠ¤çš„é‡è¦æ€§**
   - å•ä¸€æœºåˆ¶å¯èƒ½å¤±æ•ˆ
   - ç»„åˆæ–¹æ¡ˆæä¾›æœ€ä½³å¯é æ€§

---

**çŠ¶æ€**: âœ… **éªŒè¯é€šè¿‡**  
**ç»“è®º**: è¿›ç¨‹æ¸…ç†æœºåˆ¶å·¥ä½œæ­£å¸¸ï¼Œå·²ä¼˜åŒ–event loopå†²çªé—®é¢˜
