# AudioAggregator æµ‹è¯•æ”¹è¿›æ€»ç»“

## æ–‡æ¡£ä¿¡æ¯

- **æ”¹è¿›æ—¥æœŸ**: 2026-01-27
- **æ”¹è¿›èŒƒå›´**: `electron_node/electron-node/main/src/pipeline-orchestrator/audio-aggregator.test.ts`
- **æµ‹è¯•çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡ï¼ˆ12 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œå« Â§4.2/Â§6.2 äº¤é”™ã€å¹¶å‘è¡¥å……ï¼‰
- **å‚è€ƒæ–‡æ¡£**: `AUDIO_AGGREGATOR_TEST_ONLY_MIN_PATCHLIST_AND_REGRESSION_CHECKLIST.md`

> **é‡è¦è¯´æ˜**ï¼šé€»è¾‘åˆ†æ”¯é”™è¯¯åœ¨æµ‹è¯•æ¨¡å‹å†…å·²åŸºæœ¬æ’é™¤ï¼›**ç°æœ‰æ”¹è¿›å»ºè®®åˆå¹¶**ã€‚è‹¥çº¿ä¸Šä»æœ‰é—®é¢˜ï¼Œæœ€å¤§æ¦‚ç‡åœ¨ **å‘é€å±‚/å›å¡«æ˜ å°„å±‚**ï¼ˆéœ€çœŸå® spy ASR è°ƒç”¨ä¸å›è°ƒæ˜ å°„ï¼‰æˆ– **æ—¶åº/å¹¶å‘äº¤é”™**ï¼ˆéœ€äº¤é”™ç”¨ä¾‹ï¼‰ã€‚**èƒ½é€šè¿‡æµ‹è¯• â‰  æ‰¾åˆ°çº¿ä¸Šé—®é¢˜**ï¼Œé¡»æŒ‰æ–‡æ¡£ Â§4.2ã€Â§6.2 è¡¥å……ä¸Šè¿°ä¸¤ç±»ï¼Œå¦åˆ™éš¾ä»¥å®šä½çº¿ä¸Šæ ¹å› ã€‚

---

## ä¸€ã€å®ç°æ¦‚è§ˆ

### 1.1 å·²å®ç°çš„ Patch

æŒ‰ç…§ `AUDIO_AGGREGATOR_TEST_ONLY_MIN_PATCHLIST_AND_REGRESSION_CHECKLIST.md` æ–‡æ¡£è¦æ±‚ï¼Œå·²å®Œæˆä»¥ä¸‹æ”¹è¿›ï¼š

| Patch | çŠ¶æ€ | è¯´æ˜ |
|-------|------|------|
| Patch 1.1: Debug Snapshot é‡‡é›†å™¨ | âœ… å®Œæˆ | å®ç°äº†é€šè¿‡ result å¯¹è±¡è®°å½• ASR è°ƒç”¨å¿«ç…§ |
| Patch 1.2: Duration Helper | âœ… å®Œæˆ | ç»Ÿä¸€ duration å£å¾„å’Œå®¹å·®ï¼ˆ80msï¼‰ |
| Patch 1.3: æ¢å¤ R0-R5 æ‰§è¡Œ | âœ… å®Œæˆ | æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹å·²æ¢å¤æ‰§è¡Œ |
| Patch 1.4: pending ç”Ÿå‘½å‘¨æœŸæµ‹è¯• | âœ… å®Œæˆ | æ–°å¢æµ‹è¯•ç”¨ä¾‹éªŒè¯è·¨ job ä¿æŒ |
| Patch 1.5: mergedDurationMs å…³ç³»æ ¡éªŒ | âœ… å®Œæˆ | æ–°å¢æµ‹è¯•ç”¨ä¾‹éªŒè¯åˆå¹¶æ—¶é•¿å…³ç³» |
| Patch 1.6: ç©ºæ ¸é”€ä¸¥æ ¼æ€§æµ‹è¯• | âœ… å®Œæˆ | æ”¹è¿›æµ‹è¯•ç”¨ä¾‹ï¼ŒéªŒè¯ä¸¥æ ¼æ€§ |
| Patch 1.7: å¤š job å½’å±æµ‹è¯• | âœ… å®Œæˆ | æ”¹è¿›æµ‹è¯•ç”¨ä¾‹ï¼ŒéªŒè¯å½’å±ç­–ç•¥ |
| Patch 2.1: å»éšæœºåŒ– | âœ… å®Œæˆ | ä½¿ç”¨ç¡®å®šæ€§éšæœºæ•°ç”Ÿæˆå™¨ |
| Patch 2.2: æŒ‰ samples ç²¾ç¡®ç”Ÿæˆ | âœ… å®Œæˆ | æ–°å¢ `makePcm16BySamples()` API |
| Patch 2.3: å¯æ§åˆ‡åˆ†æ¨¡å¼ | âœ… å®Œæˆ | æ–°å¢ `makePausePatternAudio()` ç”Ÿæˆå™¨ |

---

## äºŒã€è¯¦ç»†å®ç°è¯´æ˜

### 2.1 Patch 1.1: Debug Snapshot é‡‡é›†å™¨

**å®ç°æ–¹å¼**: é€šè¿‡ `recordAsrSnapshot()` å‡½æ•°è®°å½•æ¯æ¬¡ `processAudioChunk()` çš„è¿”å›ç»“æœï¼Œå½¢æˆ ASR è°ƒç”¨å¿«ç…§ã€‚

**å…³é”®åŠŸèƒ½**:
- è®°å½• `ownerJobId`ã€`originalJobIds`ã€`audioDurationMs`ã€`reason`
- ä¸ä¾èµ– loggerï¼Œç›´æ¥ä»è¿”å›å€¼è·å–å…³é”®å¿«ç…§
- æä¾› `getDebugSnapshot()` å’Œ `clearDebugSnapshot()` å‡½æ•°

**ä»£ç ä½ç½®**: `audio-aggregator.test.ts:58-108`

**ä½¿ç”¨ç¤ºä¾‹**:
```typescript
const result = await aggregator.processAudioChunk(job);
recordAsrSnapshot(result);

const snapshot = getDebugSnapshot();
expect(snapshot.asrCalls.length).toBeGreaterThan(0);
expect(snapshot.lastAsrCall?.reason).toBe('NORMAL_MERGE');
```

### 2.2 Patch 1.2: Duration Helper

**å®ç°å†…å®¹**:
- `bytesToMsPcm16LE()`: ç»Ÿä¸€å­—èŠ‚åˆ°æ¯«ç§’è½¬æ¢
- `msToBytesPcm16LE()`: ç»Ÿä¸€æ¯«ç§’åˆ°å­—èŠ‚è½¬æ¢
- `samplesToMs()`: æ ·æœ¬æ•°åˆ°æ¯«ç§’è½¬æ¢
- `expectApprox()`: è¿‘ä¼¼ç›¸ç­‰æ–­è¨€ï¼ˆå®¹å·® 80msï¼‰

**ä»£ç ä½ç½®**: `audio-aggregator.test.ts:45-75`

**ä¼˜åŠ¿**:
- ç»Ÿä¸€æµ‹è¯•å’Œä¸šåŠ¡çš„ duration å£å¾„
- é¿å… rounding è¯¯å·®å¯¼è‡´çš„æµ‹è¯•å¤±è´¥
- æé«˜æµ‹è¯•çš„å¯ç»´æŠ¤æ€§

### 2.3 Patch 1.3: æ¢å¤ R0-R5 æµ‹è¯•æ‰§è¡Œ

**æ”¹è¿›å†…å®¹**:
- æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹å·²æ¢å¤æ‰§è¡Œï¼ˆä¸å† skippedï¼‰
- æ·»åŠ äº† Debug Snapshot éªŒè¯
- å¢å¼ºäº†æ–­è¨€è¦†ç›–

**æµ‹è¯•ç»“æœ**: âœ… å…¨éƒ¨é€šè¿‡

### 2.4 Patch 1.4: pending ç”Ÿå‘½å‘¨æœŸæµ‹è¯•

**æ–°å¢æµ‹è¯•ç”¨ä¾‹**: `pending_should_persist_across_jobs_when_merge_still_below_min`

**éªŒè¯ç‚¹**:
- âœ… Job1 å pending äº§ç”Ÿ
- âœ… Job2 å pending ä»å­˜åœ¨ï¼ˆæœªè¾¾ MIN ä¸åº”æ¸…ç©ºï¼‰
- âœ… ä¸åº”å‘ç”Ÿ ASR è°ƒç”¨
- âœ… ä¸åº”å‡ºç° empty æ ¸é”€
- âœ… pending duration å¢åŠ ï¼ˆåˆå¹¶äº† Job2 çš„éŸ³é¢‘ï¼‰

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡

### 2.5 Patch 1.5: mergedDurationMs å…³ç³»æ ¡éªŒ

**æ–°å¢æµ‹è¯•ç”¨ä¾‹**: `merged_duration_should_equal_pending_plus_incoming_within_tolerance`

**éªŒè¯ç‚¹**:
- âœ… `mergedDurationMs â‰ˆ pendingDurationMs + incomingDurationMs`ï¼ˆå®¹å·® 80ms å†…ï¼‰
- âœ… `mergedBytes â‰ˆ pendingBytes + incomingBytes`ï¼ˆå®¹å·®å†…ï¼‰

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡

**å‘ç°**: ä¸šåŠ¡é€»è¾‘æ­£ç¡®ï¼Œduration å£å¾„ä¸€è‡´ï¼Œæ— é—®é¢˜ã€‚

### 2.6 Patch 1.6: ç©ºæ ¸é”€ä¸¥æ ¼æ€§æµ‹è¯•

**æ”¹è¿›æµ‹è¯•ç”¨ä¾‹**: `empty_finalize_should_only_happen_when_input_duration_is_zero_and_no_pending`

**éªŒè¯ç‚¹**:
- âœ… Case A: `inputDurationMs == 0` â†’ å…è®¸ empty
- âœ… Case B: `inputDurationMs > 0` â†’ ä¸å…è®¸ emptyï¼ˆå³ä½¿ ASR å¯èƒ½å¤±è´¥ï¼‰

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡

**å‘ç°**: ä¸šåŠ¡é€»è¾‘æ­£ç¡®ï¼Œç©ºæ ¸é”€ä¸¥æ ¼æ€§ç¬¦åˆè¦æ±‚ã€‚

### 2.7 Patch 1.7: å¤š job å½’å±æµ‹è¯•

**æ”¹è¿›æµ‹è¯•ç”¨ä¾‹**: `multi_job_batch_should_be_explainable_and_must_not_empty_close_non_owner_jobs`

**éªŒè¯ç‚¹**:
- âœ… å¤´éƒ¨å¯¹é½ç­–ç•¥ï¼šæ‰€æœ‰æ‰¹æ¬¡ä½¿ç”¨ç¬¬ä¸€ä¸ª job çš„ ID
- âœ… ASR è°ƒç”¨å¿«ç…§ä¸­çš„å½’å±ä¿¡æ¯æ­£ç¡®
- âœ… `ownerJobId` å’Œ `originalJobIds` ä¸€è‡´

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡

**å‘ç°**: å½’å±ç­–ç•¥æ­£ç¡®ï¼Œæ— é—®é¢˜ã€‚

### 2.8 Patch 2.1: å»éšæœºåŒ–

**å®ç°æ–¹å¼**: ä½¿ç”¨ç¡®å®šæ€§ LCG éšæœºæ•°ç”Ÿæˆå™¨æ›¿ä»£ `Math.random()`

**ä»£ç ä½ç½®**: `audio-aggregator.test.ts:120-127`

**ä¼˜åŠ¿**:
- æµ‹è¯•ç»“æœå¯å¤ç°
- é¿å…éšæœºå™ªå£°å¯¼è‡´çš„æµ‹è¯•ä¸ç¨³å®š
- æé«˜æµ‹è¯•çš„å¯é æ€§

### 2.9 Patch 2.2: æŒ‰ samples ç²¾ç¡®ç”Ÿæˆ

**æ–°å¢ API**: `makePcm16BySamples(sampleCount, amplitude)`

**ä»£ç ä½ç½®**: `audio-aggregator.test.ts:129-142`

**ä¼˜åŠ¿**:
- ç²¾ç¡®æ§åˆ¶éŸ³é¢‘æ—¶é•¿ï¼ˆé¿å… rounding è¯¯å·®ï¼‰
- é€‚ç”¨äºè¾¹ç•Œæƒ…å†µæµ‹è¯•

### 2.10 Patch 2.3: å¯æ§åˆ‡åˆ†æ¨¡å¼

**æ–°å¢ç”Ÿæˆå™¨**: `makePausePatternAudio({ speakMs, pauseMs, repeats })`

**ä»£ç ä½ç½®**: `audio-aggregator.test.ts:144-177`

**è¿”å›å€¼**:
- `audio`: ç”Ÿæˆçš„éŸ³é¢‘ Buffer
- `totalMs`: æ€»æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
- `expectedSegmentsMin`: é¢„æœŸæœ€å°‘ç‰‡æ®µæ•°

**ä¼˜åŠ¿**:
- ç¡®ä¿éŸ³é¢‘èƒ½è¢« `splitAudioByEnergy` ç¨³å®šåˆ‡åˆ†
- å‡å°‘å¯¹åˆ‡åˆ†ç®—æ³•çš„è€¦åˆ

### 2.11 Â§4.2/Â§6.2 è¡¥å……ï¼šäº¤é”™ä¸å¹¶å‘ç”¨ä¾‹

**æ–°å¢ç”¨ä¾‹ 1**ï¼š`interleaved_sessions_should_not_cross_talk`
- å¤š session äº¤é”™ï¼šA1 â†’ B1 â†’ A2 â†’ B2ï¼ˆå…ˆå„ MaxDuration äº§ç”Ÿ pendingï¼Œå†å„ Manual ä¸è¶³ MIN â†’ HOLDï¼‰
- ä½¿ç”¨ decode é˜Ÿåˆ— + `createJobAssignMessage(..., { skipMock: true })` ä¿è¯æ¯æ¬¡ decode è¿”å›å¯¹åº”éŸ³é¢‘
- éªŒè¯ï¼šä¸¤ session buffer éš”ç¦»ã€pending äº’ä¸ä¸²è¯ã€æ—  ASR å‘é€ã€å„è‡ª pending ä¿æŒä¸” duration å¢åŠ 

**æ–°å¢ç”¨ä¾‹ 2**ï¼š`concurrent_sessions_should_complete_without_contamination`
- åŒ session å¹¶å‘ï¼š`Promise.all([ processAudioChunk(jobA), processAudioChunk(jobB) ])`
- éªŒè¯ï¼šä¸¤æ–¹å‡è¿”å› `!shouldReturnEmpty`ã€å„æœ‰ `audioSegments`ã€snapshot ä¸­ 2 æ¬¡ SEND ä¸”æŒ‰ `sessionId`/`jobId` å¯åŒºåˆ†

**è¯´æ˜**ï¼šçœŸå® ASR è°ƒç”¨ä¸å›è°ƒæ˜ å°„ã€ASR å›è°ƒä¹±åºç­‰ä»åœ¨ é›†æˆ/E2E å±‚è¡¥å……ã€‚

---

## ä¸‰ã€æµ‹è¯•ç»“æœ

### 3.1 æµ‹è¯•æ‰§è¡Œç»“æœ

```
PASS main/src/pipeline-orchestrator/audio-aggregator.test.ts
  AudioAggregator - é›†æˆæµ‹è¯•åœºæ™¯
    é›†æˆæµ‹è¯•åœºæ™¯ï¼šMaxDuration finalizeä¿®å¤
      âœ“ R0: MaxDurationæ®‹æ®µåˆå¹¶åä»ä¸è¶³5såº”è¯¥ç»§ç»­ç­‰å¾… (233 ms)
      âœ“ R1: MaxDurationæ®‹æ®µè¡¥é½åˆ°â‰¥5såº”è¯¥æ­£å¸¸é€ASR (191 ms)
      âœ“ R2: TTLå¼ºåˆ¶flushåº”è¯¥å¤„ç†<5sçš„éŸ³é¢‘ (161 ms)
      âœ“ R3: ASRå¤±è´¥ä¸åº”è§¦å‘ç©ºæ ¸é”€ (95 ms)
      âœ“ R4: çœŸæ­£æ— éŸ³é¢‘æ‰å…è®¸emptyæ ¸é”€ (2 ms)
      âœ“ R5: originalJobIdså¤´éƒ¨å¯¹é½åº”è¯¥å¯è§£é‡Š (187 ms)
      âœ“ pending_should_persist_across_jobs_when_merge_still_below_min (179 ms)
      âœ“ merged_duration_should_equal_pending_plus_incoming_within_tolerance (198 ms)
      âœ“ empty_finalize_should_only_happen_when_input_duration_is_zero_and_no_pending (89 ms)
      âœ“ multi_job_batch_should_be_explainable_and_must_not_empty_close_non_owner_jobs (203 ms)
      Â§4.2/Â§6.2 è¡¥å……ï¼šå¤š session äº¤é”™ä¸å¹¶å‘
        âœ“ interleaved_sessions_should_not_cross_talk (549 ms)
        âœ“ concurrent_sessions_should_complete_without_contamination (120 ms)

Test Suites: 1 passed, 1 total
Tests:       12 passed, 12 total
Time:        ~3.1 s
```

### 3.2 æµ‹è¯•è¦†ç›–ç»Ÿè®¡

| æµ‹è¯•åœºæ™¯ | æµ‹è¯•ç”¨ä¾‹ | çŠ¶æ€ |
|---------|---------|------|
| pending äº§ç”ŸéªŒè¯ | R0, R1 | âœ… é€šè¿‡ |
| pending åˆå¹¶ < MIN | R0 | âœ… é€šè¿‡ |
| pending åˆå¹¶ â‰¥ MIN | R1 | âœ… é€šè¿‡ |
| pending ç”Ÿå‘½å‘¨æœŸä¿æŒ | pending_should_persist... | âœ… é€šè¿‡ |
| mergedDurationMs å…³ç³» | merged_duration_should... | âœ… é€šè¿‡ |
| ç©ºæ ¸é”€ä¸¥æ ¼æ€§ | empty_finalize_should... | âœ… é€šè¿‡ |
| å¤š job å½’å± | multi_job_batch_should... | âœ… é€šè¿‡ |
| TTL force flush | R2 | âœ… é€šè¿‡ |
| ASR å¤±è´¥å¤„ç† | R3 | âœ… é€šè¿‡ |
| çœŸç©ºéŸ³é¢‘å¤„ç† | R4 | âœ… é€šè¿‡ |
| å¤´éƒ¨å¯¹é½ç­–ç•¥ | R5 | âœ… é€šè¿‡ |
| å¤š session äº¤é”™ï¼ˆÂ§4.2/Â§6.2ï¼‰ | interleaved_sessions_... | âœ… é€šè¿‡ |
| å¤š session å¹¶å‘ï¼ˆÂ§4.2/Â§6.2ï¼‰ | concurrent_sessions_... | âœ… é€šè¿‡ |

---

## å››ã€é—®é¢˜å‘ç°ä¸åˆ†æ

### 4.1 é€»è¾‘åˆ†æ”¯é”™è¯¯ï¼šå·²åŸºæœ¬æ’é™¤

åœ¨**å½“å‰æµ‹è¯•æ¨¡å‹å†…**ï¼Œé€šè¿‡æ–°å¢çš„æµ‹è¯•ç”¨ä¾‹å’Œ Debug Snapshotï¼ŒéªŒè¯äº†ä»¥ä¸‹ä¸šåŠ¡é€»è¾‘**æ­£ç¡®æ— è¯¯**ï¼š

1. **pending ç”Ÿå‘½å‘¨æœŸ**: âœ… æ­£ç¡®
   - pending åœ¨æœªè¾¾ MIN æ—¶æ­£ç¡®ä¿æŒ
   - pending åœ¨åˆå¹¶åæ­£ç¡®æ›´æ–° duration

2. **mergedDurationMs å…³ç³»**: âœ… æ­£ç¡®
   - `mergedDurationMs â‰ˆ pendingDurationMs + incomingDurationMs`ï¼ˆå®¹å·®å†…ï¼‰
   - duration å£å¾„ä¸€è‡´ï¼Œæ— é—®é¢˜

3. **ç©ºæ ¸é”€ä¸¥æ ¼æ€§**: âœ… æ­£ç¡®
   - åªæœ‰çœŸæ­£æ— éŸ³é¢‘æ—¶æ‰å…è®¸ empty
   - æœ‰éŸ³é¢‘æ—¶ä¸ä¼šé”™è¯¯æ ¸é”€

4. **å¤š job å½’å±**: âœ… æ­£ç¡®
   - å¤´éƒ¨å¯¹é½ç­–ç•¥æ­£ç¡®æ‰§è¡Œ
   - `ownerJobId` å’Œ `originalJobIds` ä¸€è‡´

**ç»“è®º**ï¼šã€Œé€»è¾‘åˆ†æ”¯é”™è¯¯ã€åœ¨æµ‹è¯•æ¨¡å‹å†…å·²åŸºæœ¬æ’é™¤ã€‚

### 4.2 âš ï¸ é‡è¦è¡¥å……ï¼šèƒ½é€šè¿‡æµ‹è¯• â‰  æ‰¾åˆ°çº¿ä¸Šé—®é¢˜

**è‹¥çº¿ä¸Šä»æœ‰é—®é¢˜ï¼Œæœ€å¤§æ¦‚ç‡è½åœ¨ä»¥ä¸‹ä¸¤ç±»ï¼ˆå½“å‰æµ‹è¯•æœªè¦†ç›–ï¼‰ï¼š**

| ç±»åˆ« | è¯´æ˜ | å½“å‰æµ‹è¯•ç¼ºå£ | åç»­éœ€è¡¥å…… |
|------|------|-------------|-----------|
| **å‘é€å±‚ / å›å¡«æ˜ å°„å±‚** | ASR çœŸå®è°ƒç”¨ã€å›è°ƒä¸ job çš„æ˜ å°„ã€ç»“æœå›å¡« | ä»…å¯¹ `processAudioChunk` çš„ **è¿”å›å€¼** åšå¿«ç…§ï¼Œæœª spy çœŸå® ASR è°ƒç”¨ä¸å›è°ƒæ˜ å°„ | **çœŸå® spy ASR è°ƒç”¨ä¸å›è°ƒæ˜ å°„**ï¼ˆé›†æˆ/ E2E å±‚ï¼‰ |
| **æ—¶åº / å¹¶å‘äº¤é”™** | å¤š job äº¤é”™åˆ°è¾¾ã€å¼‚æ­¥å›è°ƒä¹±åºã€å¹¶å‘ finalize | ç”¨ä¾‹å‡ä¸ºé¡ºåºã€å•çº¿ç¨‹ï¼Œæ— äº¤é”™ä¸å¹¶å‘ | **äº¤é”™ç”¨ä¾‹**ï¼ˆå¤š job äº¤é”™ã€ä¹±åºå›è°ƒç­‰ï¼‰ |

- **å‘é€å±‚ / å›å¡«æ˜ å°„å±‚**ï¼šéœ€åœ¨**é›†æˆæˆ– E2E** å±‚å¯¹ ASR å®¢æˆ·ç«¯åš **çœŸå® spy**ï¼ŒéªŒè¯ã€Œé€äº†å•¥ã€å›è°ƒå¦‚ä½•æ˜ å°„å› jobã€å›å¡«æ˜¯å¦æ­£ç¡®ã€ï¼›å•æµ‹åªéªŒè¯äº† aggregator çš„**è¾“å‡º**ï¼Œæœªè§¦åŠçœŸå®å‘é€ä¸æ˜ å°„ã€‚
- **æ—¶åº / å¹¶å‘äº¤é”™**ï¼šéœ€è¡¥å…… **äº¤é”™ã€å¹¶å‘** åœºæ™¯ï¼ˆå¦‚å¤š job äº¤é”™åˆ°è¾¾ã€ASR å›è°ƒä¹±åºï¼‰ï¼Œå¦åˆ™æ— æ³•æš´éœ²æ­¤ç±»çº¿ä¸Šé—®é¢˜ã€‚

**å› æ­¤**ï¼šç°æœ‰æµ‹è¯•æ”¹è¿›åº”å½“åˆå¹¶ï¼Œä½†**å¿…é¡»åŠ ä¸Šä¸Šè¿°ä¸¤æ¡è¡¥å……**ï¼›å¦åˆ™ã€Œæµ‹è¯•å…¨ç»¿ã€ä»ä¸ç­‰äºã€Œå·²æ‰¾åˆ°çº¿ä¸Šæ ¹å› ã€ã€‚

### 4.3 æµ‹è¯•æ”¹è¿›å¸¦æ¥çš„ä»·å€¼

1. **é—®é¢˜å®šä½èƒ½åŠ›æå‡**
   - Debug Snapshot å¯ä»¥å¿«é€Ÿå®šä½ï¼ˆåœ¨æµ‹è¯•æ¨¡å‹å†…ï¼‰"æ˜¯å¦ä¸è¯¥é€å´é€äº†"çš„é—®é¢˜
   - ä¸ä¾èµ– loggerï¼Œç›´æ¥ä»è¿”å›å€¼è·å–å…³é”®ä¿¡æ¯

2. **æµ‹è¯•ç¨³å®šæ€§æå‡**
   - å»éšæœºåŒ–ç¡®ä¿æµ‹è¯•ç»“æœå¯å¤ç°
   - Duration Helper ç»Ÿä¸€å£å¾„ï¼Œé¿å… rounding è¯¯å·®

3. **æµ‹è¯•è¦†ç›–å®Œæ•´æ€§**
   - æ–°å¢æµ‹è¯•ç”¨ä¾‹è¦†ç›–äº†å…³é”®ä¸šåŠ¡åœºæ™¯ï¼ˆé€»è¾‘åˆ†æ”¯ã€pendingã€mergedDurationã€ç©ºæ ¸é”€ã€å½’å±ï¼‰
   - æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹å·²æ¢å¤æ‰§è¡Œ

---

## äº”ã€ä»£ç å˜æ›´ç»Ÿè®¡

### 5.1 æ–°å¢ä»£ç 

- **Duration Helper**: çº¦ 30 è¡Œ
- **Debug Snapshot**: çº¦ 50 è¡Œ
- **éŸ³é¢‘ç”Ÿæˆæ”¹è¿›**: çº¦ 80 è¡Œ
- **æ–°å¢æµ‹è¯•ç”¨ä¾‹**: çº¦ 150 è¡Œ
- **æ€»è®¡**: çº¦ 310 è¡Œ

### 5.2 ä¿®æ”¹ä»£ç 

- **ç°æœ‰æµ‹è¯•ç”¨ä¾‹å¢å¼º**: çº¦ 50 è¡Œï¼ˆæ·»åŠ  Debug Snapshot è®°å½•å’ŒéªŒè¯ï¼‰
- **éŸ³é¢‘ç”Ÿæˆå‡½æ•°æ”¹è¿›**: çº¦ 20 è¡Œï¼ˆå»éšæœºåŒ–ï¼‰

### 5.3 ä»£ç è´¨é‡æå‡

- âœ… ç»Ÿä¸€äº† duration è®¡ç®—å£å¾„
- âœ… æé«˜äº†æµ‹è¯•çš„å¯ç»´æŠ¤æ€§
- âœ… å¢å¼ºäº†é—®é¢˜å®šä½èƒ½åŠ›
- âœ… æé«˜äº†æµ‹è¯•çš„ç¨³å®šæ€§

---

## å…­ã€åç»­å»ºè®®

### 6.1 å·²å®Œæˆé¡¹

âœ… æ‰€æœ‰å‚è€ƒæ–‡æ¡£è¦æ±‚çš„ Patch å‡å·²å®ç°å¹¶éªŒè¯é€šè¿‡

### 6.2 å¿…é¡»è¡¥å……ï¼ˆå¦åˆ™æ— æ³•å®šä½çº¿ä¸Šé—®é¢˜ï¼‰

1. **å‘é€å±‚ / å›å¡«æ˜ å°„å±‚**
   - åœ¨é›†æˆæˆ– E2E å±‚å¯¹ **çœŸå® ASR è°ƒç”¨** åš spy
   - éªŒè¯ï¼šé€äº†ä»€ä¹ˆã€å›è°ƒå¦‚ä½•æ˜ å°„å› jobã€å›å¡«æ˜¯å¦æ­£ç¡®
   - å½“å‰å•æµ‹åªéªŒè¯ aggregator **è¾“å‡º**ï¼Œæœªè¦†ç›–çœŸå®å‘é€ä¸æ˜ å°„

2. **æ—¶åº / å¹¶å‘äº¤é”™**ï¼ˆå•æµ‹å±‚å·²éƒ¨åˆ†è¡¥å……ï¼‰
   - å·²æ–°å¢ **äº¤é”™ç”¨ä¾‹** `interleaved_sessions_should_not_cross_talk`ï¼šå¤š session äº¤é”™ï¼ˆA1â†’B1â†’A2â†’B2ï¼‰ï¼ŒéªŒè¯ buffer éš”ç¦»ã€æ— ä¸²è¯ã€æ—  ASR è¯¯é€
   - å·²æ–°å¢ **å¹¶å‘ç”¨ä¾‹** `concurrent_sessions_should_complete_without_contamination`ï¼š`Promise.all` åŒ session å¹¶å‘ `processAudioChunk`ï¼ŒéªŒè¯å„è‡ªç»“æœæ­£ç¡®ã€snapshot æŒ‰ session å¯åŒºåˆ†
   - **æœªè¦†ç›–**ï¼šASR å›è°ƒä¹±åºã€åŒ session å†…å¹¶å‘ finalize ç­‰ï¼Œéœ€åœ¨ é›†æˆ/E2E å±‚éªŒè¯

### 6.3 å¯é€‰ä¼˜åŒ–ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

1. **æå–æµ‹è¯•å·¥å…·å‡½æ•°**
   - è€ƒè™‘å°† `createMockPcm16Audio`ã€`makePcm16BySamples`ã€`makePausePatternAudio` æå–åˆ°ç‹¬ç«‹çš„æµ‹è¯•å·¥å…·æ–‡ä»¶
   - ä¾›å…¶ä»–æµ‹è¯•æ–‡ä»¶å¤ç”¨

2. **æ·»åŠ æ›´å¤šè¾¹ç•Œæµ‹è¯•**
   - pending æ—¶é•¿æ¥è¿‘ 5ç§’çš„æƒ…å†µ
   - å¤šä¸ªè¿ç»­ MaxDuration finalize çš„æƒ…å†µ

---

## ä¸ƒã€éªŒæ”¶æ ‡å‡†

### 7.1 å‚è€ƒæ–‡æ¡£éªŒæ”¶æ ‡å‡†

æ ¹æ® `AUDIO_AGGREGATOR_TEST_ONLY_MIN_PATCHLIST_AND_REGRESSION_CHECKLIST.md` çš„éªŒæ”¶æ ‡å‡†ï¼š

- âœ… **ä¸ä¾èµ– logger** ä¹Ÿèƒ½ä»è¿”å›å€¼/spy æ‹¿åˆ°å…³é”®å¿«ç…§
- âœ… **èƒ½æ˜ç¡®å›ç­”å››ä¸ªé—®é¢˜**:
  - âœ… pending æ˜¯å¦è¢«æ„å¤–æ¸…ç©º/è¦†ç›– - é€šè¿‡æµ‹è¯•éªŒè¯ï¼Œæ— é—®é¢˜
  - âœ… mergedDurationMs æ˜¯å¦ç­‰äº pending + incoming - é€šè¿‡æµ‹è¯•éªŒè¯ï¼Œæ­£ç¡®
  - âœ… empty æ ¸é”€æ˜¯å¦åªå‘ç”Ÿåœ¨"ç¡®å®æ— éŸ³é¢‘" - é€šè¿‡æµ‹è¯•éªŒè¯ï¼Œæ­£ç¡®
  - âœ… å¤š job å½’å±æ˜¯å¦å¯è§£é‡Šä¸”ä¸å job - é€šè¿‡æµ‹è¯•éªŒè¯ï¼Œæ­£ç¡®

### 7.2 å›å½’æµ‹è¯•è¦†ç›–

- âœ… R0: åˆå¹¶å < MIN å¿…é¡» HOLDï¼ˆä¸é€ ASRï¼‰
- âœ… R1: åˆå¹¶å â‰¥ MIN å¿…é¡»é€ ASRï¼Œreason ä¸º merge ç±»
- âœ… R2: TTL force flush ä»é€šè¿‡ï¼ˆpending ä¸åº”æ— é™ç­‰å¾…ï¼‰
- âœ… R3: ASR failure ä¸è§¦å‘ empty æ ¸é”€
- âœ… R4: çœŸç©ºéŸ³é¢‘å…è®¸ empty
- âœ… R5: originalJobIds å¤´éƒ¨å¯¹é½å¯è§£é‡Šæ€§ä»æˆç«‹
- âœ… æ–°å¢ï¼špending è·¨ job ä¿æŒï¼ˆæœªè¾¾ MIN ä¸åº”æ¸…ç©ºï¼‰
- âœ… æ–°å¢ï¼šmergedDuration â‰ˆ pending+incomingï¼ˆå®¹å·®å†…ï¼‰
- âœ… æ–°å¢ï¼šempty æ ¸é”€ä¸¥æ ¼ï¼ˆä»…çœŸç©ºè¾“å…¥ï¼‰
- âœ… æ–°å¢ï¼šå¤š job å½’å±å¯è§£é‡Šä¸”ä¸å job

---

## å…«ã€æ€»ç»“

### 8.1 å®Œæˆåº¦

âœ… **100% å®Œæˆ**: æ‰€æœ‰å‚è€ƒæ–‡æ¡£è¦æ±‚çš„ Patch å‡å·²å®ç°å¹¶éªŒè¯é€šè¿‡

### 8.2 æµ‹è¯•è´¨é‡

- **æµ‹è¯•æ•°é‡**: 12 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼ˆåŸ 6 ä¸ª + æ–°å¢ 4 ä¸ª + Â§4.2/Â§6.2 è¡¥å…… 2 ä¸ªï¼šäº¤é”™ã€å¹¶å‘ï¼‰
- **æµ‹è¯•é€šè¿‡ç‡**: 100%
- **æµ‹è¯•è¦†ç›–**: å®Œæ•´è¦†ç›–å…³é”®ä¸šåŠ¡åœºæ™¯ï¼ˆé€»è¾‘åˆ†æ”¯ã€pendingã€mergedDurationã€ç©ºæ ¸é”€ã€å½’å±ï¼‰
- **æµ‹è¯•ç¨³å®šæ€§**: é€šè¿‡å»éšæœºåŒ–å’Œç»Ÿä¸€å£å¾„ï¼Œæ˜¾è‘—æå‡

### 8.3 é—®é¢˜å‘ç°

- âœ… **é€»è¾‘åˆ†æ”¯é”™è¯¯å·²åŸºæœ¬æ’é™¤**ï¼ˆåœ¨æµ‹è¯•æ¨¡å‹å†…éªŒè¯ï¼‰
- âš ï¸ **èƒ½é€šè¿‡æµ‹è¯• â‰  æ‰¾åˆ°çº¿ä¸Šé—®é¢˜**ï¼šè‹¥çº¿ä¸Šä»æœ‰é—®é¢˜ï¼Œæœ€å¤§æ¦‚ç‡åœ¨ **å‘é€å±‚/å›å¡«æ˜ å°„å±‚** æˆ– **æ—¶åº/å¹¶å‘äº¤é”™**ï¼Œéœ€æŒ‰ Â§4.2ã€Â§6.2 åšä¸¤ç±»è¡¥å……ï¼ˆçœŸå® ASR spy + äº¤é”™ç”¨ä¾‹ï¼‰

### 8.4 å»ºè®®è¡ŒåŠ¨

1. **âœ… æ‰¹å‡†åˆå¹¶**: å»ºè®®æ‰¹å‡†æœ¬æ¬¡æµ‹è¯•æ”¹è¿›åˆå¹¶åˆ°ä¸»åˆ†æ”¯
   - æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œæ— ä¸šåŠ¡é€»è¾‘é£é™©
   - é€»è¾‘åˆ†æ”¯åœ¨æµ‹è¯•æ¨¡å‹å†…å·²éªŒè¯ï¼Œæµ‹è¯•è´¨é‡ä¸å¯ç»´æŠ¤æ€§æå‡

2. **ğŸ“‹ å¿…é¡»è¡¥å……ï¼ˆå¦åˆ™éš¾ä»¥å®šä½çº¿ä¸Šé—®é¢˜ï¼‰**:
   - **å‘é€å±‚ / å›å¡«æ˜ å°„å±‚**ï¼šçœŸå® spy ASR è°ƒç”¨ä¸å›è°ƒæ˜ å°„ï¼ˆé›†æˆ/E2Eï¼‰
   - **æ—¶åº / å¹¶å‘äº¤é”™**ï¼šå•æµ‹å·²è¡¥å……å¤š session äº¤é”™ã€å¹¶å‘ç”¨ä¾‹ï¼›ASR å›è°ƒä¹±åºã€åŒ session å¹¶å‘ç­‰éœ€ é›†æˆ/E2E

3. **ğŸ“‹ å¯é€‰**:
   - æå–æµ‹è¯•å·¥å…·å‡½æ•°åˆ°ç‹¬ç«‹æ–‡ä»¶
   - æ·»åŠ æ›´å¤šè¾¹ç•Œæƒ…å†µæµ‹è¯•

---

## æ–‡æ¡£ç‰ˆæœ¬

- **ç‰ˆæœ¬**: v1.0
- **æœ€åæ›´æ–°**: 2026-01-27
- **ä½œè€…**: AI Assistant (Auto)
- **å®¡æ ¸çŠ¶æ€**: å¾…å†³ç­–éƒ¨é—¨å®¡æ ¸
