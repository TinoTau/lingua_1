# Job句尾丢失问题分析

**日期**: 2026-01-28  
**问题**: 多个job丢失了句尾的半句话

---

## 一、问题现象

**用户返回结果**：
```
[3] 接下來這一句 我會盡量連續的說的長一些中間只把流自然的呼吸節奏不做可以的停頓看看在超過 如果10秒鐘之後系統會不會因為操實或者進行判定而強行把這句話解斷
[5] 前半句和後半句再解斷被拆分成不同的任務甚至出現 現在與意義上的不完整獨起來前後不臉罐的情況
[11] 我們還需要繼續分析日治找出到底是在哪一個環節把我的語音給吃掉了
```

**预期文本**：
```
[3] 接下來這一句我會盡量連續地說得長一些，中間只保留自然的呼吸節奏，不做刻意的停頓，看看在超過十秒鐘之後，系統會不會因為超時或者靜音判定而強行把這句話截斷，從而導致前半句和後半句在節點端被拆成兩個不同的 job，甚至出現語義上不完整、讀起來前後不連貫的情況。
[5] 如果這次的長句能夠被完整地識別出來，而且不會出現半句話被提前發送或者直接丟失的現象，那就說明我們當前的切分策略和超時規則是基本可用的。否則，我們還需要繼續分析日誌，找出到底是在哪一個環節把我的語音吃掉了。
[11] 否則，我們還需要繼續分析日誌，找出到底是在哪一個環節把我的語音吃掉了。
```

**问题**：
1. job3 (utteranceIndex=3) 缺少后半部分
2. job5 (utteranceIndex=5) 缺少前半部分
3. job11 (utteranceIndex=11) 缺少前半部分

---

## 二、日志分析结果

### 2.1 Job3 (job-960d8f27) 的处理流程

**从日志看到**：
- 有3个batch，合并后76字符
- TextMerge显示所有batch都成功接收
- 没有missing segment

**ASR批次**：
- Batch 0: "接下來這一句" (6字符)
- Batch 1: "我會盡量連續的說的長一些中間只把流自然的呼吸節奏不做可以的停頓看看在超過" (36字符)
- Batch 2: "如果10秒鐘之後系統會不會因為操實或者進行判定而強行把這句話解斷" (32字符)

**合并后**：
- "接下來這一句我會盡量連續的說的長一些中間只把流自然的呼吸節奏不做可以的停頓看看在超過如果10秒鐘之後系統會不會因為操實或者進行判定而強行把這句話解斷" (76字符)

**问题**：
- 文本不完整，缺少后半部分（"從而導致前半句和後半句在節點端被拆成兩個不同的 job..."）

### 2.2 Job5 (job-23b12aac) 的处理流程

**从日志看到**：
- 有2个batch，合并后45字符
- TextMerge显示所有batch都成功接收
- 没有missing segment

**ASR批次**：
- Batch 0: "前半句和後半句再解斷被拆分成不同的任務甚至出現" (23字符)
- Batch 1: "現在與意義上的不完整獨起來前後不臉罐的情況" (21字符)

**合并后**：
- "前半句和後半句再解斷被拆分成不同的任務甚至出現現在與意義上的不完整獨起來前後不臉罐的情況" (45字符)

**问题**：
- 文本不完整，缺少前半部分（"如果這次的長句能夠被完整地識別出來..."）

### 2.3 Job11 (job-e94b2cb6) 的处理流程

**从日志看到**：
- 只有1个batch，31字符
- TextMerge显示batch成功接收
- 没有missing segment

**ASR批次**：
- Batch 0: "我們還需要繼續分析日治找出到底是在哪一個環節把我的語音給吃掉了" (31字符)

**问题**：
- 文本不完整，缺少前半部分（"否則，"）

---

## 三、根本原因分析

### 3.1 Forward Merge不会截断文本

**从代码确认**：
```typescript
/// Invariant 1: Gate 输出语义不变量
/// processText / decideGateAction 永远返回完整 mergedText。
/// 禁止返回裁剪片段（如 dedupResult.text）。
/// 所有 SEND/HOLD/DROP 决策必须基于完整 mergedText。
```

**结论**：
- Forward merge不会截断文本
- 只会决定是否发送（SEND/HOLD/DROP）
- 不会丢弃文本

### 3.2 可能的原因

**原因1: ASR服务返回的文本不完整**
- ASR服务可能因为音频质量问题或超时，只返回了部分文本
- 从日志看，所有batch都成功接收，没有missing segment
- 但ASR返回的文本本身可能就不完整

**原因2: 音频被错误地切分**
- 音频在切分时可能被错误地分割
- 导致某些音频片段没有被送入ASR
- 或者某些音频片段被错误地分配到了其他job

**原因3: 某些batch被错误地分配到了其他job**
- 类似之前的batch分配问题
- 某些batch可能被分配到了其他job，导致当前job的文本不完整

---

## 四、下一步分析

### 4.1 检查ASR服务返回的文本

**需要检查**：
- ASR服务是否返回了完整的文本
- 是否有音频被拒绝（RMS过低）
- 是否有ASR超时导致文本不完整

### 4.2 检查音频切分和分配

**需要检查**：
- 音频切分是否正确
- batch分配是否正确
- 是否有音频片段被遗漏

### 4.3 检查batch分配

**需要检查**：
- 是否有batch被错误地分配到了其他job
- 是否有batch被遗漏

---

## 五、总结

### 5.1 问题确认

- ✅ **Forward merge不会截断文本**：代码明确说明不会截断
- ❌ **ASR返回的文本可能不完整**：需要进一步检查
- ❌ **音频切分可能有问题**：需要进一步检查
- ❌ **batch分配可能有问题**：需要进一步检查

### 5.2 下一步行动

1. **检查ASR服务日志**：确认ASR是否返回了完整的文本
2. **检查音频切分日志**：确认音频是否被正确切分
3. **检查batch分配日志**：确认batch是否被正确分配

---

*本分析基于日志数据，需要进一步检查ASR服务和音频切分的详细日志。*
