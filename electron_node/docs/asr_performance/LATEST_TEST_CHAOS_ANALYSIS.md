# 最新测试结果混乱分析

**日期**: 2026-01-28  
**问题**: 测试结果更加混乱，有的job少了前半句，有的少了后半句，文本顺序混乱

---

## 一、测试结果

### 1.1 原文

```
现在我们开始进行一次语音识别稳定性测试。
我会先读一两句比较短的话，用来确认系统不会在句子之间随意地把语音切断，或者在没有必要的时候提前结束本次识别。

接下来这一句我会尽量连续地说得长一些，中间只保留自然的呼吸节奏，不做刻意的停顿，看看在超过十秒钟之后，系统会不会因为超时或者静音判定而强行把这句话截断，从而导致前半句和后半句在节点端被拆成两个不同的 job，甚至出现语义上不完整、读起来前后不连贯的情况。

如果这次的长句能够被完整地识别出来，而且不会出现半句话被提前发送或者直接丢失的现象，那就说明我们当前的切分策略和超时规则是基本可用的。
否则，我们还需要继续分析日志，找出到底是在哪一个环节把我的语音吃掉了。
```

### 1.2 返回结果

**原文 (ASR)**:
- [0] 開始進行次語音識別穩定性測試
- [2] 第二的時候,提前結束本次識別
- [1] [音频丢失] 我會先讀音樂 一兩句比較短的話,通來確認系統會不會在句子之間隨意的把語音切斷或者在沒有?
- [3] 接下來最. 一句,我會盡量連續的說的長一些中間直報 留自然的呼吸節奏不做刻意的停頓看看在超過10秒鐘之後系統會不會因為超市或者經營判定而詳細把這句話解斷雖然導致
- [5] 前半句和後半句的解點端被插翻成不同的任務,甚至出現 與意義上不完整,讀起來前後不連貫的情況
- [8] 我們當前的缺分策略和超市規則是基本可用的
- [7] [音频丢失] 下次的長距能夠被完整的識別出來,而且不會出現半句話被提前發送或者直接丟失的性向,那就說明我
- [9] 否則我們按. 還需要繼續分析日誌找出到底是哪一個環節把我的語音給吃掉了

**问题**:
1. ❌ **顺序混乱**: job顺序是 [0, 2, 1, 3, 5, 8, 7, 9]，不是按顺序的
2. ❌ **文本丢失**: job1和job7标记为"[音频丢失]"
3. ❌ **前半句丢失**: job0只有"開始進行次語音識別穩定性測試"，缺少"現在我們"
4. ❌ **后半句丢失**: job7只有前半句，缺少"那就說明我們當前的切分策略和超時規則"
5. ❌ **文本不完整**: 多个job的文本不完整

---

## 二、需要检查的内容

### 2.1 每个Job的处理流程

**需要检查**:
1. **Job注册**: utterance_index, job_id, session_id
2. **音频处理**: 音频时长, 音频切分, batch数量
3. **ASR处理**: ASR批次, batchIndex, originalJobId, ASR文本
4. **文本合并**: TextMerge, 合并后的文本
5. **聚合处理**: Aggregation, 聚合后的文本
6. **语义修复**: SemanticRepair, 修复后的文本
7. **最终结果**: 发送给调度服务器的文本

### 2.2 关键问题点

**需要重点检查**:
1. **空容器检测**: 是否有job被错误标记为"empty container"或"NO_TEXT_ASSIGNED"
2. **音频质量**: 是否有音频被拒绝（RMS低于阈值）
3. **batch分配**: batchIndex是否正确，originalJobId是否正确
4. **文本合并**: TextMerge是否正确合并了所有batch
5. **顺序问题**: 为什么job顺序混乱（[0, 2, 1, 3, 5, 8, 7, 9]）

---

## 三、分析步骤

### 3.1 步骤1: 提取所有job_id

**命令**:
```powershell
Get-Content electron-node\logs\electron-main.log | Select-String -Pattern "job_id" | Select-Object -First 50
```

### 3.2 步骤2: 分析每个job的完整流程

**对于每个job_id，检查**:
1. utterance_index
2. ASR批次数量和内容
3. TextMerge结果
4. 空容器检测
5. 音频质量检查

### 3.3 步骤3: 核对每个job对应的原文

**需要核对**:
- Job0应该对应: "现在我们开始进行一次语音识别稳定性测试。"
- Job1应该对应: "我会先读一两句比较短的话，用来确认系统不会在句子之间随意地把语音切断，或者在没有必要的时候提前结束本次识别。"
- Job2应该对应: "接下来这一句我会尽量连续地说得长一些..."
- 等等

---

## 四、可能的原因

### 4.1 顺序混乱的原因

**可能原因**:
1. **batchIndex混乱**: batchIndex分配不正确，导致文本顺序混乱
2. **originalJobId错误**: batch被分配到了错误的originalJobId
3. **TextMerge顺序错误**: TextMerge时没有按batchIndex排序

### 4.2 文本丢失的原因

**可能原因**:
1. **空容器检测错误**: job被错误标记为"empty container"，导致文本被清空
2. **音频质量拒绝**: 音频被拒绝，导致没有ASR结果
3. **batch丢失**: 某些batch没有被处理或丢失
4. **TextMerge不完整**: TextMerge时没有包含所有batch

### 4.3 前半句/后半句丢失的原因

**可能原因**:
1. **音频切分错误**: 音频被错误切分，导致前半句或后半句丢失
2. **batch分配错误**: batch被分配到了错误的job
3. **pendingMaxDurationAudio处理错误**: pending音频没有被正确处理

---

## 五、建议的检查方法

### 5.1 使用grep查找关键日志

**查找job注册**:
```bash
grep -i "utterance_index" electron-node/logs/electron-main.log | head -20
```

**查找ASR批次**:
```bash
grep -i "ASR batch\|addASRSegment" electron-node/logs/electron-main.log | head -30
```

**查找TextMerge**:
```bash
grep -i "TextMerge\|Merged ASR batches" electron-node/logs/electron-main.log | head -20
```

**查找空容器**:
```bash
grep -i "empty container\|NO_TEXT_ASSIGNED" electron-node/logs/electron-main.log
```

### 5.2 按utterance_index排序分析

**建议**:
1. 提取所有job的utterance_index和job_id
2. 按utterance_index排序
3. 分析每个job的处理流程
4. 核对每个job对应的原文

---

## 六、下一步行动

1. **检查日志文件位置**: 确认日志文件的实际路径
2. **提取所有job信息**: 提取所有job的utterance_index, job_id, session_id
3. **分析每个job的流程**: 检查ASR批次, TextMerge, 空容器检测等
4. **核对原文对应**: 确认每个job对应的原文是什么
5. **找出根本原因**: 分析为什么会出现顺序混乱和文本丢失

---

*本分析文档用于指导日志分析，找出文本丢失和顺序混乱的根本原因。*
