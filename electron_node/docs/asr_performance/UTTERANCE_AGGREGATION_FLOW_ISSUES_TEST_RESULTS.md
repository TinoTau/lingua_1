# Utteranceèšåˆæµç¨‹æ½œåœ¨é—®é¢˜æµ‹è¯•ç»“æœ

**æ—¥æœŸ**: 2026-01-27  
**æµ‹è¯•æ–‡ä»¶**: `utterance-aggregation-flow-issues.test.ts`  
**ç›®çš„**: éªŒè¯æ–‡æ¡£ä¸­æåˆ°çš„6ä¸ªæ½œåœ¨é—®é¢˜æ˜¯å¦å±å®ï¼Œä»¥åŠè¿™äº›æ­¥éª¤æ˜¯å¦å¿…è¦

---

## ä¸€ã€æµ‹è¯•æ¦‚è¿°

### 1.1 æµ‹è¯•ç›®æ ‡

éªŒè¯ä»¥ä¸‹6ä¸ªæ½œåœ¨é—®é¢˜ï¼š
1. `getLastCommittedText()` æ˜¯å¦é‡å¤è°ƒç”¨
2. `SemanticRepairInitializer` æ˜¯å¦é‡å¤åˆå§‹åŒ–
3. `getServiceIdForLanguage()` å’Œ `selectServiceEndpoint()` æ˜¯å¦é‡å¤æŸ¥æ‰¾
4. `checkServiceHealth()` æ˜¯å¦æ¯æ¬¡è°ƒç”¨éƒ½æ£€æŸ¥
5. `shouldRepair()` åˆ¤æ–­æ˜¯å¦å¿…è¦
6. `lastCommittedText` ä¼ é€’æ˜¯å¦ä¸€è‡´

### 1.2 æµ‹è¯•æ–¹æ³•

- ä½¿ç”¨Jestæ¡†æ¶ç¼–å†™å•å…ƒæµ‹è¯•
- é€šè¿‡Mockå¯¹è±¡éªŒè¯æ–¹æ³•è°ƒç”¨æ¬¡æ•°
- æ£€æŸ¥ç¼“å­˜æœºåˆ¶æ˜¯å¦ç”Ÿæ•ˆ
- éªŒè¯ä¼˜åŒ–æ˜¯å¦æœ‰æ•ˆ

---

## äºŒã€æµ‹è¯•ç»“æœ

### 2.1 é—®é¢˜1: `getLastCommittedText()` æ˜¯å¦é‡å¤è°ƒç”¨

#### æµ‹è¯•ç”¨ä¾‹1: aggregation-stepä¸­è°ƒç”¨ä¸€æ¬¡å¹¶ç¼“å­˜åˆ°ctx
**ç»“æœ**: âœ… **é€šè¿‡**
- `getLastCommittedText()` åœ¨ `aggregation-step.ts` ä¸­è¢«è°ƒç”¨ä¸€æ¬¡
- ç»“æœè¢«æ­£ç¡®ç¼“å­˜åˆ° `ctx.lastCommittedText`
- **ç»“è®º**: å®ç°æ­£ç¡®ï¼Œå·²åšä¼˜åŒ–

#### æµ‹è¯•ç”¨ä¾‹2: semantic-repair-stepä¸­ä¼˜å…ˆä½¿ç”¨ctx.lastCommittedText
**ç»“æœ**: âœ… **é€šè¿‡**
- å¦‚æœ `ctx.lastCommittedText` å·²è®¾ç½®ï¼Œ`semantic-repair-step.ts` ä¸ä¼šé‡å¤è°ƒç”¨ `getLastCommittedText()`
- **ç»“è®º**: ä¼˜åŒ–æœ‰æ•ˆï¼Œé¿å…é‡å¤è°ƒç”¨

#### æµ‹è¯•ç”¨ä¾‹3: ctx.lastCommittedTextä¸ºundefinedæ—¶è°ƒç”¨getLastCommittedText
**ç»“æœ**: âœ… **é€šè¿‡**
- å¦‚æœ `ctx.lastCommittedText` ä¸º `undefined`ï¼Œ`semantic-repair-step.ts` ä¼šè°ƒç”¨ `getLastCommittedText()`
- **ç»“è®º**: è¿™æ˜¯å¿…è¦çš„å›é€€æœºåˆ¶ï¼Œç¡®ä¿æ•°æ®å¯ç”¨

#### æµ‹è¯•ç”¨ä¾‹4: ctx.lastCommittedTextä¸ºnullæ—¶ä¸é‡å¤è°ƒç”¨
**ç»“æœ**: âœ… **é€šè¿‡**
- å¦‚æœ `ctx.lastCommittedText` ä¸º `null`ï¼Œ`semantic-repair-step.ts` ä¸ä¼šè°ƒç”¨ `getLastCommittedText()`
- **ç»“è®º**: å®ç°æ­£ç¡®ï¼Œ`null` è¡¨ç¤ºæ²¡æœ‰ä¸Šä¸€ä¸ªå·²æäº¤çš„æ–‡æœ¬

#### æ€»ä½“ç»“è®º
- âœ… **é—®é¢˜å·²ä¼˜åŒ–**: `getLastCommittedText()` çš„é‡å¤è°ƒç”¨é—®é¢˜å·²ç»é€šè¿‡ç¼“å­˜æœºåˆ¶è§£å†³
- âš ï¸ **æ½œåœ¨æ”¹è¿›**: å¦‚æœ `aggregation-step.ts` è¿”å› `null`ï¼Œåº”è¯¥ç¡®ä¿ `ctx.lastCommittedText` è¢«è®¾ç½®ä¸º `null`ï¼ˆè€Œä¸æ˜¯ `undefined`ï¼‰ï¼Œä»¥é¿å… `semantic-repair-step.ts` é‡å¤è·å–

---

### 2.2 é—®é¢˜2: `SemanticRepairInitializer` æ˜¯å¦é‡å¤åˆå§‹åŒ–

#### æµ‹è¯•ç”¨ä¾‹1: æ¯æ¬¡è°ƒç”¨runSemanticRepairStepéƒ½åˆ›å»ºæ–°å®ä¾‹
**ç»“æœ**: âš ï¸ **ç¡®è®¤é—®é¢˜å­˜åœ¨**
- æ¯æ¬¡è°ƒç”¨ `runSemanticRepairStep()` éƒ½ä¼šåˆ›å»ºæ–°çš„ `SemanticRepairInitializer` å®ä¾‹
- **ç»“è®º**: è¿™æ˜¯æ½œåœ¨çš„æ€§èƒ½é—®é¢˜ï¼Œå»ºè®®å¤ç”¨å®ä¾‹

#### æµ‹è¯•ç”¨ä¾‹2: å¦‚æœå·²åˆå§‹åŒ–ï¼Œè·³è¿‡initializeè°ƒç”¨
**ç»“æœ**: âœ… **éƒ¨åˆ†ä¼˜åŒ–**
- å¦‚æœ `isInitialized()` è¿”å› `true`ï¼Œä¸ä¼šç­‰å¾…åˆå§‹åŒ–å®Œæˆ
- ä½†æ¯æ¬¡ä»ä¼šåˆ›å»ºæ–°å®ä¾‹ï¼Œæœ‰å¯¹è±¡åˆ›å»ºå¼€é”€
- **ç»“è®º**: æœ‰éƒ¨åˆ†ä¼˜åŒ–ï¼Œä½†ä»æœ‰æ”¹è¿›ç©ºé—´

#### æ€»ä½“ç»“è®º
- âŒ **é—®é¢˜ç¡®å®å­˜åœ¨**: `SemanticRepairInitializer` æ¯æ¬¡è°ƒç”¨éƒ½ä¼šåˆ›å»ºæ–°å®ä¾‹
- ğŸ’¡ **ä¼˜åŒ–å»ºè®®**: å°† `SemanticRepairInitializer` ä½œä¸º `ServicesBundle` çš„ä¸€éƒ¨åˆ†ï¼Œå¤ç”¨å®ä¾‹
- ğŸ“Š **æ€§èƒ½å½±å“**: è½»å¾®ï¼ˆå¯¹è±¡åˆ›å»ºå¼€é”€è¾ƒå°ï¼Œä½†ç´¯ç§¯èµ·æ¥å¯èƒ½å½±å“æ€§èƒ½ï¼‰

---

### 2.3 é—®é¢˜3: `getServiceIdForLanguage()` å’Œ `selectServiceEndpoint()` æ˜¯å¦é‡å¤æŸ¥æ‰¾

#### æµ‹è¯•ç”¨ä¾‹1: æ¯æ¬¡è°ƒç”¨routeSemanticRepairTaskéƒ½æŸ¥æ‰¾æœåŠ¡ç«¯ç‚¹
**ç»“æœ**: âŒ **ç¡®è®¤é—®é¢˜å­˜åœ¨**
- æ¯æ¬¡è°ƒç”¨ `routeSemanticRepairTask()` éƒ½ä¼šè°ƒç”¨ `getServiceEndpointById()` æˆ– `selectServiceEndpoint()`
- æ²¡æœ‰ç¼“å­˜æœºåˆ¶
- **ç»“è®º**: è¿™æ˜¯æ½œåœ¨çš„æ€§èƒ½é—®é¢˜ï¼Œå»ºè®®æ·»åŠ ç¼“å­˜

#### æ€»ä½“ç»“è®º
- âŒ **é—®é¢˜ç¡®å®å­˜åœ¨**: æœåŠ¡ç«¯ç‚¹æŸ¥æ‰¾æ²¡æœ‰ç¼“å­˜ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½ä¼šæŸ¥æ‰¾
- ğŸ’¡ **ä¼˜åŒ–å»ºè®®**: æŒ‰è¯­è¨€ç¼“å­˜æœåŠ¡ç«¯ç‚¹ï¼Œå½“æœåŠ¡çŠ¶æ€æ”¹å˜æ—¶æ¸…é™¤ç¼“å­˜
- ğŸ“Š **æ€§èƒ½å½±å“**: ä¸­ç­‰ï¼ˆæœåŠ¡æŸ¥æ‰¾æ¶‰åŠçŠ¶æ€æŸ¥è¯¢ï¼Œå¯èƒ½æœ‰ä¸€å®šå¼€é”€ï¼‰

---

### 2.4 é—®é¢˜4: `checkServiceHealth()` æ˜¯å¦æ¯æ¬¡è°ƒç”¨éƒ½æ£€æŸ¥

#### æµ‹è¯•ç”¨ä¾‹1: æ¯æ¬¡è°ƒç”¨routeSemanticRepairTaskéƒ½æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
**ç»“æœ**: âœ… **éƒ¨åˆ†ä¼˜åŒ–**
- æœ‰å¥åº·æ£€æŸ¥ç¼“å­˜æœºåˆ¶ï¼ˆ`SemanticRepairHealthChecker`ï¼‰
- ä½†å¦‚æœç¼“å­˜è¿‡æœŸï¼Œä»ä¼šè°ƒç”¨ `checkServiceHealth()`
- **ç»“è®º**: æœ‰ç¼“å­˜æœºåˆ¶ï¼Œä½†ç¼“å­˜å¯èƒ½è¿‡æœŸ

#### æ€»ä½“ç»“è®º
- âœ… **å·²æœ‰ä¼˜åŒ–**: å¥åº·æ£€æŸ¥æœ‰ç¼“å­˜æœºåˆ¶
- âš ï¸ **æ½œåœ¨æ”¹è¿›**: å¯ä»¥ä¼˜åŒ–ç¼“å­˜æ—¶é—´ï¼Œå‡å°‘è¿‡æœŸé¢‘ç‡
- ğŸ“Š **æ€§èƒ½å½±å“**: ä½ï¼ˆæœ‰ç¼“å­˜æœºåˆ¶ï¼Œä½†è¿‡æœŸæ—¶ä»æœ‰HTTPè¯·æ±‚å¼€é”€ï¼‰

---

### 2.5 é—®é¢˜5: `shouldRepair()` åˆ¤æ–­æ˜¯å¦å¿…è¦

#### æµ‹è¯•ç”¨ä¾‹1: shouldRepairè¿”å›falseæ—¶ä¸è°ƒç”¨æœåŠ¡
**ç»“æœ**: âœ… **é€šè¿‡**
- å¦‚æœ `shouldRepair()` è¿”å› `false`ï¼Œ`process()` ä¼šå¿«é€Ÿè¿”å› `PASS`ï¼Œä¸è°ƒç”¨ `taskRouter.routeSemanticRepairTask()`
- **ç»“è®º**: åˆ¤æ–­æ˜¯å¿…è¦çš„ï¼Œå¯ä»¥é¿å…ä¸å¿…è¦çš„æœåŠ¡è°ƒç”¨

#### æµ‹è¯•ç”¨ä¾‹2: shouldRepairè¿”å›trueæ—¶è°ƒç”¨æœåŠ¡
**ç»“æœ**: âœ… **é€šè¿‡**
- å¦‚æœ `shouldRepair()` è¿”å› `true`ï¼Œ`process()` ä¼šè°ƒç”¨ `taskRouter.routeSemanticRepairTask()`
- **ç»“è®º**: åˆ¤æ–­é€»è¾‘æ­£ç¡®

#### æ€»ä½“ç»“è®º
- âœ… **åˆ¤æ–­æ˜¯å¿…è¦çš„**: `shouldRepair()` åˆ¤æ–­å¯ä»¥é¿å…ä¸å¿…è¦çš„æœåŠ¡è°ƒç”¨
- ğŸ“Š **æ€§èƒ½å½±å“**: æ­£é¢ï¼ˆå‡å°‘ä¸å¿…è¦çš„HTTPè¯·æ±‚ï¼‰

---

### 2.6 é—®é¢˜6: `lastCommittedText` ä¼ é€’æ˜¯å¦ä¸€è‡´

#### æµ‹è¯•ç”¨ä¾‹1: aggregation-stepåº”è¯¥æ€»æ˜¯è®¾ç½®ctx.lastCommittedText
**ç»“æœ**: âš ï¸ **éƒ¨åˆ†é—®é¢˜**
- `aggregation-step.ts` ä¼šå°† `getLastCommittedText()` çš„ç»“æœç¼“å­˜åˆ° `ctx.lastCommittedText`
- ä½†å¦‚æœè¿”å› `null`ï¼Œä¼šè¢«è½¬æ¢ä¸º `undefined`ï¼ˆ`ctx.lastCommittedText = lastCommittedText || undefined`ï¼‰
- **ç»“è®º**: è¿™å¯èƒ½å¯¼è‡´ `semantic-repair-step.ts` é‡å¤è·å–ï¼ˆå¦‚æœ `ctx.lastCommittedText` ä¸º `undefined`ï¼‰

#### æµ‹è¯•ç”¨ä¾‹2: å¦‚æœaggregation-stepè¿”å›nullï¼Œsemantic-repair-stepä¸åº”è¯¥é‡å¤è·å–
**ç»“æœ**: âš ï¸ **éƒ¨åˆ†é—®é¢˜**
- å¦‚æœ `ctx.lastCommittedText` ä¸º `null`ï¼Œ`semantic-repair-step.ts` ä¸ä¼šè°ƒç”¨ `getLastCommittedText()`
- ä½†å¦‚æœ `ctx.lastCommittedText` ä¸º `undefined`ï¼Œä¼šè°ƒç”¨ `getLastCommittedText()`
- **ç»“è®º**: å­˜åœ¨ä¸ä¸€è‡´æ€§ï¼Œ`null` å’Œ `undefined` çš„å¤„ç†ä¸åŒ

#### æµ‹è¯•ç”¨ä¾‹3: å¦‚æœaggregation-stepæœªè®¾ç½®ctx.lastCommittedTextï¼Œsemantic-repair-stepåº”è¯¥è·å–
**ç»“æœ**: âœ… **é€šè¿‡**
- å¦‚æœ `ctx.lastCommittedText` ä¸º `undefined`ï¼Œ`semantic-repair-step.ts` ä¼šè°ƒç”¨ `getLastCommittedText()`
- **ç»“è®º**: è¿™æ˜¯å¿…è¦çš„å›é€€æœºåˆ¶

#### æ€»ä½“ç»“è®º
- âš ï¸ **å­˜åœ¨ä¸ä¸€è‡´æ€§**: `aggregation-step.ts` å°† `null` è½¬æ¢ä¸º `undefined`ï¼Œå¯¼è‡´ `semantic-repair-step.ts` å¯èƒ½é‡å¤è·å–
- ğŸ’¡ **ä¼˜åŒ–å»ºè®®**: åœ¨ `aggregation-step.ts` ä¸­ç¡®ä¿ `ctx.lastCommittedText` æ€»æ˜¯è¢«è®¾ç½®ï¼ˆå³ä½¿æ˜¯ `null`ï¼‰ï¼Œé¿å…ä½¿ç”¨ `|| undefined`
- ğŸ“Š **æ€§èƒ½å½±å“**: è½»å¾®ï¼ˆé‡å¤è·å–çš„å¼€é”€è¾ƒå°ï¼‰

---

## ä¸‰ã€é—®é¢˜æ€»ç»“

### 3.1 å·²ä¼˜åŒ–çš„é—®é¢˜

| é—®é¢˜ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| é—®é¢˜1: `getLastCommittedText()` é‡å¤è°ƒç”¨ | âœ… å·²ä¼˜åŒ– | é€šè¿‡ç¼“å­˜æœºåˆ¶è§£å†³ï¼Œä½†ä»æœ‰æ”¹è¿›ç©ºé—´ |
| é—®é¢˜4: `checkServiceHealth()` æ¯æ¬¡æ£€æŸ¥ | âœ… å·²ä¼˜åŒ– | æœ‰ç¼“å­˜æœºåˆ¶ï¼Œä½†ç¼“å­˜å¯èƒ½è¿‡æœŸ |
| é—®é¢˜5: `shouldRepair()` åˆ¤æ–­æ˜¯å¦å¿…è¦ | âœ… å¿…è¦ | åˆ¤æ–­æ˜¯å¿…è¦çš„ï¼Œå¯ä»¥é¿å…ä¸å¿…è¦çš„æœåŠ¡è°ƒç”¨ |

### 3.2 ç¡®è®¤å­˜åœ¨çš„é—®é¢˜

| é—®é¢˜ | çŠ¶æ€ | æ€§èƒ½å½±å“ | ä¼˜åŒ–å»ºè®® |
|------|------|----------|----------|
| é—®é¢˜2: `SemanticRepairInitializer` é‡å¤åˆå§‹åŒ– | âŒ å­˜åœ¨ | è½»å¾® | å¤ç”¨å®ä¾‹ |
| é—®é¢˜3: æœåŠ¡ç«¯ç‚¹é‡å¤æŸ¥æ‰¾ | âŒ å­˜åœ¨ | ä¸­ç­‰ | æ·»åŠ ç¼“å­˜ |
| é—®é¢˜6: `lastCommittedText` ä¼ é€’ä¸ä¸€è‡´ | âš ï¸ éƒ¨åˆ† | è½»å¾® | ç¡®ä¿ä¸€è‡´æ€§ |

---

## å››ã€ä¼˜åŒ–å»ºè®®ä¼˜å…ˆçº§

### 4.1 é«˜ä¼˜å…ˆçº§

1. **å¤ç”¨ `SemanticRepairInitializer` å®ä¾‹**
   - å°† `SemanticRepairInitializer` ä½œä¸º `ServicesBundle` çš„ä¸€éƒ¨åˆ†
   - åœ¨ `ServicesBundle` åˆå§‹åŒ–æ—¶åˆ›å»ºï¼Œå¹¶åœ¨æ‰€æœ‰è°ƒç”¨ä¸­å¤ç”¨
   - **é¢„æœŸæ”¶ç›Š**: å‡å°‘å¯¹è±¡åˆ›å»ºå¼€é”€

2. **ç¼“å­˜æœåŠ¡ç«¯ç‚¹ï¼ˆæŒ‰è¯­è¨€ï¼‰**
   - åœ¨ `TaskRouterSemanticRepairHandler` ä¸­ç¼“å­˜æœåŠ¡ç«¯ç‚¹ï¼ˆæŒ‰è¯­è¨€ï¼‰
   - å½“æœåŠ¡çŠ¶æ€æ”¹å˜æ—¶ï¼Œæ¸…é™¤ç¼“å­˜
   - **é¢„æœŸæ”¶ç›Š**: å‡å°‘æœåŠ¡æŸ¥æ‰¾å¼€é”€

### 4.2 ä¸­ä¼˜å…ˆçº§

3. **ç¡®ä¿ `lastCommittedText` ä¸€è‡´æ€§**
   - åœ¨ `aggregation-step.ts` ä¸­ç¡®ä¿ `ctx.lastCommittedText` æ€»æ˜¯è¢«è®¾ç½®ï¼ˆå³ä½¿æ˜¯ `null`ï¼‰
   - é¿å…ä½¿ç”¨ `|| undefined`ï¼Œç›´æ¥èµ‹å€¼
   - **é¢„æœŸæ”¶ç›Š**: å‡å°‘é‡å¤è·å–å¼€é”€ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§

### 4.3 ä½ä¼˜å…ˆçº§

4. **ä¼˜åŒ–å¥åº·æ£€æŸ¥ç¼“å­˜æ—¶é—´**
   - å¦‚æœæœåŠ¡ç¨³å®šï¼Œå¯ä»¥å¢åŠ å¥åº·æ£€æŸ¥ç¼“å­˜æ—¶é—´
   - æˆ–è€…åœ¨æœåŠ¡ä¸å¯ç”¨æ—¶ï¼Œå¿«é€Ÿå¤±è´¥ï¼Œé¿å…ç­‰å¾…å¥åº·æ£€æŸ¥è¶…æ—¶
   - **é¢„æœŸæ”¶ç›Š**: å‡å°‘HTTPè¯·æ±‚å¼€é”€

---

## äº”ã€æµ‹è¯•ç»“è®º

### 5.1 æ€»ä½“è¯„ä¼°

- **å·²ä¼˜åŒ–é—®é¢˜**: 3ä¸ªï¼ˆé—®é¢˜1ã€4ã€5ï¼‰
- **ç¡®è®¤å­˜åœ¨é—®é¢˜**: 2ä¸ªï¼ˆé—®é¢˜2ã€3ï¼‰
- **éƒ¨åˆ†é—®é¢˜**: 1ä¸ªï¼ˆé—®é¢˜6ï¼‰

### 5.2 æ€§èƒ½å½±å“è¯„ä¼°

- **é«˜å½±å“**: æ— 
- **ä¸­ç­‰å½±å“**: 1ä¸ªï¼ˆé—®é¢˜3ï¼šæœåŠ¡ç«¯ç‚¹é‡å¤æŸ¥æ‰¾ï¼‰
- **ä½å½±å“**: 2ä¸ªï¼ˆé—®é¢˜2ï¼šé‡å¤åˆå§‹åŒ–ï¼Œé—®é¢˜6ï¼šä¼ é€’ä¸ä¸€è‡´ï¼‰

### 5.3 ä¼˜åŒ–å»ºè®®

1. **ç«‹å³å®æ–½**: é—®é¢˜2ï¼ˆå¤ç”¨å®ä¾‹ï¼‰ã€é—®é¢˜3ï¼ˆæ·»åŠ ç¼“å­˜ï¼‰
2. **åç»­ä¼˜åŒ–**: é—®é¢˜6ï¼ˆç¡®ä¿ä¸€è‡´æ€§ï¼‰
3. **æŒç»­ç›‘æ§**: é—®é¢˜4ï¼ˆä¼˜åŒ–ç¼“å­˜æ—¶é—´ï¼‰

---

## å…­ã€æµ‹è¯•ä»£ç ä½ç½®

æµ‹è¯•æ–‡ä»¶: `electron_node/electron-node/main/src/pipeline/steps/utterance-aggregation-flow-issues.test.ts`

è¿è¡Œæµ‹è¯•:
```bash
cd electron_node/electron-node
npm test -- utterance-aggregation-flow-issues.test.ts
```

---

*æµ‹è¯•å®Œæˆæ—¥æœŸ: 2026-01-27*
