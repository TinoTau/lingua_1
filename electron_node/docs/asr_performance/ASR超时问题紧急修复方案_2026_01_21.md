# ASRè¶…æ—¶é—®é¢˜ç´§æ€¥ä¿®å¤æ–¹æ¡ˆ

**æ—¥æœŸ**: 2026-01-21 02:00  
**é—®é¢˜**: GPU lease timeoutå¯¼è‡´é•¿éŸ³é¢‘å¤„ç†å¤±è´¥  
**ä¼˜å…ˆçº§**: P0 - ç´§æ€¥

---

## ğŸ”´ é—®é¢˜æ ¹å› 

### 1. è¶…æ—¶è®¾ç½®

**å½“å‰é…ç½®** (`config.py`):
```python
MAX_WAIT_SECONDS = float(os.getenv("MAX_WAIT_SECONDS", "30.0"))  # 30ç§’
```

### 2. å®é™…è€—æ—¶

**Job s-BA61422D:75 (11.2ç§’éŸ³é¢‘)**:
```
æ€»è€—æ—¶: 30.01ç§’
- transcribe(): 5.37ç§’ (18%)
- list(segments): 24.68ç§’ (82%)
```

### 3. æ ¸å¿ƒé—®é¢˜

**Workerè¿›ç¨‹ä¸­list(segments)æ²¡æœ‰timeoutä¿æŠ¤**:

```python
# asr_worker_process.py ç¬¬224è¡Œ
segments_list = list(segments)  # ç›´æ¥æ‰§è¡Œï¼Œæ— timeoutï¼
```

**Managerå±‚çš„timeoutæ— æ³•ä¸­æ–­Workerå†…éƒ¨æ“ä½œ**:
```python
# asr_worker_manager.py
result = await asyncio.wait_for(future, timeout=max_wait)  # 30ç§’è¶…æ—¶
# ä½†Workerè¿›ç¨‹å·²ç»åœ¨æ‰§è¡Œlist(segments)ï¼Œæ— æ³•ä¸­æ–­
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: å¢åŠ è¶…æ—¶é˜ˆå€¼ï¼ˆç«‹å³å®æ–½ï¼‰

**ä¿®æ”¹** `config.py`:

```python
# ä»30ç§’å¢åŠ åˆ°60ç§’
MAX_WAIT_SECONDS = float(os.getenv("MAX_WAIT_SECONDS", "60.0"))
```

**æ•ˆæœ**:
- âœ… ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯Worker
- âœ… å…è®¸é•¿éŸ³é¢‘æ­£å¸¸å¤„ç†
- âš ï¸ ç”¨æˆ·ç­‰å¾…æ—¶é—´æ›´é•¿
- âŒ ä¸è§£å†³æ ¹æœ¬æ€§èƒ½é—®é¢˜

---

### æ–¹æ¡ˆ2: ä¸ºlist(segments)æ·»åŠ ThreadPoolExecutorä¿æŠ¤ï¼ˆæ¨èï¼‰

**ä¿®æ”¹** `asr_worker_process.py`:

**å½“å‰ä»£ç **ï¼ˆç¬¬222-231è¡Œï¼‰:
```python
try:
    # è½¬æ¢ä¸º listï¼ˆå¯èƒ½å¾ˆæ…¢ï¼Œä¹Ÿå¯èƒ½å´©æºƒï¼‰
    segments_list = list(segments)
    t_segments_list = time.time() - list_start
    logger.info(...)
except Exception as e:
    logger.error(...)
```

**ä¿®æ”¹ä¸º**:
```python
import concurrent.futures

# åœ¨æ–‡ä»¶å¼€å¤´åˆ›å»ºå…¨å±€çº¿ç¨‹æ± 
_thread_pool = concurrent.futures.ThreadPoolExecutor(
    max_workers=1, 
    thread_name_prefix="segments_converter"
)

# åœ¨list(segments)å¤„ï¼ˆç¬¬222è¡Œï¼‰
try:
    # ä½¿ç”¨çº¿ç¨‹æ± +è¶…æ—¶ä¿æŠ¤list(segments)è½¬æ¢
    future = _thread_pool.submit(list, segments)
    
    # è®¾ç½®40ç§’è¶…æ—¶ï¼ˆç•™ç»™Manager 60ç§’æ€»è¶…æ—¶ï¼Œ20ç§’bufferï¼‰
    try:
        segments_list = future.result(timeout=40.0)
        t_segments_list = time.time() - list_start
        
        logger.info(
            f"[{trace_id}] ASR Worker: Converted segments to list "
            f"(took {t_segments_list:.3f}s, count={len(segments_list)})"
        )
        logger.info(
            f"[{trace_id}] phase=segments_list_done "
            f"t_segments_list={t_segments_list:.3f}s "
            f"segments_count={len(segments_list)} "
            f"worker_uptime={worker_uptime_sec:.1f}s "
            f"job_index={job_index_in_worker} "
            f"audio_duration={len(audio) / task.get('sample_rate', 16000):.2f}s"
        )
        
    except concurrent.futures.TimeoutError:
        logger.error(
            f"[{trace_id}] ASR Worker: Segments conversion timeout after 40.0s! "
            f"This indicates severe performance degradation."
        )
        # è¿”å›è¶…æ—¶é”™è¯¯
        result_queue.put({
            "job_id": job_id,
            "error": "Segments conversion timeout (40s)",
            "text": None,
            "language": None,
            "language_probabilities": None,
            "segments": None,
            "duration_ms": 0
        })
        continue
        
except Exception as e:
    logger.error(
        f"[{trace_id}] ASR Worker: Failed to convert segments to list: {e}",
        exc_info=True
    )
    # è¿”å›é”™è¯¯
    result_queue.put({
        "job_id": job_id,
        "error": f"Segments conversion failed: {str(e)}",
        "text": None,
        "language": None,
        "language_probabilities": None,
        "segments": None,
        "duration_ms": 0
    })
    continue
```

**æ•ˆæœ**:
- âœ… æä¾›å¯é çš„timeoutä¿æŠ¤
- âœ… 40ç§’åè‡ªåŠ¨ç»ˆæ­¢ï¼Œä¸ä¼šæ— é™ç­‰å¾…
- âœ… è¿”å›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯
- âœ… ä¸å½±å“å…¶ä»–æ­£å¸¸ä»»åŠ¡

---

### æ–¹æ¡ˆ3: è°ƒæ•´beam_sizeï¼ˆå®éªŒæ€§ï¼‰

**ä¿®æ”¹** `config.py`:

```python
# å½“å‰
ASR_BEAM_SIZE = int(os.getenv("ASR_BEAM_SIZE", "10"))

# è°ƒæ•´ä¸º
ASR_BEAM_SIZE = int(os.getenv("ASR_BEAM_SIZE", "5"))
```

**æ•ˆæœ**:
- âš ï¸ å¯èƒ½åŠ å¿«å¤„ç†é€Ÿåº¦
- âš ï¸ å¯èƒ½é™ä½è¯†åˆ«å‡†ç¡®ç‡
- ğŸ”¬ éœ€è¦æµ‹è¯•éªŒè¯

---

## ğŸš€ å®æ–½æ­¥éª¤

### æ­¥éª¤1: ç«‹å³ä¿®å¤ï¼ˆæ–¹æ¡ˆ1ï¼‰

```powershell
# 1. ä¿®æ”¹config.py
# å°†MAX_WAIT_SECONDSä»30.0æ”¹ä¸º60.0

# 2. é‡å¯ASRæœåŠ¡
cd d:\Programs\github\lingua_1\electron_node\services\faster_whisper_vad
python faster_whisper_vad_service.py

# 3. æµ‹è¯•
# è¿›è¡Œé›†æˆæµ‹è¯•ï¼Œè§‚å¯Ÿæ˜¯å¦è¿˜ä¼šè¶…æ—¶
```

**é¢„æœŸ**: é•¿éŸ³é¢‘ï¼ˆ11ç§’ï¼‰èƒ½æ­£å¸¸å¤„ç†ï¼Œä¸å†è¶…æ—¶

---

### æ­¥éª¤2: æ·»åŠ ThreadPoolExecutorä¿æŠ¤ï¼ˆæ–¹æ¡ˆ2ï¼‰

```powershell
# 1. ä¿®æ”¹asr_worker_process.py
# æ·»åŠ ThreadPoolExecutor+timeouté€»è¾‘

# 2. é‡å¯ASRæœåŠ¡

# 3. æµ‹è¯•
# è¿›è¡Œé›†æˆæµ‹è¯•ï¼Œç¡®è®¤40ç§’è¶…æ—¶èƒ½æ­£ç¡®è§¦å‘
```

**é¢„æœŸ**: 
- æ­£å¸¸éŸ³é¢‘ï¼šæ­£å¸¸å¤„ç†
- è¶…æ…¢ä»»åŠ¡ï¼š40ç§’åè¿”å›timeouté”™è¯¯

---

## ğŸ“Š æ€§èƒ½åŸºå‡†

### é¢„æœŸæ€§èƒ½ï¼ˆä¿®å¤åï¼‰

**11.2ç§’éŸ³é¢‘åº”è¯¥çš„è€—æ—¶**:

| é˜¶æ®µ | ç†æƒ³è€—æ—¶ | å¯æ¥å—è€—æ—¶ | å½“å‰è€—æ—¶ |
|------|---------|-----------|---------|
| decode | <10ms | <50ms | 2ms âœ… |
| VAD | <500ms | <1000ms | 727ms âœ… |
| transcribe | 1-2s | 3-5s | 5.37s âš ï¸ |
| list(segments) | <500ms | <2s | **24.68s** ğŸ”´ |
| **æ€»è®¡** | **2-3s** | **5-7s** | **30s** ğŸ”´ |

**ç»“è®º**: 
- âœ… decodeå’ŒVADæ€§èƒ½æ­£å¸¸
- âš ï¸ transcribeç¨æ…¢ä½†å¯æ¥å—
- ğŸ”´ **list(segments)ä¸¥é‡å¼‚å¸¸**ï¼ˆæ˜¯é¢„æœŸçš„50-100å€ï¼ï¼‰

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç´§æ€¥ï¼ˆä»Šå¤©ï¼‰

1. âœ… ä¿®æ”¹`MAX_WAIT_SECONDS`åˆ°60ç§’
2. âœ… é‡å¯ASRæœåŠ¡
3. âœ… è¿›è¡Œé›†æˆæµ‹è¯•éªŒè¯

### é‡è¦ï¼ˆæœ¬å‘¨ï¼‰

1. ğŸ”§ æ·»åŠ ThreadPoolExecutorä¿æŠ¤
2. ğŸ”¬ æ·±åº¦profiling list(segments)
3. ğŸ“Š å¯¹æ¯”ä¸åŒbeam_sizeçš„æ•ˆæœ

### è®¡åˆ’ï¼ˆä¸‹å‘¨ï¼‰

1. ğŸ“ è¯„ä¼°ASR Workeræ”¹é€ 
2. ğŸ§ª æµ‹è¯•æµå¼è¿”å›æ–¹æ¡ˆ
3. ğŸ“ åˆ¶å®šé•¿æœŸä¼˜åŒ–è®¡åˆ’

---

## ğŸ” æ·±åº¦è°ƒæŸ¥æ–¹å‘

### ä¸ºä»€ä¹ˆlist(segments)è¿™ä¹ˆæ…¢ï¼Ÿ

**å¯èƒ½çš„åŸå› **:

1. **faster-whisperå†…éƒ¨é—®é¢˜**
   - Generatorè¿­ä»£æ—¶çš„å†…éƒ¨è®¡ç®—
   - CUDA kernelè°ƒç”¨å¼€é”€
   - å†…å­˜æ‹·è´æ€§èƒ½

2. **ONNX Runtimeé—®é¢˜**
   - æ¨¡å‹æ¨ç†overhead
   - Tensoræ“ä½œæ€§èƒ½
   - cuDNNè°ƒç”¨æ€§èƒ½

3. **ç³»ç»Ÿå±‚é¢é—®é¢˜**
   - GPUå†…å­˜ç¢ç‰‡åŒ–
   - CUDAä¸Šä¸‹æ–‡åˆ‡æ¢
   - Python GILå½±å“

**è°ƒæŸ¥æ–¹æ³•**:

```python
# ä½¿ç”¨cProfile
import cProfile
profiler = cProfile.Profile()
profiler.enable()
segments_list = list(segments)
profiler.disable()
profiler.print_stats(sort='cumulative')

# æˆ–ä½¿ç”¨CUDA Profiler
# nvprof python asr_worker_process.py
```

---

## ğŸ“ å¤‡ä»½ä»£ç å¯¹æ¯”

### éœ€è¦ç¡®è®¤

1. **å¤‡ä»½ä»£ç çš„list(segments)è€—æ—¶**
   - æ˜¯å¦ä¹Ÿæœ‰è¿™ä¸ªé—®é¢˜ï¼Ÿ
   - è¿˜æ˜¯åªæœ‰å½“å‰ä»£ç æœ‰é—®é¢˜ï¼Ÿ

2. **ThreadPoolExecutoræ˜¯å¦å­˜åœ¨**
   - å¤‡ä»½ä»£ç æ˜¯å¦æœ‰timeoutä¿æŠ¤ï¼Ÿ
   - å¦‚æœæœ‰ï¼Œä¸ºä»€ä¹ˆå½“å‰ä»£ç æ²¡æœ‰ï¼Ÿ

3. **MAX_WAIT_SECONDSè®¾ç½®**
   - å¤‡ä»½ä»£ç æ˜¯30ç§’è¿˜æ˜¯æ›´é•¿ï¼Ÿ

---

## âš ï¸ é£é™©æç¤º

### æ–¹æ¡ˆ1é£é™©ï¼ˆå¢åŠ è¶…æ—¶ï¼‰

- âš ï¸ ç”¨æˆ·ç­‰å¾…æ—¶é—´å˜é•¿
- âš ï¸ ä¸è§£å†³æ ¹æœ¬æ€§èƒ½é—®é¢˜
- âš ï¸ å¦‚æœlist(segments)æ›´æ…¢ï¼Œ60ç§’ä¹Ÿä¸å¤Ÿ

### æ–¹æ¡ˆ2é£é™©ï¼ˆThreadPoolExecutorï¼‰

- âš ï¸ 40ç§’è¶…æ—¶åï¼Œsegmentsçº¿ç¨‹å¯èƒ½è¿˜åœ¨è¿è¡Œ
- âš ï¸ éœ€è¦ç¡®ä¿çº¿ç¨‹èƒ½è¢«æ­£ç¡®æ¸…ç†
- âš ï¸ å¯èƒ½å½±å“åç»­ä»»åŠ¡

### æ–¹æ¡ˆ3é£é™©ï¼ˆè°ƒæ•´beam_sizeï¼‰

- âš ï¸ å‡†ç¡®ç‡å¯èƒ½ä¸‹é™
- âš ï¸ éœ€è¦å¤§é‡æµ‹è¯•éªŒè¯
- âš ï¸ ç”¨æˆ·ä½“éªŒå¯èƒ½å˜å·®

---

**å½“å‰å»ºè®®**: 
1. **ç«‹å³å®æ–½æ–¹æ¡ˆ1**ï¼ˆå¢åŠ è¶…æ—¶åˆ°60ç§’ï¼‰
2. **å°½å¿«å®æ–½æ–¹æ¡ˆ2**ï¼ˆæ·»åŠ ThreadPoolExecutorä¿æŠ¤ï¼‰
3. **è¯„ä¼°æ–¹æ¡ˆ3**ï¼ˆéœ€è¦æµ‹è¯•ï¼‰

**é¢„æœŸæ•ˆæœ**: é•¿éŸ³é¢‘èƒ½æ­£å¸¸å¤„ç†ï¼Œä½†æ€§èƒ½é—®é¢˜ä»éœ€æ·±åº¦è°ƒæŸ¥
