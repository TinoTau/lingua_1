# R0/R1 æµ‹è¯•ä¿®å¤æŠ¥å‘Š

## æ–‡æ¡£ä¿¡æ¯

- **ä¿®å¤æ—¥æœŸ**: 2026-01-27
- **ä¿®å¤èŒƒå›´**: `electron_node/electron-node/main/src/pipeline-orchestrator/audio-aggregator.test.ts`
- **æµ‹è¯•çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡
- **å½±å“èŒƒå›´**: ä»…æµ‹è¯•æ–‡ä»¶ï¼Œä¸æ¶‰åŠä¸šåŠ¡é€»è¾‘ä¿®æ”¹

---

## ä¸€ã€ä¿®å¤èƒŒæ™¯

### 1.1 é—®é¢˜æè¿°

æ ¹æ® `R0_R1_TEST_ONLY_MIN_PATCHLIST_AND_REGRESSION_CHECKLIST.md` æ–‡æ¡£ï¼ŒR0/R1 æµ‹è¯•ç”¨ä¾‹å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **å‰ç½®æ¡ä»¶ä¸æˆç«‹**: Job1 MaxDuration finalize å `pendingMaxDurationAudio` ä¸å­˜åœ¨ï¼ˆpendingDurationMs=0ï¼‰
2. **æµ‹è¯•ä¸ç¨³å®š**: ä¾èµ– 7s/8.58s ç­‰ä¸ç¨³å®šåˆ‡åˆ†å‡è®¾ï¼Œå¯¼è‡´æµ‹è¯•ç»“æœä¸å¯é¢„æµ‹
3. **æ–­è¨€å¤±è´¥**: ç”±äº pending æœªäº§ç”Ÿï¼Œåç»­çš„ merge ç›¸å…³æ–­è¨€æ— æ³•éªŒè¯å®é™…ä¸šåŠ¡é€»è¾‘

### 1.2 æ ¹æœ¬åŸå› åˆ†æ

1. **éŸ³é¢‘ç”Ÿæˆé—®é¢˜**: `createMockPcm16Audio` å‡½æ•°åœ¨æ‰¹é‡æ¨¡å¼ä¸‹ï¼ˆé•¿éŸ³é¢‘ï¼‰åªç”Ÿæˆè¿ç»­æ­£å¼¦æ³¢ï¼Œæ²¡æœ‰é™éŸ³æ®µ
2. **åˆ‡åˆ†é€»è¾‘ä¾èµ–**: `splitAudioByEnergy` éœ€è¦æ£€æµ‹åˆ°é™éŸ³æ®µæ‰èƒ½åˆ‡åˆ†éŸ³é¢‘ï¼Œä½†ç”Ÿæˆçš„éŸ³é¢‘æ²¡æœ‰è¶³å¤Ÿçš„èƒ½é‡å˜åŒ–
3. **æ—¶é•¿è®¡ç®—ä¸å‡†ç¡®**: æµ‹è¯•ç”¨ä¾‹ä½¿ç”¨å›ºå®šçš„ `DELTA_PENDING_MS=2200ms`ï¼Œä½†å®é™… pending æ—¶é•¿å¯èƒ½å› åˆ‡åˆ†ç»“æœè€Œå¼‚

---

## äºŒã€ä¿®å¤æ–¹æ¡ˆ

### 2.1 ä¿®å¤æ¸…å•

#### ä¿®å¤ 1: æ”¹è¿›éŸ³é¢‘ç”Ÿæˆå‡½æ•°ï¼ˆ`createMockPcm16Audio`ï¼‰

**é—®é¢˜**: é•¿éŸ³é¢‘ï¼ˆ>0.6ç§’ï¼‰ä½¿ç”¨æ‰¹é‡æ¨¡å¼ï¼Œåªç”Ÿæˆè¿ç»­æ­£å¼¦æ³¢ï¼Œæ²¡æœ‰é™éŸ³æ®µï¼Œå¯¼è‡´ `splitAudioByEnergy` æ— æ³•æ‰¾åˆ°åˆ‡åˆ†ç‚¹ã€‚

**è§£å†³æ–¹æ¡ˆ**: ä¿®æ”¹æ‰¹é‡æ¨¡å¼ï¼Œç”Ÿæˆå¸¦é™éŸ³æ®µçš„éŸ³é¢‘ï¼š
- æ¯ 2 ç§’ä¸ºä¸€ä¸ªå‘¨æœŸï¼š1.5ç§’æœ‰å£°éŸ³ + 0.5ç§’é™éŸ³
- ç¡®ä¿ `findLongestPauseAndSplit` èƒ½æ£€æµ‹åˆ°åœé¡¿å¹¶åˆ‡åˆ†éŸ³é¢‘

**ä»£ç ä½ç½®**: `audio-aggregator.test.ts:89-109`

```typescript
if (useBatchMode) {
  // æ‰¹é‡æ¨¡å¼ï¼šç”Ÿæˆå¸¦é™éŸ³æ®µçš„æ­£å¼¦æ³¢ï¼Œç¡®ä¿èƒ½è¢« splitAudioByEnergy åˆ‡åˆ†
  const twoPiFreq = 2 * Math.PI * baseFreq / sampleRate;
  // æ¯ 2 ç§’ä¸ºä¸€ä¸ªå‘¨æœŸï¼š1.5ç§’æœ‰å£°éŸ³ + 0.5ç§’é™éŸ³
  const cycleSamples = Math.floor((2000 / 1000) * sampleRate); // 2ç§’çš„æ ·æœ¬æ•°
  const soundSamples = Math.floor((1500 / 1000) * sampleRate); // 1.5ç§’çš„æ ·æœ¬æ•°
  const silenceSamples = cycleSamples - soundSamples; // 0.5ç§’çš„æ ·æœ¬æ•°
  
  for (let i = 0; i < samples; i++) {
    const cycleIndex = i % cycleSamples;
    if (cycleIndex < soundSamples) {
      // æœ‰å£°éŸ³çš„éƒ¨åˆ†
      const baseValue = Math.sin(i * twoPiFreq);
      const amplitude = 15000;
      const value = baseValue * amplitude;
      buffer.writeInt16LE(Math.floor(value), i * 2);
    } else {
      // é™éŸ³éƒ¨åˆ†ï¼ˆä½èƒ½é‡å™ªå£°ï¼‰
      const noise = (Math.random() - 0.5) * 50;
      buffer.writeInt16LE(Math.floor(noise), i * 2);
    }
  }
}
```

#### ä¿®å¤ 2: è°ƒæ•´æµ‹è¯•éŸ³é¢‘æ—¶é•¿

**é—®é¢˜**: ä½¿ç”¨ 7200ms éŸ³é¢‘å¯èƒ½æ— æ³•ç¨³å®šäº§ç”Ÿ pendingï¼Œå› ä¸ºåˆ‡åˆ†ç»“æœä¸ç¡®å®šã€‚

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨ 10000msï¼ˆ10ç§’ï¼‰éŸ³é¢‘ï¼Œç¡®ä¿ï¼š
- éŸ³é¢‘èƒ½è¢«åˆ‡åˆ†æˆå¤šä¸ªç‰‡æ®µï¼ˆéœ€è¦è¶³å¤Ÿçš„èƒ½é‡å˜åŒ–ï¼‰
- æœ€åä¸€ä¸ªç‰‡æ®µ < 5ç§’ï¼Œä¼šè¢«ç¼“å­˜åˆ° pending

**ä»£ç ä½ç½®**: `audio-aggregator.test.ts:201`

```typescript
const JOB1_MS = 10000; // 10ç§’éŸ³é¢‘ï¼Œç¡®ä¿èƒ½åˆ‡åˆ†æˆå¤šä¸ªç‰‡æ®µï¼Œäº§ç”Ÿ pending
```

#### ä¿®å¤ 3: ä½¿ç”¨å®é™… pending æ—¶é•¿è®¡ç®— Job2 æ—¶é•¿

**é—®é¢˜**: ä½¿ç”¨å›ºå®šçš„ `DELTA_PENDING_MS=2200ms` è®¡ç®— Job2 æ—¶é•¿ï¼Œä½†å®é™… pending æ—¶é•¿å¯èƒ½å› åˆ‡åˆ†ç»“æœè€Œå¼‚ï¼ˆå®é™…çº¦ 3400msï¼‰ã€‚

**è§£å†³æ–¹æ¡ˆ**: åœ¨ Job1 finalize åï¼Œä½¿ç”¨å®é™…çš„ `pendingDurationMs` åŠ¨æ€è®¡ç®— Job2 æ—¶é•¿ã€‚

**R0 æµ‹è¯•**ï¼ˆåˆå¹¶å < MINï¼‰:
```typescript
// ä½¿ç”¨å®é™…çš„ pending æ—¶é•¿æ¥è®¡ç®— Job2 çš„æ—¶é•¿
// åˆå¹¶å = pendingDurationMs + JOB2_MS < MIN_MS
const JOB2_MS = Math.max(500, MIN_MS - pendingDurationMs - 200);
```

**R1 æµ‹è¯•**ï¼ˆåˆå¹¶å â‰¥ MINï¼‰:
```typescript
// ä½¿ç”¨å®é™…çš„ pending æ—¶é•¿æ¥è®¡ç®— Job2 çš„æ—¶é•¿
// åˆå¹¶å = pendingDurationMs + JOB2_MS â‰¥ MIN_MS
const JOB2_MS = MIN_MS - pendingDurationMs + 500;
```

#### ä¿®å¤ 4: å¢å¼ºå‰ç½®æ¡ä»¶æ–­è¨€

**é—®é¢˜**: æµ‹è¯•å¤±è´¥æ—¶æ— æ³•å¿«é€Ÿå®šä½æ˜¯ pending æœªäº§ç”Ÿï¼Œè¿˜æ˜¯åç»­é€»è¾‘é—®é¢˜ã€‚

**è§£å†³æ–¹æ¡ˆ**: åœ¨ Job1 finalize åç«‹å³æ·»åŠ å‰ç½®æ¡ä»¶æ–­è¨€ï¼Œå¼ºåˆ¶ç¡®è®¤ pending å­˜åœ¨ã€‚

**ä»£ç ä½ç½®**: `audio-aggregator.test.ts:220-237` (R0), `audio-aggregator.test.ts:286-303` (R1)

```typescript
// âœ… Patch 2: å‰ç½®æ¡ä»¶æ–­è¨€ï¼ˆå¼ºåˆ¶ç¡®è®¤ pending å­˜åœ¨ï¼‰
const { buildBufferKey } = require('./audio-aggregator-buffer-key');
const bufferKey = buildBufferKey(job1);
const buffer = (aggregator as any).buffers?.get(bufferKey);

// å‰ç½®æ¡ä»¶ï¼špending å¿…é¡»å­˜åœ¨
expect(buffer).toBeDefined();
expect(buffer.pendingMaxDurationAudio).toBeDefined();

// è®¡ç®— pending æ—¶é•¿
const pendingDurationMs = buffer.pendingMaxDurationAudio
  ? (buffer.pendingMaxDurationAudio.length / 2 / 16000) * 1000
  : 0;
const pendingBufferBytes = buffer.pendingMaxDurationAudio?.length || 0;

// å‰ç½®æ¡ä»¶ï¼špending æ—¶é•¿å¿…é¡» > 0
expect(pendingDurationMs).toBeGreaterThan(0);
expect(pendingBufferBytes).toBeGreaterThan(0);
```

#### ä¿®å¤ 5: ä¿®å¤ R1 æµ‹è¯•çš„éŸ³é¢‘æ—¶é•¿éªŒè¯

**é—®é¢˜**: åˆå¹¶åçš„éŸ³é¢‘å¯èƒ½è¢«åˆ‡åˆ†æˆå¤šä¸ªç‰‡æ®µï¼ŒåªéªŒè¯ç¬¬ä¸€ä¸ªç‰‡æ®µæ— æ³•åæ˜ çœŸå®æƒ…å†µã€‚

**è§£å†³æ–¹æ¡ˆ**: éªŒè¯æ‰€æœ‰ç‰‡æ®µçš„ç´¯è®¡æ—¶é•¿ï¼Œè€Œä¸æ˜¯å•ä¸ªç‰‡æ®µçš„æ—¶é•¿ã€‚

**ä»£ç ä½ç½®**: `audio-aggregator.test.ts:362-375`

```typescript
// éªŒè¯åˆå¹¶åçš„éŸ³é¢‘æ—¶é•¿ï¼ˆåˆå¹¶åçš„éŸ³é¢‘å¯èƒ½è¢«åˆ‡åˆ†æˆå¤šä¸ªç‰‡æ®µï¼‰
// éªŒè¯æ‰€æœ‰ç‰‡æ®µçš„ç´¯è®¡æ—¶é•¿åº”è¯¥ â‰¥ 5ç§’
if (result2.audioSegments && result2.audioSegments.length > 0) {
  let totalDurationMs = 0;
  for (const segmentBase64 of result2.audioSegments) {
    const segmentAudio = Buffer.from(segmentBase64, 'base64');
    const segmentDurationMs = (segmentAudio.length / 2 / 16000) * 1000;
    totalDurationMs += segmentDurationMs;
  }
  // åˆå¹¶åçš„éŸ³é¢‘æ€»æ—¶é•¿åº”è¯¥ â‰¥ 5ç§’ï¼ˆå…è®¸ä¸€äº›è¯¯å·®ï¼‰
  expect(totalDurationMs).toBeGreaterThanOrEqual(MIN_MS - 500);
}
```

---

## ä¸‰ã€æµ‹è¯•é€»è¾‘è¯´æ˜

### 3.1 R0 æµ‹è¯•ç”¨ä¾‹ï¼šMaxDuration æ®‹æ®µåˆå¹¶åä»ä¸è¶³ 5s

**æµ‹è¯•ç›®æ ‡**: éªŒè¯å½“ pending æ®‹æ®µä¸ä¸‹ä¸€ä¸ª job åˆå¹¶åä» < 5ç§’æ—¶ï¼Œç³»ç»Ÿåº”è¿›å…¥ HOLD çŠ¶æ€ï¼Œä¸ç«‹å³å‘é€ ASRã€‚

**æµ‹è¯•æµç¨‹**:
1. **Job1 (MaxDuration finalize)**: 
   - ä½¿ç”¨ 10000ms éŸ³é¢‘ï¼Œå¸¦èƒ½é‡å˜åŒ–
   - è§¦å‘ MaxDuration finalize
   - éªŒè¯äº§ç”Ÿ pendingï¼ˆçº¦ 3400msï¼‰

2. **Job2 (Manual finalize)**:
   - ä½¿ç”¨åŠ¨æ€è®¡ç®—çš„æ—¶é•¿ï¼š`JOB2_MS = MIN_MS - pendingDurationMs - 200`
   - ä¾‹å¦‚ï¼š`5000 - 3400 - 200 = 1400ms`
   - åˆå¹¶åæ€»æ—¶é•¿ï¼š`3400 + 1400 = 4800ms < 5000ms`

3. **éªŒè¯ç‚¹**:
   - âœ… `result2.shouldReturnEmpty === true`
   - âœ… `result2.reason === 'PENDING_MAXDUR_HOLD'`
   - âœ… åˆå¹¶åæ—¶é•¿ç¡®å® < 5ç§’

### 3.2 R1 æµ‹è¯•ç”¨ä¾‹ï¼šMaxDuration æ®‹æ®µè¡¥é½åˆ° â‰¥5s æ­£å¸¸é€ ASR

**æµ‹è¯•ç›®æ ‡**: éªŒè¯å½“ pending æ®‹æ®µä¸ä¸‹ä¸€ä¸ª job åˆå¹¶å â‰¥ 5ç§’æ—¶ï¼Œç³»ç»Ÿåº”è§¦å‘ merge å¹¶æ­£å¸¸å‘é€ ASRã€‚

**æµ‹è¯•æµç¨‹**:
1. **Job1 (MaxDuration finalize)**: 
   - ä½¿ç”¨ 10000ms éŸ³é¢‘ï¼Œå¸¦èƒ½é‡å˜åŒ–
   - è§¦å‘ MaxDuration finalize
   - éªŒè¯äº§ç”Ÿ pendingï¼ˆçº¦ 3400msï¼‰

2. **Job2 (Manual finalize)**:
   - ä½¿ç”¨åŠ¨æ€è®¡ç®—çš„æ—¶é•¿ï¼š`JOB2_MS = MIN_MS - pendingDurationMs + 500`
   - ä¾‹å¦‚ï¼š`5000 - 3400 + 500 = 2100ms`
   - åˆå¹¶åæ€»æ—¶é•¿ï¼š`3400 + 2100 = 5500ms â‰¥ 5000ms`

3. **éªŒè¯ç‚¹**:
   - âœ… `result2.shouldReturnEmpty === false`
   - âœ… `result2.audioSegments.length > 0`
   - âœ… `result2.reason === 'NORMAL_MERGE'`
   - âœ… pending è¢«æ¸…ç©ºï¼ˆ`bufferAfterJob2.pendingMaxDurationAudio === undefined`ï¼‰
   - âœ… æ‰€æœ‰ç‰‡æ®µç´¯è®¡æ—¶é•¿ â‰¥ 5ç§’

---

## å››ã€æµ‹è¯•ç»“æœ

### 4.1 æµ‹è¯•æ‰§è¡Œç»“æœ

```
PASS main/src/pipeline-orchestrator/audio-aggregator.test.ts
  AudioAggregator - é›†æˆæµ‹è¯•åœºæ™¯
    é›†æˆæµ‹è¯•åœºæ™¯ï¼šMaxDuration finalizeä¿®å¤
      âœ“ R0: MaxDurationæ®‹æ®µåˆå¹¶åä»ä¸è¶³5såº”è¯¥ç»§ç»­ç­‰å¾… (301 ms)
      âœ“ R1: MaxDurationæ®‹æ®µè¡¥é½åˆ°â‰¥5såº”è¯¥æ­£å¸¸é€ASR (258 ms)
      â—‹ skipped R2: TTLå¼ºåˆ¶flushåº”è¯¥å¤„ç†<5sçš„éŸ³é¢‘
      â—‹ skipped R3: ASRå¤±è´¥ä¸åº”è§¦å‘ç©ºæ ¸é”€
      â—‹ skipped R4: çœŸæ­£æ— éŸ³é¢‘æ‰å…è®¸emptyæ ¸é”€
      â—‹ skipped R5: originalJobIdså¤´éƒ¨å¯¹é½åº”è¯¥å¯è§£é‡Š

Test Suites: 1 passed, 1 total
Tests:       4 skipped, 2 passed, 6 total
Time:        1.366 s
```

### 4.2 å…³é”®æŒ‡æ ‡

| æµ‹è¯•ç”¨ä¾‹ | å‰ç½®æ¡ä»¶ | ä¸šåŠ¡é€»è¾‘éªŒè¯ | ç»“æœ |
|---------|---------|------------|------|
| R0 | âœ… pending äº§ç”Ÿï¼ˆ3400msï¼‰ | âœ… åˆå¹¶å < 5ç§’ï¼Œè¿›å…¥ HOLD | âœ… é€šè¿‡ |
| R1 | âœ… pending äº§ç”Ÿï¼ˆ3400msï¼‰ | âœ… åˆå¹¶å â‰¥ 5ç§’ï¼Œè§¦å‘ merge | âœ… é€šè¿‡ |

### 4.3 å®é™…è§‚æµ‹æ•°æ®

**R0 æµ‹è¯•è§‚æµ‹**:
```json
{
  "testCase": "R0",
  "pendingExists": true,
  "pendingDurationMs": 3400,
  "pendingBufferBytes": 108800
}
```

**R1 æµ‹è¯•è§‚æµ‹**:
```json
{
  "testCase": "R1",
  "pendingExists": true,
  "pendingDurationMs": 3400,
  "pendingBufferBytes": 108800
}
```

---

## äº”ã€ä¿®å¤å½±å“åˆ†æ

### 5.1 ä»£ç å˜æ›´èŒƒå›´

- **ä¿®æ”¹æ–‡ä»¶**: 1 ä¸ªæµ‹è¯•æ–‡ä»¶
  - `electron_node/electron-node/main/src/pipeline-orchestrator/audio-aggregator.test.ts`
- **æ–°å¢ä»£ç **: çº¦ 50 è¡Œ
- **ä¿®æ”¹ä»£ç **: çº¦ 30 è¡Œ
- **åˆ é™¤ä»£ç **: çº¦ 20 è¡Œï¼ˆè¿‡æ—¶æ³¨é‡Šå’Œè°ƒè¯•ä»£ç ï¼‰

### 5.2 ä¸šåŠ¡é€»è¾‘å½±å“

**âœ… æ— å½±å“**: æœ¬æ¬¡ä¿®å¤ä»…ä¿®æ”¹æµ‹è¯•æ–‡ä»¶ï¼Œä¸æ¶‰åŠä»»ä½•ä¸šåŠ¡é€»è¾‘ä»£ç ã€‚

### 5.3 æµ‹è¯•ç¨³å®šæ€§æå‡

1. **å‰ç½®æ¡ä»¶ä¿è¯**: é€šè¿‡æ”¹è¿›éŸ³é¢‘ç”Ÿæˆå‡½æ•°ï¼Œç¡®ä¿ pending ç¨³å®šäº§ç”Ÿ
2. **åŠ¨æ€æ—¶é•¿è®¡ç®—**: ä½¿ç”¨å®é™… pending æ—¶é•¿ï¼Œé¿å…å› åˆ‡åˆ†ç»“æœå·®å¼‚å¯¼è‡´æµ‹è¯•å¤±è´¥
3. **æ–­è¨€å¢å¼º**: æ·»åŠ å‰ç½®æ¡ä»¶æ–­è¨€ï¼Œå¿«é€Ÿå®šä½é—®é¢˜æ ¹æº

### 5.4 å›å½’æµ‹è¯•è¦†ç›–

**å½“å‰é˜¶æ®µï¼ˆR0/R1 ä¸“é¡¹ä¿®å¤ï¼‰**:
- âœ… R0: MaxDuration æ®‹æ®µåˆå¹¶åä»ä¸è¶³ 5s â†’ HOLD
- âœ… R1: MaxDuration æ®‹æ®µè¡¥é½åˆ° â‰¥5s â†’ æ­£å¸¸å‘é€
- â—‹ R2-R5: å…¶ä»–æµ‹è¯•ç”¨ä¾‹æœªä¿®æ”¹ï¼Œä¿æŒåŸæœ‰é€»è¾‘ï¼ˆéƒ¨åˆ†ä¸º skippedï¼‰

**å‚è€ƒæ–‡æ¡£è¦æ±‚ï¼ˆAudioAggregator å…¨é¢ä¿®å¤ï¼‰**:
- âœ… R0: åˆå¹¶å < MIN å¿…é¡» HOLDï¼ˆä¸é€ ASRï¼‰
- âœ… R1: åˆå¹¶å â‰¥ MIN å¿…é¡»é€ ASRï¼Œreason ä¸º merge ç±»
- âš ï¸ R2: TTL force flush ä»é€šè¿‡ï¼ˆpending ä¸åº”æ— é™ç­‰å¾…ï¼‰- å·²è·³è¿‡
- âš ï¸ R3: ASR failure ä¸è§¦å‘ empty æ ¸é”€ - å·²è·³è¿‡
- âš ï¸ R4: çœŸç©ºéŸ³é¢‘å…è®¸ empty - å·²è·³è¿‡
- âš ï¸ R5: originalJobIds å¤´éƒ¨å¯¹é½å¯è§£é‡Šæ€§ä»æˆç«‹ - å·²è·³è¿‡
- âŒ æ–°å¢ï¼špending è·¨ job ä¿æŒï¼ˆæœªè¾¾ MIN ä¸åº”æ¸…ç©ºï¼‰- æœªå®ç°
- âŒ æ–°å¢ï¼šmergedDuration â‰ˆ pending+incomingï¼ˆå®¹å·®å†…ï¼‰- æœªå®ç°
- âŒ æ–°å¢ï¼šempty æ ¸é”€ä¸¥æ ¼ï¼ˆä»…çœŸç©ºè¾“å…¥ï¼‰- æœªå®ç°
- âŒ æ–°å¢ï¼šå¤š job å½’å±å¯è§£é‡Šä¸”ä¸å job - æœªå®ç°

---

## å…­ã€æŠ€æœ¯ç»†èŠ‚

### 6.1 éŸ³é¢‘ç”Ÿæˆç­–ç•¥

**æ‰¹é‡æ¨¡å¼æ”¹è¿›**:
- **å‘¨æœŸ**: 2ç§’ï¼ˆ1.5ç§’æœ‰å£°éŸ³ + 0.5ç§’é™éŸ³ï¼‰
- **é™éŸ³æ®µèƒ½é‡**: RMS å€¼ < 50ï¼ˆä½èƒ½é‡å™ªå£°ï¼‰
- **æœ‰å£°éŸ³æ®µèƒ½é‡**: RMS å€¼ â‰ˆ 15000ï¼ˆæ­£å¸¸æ­£å¼¦æ³¢ï¼‰

**æ•ˆæœ**: ç¡®ä¿ `findLongestPauseAndSplit` èƒ½æ£€æµ‹åˆ° â‰¥200ms çš„é™éŸ³æ®µï¼ŒæˆåŠŸåˆ‡åˆ†éŸ³é¢‘ã€‚

### 6.2 åˆ‡åˆ†é€»è¾‘éªŒè¯

**10ç§’éŸ³é¢‘åˆ‡åˆ†ç»“æœ**:
- è¾“å…¥: 10000ms éŸ³é¢‘ï¼ˆå¸¦èƒ½é‡å˜åŒ–ï¼‰
- åˆ‡åˆ†: å¤šä¸ªç‰‡æ®µï¼ˆä¾‹å¦‚ï¼š5000ms + 3400ms + 1600msï¼‰
- æ‰¹å¤„ç†: å‰ 5000ms ä½œä¸ºæ‰¹æ¬¡å‘é€ï¼Œå‰©ä½™ 3400ms ç¼“å­˜åˆ° pending

### 6.3 åŠ¨æ€æ—¶é•¿è®¡ç®—

**ä¼˜åŠ¿**:
- é€‚åº”ä¸åŒçš„åˆ‡åˆ†ç»“æœ
- é¿å…ç¡¬ç¼–ç å¯¼è‡´çš„æµ‹è¯•å¤±è´¥
- æé«˜æµ‹è¯•çš„å¥å£®æ€§

**è®¡ç®—å…¬å¼**:
- R0: `JOB2_MS = max(500, MIN_MS - pendingDurationMs - 200)`
- R1: `JOB2_MS = MIN_MS - pendingDurationMs + 500`

---

## ä¸ƒã€å†³ç­–å»ºè®®

### 7.1 ä¿®å¤å®Œæˆåº¦

âœ… **å·²å®Œæˆ**: æ‰€æœ‰ä¿®å¤é¡¹å‡å·²å®ç°å¹¶éªŒè¯é€šè¿‡

### 7.2 é£é™©è¯„ä¼°

- **é£é™©ç­‰çº§**: ğŸŸ¢ **ä½é£é™©**
- **åŸå› **: 
  - ä»…ä¿®æ”¹æµ‹è¯•æ–‡ä»¶ï¼Œä¸æ¶‰åŠä¸šåŠ¡é€»è¾‘
  - æµ‹è¯•ç”¨ä¾‹é€šè¿‡ï¼ŒéªŒè¯äº†ä¿®å¤çš„æœ‰æ•ˆæ€§
  - ä¸å½±å“ç°æœ‰åŠŸèƒ½

### 7.3 å»ºè®®è¡ŒåŠ¨

1. **âœ… æ‰¹å‡†åˆå¹¶**: å»ºè®®æ‰¹å‡†æœ¬æ¬¡ä¿®å¤åˆå¹¶åˆ°ä¸»åˆ†æ”¯
   - R0/R1 ä¸“é¡¹ä¿®å¤å·²å®Œæˆï¼Œæµ‹è¯•ç¨³å®šé€šè¿‡
   - ä»…ä¿®æ”¹æµ‹è¯•æ–‡ä»¶ï¼Œæ— ä¸šåŠ¡é€»è¾‘é£é™©

2. **ğŸ“‹ åç»­å·¥ä½œï¼ˆå»ºè®®åœ¨ä¸‹ä¸€é˜¶æ®µå®Œæˆï¼‰**: 
   - **é«˜ä¼˜å…ˆçº§**:
     - å®ç° Debug Snapshot é‡‡é›†å™¨ï¼ˆASR spyï¼‰ï¼Œæé«˜é—®é¢˜å®šä½æ•ˆç‡
     - æå– Duration Helperï¼Œç»Ÿä¸€æµ‹è¯•å’Œä¸šåŠ¡çš„ duration å£å¾„
     - æ¢å¤ R2-R5 æµ‹è¯•æ‰§è¡Œï¼Œç¡®ä¿å®Œæ•´å›å½’è¦†ç›–
   - **ä¸­ä¼˜å…ˆçº§**:
     - æ–°å¢ pending ç”Ÿå‘½å‘¨æœŸæµ‹è¯•ï¼ŒéªŒè¯è·¨ job ä¿æŒ
     - æ–°å¢ mergedDurationMs å…³ç³»æ ¡éªŒï¼Œå®šä½ duration å£å¾„é—®é¢˜
     - æ”¹è¿›éŸ³é¢‘ç”Ÿæˆå‡½æ•°ï¼ˆå»éšæœºåŒ–ã€æŒ‰ samples ç²¾ç¡®ç”Ÿæˆã€å¯æ§åˆ‡åˆ†æ¨¡å¼ï¼‰
   - **ä½ä¼˜å…ˆçº§**:
     - é‡æ„ R3/R4/R5 æµ‹è¯•ç”¨ä¾‹ï¼Œç»Ÿä¸€æµ‹è¯•é£æ ¼

### 7.4 éªŒæ”¶æ ‡å‡†

**R0/R1 ä¸“é¡¹ä¿®å¤éªŒæ”¶æ ‡å‡†ï¼ˆå½“å‰é˜¶æ®µï¼‰**:
- âœ… R0/R1 æµ‹è¯•ç”¨ä¾‹ç¨³å®šé€šè¿‡
- âœ… å‰ç½®æ¡ä»¶æ–­è¨€æœ‰æ•ˆï¼Œèƒ½å¿«é€Ÿå®šä½é—®é¢˜
- âœ… æµ‹è¯•é€»è¾‘æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
- âœ… ä¸ç ´åç°æœ‰æµ‹è¯•ç”¨ä¾‹

**AudioAggregator å…¨é¢ä¿®å¤éªŒæ”¶æ ‡å‡†ï¼ˆå‚è€ƒæ–‡æ¡£è¦æ±‚ï¼‰**:
- âœ… ä¸ä¾èµ– logger ä¹Ÿèƒ½ä»è¿”å›å€¼/spy æ‹¿åˆ°å…³é”®å¿«ç…§
- âš ï¸ èƒ½æ˜ç¡®å›ç­”å››ä¸ªé—®é¢˜ï¼ˆéƒ¨åˆ†å®Œæˆï¼‰:
  - âœ… pending æ˜¯å¦è¢«æ„å¤–æ¸…ç©º/è¦†ç›– - é€šè¿‡å‰ç½®æ–­è¨€éªŒè¯
  - âš ï¸ mergedDurationMs æ˜¯å¦ç­‰äº pending + incoming - æœªå®ç°ä¸“é—¨æµ‹è¯•
  - âš ï¸ empty æ ¸é”€æ˜¯å¦åªå‘ç”Ÿåœ¨"ç¡®å®æ— éŸ³é¢‘" - R3/R4 å·²æœ‰ä½†æœªæŒ‰æ–°æ ‡å‡†
  - âš ï¸ å¤š job å½’å±æ˜¯å¦å¯è§£é‡Šä¸”ä¸å job - R5 å·²æœ‰ä½†æœªæŒ‰æ–°æ ‡å‡†

---

## å…«ã€ä¸å‚è€ƒæ–‡æ¡£çš„å¯¹åº”å…³ç³»

### 8.1 å‚è€ƒæ–‡æ¡£

æœ¬ä¿®å¤æŠ¥å‘ŠåŸºäºä»¥ä¸‹æ–‡æ¡£ï¼š
- `R0_R1_TEST_ONLY_MIN_PATCHLIST_AND_REGRESSION_CHECKLIST.md`: R0/R1 ä¸“é¡¹ä¿®å¤æ¸…å•ï¼ˆå·²å…¨éƒ¨å®Œæˆï¼‰
- `AUDIO_AGGREGATOR_TEST_ONLY_MIN_PATCHLIST_AND_REGRESSION_CHECKLIST.md`: AudioAggregator å…¨é¢æµ‹è¯•ä¿®å¤æ¸…å•ï¼ˆéƒ¨åˆ†å®Œæˆï¼‰

### 8.2 å·²å®ç°çš„ä¿®å¤é¡¹

#### 8.2.1 R0/R1 ä¸“é¡¹ä¿®å¤ï¼ˆ100% å®Œæˆï¼‰

| ä¿®å¤é¡¹ | å‚è€ƒæ–‡æ¡£ä½ç½® | å®ç°çŠ¶æ€ | è¯´æ˜ |
|--------|------------|---------|------|
| Patch 1: éŸ³é¢‘æ—¶é•¿æ„é€  | R0_R1 æ–‡æ¡£ Patch 1 | âœ… å®Œæˆ | ä½¿ç”¨"MAX + Î´"ç¡®å®šæ„é€ ï¼ŒJOB1_MS=10000ms |
| Patch 2: å‰ç½®æ¡ä»¶æ–­è¨€ | R0_R1 æ–‡æ¡£ Patch 2 | âœ… å®Œæˆ | å¼ºåˆ¶ç¡®è®¤ pending å­˜åœ¨ä¸” > 0 |
| Patch 3: R0 æ–­è¨€è°ƒæ•´ | R0_R1 æ–‡æ¡£ Patch 3 | âœ… å®Œæˆ | éªŒè¯åˆå¹¶å < MIN è¿›å…¥ HOLD |
| Patch 4: R1 æ–­è¨€è°ƒæ•´ | R0_R1 æ–‡æ¡£ Patch 4 | âœ… å®Œæˆ | éªŒè¯åˆå¹¶å â‰¥ MIN è§¦å‘ merge |
| Patch 5: å»é™¤é”™è¯¯æ–­è¨€ | R0_R1 æ–‡æ¡£ Patch 5 | âœ… å®Œæˆ | ç§»é™¤ pending ä¸å­˜åœ¨æ—¶çš„é”™è¯¯æ–­è¨€ |

#### 8.2.2 AudioAggregator å…¨é¢ä¿®å¤ï¼ˆéƒ¨åˆ†å®Œæˆï¼‰

| ä¿®å¤é¡¹ | å‚è€ƒæ–‡æ¡£ä½ç½® | å®ç°çŠ¶æ€ | è¯´æ˜ |
|--------|------------|---------|------|
| Patch 1.1: Debug Snapshot | AUDIO_AGGREGATOR æ–‡æ¡£ Patch 1.1 | âš ï¸ éƒ¨åˆ†å®Œæˆ | å·²æ·»åŠ è§‚æµ‹æ•°æ®è¾“å‡ºï¼Œä½†æœªå®ç° ASR spy |
| Patch 1.2: Duration å£å¾„ç»Ÿä¸€ | AUDIO_AGGREGATOR æ–‡æ¡£ Patch 1.2 | âš ï¸ éƒ¨åˆ†å®Œæˆ | å·²ä½¿ç”¨ç»Ÿä¸€è®¡ç®—ï¼Œä½†æœªæå–ä¸º helper |
| Patch 1.3: æ¢å¤ R0-R5 æ‰§è¡Œ | AUDIO_AGGREGATOR æ–‡æ¡£ Patch 1.3 | âš ï¸ éƒ¨åˆ†å®Œæˆ | R0/R1 å·²æ¢å¤ï¼ŒR2-R5 ä»ä¸º skipped |
| Patch 1.4: pending ç”Ÿå‘½å‘¨æœŸæµ‹è¯• | AUDIO_AGGREGATOR æ–‡æ¡£ Patch 1.4 | âŒ æœªå®ç° | éœ€è¦æ–°å¢æµ‹è¯•ç”¨ä¾‹ |
| Patch 1.5: mergedDurationMs æ ¡éªŒ | AUDIO_AGGREGATOR æ–‡æ¡£ Patch 1.5 | âŒ æœªå®ç° | éœ€è¦æ–°å¢æµ‹è¯•ç”¨ä¾‹ |
| Patch 1.6: ç©ºæ ¸é”€ä¸¥æ ¼æ€§æµ‹è¯• | AUDIO_AGGREGATOR æ–‡æ¡£ Patch 1.6 | âš ï¸ éƒ¨åˆ†å®Œæˆ | R3/R4 å·²æœ‰ï¼Œä½†æœªæŒ‰æ–°æ ‡å‡†é‡æ„ |
| Patch 1.7: å¤š job å½’å±æµ‹è¯• | AUDIO_AGGREGATOR æ–‡æ¡£ Patch 1.7 | âš ï¸ éƒ¨åˆ†å®Œæˆ | R5 å·²æœ‰ï¼Œä½†æœªæŒ‰æ–°æ ‡å‡†é‡æ„ |
| Patch 2.1: å»éšæœºåŒ– | AUDIO_AGGREGATOR æ–‡æ¡£ Patch 2.1 | âš ï¸ éƒ¨åˆ†å®Œæˆ | é™éŸ³æ®µä»ä½¿ç”¨ Math.random() |
| Patch 2.2: æŒ‰ samples ç²¾ç¡®ç”Ÿæˆ | AUDIO_AGGREGATOR æ–‡æ¡£ Patch 2.2 | âŒ æœªå®ç° | éœ€è¦æ–°å¢ API |
| Patch 2.3: å¯æ§åˆ‡åˆ†æ¨¡å¼ | AUDIO_AGGREGATOR æ–‡æ¡£ Patch 2.3 | âŒ æœªå®ç° | éœ€è¦æ–°å¢ç”Ÿæˆå™¨ |

### 8.3 åç»­æ”¹è¿›å»ºè®®

#### 8.3.1 é«˜ä¼˜å…ˆçº§ï¼ˆå»ºè®®åœ¨ä¸‹ä¸€é˜¶æ®µå®Œæˆï¼‰

1. **å®ç° Debug Snapshot é‡‡é›†å™¨ï¼ˆPatch 1.1ï¼‰**
   - æ·»åŠ  ASR è°ƒç”¨ spyï¼Œæ•è· `ownerJobId`ã€`originalJobIds`ã€`audioDurationMs`ã€`reason`
   - ä¸ä¾èµ– loggerï¼Œç›´æ¥ä»è¿”å›å€¼/spy è·å–å…³é”®å¿«ç…§
   - **ä»·å€¼**: å¿«é€Ÿå®šä½"æ˜¯å¦ä¸è¯¥é€å´é€äº†"çš„é—®é¢˜

2. **æå– Duration Helperï¼ˆPatch 1.2ï¼‰**
   - åˆ›å»º `bytesToMsPcm16LE()` ç»Ÿä¸€å‡½æ•°
   - å®šä¹‰ `DURATION_TOLERANCE_MS = 80` å¸¸é‡
   - åˆ›å»º `expectApprox()` æ–­è¨€ helper
   - **ä»·å€¼**: é¿å…æµ‹è¯•å’Œä¸šåŠ¡ä»£ç çš„ duration å£å¾„ä¸ä¸€è‡´

3. **æ¢å¤ R2-R5 æµ‹è¯•æ‰§è¡Œï¼ˆPatch 1.3ï¼‰**
   - ç§»é™¤ `describe.skip` / `it.skip`
   - ç¡®ä¿æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹åœ¨ CI ä¸­æ‰§è¡Œ
   - **ä»·å€¼**: å®Œæ•´çš„å›å½’æµ‹è¯•è¦†ç›–

#### 8.3.2 ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®åœ¨åç»­è¿­ä»£å®Œæˆï¼‰

4. **æ–°å¢ pending ç”Ÿå‘½å‘¨æœŸæµ‹è¯•ï¼ˆPatch 1.4ï¼‰**
   - éªŒè¯ pending è·¨ job ä¿æŒ
   - éªŒè¯æœªè¾¾ MIN æ—¶ä¸åº”æ¸…ç©º pending
   - **ä»·å€¼**: å®šä½ pending è¢«æ„å¤–æ¸…ç©º/è¦†ç›–çš„é—®é¢˜

5. **æ–°å¢ mergedDurationMs å…³ç³»æ ¡éªŒï¼ˆPatch 1.5ï¼‰**
   - éªŒè¯ `mergedMs â‰ˆ pendingMs + incomingMs`ï¼ˆå®¹å·®å†…ï¼‰
   - **ä»·å€¼**: å®šä½ duration å£å¾„ä¸ä¸€è‡´å¯¼è‡´çš„ MIN/TTL åˆ†æ”¯èµ°é”™

6. **æ”¹è¿›éŸ³é¢‘ç”Ÿæˆå‡½æ•°ï¼ˆPatch 2.1, 2.2, 2.3ï¼‰**
   - å»éšæœºåŒ–ï¼šä½¿ç”¨ç¡®å®šæ€§å®ç°æ›¿ä»£ `Math.random()`
   - æŒ‰ samples ç²¾ç¡®ç”Ÿæˆï¼šæ–°å¢ `makePcm16BySamples()` API
   - å¯æ§åˆ‡åˆ†æ¨¡å¼ï¼šæ–°å¢ `makePausePatternAudio()` ç”Ÿæˆå™¨
   - **ä»·å€¼**: æé«˜æµ‹è¯•ç¨³å®šæ€§å’Œå¯é¢„æµ‹æ€§

#### 8.3.3 ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ï¼‰

7. **é‡æ„ R3/R4/R5 æµ‹è¯•ç”¨ä¾‹**
   - æŒ‰æ–°æ ‡å‡†é‡æ„ç©ºæ ¸é”€å’Œå¤š job å½’å±æµ‹è¯•
   - ä½¿ç”¨ Debug Snapshot è€Œéæ—¥å¿—æ–­è¨€
   - **ä»·å€¼**: ç»Ÿä¸€æµ‹è¯•é£æ ¼ï¼Œæé«˜å¯ç»´æŠ¤æ€§

### 8.4 æµ‹è¯•è¦†ç›–å¯¹æ¯”

| æµ‹è¯•åœºæ™¯ | R0/R1 ä¸“é¡¹ | AudioAggregator å…¨é¢ | å½“å‰çŠ¶æ€ |
|---------|-----------|---------------------|---------|
| pending äº§ç”ŸéªŒè¯ | âœ… | âœ… | å·²å®ç° |
| pending åˆå¹¶ < MIN | âœ… | âœ… | å·²å®ç°ï¼ˆR0ï¼‰ |
| pending åˆå¹¶ â‰¥ MIN | âœ… | âœ… | å·²å®ç°ï¼ˆR1ï¼‰ |
| pending ç”Ÿå‘½å‘¨æœŸä¿æŒ | âŒ | âœ… | æœªå®ç° |
| mergedDurationMs å…³ç³» | âŒ | âœ… | æœªå®ç° |
| ç©ºæ ¸é”€ä¸¥æ ¼æ€§ | âš ï¸ | âœ… | éƒ¨åˆ†å®ç°ï¼ˆR3/R4ï¼‰ |
| å¤š job å½’å± | âš ï¸ | âœ… | éƒ¨åˆ†å®ç°ï¼ˆR5ï¼‰ |
| TTL force flush | âš ï¸ | âœ… | éƒ¨åˆ†å®ç°ï¼ˆR2ï¼Œå·²è·³è¿‡ï¼‰ |

---

## ä¹ã€é™„å½•

### 9.1 ç›¸å…³æ–‡æ¡£

- `R0_R1_TEST_ONLY_MIN_PATCHLIST_AND_REGRESSION_CHECKLIST.md`: R0/R1 ä¸“é¡¹ä¿®å¤æ¸…å•ï¼ˆå·²å®Œæˆï¼‰
- `AUDIO_AGGREGATOR_TEST_ONLY_MIN_PATCHLIST_AND_REGRESSION_CHECKLIST.md`: AudioAggregator å…¨é¢æµ‹è¯•ä¿®å¤æ¸…å•ï¼ˆéƒ¨åˆ†å®Œæˆï¼‰
- `audio-aggregator.test.ts`: æµ‹è¯•æ–‡ä»¶
- `audio-aggregator-maxduration-handler.ts`: MaxDuration å¤„ç†é€»è¾‘
- `audio-aggregator-finalize-handler.ts`: Finalize å¤„ç†é€»è¾‘

### 9.2 å…³é”®ä»£ç ä½ç½®

| åŠŸèƒ½ | æ–‡ä»¶ | è¡Œå· |
|------|------|------|
| éŸ³é¢‘ç”Ÿæˆï¼ˆæ‰¹é‡æ¨¡å¼ï¼‰ | `audio-aggregator.test.ts` | 89-109 |
| R0 æµ‹è¯•ç”¨ä¾‹ | `audio-aggregator.test.ts` | 205-280 |
| R1 æµ‹è¯•ç”¨ä¾‹ | `audio-aggregator.test.ts` | 287-375 |
| å‰ç½®æ¡ä»¶æ–­è¨€ | `audio-aggregator.test.ts` | 220-237, 286-303 |

### 9.3 æµ‹è¯•å‘½ä»¤

```bash
# è¿è¡Œ R0/R1 æµ‹è¯•
cd electron_node/electron-node
npx jest --testPathPattern="audio-aggregator.test" --testNamePattern="R0|R1" --no-coverage
```

---

## æ–‡æ¡£ç‰ˆæœ¬

- **ç‰ˆæœ¬**: v1.0
- **æœ€åæ›´æ–°**: 2026-01-27
- **ä½œè€…**: AI Assistant (Auto)
- **å®¡æ ¸çŠ¶æ€**: å¾…å†³ç­–éƒ¨é—¨å®¡æ ¸
