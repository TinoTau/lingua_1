# 节点端日志未生成：原因与排查

## 一、日志写到哪里？

- **代码位置**：`electron_node/electron-node/main/src/logger.ts`（运行时可能用编译后的 `main/logger.js`）。
- **约定路径**：`<项目根>/logs/electron-main.log`；测试环境为 `electron-main.test.log`。
- **项目根**：由 `findProjectRoot(__dirname)` 得到，即**同时包含 `package.json` 和 `main` 目录**的那一级；若找不到则用 `process.cwd()`。

因此实际路径可能是：

- 从 **electron-node 目录** 启动（如 `npm run start`、`electron .`）：  
  `electron_node/electron-node/logs/electron-main.log`
- 从 **其他目录** 启动且 `findProjectRoot` 未找到「package.json + main」：  
  `process.cwd()/logs/electron-main.log`（可能是仓库根或脚本所在目录下的 `logs/`）

**启动时控制台会打一行**：`[Logger] Log file: <绝对路径>`，以该路径为准。

---

## 二、为什么日志没有生成？

### 1. 日志文件被其他进程占用（最常见）

- **逻辑**：pino 在加载 logger 时**同步打开** `electron-main.log`。若该文件已被别的进程打开（未关闭句柄），在 Windows 上常会报错（如 `EBUSY`/`EACCES`），**打开失败会抛错，导致进程在启动阶段退出**（见 logger 注释：「若文件被上一轮进程占用，pino 打开会失败，进程直接退出」）。
- **典型情况**：
  - 上一轮 Electron 或 node 主进程**未正常退出**（卡死、强杀、崩溃），仍持有该日志文件句柄。
  - 又启动了新的节点/Electron，新进程在 `require('logger')` 时打开同一文件失败 → 启动失败 → 看不到新日志。
- **表现**：进程起不来或很快退出，自然「没有新日志」；旧日志文件可能还在，但内容停留在上一轮。

**排查**：

1. 关掉所有与节点/Electron 相关的进程（任务管理器、`taskkill`、或关闭所有相关终端/窗口），再重新启动一次，看是否恢复正常写日志。
2. 用工具查「谁在占用该文件」：
   - **Windows**：Process Explorer → Find → Find Handle or DLL，搜 `electron-main.log`；或 `handle.exe`（Sysinternals）。
   - 结束占用该文件的进程后再启动。

### 2. 实际写的路径不是你查的那个

- 若启动时的**工作目录**或 **Electron 打包路径**导致 `findProjectRoot(__dirname)` 或 `process.cwd()` 和你预期不一致，日志会写到别的 `logs/` 下。
- **排查**：看启动时控制台输出的 `[Logger] Log file: ...`，去该**绝对路径**下找 `electron-main.log`；若没有这行，说明 logger 未加载（见下）。

### 3. 根本没走到写文件的进程

- 集成测试若只跑了 **Jest** 或只跑了 **渲染进程/其它服务**，而**没有启动主进程**（不加载 `main/logger.js`），则不会写 `electron-main.log`。
- Jest 里 logger 被 **mock**（`__mocks__/logger.ts`），只打控制台，不写文件。
- **排查**：确认你这次集成测试是否真的启动了「会 require logger 的那一个主进程」（例如 Electron 主进程或跑 pipeline 的 node 进程），并看其控制台是否有 `[Logger] Log file: ...`。

### 4. 日志目录无写权限

- 若 `logs/` 所在磁盘或目录无写权限，创建/写入会失败，进程可能同样在启动时抛错退出。
- **排查**：确认该目录可写（可手动在该目录建一个文件试一下）。

---

## 三、建议操作（按顺序）

1. **看启动时路径**  
   启动节点/Electron 后，在控制台找一行：  
   `[Logger] Log file: D:\...\logs\electron-main.log`  
   以后都去这个路径看日志。

2. **排除占用**  
   关掉所有可能占用该文件的进程（旧 Electron、旧 node、集成测试残留进程），再启动一次；必要时用 Process Explorer / handle 查占用。

3. **确认进程类型**  
   确认当前这次「集成测试」里，写 `electron-main.log` 的是哪个进程、从哪个目录启动，避免在错误的目录下找日志。

4. **若仍无法写文件**  
   可在 logger 中为「打开文件失败」加 fallback（见下），避免因日志文件不可用导致整个进程起不来。

---

## 四、代码侧可做的容错（可选）

若希望「即使日志文件打不开也不退出进程」，可在 `main/src/logger.ts` 中：

- 用 try/catch 包住 pino 的创建；
- 若 `destination: logFile` 失败，则 fallback 为仅写 stdout（或改用临时路径如 `electron-main.fallback.log`），并打出一行 `console.error` 说明无法写入原路径及原因。

这样即使文件被占用或权限有问题，进程仍能启动，便于继续排查（例如通过控制台或其它方式抓日志）。
