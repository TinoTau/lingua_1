# Aggregator P1 任务总结

**最后更新**：2025-01-XX  
**当前状态**：✅ NMT Repair 已完成，其他任务待开发

---

## P1 任务概览

| 任务编号 | 任务名称 | 状态 | 优先级 | 工作量 | 依赖 |
|---------|---------|------|--------|--------|------|
| AGG-10 | NMT Repair | ✅ 已完成 | - | 2-3 周 | - |
| AGG-11 | Glossary/专名/数字保护 | ⚠️ 待开发 | 🟡 中 | 1 周 | NMT Repair |
| AGG-12 | A/B 调参框架 | ⚠️ 待开发 | 🟢 低 | 1-2 周 | - |
| AGG-13 | 失败模式回放用例集 | ⚠️ 待开发 | 🟢 低 | 3-5 天 | - |
| - | Partial Results 处理 | ⚠️ 待开发 | 🟢 低 | 1-2 周 | - |

**P1 总工作量**：约 3-5 周（如果全部实现，不含已完成的 NMT Repair）

---

## 详细任务说明

### ✅ 1. NMT Repair（AGG-10）- 已完成

**功能描述**：
- 同音候选生成与打分
- 轻量去噪（重复、短尾、口头填充词）
- 保守修复（禁止新增实体/数字）
- **同音字自动学习**（新增）

**实现状态**：✅ **已完成**（2025-01-XX）

**实现内容**：
- ✅ NMT 候选生成（基于 beam search）
- ✅ 候选打分机制（规则分 + NMT 分 + 语言模型分）
- ✅ 同音字检测和修复
- ✅ 同音字自动学习（从修复结果中自动累积错误模式）

**详细文档**：
- `AGGREGATOR_NMT_REPAIR_IMPLEMENTATION.md` - 实现文档
- `AGGREGATOR_NMT_REPAIR_ANALYSIS.md` - 分析文档

**后续优化**（可选）：
- 改进差异检测算法（当前简化实现）
- 支持多词替换
- 添加学习模式验证机制

---

### ⚠️ 2. Glossary/专名/数字保护（AGG-11）- 待开发

**功能描述**：
- 在 NMT Repair 中保护 glossary 词
- 保护专名和数字不被修改
- 与 NMT Repair 配合使用

**复杂度**：中  
**预计工作量**：1 周  
**优先级**：🟡 中

**依赖**：
- ✅ NMT Repair（已完成）

**触发条件**：
- 如果 NMT Repair 误修改了专名或数字
- 如果用户需要保护特定的术语

**实现要点**：
1. **Glossary 接口**
   - 提供术语表接口，支持会议室/线下模式配置
   - 配置格式：
     ```toml
     [scheduler.asr_glossary]
     enabled = true
     conference_mode_words = ["会议室", "项目", "方案"]
     offline_mode_words = ["线下", "面对面"]
     ```

2. **专名检测**
   - 检测文本中的专名（人名、地名、公司名等）
   - 使用简单的规则或外部库

3. **数字保护**
   - 检测文本中的数字（包括中文数字）
   - 确保数字不被修改

4. **打分机制扩展**
   - 在候选打分中，对包含 glossary 词的候选加分
   - 对修改了 glossary 词的候选减分
   - 对修改了专名或数字的候选强减分

**实现位置**：
- 节点端：`electron_node/electron-node/main/src/aggregator/candidate-scorer.ts`
- 调度服务器：`central_server/scheduler/src/core/config.rs`

**判断标准**：
- 如果 NMT Repair 没有误修改专名或数字 → 不需要
- 如果出现了误修改 → 需要实现

**建议**：先观察实际使用情况，根据错误报告决定

---

### ⚠️ 3. Partial Results 处理 - 待开发

**功能描述**：
- 处理 `is_final: false` 的 partial results
- 使用更保守的 merge 策略
- 避免 partial results 导致的抖动

**复杂度**：中  
**预计工作量**：1-2 周  
**优先级**：🟢 低

**依赖**：无

**触发条件**：
- 如果需要更快的响应（< 500ms）
- 如果用户需要实时看到识别结果

**实现要点**：
1. **Partial Results 识别**
   - 识别 `is_final: false` 的结果
   - 使用不同的处理策略

2. **保守的 Merge 策略**
   - 对 partial results 使用更保守的 merge 阈值
   - 避免过早合并导致错误

3. **抖动避免**
   - 使用缓冲机制避免频繁更新
   - 只在有明显变化时才更新

4. **Final Results 处理**
   - 当收到 final result 时，合并之前的 partial results
   - 确保最终结果的完整性

**实现位置**：
- `electron_node/electron-node/main/src/aggregator/aggregator-state.ts`
- `electron_node/electron-node/main/src/agent/aggregator-middleware.ts`

**判断标准**：
- 如果 final 结果的处理速度已满足需求 → 不需要
- 如果需要更快的响应（< 500ms）→ 考虑实现

**建议**：先观察实际使用情况，根据延迟需求决定

---

### ⚠️ 4. A/B 调参框架（AGG-12）- 待开发

**功能描述**：
- 配置下发机制
- 回放评测框架
- 参数对比分析

**复杂度**：中  
**预计工作量**：1-2 周  
**优先级**：🟢 低

**依赖**：无

**触发条件**：
- 如果需要自动化调参
- 如果需要对比不同参数的效果

**实现要点**：
1. **配置下发机制**
   - Scheduler 下发配置到 Node
   - Node 接收并应用配置
   - 支持热更新（不重启）

2. **回放评测框架**
   - 记录历史对话数据
   - 使用不同参数回放测试
   - 对比效果指标

3. **参数对比分析**
   - 对比不同参数的效果
   - 生成对比报告
   - 推荐最佳参数

**实现位置**：
- 调度服务器：`central_server/scheduler/src/core/config.rs`
- 节点端：`electron_node/electron-node/main/src/agent/node-agent.ts`

**判断标准**：
- 如果手动调参已足够 → 不需要
- 如果需要自动化调参 → 考虑实现

**建议**：初期可以手动调参，后续根据需求决定

---

### ⚠️ 5. 失败模式回放用例集（AGG-13）- 待开发

**功能描述**：
- 收集典型失败场景的测试用例
- 包含夹杂语言、手动截断、停顿等场景
- 用于回归测试

**复杂度**：低  
**预计工作量**：3-5 天  
**优先级**：🟢 低

**依赖**：无

**触发条件**：
- 需要回归测试
- 需要验证修复效果

**实现要点**：
1. **用例收集**
   - 收集典型失败场景
   - 包含：
     - 夹杂语言场景
     - 手动截断场景
     - 停顿场景
     - 重复场景
     - 同音字错误场景

2. **用例格式**
   - 使用 JSON 格式存储
   - 包含输入、预期输出、实际输出

3. **自动化测试**
   - 使用用例集进行自动化测试
   - 生成测试报告

**实现位置**：
- `electron_node/docs/AGGREGATOR/test_vectors.json`（扩展）
- `electron_node/electron-node/tests/aggregator-test-vectors.ts`（扩展）

**判断标准**：
- 可以逐步积累
- 不需要一次性完成

**建议**：逐步积累，不需要一次性完成

---

## 推荐开发顺序

### 阶段 1：根据实际需求决定（1-2 周观察期）

1. **观察实际使用情况**
   - 收集用户反馈
   - 分析性能数据
   - 识别问题场景

2. **根据反馈决定开发顺序**
   - 如果出现误修改 → 优先开发 Glossary 保护
   - 如果需要更快响应 → 优先开发 Partial Results 处理
   - 如果需要自动化调参 → 考虑开发 A/B 调参框架

### 阶段 2：功能开发（根据需求）

1. **Glossary/专名/数字保护**（1 周）
   - 如果 NMT Repair 误修改了专名或数字
   - 优先级：🟡 中

2. **Partial Results 处理**（1-2 周）
   - 如果需要更快的响应（< 500ms）
   - 优先级：🟢 低

3. **A/B 调参框架**（1-2 周）
   - 如果需要自动化调参
   - 优先级：🟢 低

4. **失败模式用例集**（3-5 天）
   - 逐步积累
   - 优先级：🟢 低

---

## 关键决策点

### 是否需要 Glossary 保护？

**判断标准**：
- 如果 NMT Repair 没有误修改专名或数字 → 不需要
- 如果出现了误修改 → 需要实现

**建议**：先观察实际使用情况，根据错误报告决定

### 是否需要 Partial Results 处理？

**判断标准**：
- 如果 final 结果的处理速度已满足需求 → 不需要
- 如果需要更快的响应（< 500ms）→ 考虑实现

**建议**：先观察实际使用情况，根据延迟需求决定

### 是否需要 A/B 调参框架？

**判断标准**：
- 如果手动调参已足够 → 不需要
- 如果需要自动化调参 → 考虑实现

**建议**：初期可以手动调参，后续根据需求决定

---

## 总结

### 当前状态

✅ **NMT Repair 已完成**（AGG-10）  
⏸️ **其他 P1 任务待定**（根据实际需求决定）

### 下一步行动

1. **观察实际使用情况**（1-2 周）
   - 收集用户反馈
   - 分析性能数据
   - 识别问题场景

2. **根据反馈决定开发顺序**
   - 如果出现误修改 → Glossary 保护
   - 如果需要更快响应 → Partial Results 处理
   - 如果需要自动化调参 → A/B 调参框架

3. **逐步积累用例集**
   - 不需要一次性完成
   - 可以逐步积累

---

## 相关文档

- `AGGREGATOR_OPTIMIZATION_AND_REMAINING_WORK.md` - 优化与剩余工作
- `AGGREGATOR_NEXT_DEVELOPMENT_PLAN.md` - 下一步开发计划
- `AGGREGATOR_NMT_REPAIR_IMPLEMENTATION.md` - NMT Repair 实现文档

