# 集成测试性能问题分析

## 问题描述

用户报告：
1. **Job 9**：很短一句话等了20秒以上
2. **Job 12**：也有20秒，从翻译结果来看还丢失了半句话
3. **Job 13和Job 14**：又是对Job 12的重复

## 日志分析

### Job 9 时间线

- **09:42:59.834**: 第一次收到job_assign，音频被缓冲（Short utterance wait timeout）
- **09:42:59.834**: 返回空结果（因为音频还在缓冲）
- **09:43:09.008**: 第二次收到job_assign（**等待了9秒**）
- **09:43:09.033**: ASR INPUT
- **09:43:10.197**: ASR OUTPUT (**1.16秒**)
- **09:43:10.530**: Semantic repair completed (**0.33秒**)
- **09:43:10.531**: NMT INPUT
- **09:43:11.663**: NMT OUTPUT (**1.13秒**)
- **09:43:12.058**: TTS completed (**0.4秒**)

**分析**：
- 节点端处理时间：约**3秒**（ASR 1.16s + Semantic 0.33s + NMT 1.13s + TTS 0.4s）
- 但用户等了20秒以上，主要时间花在**等待下一个音频chunk到达**（9秒）

### Job 12 时间线

- **09:42:59.830**: 第一次收到job_assign
- **09:42:59.834**: 音频被缓冲（Short utterance detected, delaying processing）
- **09:42:59.834**: 返回空结果
- **09:43:32.064**: 第二次收到job_assign（**等待了32秒！**）
- **09:43:32.101**: ASR INPUT
- **09:43:34.103**: ASR OUTPUT (**2秒**)
- **09:43:34.728**: Semantic repair completed (**0.6秒**)
- **09:43:34.729**: NMT INPUT
- **09:43:36.716**: NMT OUTPUT (**1.99秒**)
- **09:43:37.140**: TTS completed (**0.4秒**)

**分析**：
- 节点端处理时间：约**5秒**（ASR 2s + Semantic 0.6s + NMT 1.99s + TTS 0.4s）
- 但用户等了20秒，主要时间花在**等待下一个音频chunk到达**（32秒）

### Job 12-14 合并分析

- **Job 12**: Action=NEW_STREAM, isLastInMergedGroup=False
- **Job 13**: Action=NEW_STREAM, isLastInMergedGroup=False
- **Job 14**: Action=MERGE, isLastInMergedGroup=True

**分析**：
- Job 12和13被合并到Job 14
- 但Job 12和13都是NEW_STREAM，说明它们没有被正确识别为需要合并的utterance
- 这可能导致Job 12和13的文本被单独处理，然后Job 14又使用了这些文本

## 根本原因

### 问题1：音频聚合等待时间过长

**现象**：
- Job 9和Job 12都触发了"Short utterance detected, delaying processing"
- 等待时间：Job 9等待9秒，Job 12等待32秒

**原因**：
- 短句延迟合并机制等待下一个chunk到达
- 如果用户说话停顿较长，等待时间会很长
- 当前等待时间设置为5秒，但如果音频仍然很短（<3秒），会继续等待

**影响**：
- 用户感觉系统很慢
- 实际上节点端处理很快（3-5秒），但等待时间很长（9-32秒）

### 问题2：Job 12文本丢失

**现象**：
- 用户说Job 12丢失了半句话
- 从web端输出看，Job 12的翻译不完整

**可能原因**：
1. **音频被切分**：AudioAggregator的fallback split可能在句子中间切分
2. **文本聚合问题**：Job 12的文本可能被错误地合并或切分
3. **Context_text问题**：Job 13和14可能使用了Job 12的不完整文本作为context

### 问题3：Job 13和14重复Job 12

**现象**：
- Job 13和14的翻译结果与Job 12重复

**可能原因**：
1. **文本合并问题**：Job 12、13、14的文本可能被错误地合并
2. **Context_text问题**：Job 13和14可能使用了Job 12的文本作为context，导致重复翻译
3. **去重逻辑问题**：DedupStage可能没有正确识别重复文本

## 建议的修复

### 修复1：优化短句等待机制

**问题**：等待时间过长，用户感觉系统很慢

**方案**：
1. 减少短句等待时间（从5秒减少到3秒）
2. 如果等待超时后音频仍然很短，不再继续等待，直接处理
3. 或者，根据音频时长动态调整等待时间

### 修复2：检查文本聚合逻辑

**问题**：Job 12文本丢失，Job 13和14重复

**方案**：
1. 检查AudioAggregator的fallback split逻辑，确保不在句子中间切分
2. 检查文本聚合逻辑，确保Job 12、13、14的文本正确合并
3. 检查context_text获取逻辑，确保不使用不完整的文本作为context

### 修复3：改进日志记录

**问题**：难以诊断问题

**方案**：
1. 记录每个服务的详细耗时
2. 记录文本聚合的详细信息（原始文本、聚合后文本、action等）
3. 记录context_text的获取和使用情况

## 下一步

1. 检查Job 12的ASR文本内容，确认是否被切分
2. 检查Job 12-14的context_text，确认是否有问题
3. 检查文本聚合逻辑，确认Job 12、13、14的合并是否正确
