# 性能问题根本原因分析

## 问题总结

### 问题1：Job 9和Job 12等待时间过长（20秒+）

**现象**：
- Job 9：第一次job_assign后等待9秒才收到第二次
- Job 12：第一次job_assign后等待32秒才收到第二次
- 节点端处理时间：Job 9约3秒，Job 12约5秒
- 用户感觉等了20秒以上

**根本原因**：
- **短句延迟合并机制等待时间过长**
- 当前逻辑：如果音频<8秒且`isManualCut=true`，延迟5秒等待下一个chunk
- 如果等待超时后音频仍然很短（<3秒），会继续等待（最多10秒）
- 如果用户说话停顿较长，等待时间会累积到10秒甚至更长

**影响**：
- 用户感觉系统很慢
- 实际上节点端处理很快（3-5秒），但等待时间很长（9-32秒）

### 问题2：Job 12文本丢失

**现象**：
- ASR文本是完整的："提高了一点,那我希望接下来可以做到更好更快 也就是说我们需要把这个事情继续做下去 然后这个架构也没有太大的问题,只是需要再提升一点速度"
- 但web端翻译结果不完整："improved a little, then i hope that the next can do better fasters."
- 丢失了后半句："也就是说我们需要把这个事情继续做下去 然后这个架构也没有太大的问题,只是需要再提升一点速度"

**可能原因**：
1. **NMT服务截断**：NMT服务可能因为某种原因截断了输出
2. **文本处理问题**：在文本传递过程中可能被截断
3. **Context_text问题**：如果context_text过长，可能导致NMT服务处理异常

### 问题3：Job 13和14重复Job 12

**现象**：
- Job 13的ASR文本："再提高了一点速度 然后再提高了一点速度"
- Job 14的ASR文本："再提高了一点速度 再提高了一点速度"
- Job 13的context_text是Job 12的完整文本
- Job 14的context_text是"再提高了一点速度"
- Web端输出显示Job 13和14的翻译与Job 12重复

**根本原因**：
- **Context_text获取逻辑问题**：
  - Job 13使用了Job 12的完整文本作为context_text
  - 但Job 13的ASR文本是"再提高了一点速度 然后再提高了一点速度"
  - 这导致NMT服务混淆，可能重复翻译了Job 12的内容

## 解决方案

### 修复1：优化短句等待机制（高优先级）

**问题**：等待时间过长，用户感觉系统很慢

**方案**：
1. **减少短句等待时间**：从5秒减少到3秒
2. **移除延长等待逻辑**：如果等待超时后音频仍然很短，不再继续等待，直接处理
3. **或者**：根据音频时长动态调整等待时间（音频越短，等待时间越短）

**修改文件**：
- `audio-aggregator.ts`

### 修复2：检查NMT服务输出（中优先级）

**问题**：Job 12文本丢失

**方案**：
1. 检查NMT服务的输出是否被截断
2. 检查文本传递过程中是否有截断
3. 检查context_text长度是否影响NMT服务

### 修复3：改进context_text获取逻辑（高优先级）

**问题**：Job 13和14使用了错误的context_text

**方案**：
1. 检查`getLastCommittedText`逻辑，确保返回正确的上一句
2. 如果当前句和上一句相似度很高，不使用context_text
3. 如果context_text是不完整句子，不使用context_text（已有修复，但可能需要加强）

## 立即修复

### 修复1：优化短句等待机制

**修改**：移除延长等待逻辑，减少等待时间

```typescript
// 修改前：如果音频仍然很短（<3秒），继续等待（最多10秒）
if (isStillVeryShort && elapsedMs < this.SHORT_UTTERANCE_WAIT_MS * 2) {
  // 延长等待时间
  buffer.shortUtteranceWaitUntil = nowMs + this.SHORT_UTTERANCE_WAIT_MS;
  return null; // 继续等待
}

// 修改后：等待超时后直接处理，不再延长等待
// 移除延长等待逻辑，直接处理
```

**同时**：减少短句等待时间从5秒到3秒

### 修复2：加强context_text检查

**修改**：在`getLastCommittedText`中加强检查，确保返回的context_text不会导致重复翻译

## 预期效果

1. **减少等待时间**：
   - Job 9和Job 12的等待时间从9-32秒减少到3秒以内
   - 用户感觉系统更快

2. **减少文本丢失**：
   - 检查NMT服务输出，确保文本完整

3. **减少重复翻译**：
   - 改进context_text获取逻辑，避免使用错误的context
