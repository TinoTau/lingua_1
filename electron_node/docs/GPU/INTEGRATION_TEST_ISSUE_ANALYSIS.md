# 集成测试问题分析

## 问题描述

根据web端输出，发现以下问题：

1. **job7翻译重复**：
   - 原文：[7] 但是这个诗里的内容或者说与医治疗得结果是非常的糟糕还不如之前
   - 译文：But the contents of this poem or saying that the results with medical repair are very bad even less than before **but the content of this poet or said that the result with medical treatment is very bad yet less than previously.**
   - 问题：翻译结果有重复，后半部分重复了前半部分的内容

2. **job14显示"重复的翻译"**：
   - 原文：[14] 重复的翻译 但是不知道为什么
   - 问题：去重逻辑可能有问题

3. **整体翻译质量差**：
   - 翻译结果不连贯
   - 可能是context_text不正确

## 需要检查的关键点

### 1. 每个服务的输入输出

需要检查日志中：
- **ASR输入**：原始音频
- **ASR输出**：识别文本
- **聚合输入**：ASR文本
- **聚合输出**：聚合后的文本
- **语义修复输入**：聚合文本
- **语义修复输出**：修复后的文本
- **NMT输入**：修复后的文本 + context_text
- **NMT输出**：翻译文本
- **去重检查**：是否被过滤

### 2. 文本合并逻辑

检查：
- 哪些job被合并了？
- 合并后的文本是什么？
- 合并后的job使用哪个utterance_index？

### 3. 去重逻辑

检查：
- DedupStage是否正确过滤了重复的job_id？
- 是否有同一个job被处理了多次？

### 4. context_text获取

检查：
- NMT获取的context_text是什么？
- 是否正确获取到上一个utterance的文本？
- 顺序执行是否影响了context_text的获取？

## 可能的原因

### 1. job7翻译重复的可能原因

1. **NMT服务返回了重复结果**：
   - NMT服务本身的问题
   - 需要检查NMT服务的日志

2. **同一个文本被翻译了两次**：
   - 顺序执行管理器可能没有正确阻止重复执行
   - 或者有多个任务同时执行了相同的文本

3. **文本合并问题**：
   - 如果job7被合并了，可能合并逻辑有问题
   - 或者合并后的文本包含了重复内容

### 2. job14"重复的翻译"的可能原因

1. **去重逻辑问题**：
   - DedupStage可能没有正确记录已发送的job_id
   - 或者同一个job被处理了多次

2. **job被重复提交**：
   - 调度服务器可能重复发送了同一个job
   - 或者节点端重复处理了同一个job

### 3. 整体翻译质量差的可能原因

1. **context_text不正确**：
   - 如果顺序执行导致任务顺序混乱，context_text可能获取错误
   - 或者getLastCommittedText返回了错误的文本

2. **文本合并问题**：
   - 合并后的文本可能不连贯
   - 或者合并逻辑有问题

3. **顺序执行问题**：
   - 如果任务没有按正确顺序执行，可能导致context_text错误

## 建议的检查步骤

1. **检查日志**：
   - 搜索每个job的完整处理流程
   - 检查ASR、聚合、语义修复、NMT、去重的输入输出

2. **检查顺序执行**：
   - 确认任务是否按正确顺序执行
   - 检查是否有任务被跳过或重复执行

3. **检查文本合并**：
   - 确认哪些job被合并了
   - 检查合并后的文本是否正确

4. **检查去重**：
   - 确认DedupStage是否正确工作
   - 检查是否有重复的job_id

5. **检查context_text**：
   - 确认NMT获取的context_text是什么
   - 检查getLastCommittedText是否正确

## 需要添加的日志

为了便于调试，建议添加以下日志：

1. **每个服务的输入输出**：
   - ASR输入输出
   - 聚合输入输出
   - 语义修复输入输出
   - NMT输入输出（包括context_text）
   - 去重检查结果

2. **顺序执行状态**：
   - 任务提交时的状态
   - 任务执行时的状态
   - 任务完成时的状态

3. **文本合并状态**：
   - 哪些job被合并了
   - 合并后的文本是什么

4. **去重状态**：
   - job_id是否已发送
   - 去重检查结果
