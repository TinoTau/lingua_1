# 阶段 3.1：模型管理功能测试

## 测试概述

本目录包含阶段 3.1（模型管理功能）的单元测试和功能测试。

**测试日期**: 2025-01-XX  
**测试范围**: 
- 服务器端模型库 API
- 客户端 ModelManager 核心功能
- 模型下载、校验、安装
- 任务锁和文件锁机制
- 断点续传
- 多文件并发下载
- registry.json 原子写入
- ModelNotAvailableError 错误处理
- IPC 进度事件推送

## 测试模块

### 1. 服务器端 API 测试
- `/api/models` 接口测试
- `/api/models/{model_id}` 接口测试
- `/storage/models/{model_id}/{version}/{file_path}` 文件下载测试
- `/api/model-usage/ranking` 热门模型排行测试
- Range 请求支持测试
- 路径遍历攻击防护测试

### 2. ModelManager 核心功能测试
- 模型列表获取测试
- 模型下载测试
- 断点续传测试
- 多文件并发下载测试
- SHA256 校验测试
- 模型安装测试
- 模型卸载测试
- getModelPath 测试

### 2.1 模型下载进度显示测试
- 进度事件结构测试
- 进度状态转换测试
- 下载速度计算测试
- 剩余时间计算测试
- 文件进度跟踪测试
- 总进度计算测试

### 2.2 模型下载错误处理测试
- 错误分类测试（网络、磁盘、校验、未知）
- 可重试判断测试
- 错误信息格式化测试
- 自动重试机制测试（指数退避、重试次数限制）

### 2.3 模型验证功能测试
- 文件存在性检查测试
- 文件大小验证测试
- SHA256 校验测试
- 验证进度计算测试

### 3. 锁机制测试
- 任务锁获取和释放测试
- 文件锁测试
- 孤儿锁清理测试
- 锁超时测试
- 并发下载冲突测试

### 4. registry.json 测试
- 原子写入测试
- 多版本共存测试
- 文件损坏恢复测试

### 5. 错误处理测试
- ModelNotAvailableError 测试
- 网络错误重试测试
- 校验失败处理测试
- 调度服务器错误上报测试

### 6. IPC 集成测试
- 进度事件推送测试
- 错误事件推送测试
- IPC 接口测试

## 运行测试

### 前置条件

1. **启动模型库服务**：
```bash
cd model-hub
export MODELS_DIR=./models
python src/main.py
```

2. **准备测试模型文件**（可选）：
```bash
# 在 models/storage/ 目录下创建测试模型结构
mkdir -p models/storage/test-model/1.0.0
# 添加测试文件
```

### 运行单元测试

```bash
cd electron-node
npm install  # 安装 Jest 等测试依赖
npm run test:stage3.1
```

或者运行所有测试：

```bash
npm test
```

## 测试检查清单

- [ ] 服务器端 API 正常响应
- [ ] 模型列表获取正常
- [ ] 文件下载支持 Range 请求
- [ ] 模型下载功能正常
- [ ] 断点续传功能正常
- [ ] 多文件并发下载正常
- [ ] SHA256 校验正常
- [ ] 任务锁机制正常
- [ ] registry.json 原子写入正常
- [ ] 错误处理正常
- [ ] IPC 事件推送正常

