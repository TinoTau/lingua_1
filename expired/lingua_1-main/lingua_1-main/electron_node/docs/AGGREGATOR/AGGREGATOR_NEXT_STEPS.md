# Aggregator 接下来的开发内容

**最后更新**：2025-01-XX  
**当前状态**：✅ P0 功能已完成

---

## 当前完成状态

### ✅ P0 核心功能（100% 完成）

- ✅ 核心决策逻辑（Text Incompleteness Score + Language Stability Gate）
- ✅ Dedup（边界重叠裁剪）
- ✅ Tail Carry（尾巴延迟归属）
- ✅ 会话态管理（per session）
- ✅ gap_ms 计算（从 segments 推导）
- ✅ 中间件集成（NodeAgent）
- ✅ 重新触发 NMT（已完成并测试通过）

### ✅ P0 测试与优化（100% 完成）

- ✅ 功能测试与验证
- ✅ 单元测试完善
- ✅ 重新触发 NMT 实现
- ✅ 参数调优（已进行多轮优化）

---

## 接下来的开发内容

### 阶段 1：性能优化（可选，1-2 周）

#### 1. 重新翻译延迟优化 ⚠️ **建议实现**

**当前状态**：
- 平均延迟：1077.67ms
- 目标：< 500ms

**优化方案**：

**方案 A：缓存机制**（推荐）
- **功能**：缓存最近翻译的文本，避免重复翻译
- **复杂度**：低
- **预计工作量**：2-3 天
- **效果**：如果文本重复率高，可以显著降低延迟

**方案 B：异步处理**
- **功能**：先返回结果，异步重新翻译
- **复杂度**：中
- **预计工作量**：3-5 天
- **效果**：不增加主流程延迟，但翻译更新会有延迟

**方案 C：批量处理**
- **功能**：如果多个 utterance 同时聚合，批量翻译
- **复杂度**：中
- **预计工作量**：2-3 天
- **效果**：减少 NMT 调用次数

**优先级**：🟡 中等（功能正常，但延迟较高）

---

#### 2. 上下文传递优化 ⚠️ **建议实现**

**当前状态**：
- `context_text` 设置为 `undefined`
- 可能影响翻译质量

**优化方案**：
- 传递上一个 utterance 的文本作为上下文
- 提升翻译质量（特别是连续对话场景）

**复杂度**：低  
**预计工作量**：1-2 天  
**优先级**：🟡 中等

---

### 阶段 2：P1 增强功能（可选，根据需求）

#### 1. NMT Repair（AGG-10） ⚠️ **待开发**

**功能描述**：
- 同音候选生成与打分
- 轻量去噪（重复、短尾、口头填充词）
- 保守修复（禁止新增实体/数字）

**复杂度**：高  
**预计工作量**：2-3 周

**依赖**：
- NMT 服务需要支持候选生成
- 需要 glossary/专名保护机制

**优先级**：🟡 中等（如果 P0 效果良好，可能不需要）

**判断标准**：
- 如果 P0 的 Dedup + Tail Carry + 重新翻译已能解决大部分问题 → 可能不需要
- 如果仍有明显的同音字错误 → 考虑实现

---

#### 2. Partial Results 处理 ⚠️ **待开发**

**功能描述**：
- 处理 `is_final: false` 的 partial results
- 使用更保守的 merge 策略
- 避免 partial results 导致的抖动

**复杂度**：中  
**预计工作量**：1-2 周

**优先级**：🟢 低（P0 只处理 final 结果已足够）

**判断标准**：
- 如果 final 结果的处理速度已满足需求 → 不需要
- 如果需要更快的响应（< 500ms）→ 考虑实现

---

#### 3. A/B 调参框架（AGG-12） ⚠️ **待开发**

**功能描述**：
- 配置下发机制
- 回放评测框架
- 参数对比分析

**复杂度**：中  
**预计工作量**：1-2 周

**优先级**：🟢 低（初期可以手动调参）

---

#### 4. Glossary/专名/数字保护（AGG-11） ⚠️ **待开发**

**功能描述**：
- 在 NMT Repair 中保护 glossary 词
- 保护专名和数字不被修改
- 与 NMT Repair 配合使用

**复杂度**：中  
**预计工作量**：1 周

**依赖**：需要先实现 NMT Repair

**优先级**：🟢 低（依赖 NMT Repair）

---

#### 5. 失败模式回放用例集（AGG-13） ⚠️ **待开发**

**功能描述**：
- 收集典型失败场景的测试用例
- 包含夹杂语言、手动截断、停顿等场景
- 用于回归测试

**复杂度**：低  
**预计工作量**：3-5 天

**优先级**：🟢 低（可以逐步积累）

---

## 推荐开发顺序

### 立即执行（如果性能优化）

1. **重新翻译延迟优化**（2-3 天）
   - 添加缓存机制
   - 预期效果：如果文本重复率高，可以显著降低延迟

2. **上下文传递优化**（1-2 天）
   - 传递上一个 utterance 的文本作为上下文
   - 预期效果：提升翻译质量

### 短期规划（1-2 周）

1. **性能监控和优化**（持续）
   - 收集更多使用数据
   - 根据实际效果调整参数
   - 优化重新翻译延迟

### 长期规划（根据需求）

1. **NMT Repair**（2-3 周）
   - 如果 P0 效果不够好，考虑实现
   - 需要 NMT 服务支持

2. **Partial Results 处理**（1-2 周）
   - 如果需要更快的响应，考虑实现

3. **其他增强功能**（根据实际需求）

---

## 工作量估算

### 性能优化（可选）

| 任务 | 工作量 | 优先级 | 状态 |
|------|--------|--------|------|
| 重新翻译延迟优化（缓存） | 2-3 天 | 🟡 中 | ⚠️ 待实现 |
| 上下文传递优化 | 1-2 天 | 🟡 中 | ⚠️ 待实现 |
| 异步处理优化 | 3-5 天 | 🟢 低 | ⚠️ 待实现 |

**性能优化总工作量**：约 1-2 周（如果全部实现）

### P1 增强功能（可选）

| 任务 | 工作量 | 优先级 | 状态 |
|------|--------|--------|------|
| NMT Repair | 2-3 周 | 🟡 中 | ⚠️ 待开发 |
| Partial Results 处理 | 1-2 周 | 🟢 低 | ⚠️ 待开发 |
| A/B 调参框架 | 1-2 周 | 🟢 低 | ⚠️ 待开发 |
| Glossary 保护 | 1 周 | 🟢 低 | ⚠️ 待开发 |
| 失败模式用例集 | 3-5 天 | 🟢 低 | ⚠️ 待开发 |

**P1 总工作量**：约 5-8 周（如果全部实现）

---

## 关键决策点

### 是否需要性能优化？

**判断标准**：
- 如果当前延迟（1077.67ms）可接受 → 不需要
- 如果延迟影响用户体验 → 需要优化

**建议**：
- **缓存机制**：如果文本重复率高，建议实现（2-3 天）
- **异步处理**：如果延迟要求不高，可以考虑（3-5 天）

### 是否需要上下文传递？

**判断标准**：
- 如果翻译质量已满足需求 → 不需要
- 如果连续对话场景翻译质量不够好 → 需要实现

**建议**：建议实现（1-2 天，工作量小，效果明显）

### 是否需要 P1 功能？

**判断标准**：
- 如果 P0 效果已满足需求 → 不需要
- 如果仍有明显问题 → 考虑实现

**建议**：先使用 P0 功能，根据实际效果决定是否开发 P1 功能

---

## 总结

### 当前状态

✅ **P0 功能已完成**（100%）  
✅ **测试通过**（重新触发 NMT 功能正常工作）  
⏸️ **性能优化待定**（根据需求决定）

### 下一步建议

1. **立即执行**（如果性能优化）：
   - 重新翻译延迟优化（缓存机制，2-3 天）
   - 上下文传递优化（1-2 天）

2. **短期规划**（1-2 周）：
   - 性能监控和优化
   - 根据实际使用数据调整参数

3. **长期规划**（根据需求）：
   - 根据 P0 效果决定是否开发 P1 功能

### 工作量估算

- **性能优化**：约 1-2 周（可选）
- **P1 增强**：约 5-8 周（如果全部实现）

**建议**：P0 功能已完成并正常工作，可以继续使用。根据实际使用效果和需求决定是否进行性能优化或开发 P1 功能。

---

## 相关文档

- `AGGREGATOR_OPTIMIZATION_AND_REMAINING_WORK.md` - 优化与剩余工作
- `AGGREGATOR_NMT_RETRANSLATION_IMPLEMENTATION.md` - 重新触发 NMT 实现文档
- `AGGREGATOR_NMT_RETRANSLATION_TEST_REPORT.md` - 重新触发 NMT 测试报告
- `AGGREGATOR_IMPLEMENTATION_STATUS_AND_ARCHITECTURE.md` - 实现状态与架构

