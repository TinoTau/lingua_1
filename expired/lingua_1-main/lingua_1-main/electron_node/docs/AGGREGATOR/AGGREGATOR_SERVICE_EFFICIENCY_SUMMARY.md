# 服务处理效率总结

**日期**：2025-01-XX  
**数据来源**：节点端日志分析（最近 10-11 个任务）

---

## 当前处理效率

### 总体指标

| 服务/阶段 | 平均时间 | 中位数 | 范围 | 说明 |
|-----------|---------|--------|------|------|
| **Pipeline Orchestration** | 2421.2 ms | 1585 ms | 1219-5216 ms | ASR + NMT + TTS 总时间 |
| **Job Total** | 2537.91 ms | 2069 ms | 43-6257 ms | Pipeline + Aggregator + 网络 |
| **NMT Retranslation** | ~1077.67 ms | - | 348-1215 ms | 重新翻译时间（缓存命中时 < 10ms） |
| **TTS Synthesis** | 378.48 ms | 102.61 ms | 91.52-2381.21 ms | TTS 实际合成时间 |

---

## 各服务估算时间

### 基于中位数（更准确）

```
Pipeline 中位数：1585 ms
├─ ASR：~800-1000 ms（估算）
├─ NMT：~500-800 ms（估算）
├─ TTS：~300 ms（102.61 ms 合成 + 200 ms 网络）
└─ 其他开销：~200 ms
```

### 基于平均值

```
Pipeline 平均：2421.2 ms
├─ ASR：~1000-1500 ms（估算）
├─ NMT：~600-1000 ms（估算）
├─ TTS：~600 ms（378.48 ms 合成 + 200 ms 网络）
└─ 其他开销：~200 ms
```

---

## 效率指标

### ASR 效率（估算）

**假设音频时长 2 秒（2000ms）**：
- 处理时间 1000ms → 效率 **2.0x**（2倍实时）
- 处理时间 1500ms → 效率 **1.33x**（1.33倍实时）

**结论**：ASR 效率良好，通常能达到实时或更快

---

### NMT 效率（估算）

**假设文本 50 字符**：
- 处理时间 500ms → 效率 **100 字符/秒**
- 处理时间 800ms → 效率 **62.5 字符/秒**
- 处理时间 1000ms → 效率 **50 字符/秒**

**结论**：NMT 效率中等，通常在 50-100 字符/秒

---

### TTS 效率（实际数据）

**从日志中提取的实际数据**：
- 平均合成时间：378.48 ms
- 中位数合成时间：102.61 ms（大部分任务很快）
- 假设音频时长 2 秒（2000ms）：
  - 处理时间 100ms → 效率 **20.0x**（20倍实时）
  - 处理时间 378ms → 效率 **5.3x**（5.3倍实时）

**结论**：TTS 效率优秀，通常能达到 5-20 倍实时

---

## 性能瓶颈

### 1. Pipeline 总时间

**当前状态**：
- 平均：2421.2 ms
- 中位数：1585 ms

**分析**：
- 中位数接近目标（< 1500 ms）
- 平均值偏高，可能是部分复杂任务拉高了平均值
- 最大值 5216 ms 可能是网络问题或复杂任务

**优化建议**：
- 优化网络传输
- 减少序列化/反序列化开销
- 优化错误处理（避免重试导致延迟）

---

### 2. NMT 重新翻译

**当前状态**：
- 平均：~1077.67 ms
- 范围：348-1215 ms

**已实施优化**：
- ✅ 缓存机制（缓存命中时 < 10ms）
- ✅ 上下文传递（1分钟过期）

**进一步优化**：
- 如果缓存命中率仍然不高，考虑缓存原始文本的翻译

---

### 3. TTS 时间波动

**当前状态**：
- 平均：378.48 ms
- 中位数：102.61 ms
- 最大值：2381.21 ms

**分析**：
- 中位数很快（102.61 ms），说明大部分任务性能良好
- 最大值可能是首次加载模型或长文本
- 平均值被少数慢任务拉高

**优化建议**：
- 预热 TTS 模型（避免首次加载延迟）
- 优化长文本处理

---

## 如何获取详细效率数据

### 方法 1：运行分析脚本

```powershell
powershell -ExecutionPolicy Bypass -File tests/analyze-service-times.ps1
```

### 方法 2：查看心跳消息

处理效率指标在心跳消息中上报，包含：
- `processing_metrics.serviceEfficiencies`：按服务ID分组的效率
- `asr_metrics.processingEfficiency`：ASR 效率（向后兼容）

### 方法 3：通过 IPC 接口

在 Electron 应用中：
```typescript
const metrics = await window.electronAPI.getProcessingMetrics();
// 返回：Record<serviceId, efficiency>
```

---

## 效率指标说明

### ASR 效率

**定义**：`效率 = 音频时长(ms) / 处理时间(ms)`

**典型值**：
- 实时处理：1.0x
- 2倍实时：2.0x
- 慢于实时：< 1.0x

**当前估算**：1.33-2.0x（良好）

---

### NMT 效率

**定义**：`效率 = 文本长度(字符) / 处理时间(ms) * 1000`（字符/秒）

**典型值**：
- 50-100 字符/秒：中等
- 100-200 字符/秒：良好
- > 200 字符/秒：优秀

**当前估算**：50-100 字符/秒（中等）

---

### TTS 效率

**定义**：`效率 = 音频时长(ms) / 处理时间(ms)`

**典型值**：
- 实时处理：1.0x
- 5倍实时：5.0x
- 20倍实时：20.0x

**当前实际**：5.3-20.0x（优秀）

---

## 相关文档

- `AGGREGATOR_SERVICE_EFFICIENCY_REPORT.md` - 详细效率报告
- `AGGREGATOR_PERFORMANCE_OPTIMIZATION_PLAN.md` - 性能优化方案

