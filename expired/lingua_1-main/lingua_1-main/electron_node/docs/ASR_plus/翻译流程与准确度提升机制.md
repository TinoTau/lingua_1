# èŠ‚ç‚¹ç«¯ç¿»è¯‘æµç¨‹ä¸å‡†ç¡®åº¦æå‡æœºåˆ¶

## ä¸€ã€å®Œæ•´æµç¨‹æ¦‚è§ˆ

### 1.1 ä»»åŠ¡æ¥æ”¶é˜¶æ®µ

**ä½ç½®**ï¼š`node-agent.ts` â†’ `handleMessage()` â†’ `handleJob()`

**æµç¨‹**ï¼š
1. èŠ‚ç‚¹ç«¯é€šè¿‡ WebSocket æ¥æ”¶è°ƒåº¦æœåŠ¡å™¨å‘é€çš„ `job_assign` æ¶ˆæ¯
2. æ¶ˆæ¯åŒ…å«ï¼šéŸ³é¢‘æ•°æ®ï¼ˆOpusæ ¼å¼ï¼‰ã€æºè¯­è¨€ã€ç›®æ ‡è¯­è¨€ã€ä¼šè¯IDã€utteranceç´¢å¼•ç­‰
3. è¿›è¡Œé‡å¤ä»»åŠ¡æ£€æµ‹ï¼ˆé˜²æ­¢ç›¸é‚»é‡å¤å¤„ç†ï¼‰
4. è°ƒç”¨ `JobProcessor.processJob()` å¼€å§‹å¤„ç†

**å…³é”®ä»£ç **ï¼š
```273:333:electron_node/electron-node/main/src/agent/node-agent.ts
  private async handleMessage(data: string): Promise<void> {
    try {
      const message = JSON.parse(data);

      switch (message.type) {
        case 'node_register_ack': {
          const ack = message as NodeRegisterAckMessage;
          this.nodeId = ack.node_id;
          // æ›´æ–°æ‰€æœ‰handlerçš„nodeIdï¼ˆç¡®ä¿å®ƒä»¬æœ‰æ­£ç¡®çš„nodeIdå’ŒWebSocketè¿æ¥ï¼‰
          this.heartbeatHandler.updateConnection(this.ws, this.nodeId);
          this.registrationHandler.updateConnection(this.ws, this.nodeId);
          this.jobProcessor.updateConnection(this.ws, this.nodeId);
          this.resultSender.updateConnection(this.ws, this.nodeId);
          logger.info({ nodeId: this.nodeId }, 'Node registered successfully');
          // ç«‹åˆ»è¡¥å‘ä¸€æ¬¡å¿ƒè·³ï¼ŒæŠŠ installed_services/capability_state å°½å¿«åŒæ­¥åˆ° Scheduler
          this.heartbeatHandler.sendHeartbeatOnce().catch((error) => {
            logger.warn({ error }, 'Failed to send immediate heartbeat after node_register_ack');
          });
          break;
        }

        case 'job_assign': {
          const job = message as JobAssignMessage;
          // è¯Šæ–­ï¼šè®°å½•æ¥æ”¶åˆ°çš„ audio_formatï¼ˆç”¨äºè°ƒè¯•ä¸ºä»€ä¹ˆä¼šå‡ºç°ç©ºå€¼ï¼‰
          logger.info(
            {
              jobId: job.job_id,
              traceId: job.trace_id,
              audioFormat: job.audio_format,
              audioFormatType: typeof job.audio_format,
              audioFormatLength: job.audio_format?.length,
              hasAudioFormat: 'audio_format' in job,
              messageKeys: Object.keys(job),
            },
            'Received job_assign message, checking audio_format field'
          );
          await this.handleJob(job);
          break;
        }

        case 'job_cancel': {
          const cancel = message as JobCancelMessage;
          const ok = this.inferenceService.cancelJob(cancel.job_id);
          logger.info(
            { jobId: cancel.job_id, traceId: cancel.trace_id, reason: cancel.reason, ok },
            'Received job_cancel from scheduler'
          );
          break;
        }

        case 'pairing_code':
          // é…å¯¹ç å·²ç”Ÿæˆï¼Œé€šè¿‡ IPC é€šçŸ¥æ¸²æŸ“è¿›ç¨‹
          break;

        default:
          logger.warn({ messageType: message.type }, 'Unknown message type');
      }
    } catch (error) {
      logger.error({ error }, 'Failed to handle message');
    }
  }
```

---

### 1.2 ASRï¼ˆè¯­éŸ³è¯†åˆ«ï¼‰é˜¶æ®µ

**ä½ç½®**ï¼š`pipeline-orchestrator.ts` â†’ `processJob()`

#### æ­¥éª¤1ï¼šéŸ³é¢‘èšåˆï¼ˆæå‡å‡†ç¡®åº¦æœºåˆ¶ #1ï¼‰

**ä½ç½®**ï¼š`audio-aggregator.ts`

**æœºåˆ¶è¯´æ˜**ï¼š
- **ç›®çš„**ï¼šåœ¨ASRä¹‹å‰æ ¹æ® `is_manual_cut` å’Œ `is_pause_triggered` æ ‡è¯†èšåˆéŸ³é¢‘å—
- **æ•ˆæœ**ï¼šé¿å…ASRè¯†åˆ«ä¸å®Œæ•´çš„çŸ­å¥ï¼Œæé«˜è¯†åˆ«å‡†ç¡®ç‡
- **å®ç°**ï¼šçŸ­éŸ³é¢‘å—ä¼šè¢«ç¼“å†²ï¼Œç­‰å¾…æ›´å¤šéŸ³é¢‘å—æˆ–è§¦å‘æ ‡è¯†åå†è¿›è¡ŒASR

**å…³é”®ä»£ç **ï¼š
```80:110:pipeline-orchestrator.ts
      // éŸ³é¢‘èšåˆï¼šåœ¨ASRä¹‹å‰æ ¹æ® is_manual_cut å’Œ is_pause_triggered æ ‡è¯†èšåˆéŸ³é¢‘
      // è¿™æ ·å¯ä»¥é¿å…ASRè¯†åˆ«ä¸å®Œæ•´çš„çŸ­å¥ï¼Œæé«˜è¯†åˆ«å‡†ç¡®ç‡
      const aggregatedAudio = await this.audioAggregator.processAudioChunk(job);
      
      // å¦‚æœè¿”å›nullï¼Œè¯´æ˜éŸ³é¢‘è¢«ç¼“å†²ï¼Œç­‰å¾…æ›´å¤šéŸ³é¢‘å—æˆ–è§¦å‘æ ‡è¯†
      // æ­¤æ—¶åº”è¯¥è¿”å›ç©ºç»“æœï¼Œä¸è¿›è¡ŒASRå¤„ç†
      if (aggregatedAudio === null) {
        logger.info(
          {
            jobId: job.job_id,
            sessionId: job.session_id,
            utteranceIndex: job.utterance_index,
            bufferStatus: this.audioAggregator.getBufferStatus(job.session_id),
          },
          'PipelineOrchestrator: Audio chunk buffered, waiting for more chunks or trigger. Returning empty result.'
        );
        // è¿”å›ç©ºç»“æœï¼Œç­‰å¾…æ›´å¤šéŸ³é¢‘å—æˆ–è§¦å‘æ ‡è¯†
        return {
          text_asr: '',
          text_translated: '',
          tts_audio: '',
          tts_format: 'pcm16',
          extra: {
            emotion: undefined,
            speech_rate: undefined,
            voice_style: undefined,
            language_probability: undefined,
            language_probabilities: undefined,
          },
        };
      }
```

#### æ­¥éª¤2ï¼šæ„å»ºPromptä¸Šä¸‹æ–‡ï¼ˆæå‡å‡†ç¡®åº¦æœºåˆ¶ #2ï¼‰

**ä½ç½®**ï¼š`pipeline-orchestrator-asr.ts` â†’ `buildPrompt()`

**æœºåˆ¶è¯´æ˜**ï¼š
- **ç›®çš„**ï¼šä¸ºASRæœåŠ¡æä¾›ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œæé«˜è¯†åˆ«å‡†ç¡®åº¦
- **å†…å®¹æ¥æº**ï¼š
  - ç”¨æˆ·é…ç½®çš„å…³é”®è¯ï¼ˆuserKeywordsï¼‰
  - æœ€è¿‘å·²æäº¤çš„æ–‡æœ¬ï¼ˆrecentCommittedTextï¼‰
  - è´¨é‡é—¨æ§ï¼šæ ¹æ®æœ€è¿‘è´¨é‡åˆ†æ•°å†³å®šæ˜¯å¦ä½¿ç”¨ä¸Šä¸‹æ–‡
    - è´¨é‡ < 0.4ï¼šå®Œå…¨ç¦ç”¨ä¸Šä¸‹æ–‡
    - è´¨é‡ 0.4-0.65ï¼šåªä½¿ç”¨ç”¨æˆ·å…³é”®è¯
    - è´¨é‡ >= 0.65ï¼šä½¿ç”¨å…³é”®è¯ + æœ€è¿‘ä¸Šä¸‹æ–‡

**å…³é”®ä»£ç **ï¼š
```47:85:pipeline-orchestrator-asr.ts
  buildPrompt(job: JobAssignMessage): string | undefined {
    let contextText = (job as any).context_text;  // ä¿ç•™åŸæœ‰çš„context_text
    if (this.enableS1PromptBias && this.aggregatorManager && this.promptBuilder && job.session_id) {
      try {
        const state = this.aggregatorManager.getOrCreateState(job.session_id, 'offline');
        const recentCommittedText = (state as any).getRecentCommittedText();
        const userKeywords = (state as any).getRecentKeywords();
        
        // è·å–å½“å‰è´¨é‡åˆ†æ•°ï¼ˆå¦‚æœæœ‰ï¼‰
        const lastQuality = (state as any).getLastCommitQuality();
        
        // è®°å½• context_text çš„è¯¦ç»†ä¿¡æ¯ï¼ˆç”¨äºè°ƒè¯• Job2 é—®é¢˜ï¼‰
        logger.info(
          {
            jobId: job.job_id,
            utteranceIndex: job.utterance_index,
            sessionId: job.session_id,
            originalContextText: contextText ? contextText.substring(0, 100) : null,
            originalContextTextLength: contextText?.length || 0,
            recentCommittedTextCount: recentCommittedText.length,
            recentCommittedTextPreview: recentCommittedText.slice(0, 3).map((t: string) => t.substring(0, 50)),
            userKeywordsCount: userKeywords.length,
            lastQuality,
          },
          'S1: Building prompt - context_text details'
        );
        
        // æ„å»ºprompt
        const promptCtx: PromptBuilderContext = {
          userKeywords: userKeywords || [],
          recentCommittedText: recentCommittedText || [],
          qualityScore: lastQuality,
        };
        
        const prompt = this.promptBuilder.build(promptCtx);
        if (prompt) {
          // å¦‚æœåŸæœ‰context_textå­˜åœ¨ï¼Œå¯ä»¥åˆå¹¶æˆ–æ›¿æ¢
```

#### æ­¥éª¤3ï¼šæ‰§è¡ŒASRè¯†åˆ«

**ä½ç½®**ï¼š`pipeline-orchestrator.ts` â†’ `processJob()`

**æµç¨‹**ï¼š
1. å°†OpuséŸ³é¢‘è§£ç ä¸ºPCM16æ ¼å¼
2. æ„å»ºASRä»»åŠ¡ï¼ŒåŒ…å«éŸ³é¢‘ã€è¯­è¨€ã€ä¸Šä¸‹æ–‡ç­‰
3. è°ƒç”¨ASRæœåŠ¡ï¼ˆæ”¯æŒæµå¼æˆ–éæµå¼ï¼‰
4. æ¥æ”¶ASRç»“æœï¼šæ–‡æœ¬ã€åˆ†æ®µä¿¡æ¯ã€è¯­è¨€æ¦‚ç‡ã€è´¨é‡åˆ†æ•°ç­‰

**å…³é”®ä»£ç **ï¼š
```175:212:pipeline-orchestrator.ts
      const asrTask: ASRTask = {
        audio: audioForASR,
        audio_format: audioFormatForASR,
        sample_rate: job.sample_rate || 16000,
        src_lang: job.src_lang,
        enable_streaming: job.enable_streaming_asr || false,
        context_text: contextText,  // S1: ä½¿ç”¨æ„å»ºçš„promptæˆ–åŸå§‹context_text
        job_id: job.job_id, // ä¼ é€’ job_id ç”¨äºä»»åŠ¡å–æ¶ˆ
        utterance_index: job.utterance_index, // ä¼ é€’ utterance_index ç”¨äºæ—¥å¿—å’Œè°ƒè¯•
        // EDGE-4: Padding é…ç½®ï¼ˆä» job ä¸­æå–ï¼Œå¦‚æœè°ƒåº¦æœåŠ¡å™¨ä¼ é€’äº†è¯¥å‚æ•°ï¼‰
        padding_ms: job.padding_ms,
        // P0.5-SH-4: ä¼ é€’é‡è·‘æ¬¡æ•°ï¼ˆä» job ä¸­æå–ï¼Œå¦‚æœè°ƒåº¦æœåŠ¡å™¨ä¼ é€’äº†è¯¥å‚æ•°ï¼‰
        rerun_count: (job as any).rerun_count || 0,
      } as any; // æ·»åŠ session_idç”¨äºæ—¥å¿—
      (asrTask as any).session_id = job.session_id;

      let asrResult: ASRResult;
      if (job.enable_streaming_asr && partialCallback) {
        // æµå¼ ASR å¤„ç†
        asrResult = await this.asrHandler.processASRStreaming(asrTask, partialCallback);
      } else {
        asrResult = await this.taskRouter.routeASRTask(asrTask);
      }

      // è®°å½• ASR æ‰€æœ‰ç”Ÿæˆç»“æœ
      logger.info(
        {
          jobId: job.job_id,
          sessionId: job.session_id,
          utteranceIndex: job.utterance_index,
          asrText: asrResult.text,
          asrTextLength: asrResult.text?.length || 0,
          segmentsCount: asrResult.segments?.length || 0,
          qualityScore: asrResult.badSegmentDetection?.qualityScore,
          languageProbability: asrResult.language_probability,
        },
        'PipelineOrchestrator: ASR result received'
      );
```

#### æ­¥éª¤4ï¼šASRåæ–‡æœ¬èšåˆï¼ˆæå‡å‡†ç¡®åº¦æœºåˆ¶ #3ï¼‰

**ä½ç½®**ï¼š`pipeline-orchestrator.ts` â†’ `processJob()`

**æœºåˆ¶è¯´æ˜**ï¼š
- **ç›®çš„**ï¼šåœ¨ASRä¹‹åã€NMTä¹‹å‰è¿›è¡Œæ–‡æœ¬èšåˆå’Œå»é‡
- **åŠŸèƒ½**ï¼š
  - åˆå¹¶çŸ­å¥ï¼šå°†å¤šä¸ªçŸ­utteranceåˆå¹¶æˆå®Œæ•´å¥å­
  - å»é‡ï¼šç§»é™¤é‡å¤çš„æ–‡æœ¬ç‰‡æ®µ
  - å°¾éƒ¨æºå¸¦ï¼šä¿ç•™ä¸Šä¸€å¥çš„å°¾éƒ¨æ–‡æœ¬ï¼Œé¿å…æˆªæ–­

**å…³é”®ä»£ç **ï¼š
```319:350:pipeline-orchestrator.ts
      // 1.5. AggregatorMiddleware: åœ¨ ASR ä¹‹åã€NMT ä¹‹å‰è¿›è¡Œæ–‡æœ¬èšåˆ
      let textForNMT = asrTextTrimmed;
      let shouldProcessNMT = true;
      if (this.aggregatorMiddleware) {
        const aggregationResult = this.aggregatorMiddleware.processASRResult(job, {
          text: asrTextTrimmed,
          segments: asrResult.segments,
          language_probability: asrResult.language_probability,
          language_probabilities: asrResult.language_probabilities,
          badSegmentDetection: asrResult.badSegmentDetection,
        });
        
        if (aggregationResult.shouldProcess) {
          textForNMT = aggregationResult.aggregatedText;
          shouldProcessNMT = true;
          
          // è®°å½•åˆå¹¶åçš„ç»“æœ
          logger.info(
            {
              jobId: job.job_id,
              sessionId: job.session_id,
              utteranceIndex: job.utterance_index,
              originalASRText: asrTextTrimmed,
              originalASRTextLength: asrTextTrimmed.length,
              aggregatedText: textForNMT,
              aggregatedTextLength: textForNMT.length,
              action: aggregationResult.action,
              dedupCharsRemoved: aggregationResult.metrics?.dedupCharsRemoved || 0,
              textChanged: textForNMT !== asrTextTrimmed,
            },
            'PipelineOrchestrator: Text aggregated after ASR, ready for NMT'
          );
```

---

### 1.3 åå¤„ç†é˜¶æ®µï¼ˆPostProcessï¼‰

**ä½ç½®**ï¼š`postprocess-coordinator.ts` â†’ `process()`

#### Stage 1ï¼šæ–‡æœ¬èšåˆï¼ˆAggregationStageï¼‰

**åŠŸèƒ½**ï¼š
- è¿›ä¸€æ­¥èšåˆæ–‡æœ¬ï¼ˆå¦‚æœPipelineé˜¶æ®µæœªå®Œå…¨èšåˆï¼‰
- å†³å®šæ˜¯å¦æäº¤æ–‡æœ¬ï¼ˆåŸºäºæ—¶é—´ã€é•¿åº¦ç­‰æ¡ä»¶ï¼‰
- ç®¡ç†åˆå¹¶ç»„ï¼ˆMERGE vs NEW_STREAMï¼‰

#### Stage 2ï¼šç¿»è¯‘ï¼ˆTranslationStageï¼‰ï¼ˆæå‡å‡†ç¡®åº¦æœºåˆ¶ #4-#7ï¼‰

**ä½ç½®**ï¼š`translation-stage.ts` â†’ `process()`

##### æœºåˆ¶ #4ï¼šç¿»è¯‘ç¼“å­˜

**è¯´æ˜**ï¼š
- ç¼“å­˜å·²ç¿»è¯‘çš„æ–‡æœ¬ï¼Œé¿å…é‡å¤ç¿»è¯‘
- ç¼“å­˜é”®åŒ…å«ï¼šæºè¯­è¨€ã€ç›®æ ‡è¯­è¨€ã€æ–‡æœ¬å†…å®¹ã€ä¸Šä¸‹æ–‡
- ç¼“å­˜å¤§å°ï¼š200æ¡ï¼ŒTTLï¼š10åˆ†é’Ÿ

**å…³é”®ä»£ç **ï¼š
```116:137:translation-stage.ts
    // ç”Ÿæˆç¼“å­˜é”®
    const cacheKey = generateCacheKey(
      job.src_lang,
      job.tgt_lang,
      aggregatedText,
      contextText
    );

    // æ£€æŸ¥æ˜¯å¦åº”è¯¥ç¼“å­˜
    const shouldCacheThis = shouldCache(aggregatedText);

    // æ£€æŸ¥ç¼“å­˜
    const cachedTranslation = shouldCacheThis ? this.translationCache.get(cacheKey) : undefined;
    if (cachedTranslation) {
      logger.debug
```

##### æœºåˆ¶ #5ï¼šä¸Šä¸‹æ–‡ä¼ é€’ï¼ˆContext Textï¼‰

**è¯´æ˜**ï¼š
- å°†ä¸Šä¸€ä¸ªutteranceçš„åŸæ–‡ï¼ˆASRæ–‡æœ¬ï¼‰ä½œä¸ºNMTçš„ `context_text`
- **é‡è¦**ï¼šä½¿ç”¨åŸæ–‡è€Œéç¿»è¯‘æ–‡æœ¬ï¼Œé¿å…æ··åˆè¯­è¨€è¾“å…¥
- é™åˆ¶ä¸Šä¸‹æ–‡é•¿åº¦ï¼šæœ€å¤š200å­—ç¬¦

**å…³é”®ä»£ç **ï¼š
```107:114:translation-stage.ts
    // è·å–ä¸Šä¸‹æ–‡æ–‡æœ¬ï¼ˆç”¨äºNMTæœåŠ¡çš„context_textï¼‰
    // é‡è¦ï¼šåº”è¯¥ä½¿ç”¨ä¸Šä¸€ä¸ªutteranceçš„åŸæ–‡ï¼ˆASRæ–‡æœ¬ï¼Œä¸­æ–‡ï¼‰ï¼Œè€Œä¸æ˜¯ç¿»è¯‘æ–‡æœ¬ï¼ˆè‹±æ–‡ï¼‰
    // å› ä¸ºNMTæœåŠ¡ä¼šå°†context_textå’Œtextæ‹¼æ¥ï¼Œå¦‚æœcontext_textæ˜¯è‹±æ–‡ç¿»è¯‘ï¼Œä¼šå¯¼è‡´æ··åˆè¯­è¨€è¾“å…¥
    // ä¼ å…¥ currentText å‚æ•°ï¼Œç¡®ä¿ä¸ä¼šè¿”å›å½“å‰å¥
    let contextText = this.aggregatorManager?.getLastCommittedText(job.session_id, aggregatedText) || undefined;
    if (contextText && contextText.length > 200) {
      contextText = contextText.substring(contextText.length - 200);
    }
```

##### æœºåˆ¶ #6ï¼šNMT Repairï¼ˆåŒéŸ³å­—ä¿®å¤ï¼‰

**è¯´æ˜**ï¼š
- **ç›®çš„**ï¼šä¿®å¤ASRè¯†åˆ«é”™è¯¯ï¼ˆç‰¹åˆ«æ˜¯åŒéŸ³å­—é”™è¯¯ï¼‰
- **è§¦å‘æ¡ä»¶**ï¼š
  - è´¨é‡åˆ†æ•° < 0.7ï¼ˆå¯é…ç½®é˜ˆå€¼ï¼‰
  - åªæœ‰ä¸€ä¸ªåŸæ–‡å€™é€‰
- **å®ç°æ–¹å¼**ï¼š
  - è¯·æ±‚NMTæœåŠ¡ç”Ÿæˆå¤šä¸ªå€™é€‰ç¿»è¯‘ï¼ˆé»˜è®¤5ä¸ªï¼‰
  - ä½¿ç”¨å€™é€‰æ‰“åˆ†æœºåˆ¶é€‰æ‹©æœ€ä½³ç¿»è¯‘
  - é€šè¿‡åŒéŸ³å­—ä¿®å¤ç®—æ³•ä¿®å¤åŸæ–‡é”™è¯¯

**å…³é”®ä»£ç **ï¼š
```180:214:translation-stage.ts
    // å¦‚æœåªæœ‰ä¸€ä¸ªåŸæ–‡å€™é€‰ä¸”å¯ç”¨äº† NMT Repairï¼Œä½¿ç”¨ NMT å€™é€‰ç”Ÿæˆ
    if (sourceCandidates.length === 1 && shouldRepair) {
      const nmtRepairStartTime = Date.now();
      logger.info({
        jobId: job.job_id,
        sessionId: job.session_id,
        textLength: aggregatedText.length,
        numCandidates: this.config.nmtRepairNumCandidates || 5,
        qualityScore,
        note: 'NMT Repair triggered - this may take longer due to multiple candidates',
      }, 'TranslationStage: Starting NMT Repair (may block if GPU is overloaded)');
      
      const nmtTask: NMTTask = {
        text: aggregatedText,
        src_lang: job.src_lang,
        tgt_lang: job.tgt_lang,
        context_text: contextText, // ä½¿ç”¨ä¸Šä¸€ä¸ªutteranceçš„åŸæ–‡ï¼ˆä¸­æ–‡ï¼‰ï¼Œç”¨äºNMTçº é”™
        job_id: job.job_id,
        num_candidates: this.config.nmtRepairNumCandidates || 5,
      } as any; // æ·»åŠ session_idå’Œutterance_indexç”¨äºæ—¥å¿—
      (nmtTask as any).session_id = job.session_id;
      (nmtTask as any).utterance_index = job.utterance_index;

      const nmtResult = await this.taskRouter.routeNMTTask(nmtTask);
      
      const nmtRepairDuration = Date.now() - nmtRepairStartTime;
      if (nmtRepairDuration > 30000) {
        logger.warn({
          jobId: job.job_id,
          sessionId: job.session_id,
          nmtRepairDurationMs: nmtRepairDuration,
          numCandidates: this.config.nmtRepairNumCandidates || 5,
          note: 'NMT Repair took longer than 30 seconds - GPU may be overloaded',
        }, 'TranslationStage: NMT Repair took too long');
      }
```

##### æœºåˆ¶ #7ï¼šå¼‚æ­¥é‡æ–°ç¿»è¯‘

**è¯´æ˜**ï¼š
- å¯¹äºé•¿æ–‡æœ¬ï¼ˆ>50å­—ç¬¦ï¼‰ï¼Œä½¿ç”¨å¼‚æ­¥é‡æ–°ç¿»è¯‘
- å…ˆè¿”å›åˆå§‹ç¿»è¯‘ï¼Œåå°é‡æ–°ç¿»è¯‘å®Œæ•´èšåˆæ–‡æœ¬
- é¿å…é˜»å¡ï¼Œæé«˜å“åº”é€Ÿåº¦

**é…ç½®**ï¼š
```114:115:node-agent.ts
      enableAsyncRetranslation: true,  // å¼‚æ­¥é‡æ–°ç¿»è¯‘ï¼ˆé»˜è®¤å¯ç”¨ï¼Œé•¿æ–‡æœ¬ä½¿ç”¨å¼‚æ­¥å¤„ç†ï¼‰
      asyncRetranslationThreshold: 50,  // å¼‚æ­¥é‡æ–°ç¿»è¯‘é˜ˆå€¼ï¼ˆæ–‡æœ¬é•¿åº¦ï¼Œé»˜è®¤ 50 å­—ç¬¦ï¼‰
```

#### Stage 3ï¼šå»é‡ï¼ˆDedupStageï¼‰ï¼ˆæå‡å‡†ç¡®åº¦æœºåˆ¶ #8ï¼‰

**è¯´æ˜**ï¼š
- æ£€æŸ¥æ˜¯å¦ä¸æœ€è¿‘å‘é€çš„æ–‡æœ¬é‡å¤
- é¿å…å‘é€é‡å¤çš„ç¿»è¯‘ç»“æœ
- è®°å½•å·²å‘é€çš„job_idï¼Œé˜²æ­¢é‡å¤å¤„ç†

#### Stage 4ï¼šTTSï¼ˆæ–‡æœ¬è½¬è¯­éŸ³ï¼‰

**ä½ç½®**ï¼š`tts-stage.ts` â†’ `process()`

**æµç¨‹**ï¼š
1. æ¥æ”¶ç¿»è¯‘åçš„æ–‡æœ¬
2. æ„å»ºTTSä»»åŠ¡ï¼ˆæ–‡æœ¬ã€ç›®æ ‡è¯­è¨€ã€è¯­éŸ³IDç­‰ï¼‰
3. è°ƒç”¨TTSæœåŠ¡ç”ŸæˆéŸ³é¢‘ï¼ˆWAVæ ¼å¼ï¼‰
4. è¿”å›éŸ³é¢‘æ•°æ®

**å…³é”®ä»£ç **ï¼š
```79:98:tts-stage.ts
      const ttsTask: TTSTask = {
        text: translatedText.trim(),
        lang: job.tgt_lang,
        voice_id: (job as any).voice_id,
        speaker_id: (job as any).speaker_id,
        sample_rate: job.sample_rate || 16000,
        job_id: job.job_id,
      };

      logger.info(
        {
          jobId: job.job_id,
          sessionId: job.session_id,
          textLength: translatedText.length,
          tgtLang: job.tgt_lang,
        },
        'TTSStage: Starting TTS task'
      );

      const ttsResult = await this.taskRouter.routeTTSTask(ttsTask);
```

---

### 1.4 ç»“æœå‘é€é˜¶æ®µ

**ä½ç½®**ï¼š`node-agent-result-sender.ts` â†’ `sendJobResult()`

**æµç¨‹**ï¼š
1. å°†TTSéŸ³é¢‘ä»WAVæ ¼å¼ç¼–ç ä¸ºOpusæ ¼å¼ï¼ˆç»Ÿä¸€ä¼ è¾“æ ¼å¼ï¼‰
2. æ„å»º `job_result` æ¶ˆæ¯
3. é€šè¿‡WebSocketå‘é€ç»™è°ƒåº¦æœåŠ¡å™¨

---

## äºŒã€æå‡ç¿»è¯‘å‡†ç¡®åº¦çš„å…³é”®æœºåˆ¶æ€»ç»“

### æœºåˆ¶ #1ï¼šéŸ³é¢‘èšåˆï¼ˆPre-ASRï¼‰
- **ä½ç½®**ï¼š`audio-aggregator.ts`
- **ä½œç”¨**ï¼šåœ¨ASRä¹‹å‰èšåˆçŸ­éŸ³é¢‘å—ï¼Œé¿å…è¯†åˆ«ä¸å®Œæ•´çŸ­å¥
- **æå‡æ•ˆæœ**ï¼šæé«˜ASRè¯†åˆ«å®Œæ•´æ€§å’Œå‡†ç¡®åº¦

### æœºåˆ¶ #2ï¼šPromptä¸Šä¸‹æ–‡æ„å»ºï¼ˆASRé˜¶æ®µï¼‰
- **ä½ç½®**ï¼š`pipeline-orchestrator-asr.ts` â†’ `buildPrompt()`
- **ä½œç”¨**ï¼šä¸ºASRæä¾›å…³é”®è¯å’Œæœ€è¿‘ä¸Šä¸‹æ–‡ï¼Œæé«˜è¯†åˆ«å‡†ç¡®åº¦
- **è´¨é‡é—¨æ§**ï¼šæ ¹æ®å†å²è´¨é‡åŠ¨æ€è°ƒæ•´ä¸Šä¸‹æ–‡ä½¿ç”¨ç­–ç•¥
- **æå‡æ•ˆæœ**ï¼šæé«˜ASRå¯¹ä¸“ä¸šæœ¯è¯­å’Œä¸Šä¸‹æ–‡çš„è¯†åˆ«å‡†ç¡®åº¦

### æœºåˆ¶ #3ï¼šæ–‡æœ¬èšåˆä¸å»é‡ï¼ˆPost-ASRï¼‰
- **ä½ç½®**ï¼š`aggregator-middleware.ts`
- **ä½œç”¨**ï¼š
  - åˆå¹¶çŸ­å¥æˆå®Œæ•´å¥å­
  - å»é™¤é‡å¤æ–‡æœ¬ç‰‡æ®µ
  - ä¿ç•™å°¾éƒ¨æ–‡æœ¬ï¼Œé¿å…æˆªæ–­
- **æå‡æ•ˆæœ**ï¼šç¡®ä¿NMTç¿»è¯‘çš„æ˜¯å®Œæ•´ã€æ— é‡å¤çš„æ–‡æœ¬

### æœºåˆ¶ #4ï¼šç¿»è¯‘ç¼“å­˜
- **ä½ç½®**ï¼š`translation-stage.ts`
- **ä½œç”¨**ï¼šç¼“å­˜å·²ç¿»è¯‘æ–‡æœ¬ï¼Œé¿å…é‡å¤ç¿»è¯‘
- **æå‡æ•ˆæœ**ï¼šæé«˜å“åº”é€Ÿåº¦ï¼Œä¿æŒç¿»è¯‘ä¸€è‡´æ€§

### æœºåˆ¶ #5ï¼šä¸Šä¸‹æ–‡ä¼ é€’ï¼ˆNMTé˜¶æ®µï¼‰
- **ä½ç½®**ï¼š`translation-stage.ts`
- **ä½œç”¨**ï¼šå°†ä¸Šä¸€ä¸ªutteranceçš„åŸæ–‡ä½œä¸ºNMTçš„ä¸Šä¸‹æ–‡
- **æå‡æ•ˆæœ**ï¼šæé«˜NMTå¯¹ä¸Šä¸‹æ–‡ç›¸å…³ç¿»è¯‘çš„å‡†ç¡®åº¦

### æœºåˆ¶ #6ï¼šNMT Repairï¼ˆåŒéŸ³å­—ä¿®å¤ï¼‰
- **ä½ç½®**ï¼š`translation-stage.ts`
- **ä½œç”¨**ï¼š
  - ç”Ÿæˆå¤šä¸ªå€™é€‰ç¿»è¯‘
  - é€šè¿‡æ‰“åˆ†æœºåˆ¶é€‰æ‹©æœ€ä½³ç¿»è¯‘
  - ä¿®å¤ASRåŒéŸ³å­—é”™è¯¯
- **è§¦å‘æ¡ä»¶**ï¼šè´¨é‡åˆ†æ•° < 0.7
- **æå‡æ•ˆæœ**ï¼šä¿®å¤ASRè¯†åˆ«é”™è¯¯ï¼Œæé«˜ç¿»è¯‘å‡†ç¡®åº¦

### æœºåˆ¶ #7ï¼šå¼‚æ­¥é‡æ–°ç¿»è¯‘
- **ä½ç½®**ï¼š`translation-stage.ts`
- **ä½œç”¨**ï¼šå¯¹é•¿æ–‡æœ¬è¿›è¡Œå¼‚æ­¥é‡æ–°ç¿»è¯‘ï¼Œç¡®ä¿ç¿»è¯‘å®Œæ•´èšåˆæ–‡æœ¬
- **æå‡æ•ˆæœ**ï¼šé¿å…ç¿»è¯‘ä¸å®Œæ•´æ–‡æœ¬ï¼Œæé«˜é•¿æ–‡æœ¬ç¿»è¯‘å‡†ç¡®åº¦

### æœºåˆ¶ #8ï¼šå»é‡æ£€æŸ¥ï¼ˆPost-Translationï¼‰
- **ä½ç½®**ï¼š`dedup-stage.ts`
- **ä½œç”¨**ï¼šæ£€æŸ¥å¹¶è¿‡æ»¤é‡å¤çš„ç¿»è¯‘ç»“æœ
- **æå‡æ•ˆæœ**ï¼šé¿å…é‡å¤è¾“å‡ºï¼Œæé«˜ç”¨æˆ·ä½“éªŒ

---

## ä¸‰ã€å®Œæ•´æµç¨‹å›¾

```
è°ƒåº¦æœåŠ¡å™¨
    â†“ (job_assign)
èŠ‚ç‚¹ç«¯ NodeAgent
    â†“
JobProcessor
    â†“
PipelineOrchestrator
    â†“
[æœºåˆ¶ #1] éŸ³é¢‘èšåˆ (AudioAggregator)
    â†“
[æœºåˆ¶ #2] æ„å»ºPromptä¸Šä¸‹æ–‡ (ASRHandler.buildPrompt)
    â†“
ASRæœåŠ¡ (è¯­éŸ³è¯†åˆ«)
    â†“
[æœºåˆ¶ #3] æ–‡æœ¬èšåˆä¸å»é‡ (AggregatorMiddleware)
    â†“
PostProcessCoordinator
    â†“
[Stage 1] AggregationStage (è¿›ä¸€æ­¥èšåˆ)
    â†“
[Stage 2] TranslationStage
    â”œâ”€ [æœºåˆ¶ #4] ç¿»è¯‘ç¼“å­˜æ£€æŸ¥
    â”œâ”€ [æœºåˆ¶ #5] æ„å»ºä¸Šä¸‹æ–‡ (context_text)
    â”œâ”€ [æœºåˆ¶ #6] NMT Repair (å¦‚æœè´¨é‡åˆ†æ•° < 0.7)
    â””â”€ [æœºåˆ¶ #7] å¼‚æ­¥é‡æ–°ç¿»è¯‘ (å¦‚æœæ–‡æœ¬é•¿åº¦ > 50)
    â†“
NMTæœåŠ¡ (æœºå™¨ç¿»è¯‘)
    â†“
[Stage 3] DedupStage
    â””â”€ [æœºåˆ¶ #8] å»é‡æ£€æŸ¥
    â†“
[Stage 4] TTSStage
    â†“
TTSæœåŠ¡ (æ–‡æœ¬è½¬è¯­éŸ³)
    â†“
ç»“æœç¼–ç  (WAV â†’ Opus)
    â†“
ResultSender
    â†“ (job_result)
è°ƒåº¦æœåŠ¡å™¨
```

---

## å››ã€é…ç½®å‚æ•°è¯´æ˜

### å…³é”®é…ç½®é¡¹ï¼ˆnode-agent.tsï¼‰

```typescript
const aggregatorConfig: AggregatorMiddlewareConfig = {
  enabled: true,
  mode: 'offline',
  ttlMs: 5 * 60 * 1000,  // 5åˆ†é’ŸTTL
  maxSessions: 500,
  translationCacheSize: 200,  // ç¿»è¯‘ç¼“å­˜å¤§å°
  translationCacheTtlMs: 10 * 60 * 1000,  // ç¿»è¯‘ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼š10åˆ†é’Ÿ
  enableAsyncRetranslation: true,  // å¼‚æ­¥é‡æ–°ç¿»è¯‘
  asyncRetranslationThreshold: 50,  // å¼‚æ­¥é‡æ–°ç¿»è¯‘é˜ˆå€¼ï¼ˆæ–‡æœ¬é•¿åº¦ï¼‰
  nmtRepairEnabled: true,  // å¯ç”¨NMT Repair
  nmtRepairNumCandidates: 5,  // ç”Ÿæˆ5ä¸ªå€™é€‰
  nmtRepairThreshold: 0.7,  // è´¨é‡åˆ†æ•° < 0.7 æ—¶è§¦å‘
};
```

---

## äº”ã€å»ºè®®ä¼˜åŒ–æ–¹å‘

### 1. ASRé˜¶æ®µ
- âœ… å·²å®ç°ï¼šéŸ³é¢‘èšåˆã€Promptä¸Šä¸‹æ–‡
- ğŸ”„ å¯ä¼˜åŒ–ï¼šå¢åŠ éŸ³é¢‘è´¨é‡æ£€æŸ¥ï¼Œè¿‡æ»¤ä½è´¨é‡éŸ³é¢‘

### 2. NMTé˜¶æ®µ
- âœ… å·²å®ç°ï¼šä¸Šä¸‹æ–‡ä¼ é€’ã€NMT Repairã€ç¿»è¯‘ç¼“å­˜
- ğŸ”„ å¯ä¼˜åŒ–ï¼š
  - å¢åŠ æœ¯è¯­è¡¨ï¼ˆGlossaryï¼‰æ”¯æŒ
  - ä¼˜åŒ–ä¸Šä¸‹æ–‡é•¿åº¦å’Œé€‰æ‹©ç­–ç•¥
  - å¢åŠ ç¿»è¯‘è´¨é‡è¯„ä¼°

### 3. åå¤„ç†é˜¶æ®µ
- âœ… å·²å®ç°ï¼šæ–‡æœ¬èšåˆã€å»é‡
- ğŸ”„ å¯ä¼˜åŒ–ï¼š
  - å¢åŠ ç¿»è¯‘åç¼–è¾‘ï¼ˆPost-Editï¼‰æœºåˆ¶
  - å¢åŠ ç¿»è¯‘ä¸€è‡´æ€§æ£€æŸ¥

---

## å…­ã€æ€»ç»“

æœ¬ç³»ç»Ÿé€šè¿‡8ä¸ªå…³é”®æœºåˆ¶åœ¨ASRã€NMTã€TTSä¸‰ä¸ªé˜¶æ®µå…¨é¢æå‡ç¿»è¯‘å‡†ç¡®åº¦ï¼š

1. **ASRé˜¶æ®µ**ï¼šéŸ³é¢‘èšåˆã€Promptä¸Šä¸‹æ–‡ â†’ æé«˜è¯†åˆ«å‡†ç¡®åº¦
2. **æ–‡æœ¬å¤„ç†é˜¶æ®µ**ï¼šæ–‡æœ¬èšåˆã€å»é‡ â†’ ç¡®ä¿å®Œæ•´ã€æ— é‡å¤æ–‡æœ¬
3. **NMTé˜¶æ®µ**ï¼šä¸Šä¸‹æ–‡ä¼ é€’ã€NMT Repairã€ç¿»è¯‘ç¼“å­˜ â†’ æé«˜ç¿»è¯‘å‡†ç¡®åº¦
4. **åå¤„ç†é˜¶æ®µ**ï¼šå»é‡æ£€æŸ¥ â†’ é¿å…é‡å¤è¾“å‡º

è¿™äº›æœºåˆ¶ååŒå·¥ä½œï¼Œå½¢æˆäº†ä¸€ä¸ªå®Œæ•´çš„ç¿»è¯‘å‡†ç¡®åº¦æå‡ä½“ç³»ã€‚
