# Opus 解码质量差的原因分析

**日期**: 2025-12-25  
**状态**: 🔍 **分析中**

---

## 问题

用户反馈：Opus 解码出来的音频质量很差，导致 ASR 无法识别。

**现象**:
- Opus 解码成功（3840 samples）
- 但音频质量很差：
  - std（标准差）: 0.0121-0.0898（正常应该在 0.1-0.3）
  - RMS（能量）: 非常低
  - 动态范围: 很小
  - 时长: 0.24 秒（太短）

---

## 可能的原因

### 1. 编码端比特率设置过低 ⚠️

**问题**: Opus 编码器可能使用了默认比特率，对于语音来说可能太低。

**检查**:
- Web 端编码器是否设置了比特率？
- 默认比特率是多少？
- 是否适合语音编码？

**Opus 推荐比特率**:
- **语音（VOIP）**: 6-32 kbps（单声道）
- **音乐**: 64-128 kbps（单声道）
- **默认值**: 通常为 64 kbps（可能对语音来说太高，导致压缩损失）

### 2. 编码器参数不匹配 ⚠️

**检查项**:
- ✅ 采样率: 16000 Hz（匹配）
- ✅ 声道数: 1（匹配）
- ✅ Application: VOIP（匹配）
- ❓ 比特率: 未设置（可能使用默认值）
- ❓ 帧大小: 20ms（匹配）

### 3. 数据丢失或损坏 ⚠️

**可能原因**:
- Plan A 格式解析错误
- Packet 丢失
- 数据在传输过程中损坏

**检查**:
- 日志中是否有 decode_fails？
- Packet 数量是否匹配？

### 4. 编码器状态问题 ⚠️

**问题**: 编码器可能没有正确初始化或状态丢失。

**检查**:
- 编码器是否在每次请求时重新初始化？
- 状态是否在请求之间保持？

### 5. 音频输入质量问题 ⚠️

**问题**: 原始音频输入可能就有问题。

**检查**:
- Web 端录音质量如何？
- 麦克风输入是否正常？
- 是否有噪声或失真？

---

## 检查清单

### 编码端（Web）

1. ✅ **采样率**: 16000 Hz
2. ✅ **声道数**: 1（单声道）
3. ✅ **Application**: VOIP
4. ❓ **比特率**: 需要检查是否设置
5. ❓ **帧大小**: 20ms（需要确认）

### 解码端（节点）

1. ✅ **采样率**: 16000 Hz
2. ✅ **声道数**: 1（单声道）
3. ✅ **解码器初始化**: 正常

### 数据格式

1. ✅ **Plan A 格式**: 正确
2. ❓ **Packet 完整性**: 需要检查
3. ❓ **数据损坏**: 需要检查

---

## 建议的修复

### 1. 设置合适的比特率

**在 Web 端编码器中设置比特率**:
```typescript
// 推荐：语音使用 16-32 kbps
this.encoder.setBitrate(16000); // 16 kbps for VOIP
```

### 2. 检查编码器状态

**确保编码器正确初始化**:
```typescript
// 检查编码器是否已初始化
if (!this.encoder || !this.isReady) {
  await this.initialize();
}
```

### 3. 增强日志记录

**在解码端记录更多信息**:
- Packet 数量
- 解码失败的 packet
- 音频质量指标

### 4. 验证数据完整性

**检查 Plan A 格式解析**:
- 验证 packet_len 是否正确
- 验证 packet 数据是否完整
- 检查是否有数据丢失

---

## 下一步

1. **检查 Web 端编码器配置**
   - 查看是否设置了比特率
   - 查看编码器初始化参数

2. **检查数据完整性**
   - 验证 Plan A 格式解析
   - 检查是否有数据丢失

3. **增强日志记录**
   - 记录编码端参数
   - 记录解码端参数
   - 记录音频质量指标

---

**分析完成时间**: 2025-12-25  
**状态**: 🔍 **需要检查编码端配置和数据完整性**

