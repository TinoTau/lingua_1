# ASR 超时音频切割机制补充与优化建议

## 1. 文档目的

本文档作为《Timeout Audio Splitting Mechanism / Implementation》的**补充说明**，用于在不引入词库、不增加模型复杂度、不依赖二次解码的前提下，进一步提升 ASR 在**长语音、噪声环境、短句边界不稳定**场景下的识别稳定性与鲁棒性。

本补充内容可直接作为开发部门的优化实施参考。

---

## 2. 当前方案的正确性确认

现有实现已经具备以下关键优势：

- 使用 **最长停顿（Longest Pause）** 而非固定位置进行切割，避免句中硬截断
- 超时触发时采用 **一分为二 + 后半句延迟合并** 的策略，保证语义连续性
- 明确切割优先级：
  - Manual / Pause > Timeout > Buffer Flush
- 已具备单元测试覆盖超时切割与合并行为

该方案在当前技术架构下是**正确且必要的**，本补充仅针对极端与边界场景进行增强。

---

## 3. 建议补充的关键优化点（不引入维护负担）

### 3.1 噪声环境下的兜底切割策略（重要）

#### 问题说明

在持续底噪（风噪、空调、路噪）环境中，RMS 能量可能长期高于固定阈值，导致：

- 找不到满足条件的“静音段”
- 超时触发后无法分割，只能整体送入 ASR

这会直接降低长语音场景的识别稳定性。

#### 建议方案

当 **未找到符合条件的静音段** 时，启用兜底策略：

- 在音频中寻找 **能量最低的连续区间（300–600ms）** 作为分割点
- 或在音频中段（例如 30%–70% 区间）查找最低能量点，避免切在开头或结尾

> 该策略仍然是纯信号处理，不依赖语义、不引入词库。

---

### 3.2 分割点 Hangover（尾部保留）机制

#### 问题说明

若分割点紧邻爆破音或擦音（p/t/k/s/f 等），切点过于精确可能导致前半句尾音缺失，影响识别。

#### 建议方案

在确定分割点后：

- 对前半句额外保留 **120–250ms** 的音频（Hangover）
- 保证尾音完整，同时不显著增加长度

---

### 3.3 pendingSecondHalf 生命周期安全阀

#### 问题说明

后半句音频被暂存以等待下一 utterance 合并，但在极端情况下可能长期滞留。

#### 建议补充两条安全策略

1. **TTL（时间上限）**
   - pendingSecondHalf 超过 10–15 秒仍未合并，强制 flush 走 ASR

2. **长度上限**
   - pendingSecondHalf 超过设定时长（如 10–12 秒），不再等待合并，直接处理或再次切割

---

## 4. 参数与算法层面的稳态优化

### 4.1 静音阈值从“固定值”改为“相对值”

#### 现状问题

固定 RMS 阈值（如 500）在不同设备、麦克风增益下鲁棒性不足。

#### 建议方案

- 预扫描音频 RMS 分布（如 p10 / p20 / median）
- 设置：
  
  ```
  silence_threshold = max(abs_min, median * ratio)
  ```

- 推荐 ratio 范围：0.25–0.35

这样可自动适配不同录音环境。

---

### 4.2 RMS 计算窗口优化

- 当前窗口：100ms
- 建议：
  - RMS 计算粒度：50ms
  - 静音决策窗口：100–150ms

该调整在快语速与中文场景下更稳定。

---

### 4.3 可选的二级切割（极长语音）

#### 场景

当一次超时切割后，前半句仍然过长（例如 >10 秒）。

#### 建议方案（可选）

- 在前半句内部再次寻找次长停顿或最低能量点
- 将单段音频控制在 6–10 秒区间

该方案可显著改善极端长句的延迟与识别准确率。

---

## 5. 可观测性与验收指标（建议补充）

为便于后续调参与回归分析，建议增加以下指标：

- `timeout_split_success_rate`
- `timeout_split_longest_pause_ms_distribution`
- `first_half_duration_ms / second_half_duration_ms`
- `pending_second_half_flush_reason`（merge / ttl / max_length）

这些指标不影响业务逻辑，仅用于评估效果。

---

## 6. 总结

在现有超时音频切割机制基础上，建议重点补强：

1. **噪声环境下的兜底切割能力**
2. **分割点稳态化（Hangover + 相对阈值）**
3. **pendingSecondHalf 生命周期安全阀**

以上优化均：

- 不引入词库
- 不增加模型复杂度
- 不需要二次解码
- 与当前 ASR / VAD 架构完全兼容

可作为当前阶段 ASR 稳定性提升的最后一层工程保障。

---

**文档状态**：补充建议稿  
**适用对象**：ASR / Node / Audio Pipeline 开发人员  
**实施风险**：低  
**预期收益**：中-高

