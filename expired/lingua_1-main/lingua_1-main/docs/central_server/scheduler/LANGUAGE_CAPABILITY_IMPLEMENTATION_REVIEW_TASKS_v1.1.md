# 语言能力调度实现审阅 —— 修订与优化任务清单（v1.1）

> 本文档基于开发部门当前语言能力调度实现的审阅结论整理而成，
> 目标是以**最小代价修正高风险遗漏**，并给出**明确、可执行的优化任务清单**，
> 以保证语言能力调度在节点规模和语言规模扩大后仍然稳定可控。

---

## 一、结论摘要

- 当前实现 **方向正确、整体可落地**
- 存在 **3 项 P0 级隐患**，不修复将导致性能和稳定性问题
- 建议在继续扩展前 **先完成本清单中的 P0 项**

---

## 二、P0：必须修复的高优先级问题

### P0-1：`any_to_any` 被展开为 N×N pairs

**问题**
- 调度端对 `any_to_any` 规则展开为所有 `(src, tgt)` 组合

**风险**
- 索引构建与更新复杂度 O(N²)
- 节点或语言规模扩大后不可控

**建议**
- 不展开 `any_to_any`
- 改为规则匹配模式，仅在匹配阶段判断

---

### P0-2：`blocked_pairs` 线性扫描

**问题**
- blocked_pairs 使用线性 `iter().any()`

**风险**
- 在高频匹配下性能明显下降

**建议**
- 预处理为 HashSet
- 匹配阶段 O(1) 判断

---

### P0-3：节点能力统计未限制 READY 状态

**问题**
- running 状态即计入能力

**风险**
- 节点被误认为支持某语言，但实际不可服务

**建议**
- 仅统计 READY 服务
- capabilities 失败时使用 last-known-good + TTL

---

## 三、P1：强烈建议优化

### P1-1：语言规范化规则不完整
- 统一大小写
- auto 不进入索引
- 补充历史别名映射（in→id, iw→he）

---

### P1-2：业务模式未显式建模
建议引入：
- TEXT_TRANSLATE
- SPEECH_TRANSLATE
- SPEECH_TRANSLATE_WITH_TTS
- TTS_ONLY

---

### P1-3：`src_lang = auto` 场景补充约束
- 节点必须有 READY ASR
- 按 ASR 覆盖度排序

---

## 四、观测与文档建议
- 拆分无可用节点原因码
- 实施效果区分“实测”与“预期”

---

## 五、执行清单

**P0**
- [ ] 移除 N×N 展开
- [ ] blocked_pairs HashSet 化
- [ ] READY 状态能力统计

**P1**
- [ ] 语言规范化
- [ ] 业务模式枚举
- [ ] auto 场景增强

---

## 六、总结
完成以上修订后，语言能力调度将具备良好的可扩展性和可观测性。
