# Web 端 VAD 切片问题 —— 稳定性修复补充方案（不影响翻译效率）

## 文档目的
本文件在既有《Web 端 VAD 切片问题决策文档》的基础上，整理：
1. 可直接落地的推荐修复方案  
2. 原方案中需要补齐但未明确的工程细节  
3. 明确所有改动 **不会降低翻译实时性与吞吐**

> 所有方案仅涉及 **Web 端音频采集与切片逻辑**，不引入额外推理、不增加 GPU / CPU 负载。

---

## 一、问题本质回顾（简述）
TTS 播放期间录音器 `stop`  
→ 播放结束后 recorder 延迟恢复 + VAD 状态重置  
→ 重新 attack（≈300ms）+ 短句易触发 release  
→ 音频被切成 0.2–1s 的极短片段  
→ ASR 识别失败

该问题属于 **前端切片稳定性问题**，而非 ASR / 翻译模型性能问题。

---

## 二、最终推荐执行方案（组合方案）
推荐采用以下 **4 项组合方案**，均为客户端侧逻辑调整：

1. 事件驱动恢复录音（替代固定 `setTimeout`）
2. 智能 VAD 状态恢复（仅保留宏状态）
3. 播放结束后的短保护窗口（anti‑fragment gate）
4. 最小发送切片阈值（`minChunkMs / minSpeechMs`）

---

## 三、方案一：事件驱动恢复录音（必须）
**实现方式**
- 在 `TTS audio.onended` 回调中触发 `recorder.start()`
- 使用 `requestAnimationFrame` 确保状态机切换完成
- 可选兜底：`30–50ms` fallback timeout

**收益**
- 消除固定 100ms 延迟带来的不确定性
- 不引入额外等待，不影响首包延迟

---

## 四、方案二：智能 VAD 状态恢复（关键）
**规则**
- recorder 停止时间 `< 1s`：保留 `isSendingAudio`
- recorder 停止时间 `≥ 1s`：完全重置 VAD 状态
- 无论哪种情况，必须重置：
  - `consecutiveVoiceFrames`
  - `consecutiveSilenceFrames`

**目的**
- 避免短暂停止后重新 attack 丢失起音（≈300ms）

---

## 五、方案三：恢复保护窗口（强烈建议）
**实现**
- 录音恢复后的前 `150–300ms`：
  - 禁止触发 release  
  - 或临时提高 `releaseFrames / minSpeechMs`

**作用**
- 防止低能量起音 + 环境余音导致瞬时切片抖动

---

## 六、方案四：最小切片阈值（兜底但高收益）
**建议参数**
- `minSpeechMs`: `800–1200ms`
- `minChunkMs`: `1000ms`

**规则**
- 小于阈值的音频不立即发送
- 与后续语音合并或延迟发送

> 仅影响发送策略，不增加录音或推理成本。

---

## 七、为什么不会影响翻译效率
- 所有改动发生在 **Web 客户端**
- 不增加 ASR / NMT / TTS 推理次数
- 不引入额外 GPU / CPU 推理
- 减少无效短片段，反而提升 **有效吞吐与稳定性**

---

## 八、实施优先级（给开发）
**必须**
1. 事件驱动恢复录音  
2. 智能 VAD 状态恢复  

**强烈建议**
3. 恢复保护窗口  
4. `minChunkMs / minSpeechMs`

**本轮不建议**
- 全局降低 `attackFrames`
- 播放期间持续录音（回声风险）

---

## 九、验收标准
- 播放后语音切片长度以 `≥ 1s` 为主
- ASR 空结果率显著下降
- 后续输入与首次输入识别质量一致
- 翻译端到端延迟无明显上升
