# ä¼šè®®å®¤æ¨¡å¼è°ƒåº¦é€»è¾‘ç¡®è®¤

**æ—¥æœŸ**: 2025-01-XX  
**ç›®çš„**: ç¡®è®¤ä¼šè®®å®¤æ¨¡å¼ä¸‹è°ƒåº¦é€»è¾‘æ˜¯å¦éœ€è¦æ”¹å˜

---

## ğŸ“‹ è°ƒåº¦é€»è¾‘ç¡®è®¤

### âœ… **èŠ‚ç‚¹é€‰æ‹©é€»è¾‘ï¼ˆè°ƒåº¦é€»è¾‘ï¼‰ä¸éœ€è¦æ”¹å˜**

æ ¹æ® [Webâ†”Web åŸå£°é€šè¯ + ç¿»è¯‘æ¥ç®¡æ–¹æ¡ˆ v1.1](./Web_RawVoice_Translation_Handover_Spec_v1.1.md) ç¬¬9èŠ‚"ç¿»è¯‘é“¾è·¯ï¼ˆä¿æŒå…¼å®¹ï¼‰"ï¼š

> **Scheduler**ï¼š
> - å¯é€‰ Sticky Nodeï¼ˆä¼šè¯/æˆ¿é—´çº§åˆ«ï¼‰
> - **ç»§ç»­ä½¿ç”¨ NodeStatus=ready è¿‡æ»¤ç­–ç•¥**

**ç»“è®º**ï¼š
- âœ… èŠ‚ç‚¹é€‰æ‹©ç®—æ³•ä¿æŒä¸å˜
- âœ… ä»ç„¶ä½¿ç”¨ç°æœ‰çš„ `NodeStatus=ready` è¿‡æ»¤ç­–ç•¥
- âœ… ä»ç„¶ä½¿ç”¨æ¨¡å—ä¾èµ–å±•å¼€ç®—æ³•é€‰æ‹©èŠ‚ç‚¹
- âœ… ä»ç„¶ä½¿ç”¨æœ€å°‘è¿æ¥æ•°è´Ÿè½½å‡è¡¡ç­–ç•¥
- âœ… å¯é€‰æ”¯æŒ Sticky Nodeï¼ˆä¼šè¯/æˆ¿é—´çº§åˆ«ï¼‰ï¼Œä½†ä¸å¼ºåˆ¶

### âœ… **ç¿»è¯‘ç»“æœè·¯ç”±é€»è¾‘éœ€è¦æ”¹å˜**

**å½“å‰å®ç°**ï¼ˆå•ä¼šè¯æ¨¡å¼ï¼‰ï¼š
- ç¿»è¯‘ç»“æœåªå‘é€ç»™å‘é€è€…ï¼ˆ`session_id`ï¼‰

**ä¼šè®®å®¤æ¨¡å¼éœ€æ±‚**ï¼š
- ç¿»è¯‘ç»“æœéœ€è¦æŒ‰ `preferred_lang` è·¯ç”±ç»™æˆ¿é—´å†…æ‰€æœ‰ç›®æ ‡è¯­è¨€çš„æˆå‘˜
- å¦‚æœæˆ¿é—´å†…å¤šä¸ªæˆå‘˜çš„ç›®æ ‡è¯­è¨€ç›¸åŒï¼Œä»–ä»¬éƒ½ä¼šæ”¶åˆ°ç›¸åŒçš„ç¿»è¯‘ç»“æœ

**å·²å®ç°çš„ä¿®æ”¹**ï¼š
- âœ… åœ¨ `node_handler.rs` ä¸­ä¿®æ”¹äº†ç¿»è¯‘ç»“æœå‘é€é€»è¾‘
- âœ… æ£€æŸ¥å‘é€è€…æ˜¯å¦åœ¨æˆ¿é—´ä¸­
- âœ… å¦‚æœåœ¨æˆ¿é—´ä¸­ï¼Œè·å–æˆ¿é—´å†…æ‰€æœ‰ç›®æ ‡è¯­è¨€çš„æˆå‘˜
- âœ… å°†ç¿»è¯‘ç»“æœå‘é€ç»™æ‰€æœ‰åŒ¹é…çš„æˆå‘˜ï¼ˆåŒ…æ‹¬å‘é€è€…ï¼‰
- âœ… æ›´æ–°æˆ¿é—´æœ€åè¯´è¯æ—¶é—´ï¼ˆç”¨äºæˆ¿é—´è¿‡æœŸæ£€æµ‹ï¼‰

---

## ğŸ”§ å®ç°ç»†èŠ‚

### 1. èŠ‚ç‚¹é€‰æ‹©ï¼ˆè°ƒåº¦é€»è¾‘ï¼‰

**ä½ç½®**: `scheduler/src/dispatcher.rs`

**é€»è¾‘**: ä¿æŒä¸å˜
- ä½¿ç”¨ `select_node_with_module_expansion()` æ–¹æ³•
- è¿‡æ»¤ `NodeStatus=ready` çš„èŠ‚ç‚¹
- ä½¿ç”¨æœ€å°‘è¿æ¥æ•°è´Ÿè½½å‡è¡¡ç­–ç•¥
- æ£€æŸ¥èµ„æºä½¿ç”¨ç‡é˜ˆå€¼
- æ£€æŸ¥ GPU å¯ç”¨æ€§

**ä»£ç ä½ç½®**:
```rust
// scheduler/src/dispatcher.rs
// create_job() æ–¹æ³•ä¸­çš„èŠ‚ç‚¹é€‰æ‹©é€»è¾‘ä¿æŒä¸å˜
let assigned_node_id = self.select_node_with_module_expansion(&src_lang, &tgt_lang, features.clone(), true).await;
```

### 2. ç¿»è¯‘ç»“æœè·¯ç”±ï¼ˆå·²ä¿®æ”¹ï¼‰

**ä½ç½®**: `scheduler/src/websocket/node_handler.rs`

**ä¿®æ”¹å‰**:
```rust
// åªå‘é€ç»™å‘é€è€…
state.session_connections.send(&session_id, Message::Text(result_json)).await;
```

**ä¿®æ”¹å**:
```rust
// æ£€æŸ¥æ˜¯å¦åœ¨æˆ¿é—´ä¸­
if let Some(room_code) = state.room_manager.find_room_by_session(&session_id).await {
    // ä¼šè®®å®¤æ¨¡å¼ï¼šæŒ‰æˆ¿é—´æˆå‘˜è¯­è¨€è·¯ç”±
    let target_members = state.room_manager.get_target_language_members(
        &room_code,
        target_lang,
        None, // ä¸æ’é™¤å‘é€è€…
    ).await;
    
    // å‘æ‰€æœ‰ç›®æ ‡è¯­è¨€çš„æˆå‘˜å‘é€ç¿»è¯‘ç»“æœ
    for member in target_members {
        state.session_connections.send(&member.session_id, Message::Text(result_json)).await;
    }
} else {
    // å•ä¼šè¯æ¨¡å¼ï¼šåªå‘é€ç»™å‘é€è€…
    state.session_connections.send(&session_id, Message::Text(result_json)).await;
}
```

---

## ğŸ“Š è°ƒåº¦æµç¨‹å¯¹æ¯”

### å•ä¼šè¯æ¨¡å¼

```
å®¢æˆ·ç«¯å‘é€éŸ³é¢‘ â†’ Scheduler åˆ›å»º Job â†’ é€‰æ‹©èŠ‚ç‚¹ â†’ å‘é€åˆ°èŠ‚ç‚¹
                                                      â†“
å®¢æˆ·ç«¯æ¥æ”¶ç»“æœ â† Scheduler æ¥æ”¶ç»“æœ â† èŠ‚ç‚¹å¤„ç†å®Œæˆ
```

### ä¼šè®®å®¤æ¨¡å¼

```
å®¢æˆ·ç«¯Aå‘é€éŸ³é¢‘ â†’ Scheduler åˆ›å»º Job â†’ é€‰æ‹©èŠ‚ç‚¹ â†’ å‘é€åˆ°èŠ‚ç‚¹
                                                      â†“
å®¢æˆ·ç«¯Aæ¥æ”¶ç»“æœ â† Scheduler æ¥æ”¶ç»“æœ â† èŠ‚ç‚¹å¤„ç†å®Œæˆ
å®¢æˆ·ç«¯Bæ¥æ”¶ç»“æœ â† (å¦‚æœ preferred_lang åŒ¹é…)
å®¢æˆ·ç«¯Cæ¥æ”¶ç»“æœ â† (å¦‚æœ preferred_lang åŒ¹é…)
```

**å…³é”®å·®å¼‚**ï¼š
- âœ… èŠ‚ç‚¹é€‰æ‹©é€»è¾‘ï¼š**å®Œå…¨ç›¸åŒ**
- âœ… ç¿»è¯‘ç»“æœè·¯ç”±ï¼š**ä¸åŒ**ï¼ˆå•ä¼šè¯æ¨¡å¼åªå‘é€ç»™å‘é€è€…ï¼Œä¼šè®®å®¤æ¨¡å¼æŒ‰è¯­è¨€è·¯ç”±ç»™æ‰€æœ‰åŒ¹é…æˆå‘˜ï¼‰

---

## âœ… ç»“è®º

### è°ƒåº¦é€»è¾‘ï¼ˆèŠ‚ç‚¹é€‰æ‹©ï¼‰

**ä¸éœ€è¦æ”¹å˜** âœ…

- èŠ‚ç‚¹é€‰æ‹©ç®—æ³•ä¿æŒä¸å˜
- ä»ç„¶ä½¿ç”¨ `NodeStatus=ready` è¿‡æ»¤ç­–ç•¥
- ä»ç„¶ä½¿ç”¨æ¨¡å—ä¾èµ–å±•å¼€ç®—æ³•
- ä»ç„¶ä½¿ç”¨æœ€å°‘è¿æ¥æ•°è´Ÿè½½å‡è¡¡ç­–ç•¥

### ç¿»è¯‘ç»“æœè·¯ç”±

**éœ€è¦æ”¹å˜** âœ… **å·²å®ç°**

- âœ… å•ä¼šè¯æ¨¡å¼ï¼šåªå‘é€ç»™å‘é€è€…ï¼ˆä¿æŒå…¼å®¹ï¼‰
- âœ… ä¼šè®®å®¤æ¨¡å¼ï¼šæŒ‰æˆ¿é—´æˆå‘˜è¯­è¨€è·¯ç”±ç»™æ‰€æœ‰åŒ¹é…æˆå‘˜
- âœ… æ”¯æŒå¤šæˆå‘˜æ¥æ”¶åŒä¸€ç¿»è¯‘ç»“æœï¼ˆå¦‚æœè¯­è¨€ç›¸åŒï¼‰

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [Webâ†”Web åŸå£°é€šè¯ + ç¿»è¯‘æ¥ç®¡æ–¹æ¡ˆ v1.1](./Web_RawVoice_Translation_Handover_Spec_v1.1.md)
- [å¼€å‘å°±ç»ªæ€§è¯„ä¼°](./Web_RawVoice_Translation_Handover_Spec_v1.1_DEVELOPMENT_READINESS.md)

---

**ç¡®è®¤å®Œæˆæ—¶é—´**: 2025-01-XX

