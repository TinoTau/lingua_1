
# Web 端半双工实时语音翻译统一设计说明（含技术方案、FRD、上下文拼接优先级强化版）

版本：v3（一体化整合版）  
作者：Tino（产品规划）  

---

# 0. 本版本中你特别要求的关键决策（已写入正文并覆盖旧版本）

1. **跳过播放按钮不是必须，也不做 v1 功能**  
   - 用户会通过 Send 按钮自行调整句子长度  
   - 播放阶段严格半双工即可  

2. **ASR 字幕是必须功能**  
   - 用户需要实时看到识别内容并确认准确性  
   - 属于核心体验，不是可选项  

3. **Utterance Group & 上下文拼接为最高优先级** ✅ **已完成**  
   - 直接影响识别理解、翻译自然度  
   - 不仅要实现，还要在架构层做"强依赖"设计  
   - 不属于"后续增强"，是 v1 必须落地的逻辑  
   - **详细规范**: 请参考 [UTTERANCE_GROUP.md](./UTTERANCE_GROUP.md)  

4. **静音阈值不可由用户配置（避免复杂度）**  
   - 系统内部可预留配置项，但不暴露给用户  
   - 通过上下文拼接机制来弥补误判，不依赖阈值调节  

5. **iOS 相关内容从文档中移除或降级为未来考虑，不参与当前方案设计**

---

# 1. 背景与目标

Web 端实时语音翻译容易遇到两类核心问题：

1. **声学回响**：TTS 播放声音被麦克风回录导致 ASR 误识别。  
2. **体验断裂**：传统的“短句轮询”或“长句输入”模式不自然，用户难以掌握节奏。

本方案采用：

- 半双工自动切换（输入时不开播、播放时不收音）  
- 上下文拼接（Utterance Group，多轮语义合并）  
- 强制 ASR 字幕反馈  
- 明确 Send 行为作为用户主动结束发言方式  

确保：

- 不出现声音回录问题  
- 翻译结果连贯自然  
- 用户“看到字幕”验证自己的语音是否识别正确  
- 用户可自行掌握说话节奏（用 Send 控制句长）

---

# 2. 交互模式定义（半双工 + Send 主导节奏）

系统存在两种模式：

## 2.1 输入模式（Input Mode）
- 麦克风开启  
- Web Audio API 采音  
- ASR 实时字幕显示（必需）  
- 用户通过 **Send 按钮** 明确结束本轮输入  
- 若静音超过阈值（固定参数），系统自动结束  

## 2.2 输出模式（Output Mode）
- 麦克风彻底关闭  
- 播放 TTS  
- 用户说话被忽略（不缓存、不上传、不拼接）  
- 播放结束后恢复输入模式  

此结构避免了回音问题，也保证用户可以直观地知道“什么时候轮到我说话”。

---

# 3. 状态机（更新版）

```text
[INPUT_READY]
   │（开始说话 → 检测到语音）
   ▼
[INPUT_RECORDING] →（ASR 字幕实时显示）
   │（Send 按钮）或（静音 > 阈值 + 尾部缓冲）
   ▼
[WAITING_RESULT]
   │（收到翻译文本 + TTS 流）
   ▼
[PLAYING_TTS]
   │（播完 TTS）
   ▼
[INPUT_READY]
```

状态变化关键点：

- **ASR 字幕必须在 INPUT_RECORDING 中实时展示**  
- 输出模式直接 **关麦**，不做监听  
- Send 是主导节奏的主要动作  

---

# 4. Send 按钮行为（核心机制）

- 用户点击 Send = 明确表示“我这句话讲完了”  
- 系统立即：
  1. 停止录音  
  2. 关闭麦克风  
  3. 发送音频尾包（is_final=true）  
  4. 转入 WAITING_RESULT  
  5. 停止字幕更新  

**无需取消按钮（Cancel）**  
如果用户说错了，可以：

- 等播放结束  
- 再次按 Send 结束当前补充内容  

---

# 5. 静音自动结束（固定参数，不提供用户配置）

你要求：  
- **不允许用户配置静音阈值，避免复杂度**  
- 用“上下文拼接”弥补误判，不依赖参数调节  

因此采取：

```
silence_timeout_ms = 1000ms
tail_buffer_ms = 250ms
用户无法设置此参数
系统内部可修改（配置文件）
```

---

# 6. 输出阶段行为（播放期间全部丢弃，不缓存）

在 WAITING_RESULT 与 PLAYING_TTS：

- 浏览器不采集音频  
- 即使用户说话，也不会被用于任何识别  
- 用户若想补充，必须等播放结束重新说  
- 补充内容通过 Utterance Group 自动拼接上下文  

此规则是 **半双工核心约束，不允许破坏**

---

# 7. ASR 字幕（强制）

你强调这是必须功能——正确，这将极大提升用户信心。

### 实现要求：

1. ASR 引擎必须支持增量输出（partial + final）  
2. 浏览器 UI 必须实时显示 ASR 字幕  
3. 若识别错误，用户可立即停止并重新说（通过 Send 控制）  

### 好处：

- 老年用户体验显著提升  
- 用户能主动调节句长和停顿  
- 错误字幕可以促使用户重说，提高整体翻译质量  

---

# 8. 上下文拼接（Utterance Group：最高优先级）

你要求将其作为 **最高优先级功能**（不是后续增强），原因合理：

- ASR 需要上下文避免识别中断后含义偏差  
- Translation/LLM 需要上下文维持语义连续  
- 多轮对话本质上属于同一片段的补充  

### Group 的结构：

```
Group G1:
   part1: ASR_final1 + 翻译
   part2: ASR_final2 + 翻译
   part3: ...
```

### 拼接方式（不拼接音频，只拼接文本）

```
full_context = part1_text + part2_text + ...
```

- 由 Translation Engine 进行上下文增强翻译  
- 可在 Prompt 中注入所有相关片段（对于 LLM 翻译器）

### 触发规则（保持原版）：

- 播放结束 30 秒内继续说话 → 归为同一组  
- 若用户明显开启新话题 → 新组  

---

# 9. 技术架构（Web 前端 + 后端服务）

## 9.1 前端（必须组件）

| 文件 | 说明 |
|------|------|
| recorder.js | 录音 + 静音检测 |
| state_machine.js | 控制输入/输出状态 |
| websocket_client.js | PCM16 上传 + TTS 下载 |
| tts_player.js | TTS 播放（流式） |
| asr_subtitle.js | 实时字幕展示（必须） |

---

## 9.2 WebSocket 协议（简版）

### 上传

```
{
  type: "audio_chunk",
  seq: 12,
  is_final: false,
  payload: <Binary PCM16>
}
```

### 结束帧

```
{ type: "audio_chunk", is_final: true }
```

### 下行数据

```
{ type: "asr_partial", text: "..." }
{ type: "asr_final", text: "..." }
{ type: "translation", text: "..." }
{ type: "tts_audio", seq: 0, payload: <Binary> }
```

---

# 10. 功能需求（FRD 整合版）

| 编号 | 功能 | 必选？ | 说明 |
|------|------|--------|-------|
| FR-01 | 半双工模式 | 必须 | 输入与输出不可并行 |
| FR-02 | 输出阶段关麦 | 必须 | 彻底关闭浏览器麦克风 |
| FR-03 | Send 按钮 | 必须 | 用户主动结束本轮输入 |
| FR-04 | 静音自动结束 | 必须 | 固定参数，不提供用户配置 |
| FR-05 | ASR 字幕 | 必须 | 实时展示识别内容 |
| FR-06 | 上下文拼接（Group） | **必须** | 最高优先级，影响准确度 |
| FR-07 | 流式 ASR | 必须 | 支持 partial + final |
| FR-08 | 流式 TTS | 必须 | 用于低延迟播放 |
| FR-09 | 译文字幕 | 必须 | 播放期间显示翻译文本 |
| FR-10 | 跳过播放按钮 | 可选 | 你明确要求：v1 不实现 |

---

# 11. 文本版 UI 草图（强化版）

## 输入模式（带字幕）
```
 -----------------------------------------------------
| [●红麦克风] 正在收音…                                |
| --------------------------------------------------- |
| ASR 字幕：                                           |
|   我想问一下明天的天气……（实时更新）                 |
| --------------------------------------------------- |
| [Send / 结束本轮]                                    |
 -----------------------------------------------------
```

## 输出模式（麦克风关闭）
```
 -----------------------------------------------------
| [○灰麦克风] 正在播放译文，请稍候…                    |
| --------------------------------------------------- |
| 翻译字幕：                                           |
|   I would like to ask about the weather tomorrow.   |
| --------------------------------------------------- |
 -----------------------------------------------------
```

---

# 12. 版本与范围确认（v1）

### v1 范围必须包含：

- 半双工  
- Send 按钮  
- 实时 ASR 字幕  
- 上下文拼接（Group）  
- 流式 ASR/NMT/TTS  
- 输出阶段完全关麦  
- 译文字幕  

### v1 不包含：

- 跳过播放按钮  
- 用户自定义静音阈值  
- iOS 客户端开发  

---

# 13. 文件说明

此文档为你要求的三份内容（设计说明 + 技术方案 + FRD）整合版，可直接给开发部门。

