# 公司模型库与 Electron 客户端模型管理统一技术方案（v2）

版本：v2.0  
作者：Tino（产品规划）  
适用对象：后端 / 基础设施 / Electron 客户端开发 / 推理引擎开发

---

# 0. 更新说明（相对于 v1.0 的新增内容）

根据开发部门反馈及产品最新策略，本版本新增或修改内容如下：

1. **不需要考虑现有用户迁移**，但要确保未来版本更新具备前向兼容能力（模型格式、目录结构、registry 结构可拓展）。  
2. **不引入多环境隔离**（dev/staging/prod），维持单环境模型库，保持代码简洁。  
3. **必须防止重复下载、并发冲突与多任务竞态条件**，新增文件锁与任务锁设计。  
4. **日志与监控为未来独立模块**，本期不实现，但方案中预留接口（钩子 hooks）。  
5. **不需要用户提示文案**，但保留业务错误类型分类。  
6. **下载体验改为：客户端仅负责运算，不负责兜底**。  
   - 若模型未安装 → 客户端立即反馈给调度服务器，由调度服务器选择其他节点执行任务。  
   - 模型管理页面增加“热门模型排名”，以便用户主动为系统贡献算力。  
7. **不需要版本回滚机制**：模型更新由公司统一维护，客户端只需按提示更新模型即可。  
8. **新增测试方案：测试要点 + 验收标准**（专给开发与 QA）。

所有新增内容已整合进文档结构中。

---

# 1. 公司模型库（Server 侧）技术方案（保持 v1 设计 + 兼容性拓展）

## 1.1 模型存储目录结构（需长期保持可扩展）

```text
/storage/models/
  <model_id>/
    <version>/
      files...
      checksum.sha256
      manifest.json (预留扩展)
```

兼容性要求：

- 不允许破坏旧版本模型的结构。  
- 允许未来为每个模型版本增加次级配置、优化文件、runtime metadata。  

## 1.2 模型元数据 API（保持单环境）

```
GET /api/models
GET /api/models/{model_id}
GET /storage/models/<model_id>/<version>/<file>
```

所有服务均采用单一环境（生产级），保持简洁性。

---

# 2. Electron 客户端模型管理器（ModelManager）v2

功能集中于：

- 模型下载  
- 断点续传  
- 完整性校验  
- 版本管理  
- 并发控制  
- 模型查询  
- 任务锁 / 文件锁  
- 状态机  
- 与调度服务器交互  

客户端 **不兜底翻译逻辑**，缺模型时立即返回 `MODEL_NOT_AVAILABLE`。

---

# 3. 并发与重复下载控制（核心新增）

## 3.1 任务锁（Task Lock）

确保同一模型 + 版本 **仅能启动一个下载任务**。

实现：

```
in-progress-downloads/
  whisper-large-v3-1.0.0.lock
```

规则：

- 若 lock 存在 → 不创建新任务  
- 所有任务结束 / 异常退出时 → 自动释放 lock  
- 应用重启时 → 清理孤儿 lock  

## 3.2 文件锁（File Lock）

确保 `.part` 文件不会被两个线程同时写入：

```
models/temp/<modelId>_<version>.<filename>.part.lock
```

用于防止竞态写入和文件损坏。

---

# 4. 未来兼容性设计（替代“现有用户迁移”）

## registry.json 可扩展结构：

```json
{
  "whisper-large-v3": {
    "1.0.0": {
      "status": "ready",
      "installed_at": "...",
      "size_bytes": 123,
      "checksum_sha256": "...",
      "extra": {}
    }
  }
}
```

要求：

- `extra` 字段用于未来扩展。  
- 允许多个版本并存。  
- ModelManager 的 `getModelPath()` 永远可用，且未来扩展不破坏接口。  

---

# 5. 下载体验策略（明确终版）

### 5.1 客户端态度：不兜底、不等待模型下载

如果业务模块检查模型不可用：

```
getModelPath() → throw "MODEL_NOT_AVAILABLE"
```

客户端立即：

- 返回给调度服务器  
- 调度服务器重新分配节点  

客户端永不尝试 fallback 或本地执行。

---

### 5.2 热门模型排名 UI（新增）

客户端模型管理页显示：

```
Top Models (需求量排行):
1. marian-zh-en
2. whisper-large-v3-zh
3. marian-en-ja
```

数据来自调度服务器：

```
GET /api/model-usage/ranking
```

用户可据此选择安装高需求模型，为系统贡献算力。

---

# 6. 日志与监控（本期不实现，但预留接口）

ModelManager 预留如下 hooks（当前 no-op）：

```ts
onDownloadStart()
onDownloadProgress()
onDownloadError()
onDownloadComplete()
```

未来日志模块上线后可直接接入。

---

# 7. 测试方案（新增章节）

以下为开发 + QA 必须执行的测试内容。

---

## 7.1 单模型下载测试

### 小模型测试（<100MB）

| 测试点 | 标准 |
|-------|------|
| 正常下载 | 成功，CPU 占用平稳 |
| 中断网络 | 自动暂停，恢复后必须继续 |
| 应用重启 | 必须继续下载 |
| 校验失败 | 自动清理损坏文件并重新下载 |
| 删除 .part | 能正常重新下载 |

---

## 7.2 大模型测试（>1GB）

| 测试点 | 标准 |
|--------|--------|
| 下载效率 | 常规网络下速度稳定 |
| 内存占用 | 不持续上升，无泄漏 |
| 断点续传 | 恢复准确、无重复下载 |

---

## 7.3 并发测试（核心新增）

| 场景 | 验收标准 |
|------|----------|
| 用户连续点击 10 次“下载” | 仅创建 1 个真实任务 |
| 业务线程并发调用 5 次 getModelPath | 无死锁、无重复下载 |
| 多模型并发下载 | 各任务互不影响 |

---

## 7.4 锁机制测试

| 场景 | 标准 |
|------|-------|
| 强制 kill 程序 | lock 文件自动清理 |
| 残留 part.lock | 系统能自动恢复 |
| 双写入竞争 | 文件无损坏，第二任务等待或拒绝 |

---

## 7.5 registry.json 稳定性

| 测试点 | 标准 |
|--------|--------|
| 原子写入 | 无半写损坏 |
| 文件缺失 | 自动重建 |
| 多版本共存 | 正常读取路径 |

---

## 7.6 调度服务器联调

流程：

1. getModelPath → MODEL_NOT_AVAILABLE  
2. 客户端上报调度服务器  
3. 调度服务器重新调度  
4. 整个流程 <300ms  

---

## 7.7 模型需求排行 UI

| 测试点 | 标准 |
|--------|--------|
| API 正常 | 正确展示 |
| API 失败 | 不阻塞 UI |
| 排名变动 | UI 自动刷新 |

---

# 8. 验收标准（必须全部通过）

1. 无重复下载  
2. 无并发冲突  
3. 断点续传稳定  
4. 校验系统可靠  
5. registry.json 稳定无损坏  
6. 模型不可用情况必须正确返回调度服务器  
7. 热门模型排行正确展示  
8. 性能稳定，无内存泄漏  
9. 所有断网 / 失败场景恢复正确  

---

# 9. 小结

本技术方案 v2：

- 加强了并发控制与锁机制  
- 适配了“客户端不兜底翻译”的分布式调度架构  
- 引入“热门模型”机制以驱动用户主动安装缺口模型  
- 删除了无用逻辑（多环境、回滚、提示文案等）  
- 增加了系统级测试方案和验收标准  

可直接交付开发部门实施。

