# 模型管理方案可行性评估

## 评估结论

**总体评估：方案可行，但需要一些调整和补充**

该技术方案整体设计合理，与现有代码架构兼容，但需要在以下方面进行完善：

---

## 1. 方案与现有实现的对比

### 1.1 ✅ 已实现的部分

1. **ModelManager 基础框架**
   - ✅ 已实现 `ModelManager` 类
   - ✅ 已实现非 C 盘路径检测（`findAlternativePath`）
   - ✅ 已实现基础的模型安装/卸载功能
   - ✅ 已实现 SHA256 校验
   - ✅ 已实现 IPC 接口（`get-installed-models`, `get-available-models`, `install-model`, `uninstall-model`）

2. **模型库服务**
   - ✅ 已有 `model-hub` 服务（FastAPI）
   - ✅ 已实现 `/api/v1/models` 接口
   - ✅ 已实现模型元数据结构

### 1.2 ⚠️ 需要补充的部分

#### 1.2.1 服务器端（模型库服务）

**问题 1：API 响应格式不匹配**
- **方案要求**：返回包含 `versions` 数组的嵌套结构，支持多版本
- **现有实现**：返回扁平化的模型列表，每个模型只有一个版本
- **建议**：调整 API 响应格式以匹配方案规范

**问题 2：文件下载接口缺失**
- **方案要求**：`GET /storage/models/<model_id>/<version>/<file_path>` 支持 Range 请求
- **现有实现**：只有元数据 API，没有文件下载接口
- **建议**：实现静态文件服务，支持 Range 请求和断点续传

**问题 3：checksum.sha256 文件缺失**
- **方案要求**：每个模型版本目录包含 `checksum.sha256` 文件
- **现有实现**：只有单个 `sha256` 字段在元数据中
- **建议**：生成并存储 `checksum.sha256` 文件

#### 1.2.2 客户端（Electron ModelManager）

**问题 1：目录结构不匹配**
- **方案要求**：`models/<model_id>/<version>/files...`
- **现有实现**：`models/<model_id>/model.bin`（没有版本目录）
- **建议**：调整目录结构以支持多版本

**问题 2：断点续传未实现**
- **方案要求**：支持 HTTP Range 请求，使用 `.part` 临时文件
- **现有实现**：直接下载，不支持断点续传
- **建议**：实现断点续传逻辑

**问题 3：下载进度事件缺失**
- **方案要求**：通过 `models:progress` 事件推送下载进度
- **现有实现**：只有控制台日志，没有 IPC 事件推送
- **建议**：实现 IPC 事件推送机制

**问题 4：registry.json 格式不匹配**
- **方案要求**：`registry.json` 包含版本信息和状态
- **现有实现**：`manifest.json` 格式简单，缺少版本和状态信息
- **建议**：调整 registry 格式以匹配方案

**问题 5：多文件支持缺失**
- **方案要求**：支持下载多个文件（model.onnx, tokenizer.json, config.json 等）
- **现有实现**：只下载单个 `model.bin` 文件
- **建议**：实现多文件下载和校验

**问题 6：状态管理不完善**
- **方案要求**：支持 `not_installed / downloading / verifying / installing / ready / error` 状态
- **现有实现**：只有简单的已安装/未安装状态
- **建议**：实现完整的状态管理

---

## 2. 具体调整建议

### 2.1 服务器端调整

#### 调整 1：API 响应格式

**当前格式**：
```json
[
  {
    "model_id": "whisper-large-v3-zh",
    "version": "1.0.0",
    "size_bytes": 1865432123,
    "sha256": "abc123...",
    ...
  }
]
```

**建议调整为**：
```json
[
  {
    "id": "whisper-large-v3-zh",
    "name": "Whisper Large V3 中文增强版",
    "versions": [
      {
        "version": "1.0.0",
        "size_bytes": 1865432123,
        "files": [
          { "path": "model.onnx", "size_bytes": 123456789 },
          { "path": "tokenizer.json", "size_bytes": 456789 }
        ],
        "checksum_sha256": "abc123...",
        "updated_at": "2025-11-30T12:34:56Z"
      }
    ],
    "default_version": "1.0.0",
    "task": "asr",
    "languages": ["zh", "en"]
  }
]
```

#### 调整 2：实现文件下载服务

需要添加静态文件服务，支持：
- Range 请求（`206 Partial Content`）
- 正确的 `Content-Length` 和 `Accept-Ranges` 头

#### 调整 3：生成 checksum.sha256 文件

在模型存储目录中为每个版本生成 `checksum.sha256` 文件。

### 2.2 客户端调整

#### 调整 1：目录结构

**当前**：
```
models/
  whisper-large-v3-zh/
    model.bin
    manifest.json
```

**建议调整为**：
```
models/
  manifest_cache.json
  registry.json
  whisper-large-v3-zh/
    1.0.0/
      model.onnx
      tokenizer.json
      config.json
      checksum.sha256
  temp/
    whisper-large-v3-zh_1.0.0.model.onnx.part
```

#### 调整 2：实现断点续传

```typescript
async downloadFileWithResume(
  url: string,
  filePath: string,
  totalSize: number
): Promise<void> {
  const partPath = filePath + '.part';
  let startByte = 0;
  
  // 检查是否有部分下载的文件
  if (await this.fileExists(partPath)) {
    const stats = await fs.stat(partPath);
    startByte = stats.size;
  }
  
  // 使用 Range 请求继续下载
  const response = await axios.get(url, {
    headers: { Range: `bytes=${startByte}-` },
    responseType: 'stream',
    onDownloadProgress: (progress) => {
      // 发送进度事件
      this.emitProgress(modelId, version, progress);
    }
  });
  
  // 追加写入
  const writer = fs.createWriteStream(partPath, { flags: 'a' });
  response.data.pipe(writer);
}
```

#### 调整 3：实现 IPC 事件推送

```typescript
// 在主进程中
import { ipcMain } from 'electron';

// 发送进度事件
function emitProgress(progress: ModelDownloadProgress) {
  mainWindow?.webContents.send('models:progress', progress);
}

// 发送错误事件
function emitError(error: ModelDownloadError) {
  mainWindow?.webContents.send('models:error', error);
}
```

#### 调整 4：完善 registry.json 格式

```json
{
  "whisper-large-v3-zh": {
    "1.0.0": {
      "status": "ready",
      "installed_at": "2025-12-10T12:00:00Z",
      "size_bytes": 1865432123,
      "checksum_sha256": "abc123...",
      "files": [
        { "path": "model.onnx", "sha256": "..." },
        { "path": "tokenizer.json", "sha256": "..." }
      ]
    }
  }
}
```

---

## 3. 实施优先级建议

### 高优先级（必须实现）

1. ✅ **调整 API 响应格式** - 支持多版本结构
2. ✅ **实现文件下载服务** - 支持 Range 请求
3. ✅ **调整客户端目录结构** - 支持版本目录
4. ✅ **实现多文件下载** - 支持下载多个文件
5. ✅ **完善 registry.json** - 包含版本和状态信息

### 中优先级（重要功能）

6. ⚠️ **实现断点续传** - 提升下载体验
7. ⚠️ **实现进度事件推送** - UI 实时显示进度
8. ⚠️ **完善状态管理** - 支持所有状态类型

### 低优先级（优化功能）

9. ⏸️ **实现 manifest_cache.json** - 缓存服务器清单
10. ⏸️ **实现错误重试机制** - 自动重试失败下载
11. ⏸️ **实现下载限速** - 控制下载速度

---

## 4. 兼容性检查

### 4.1 与现有代码的兼容性

- ✅ **ModelManager 类**：可以扩展，不需要重写
- ✅ **IPC 接口**：可以扩展，保持向后兼容
- ✅ **模型库服务**：需要调整 API 格式，但可以保持兼容

### 4.2 与协议规范的兼容性

- ✅ **消息格式**：方案中的模型信息与协议规范中的 `InstalledModel` 兼容
- ✅ **节点注册**：方案中的模型列表可以用于节点注册时的 `installed_models` 字段

---

## 5. 风险评估

### 5.1 技术风险

- **低风险**：目录结构调整可能影响已安装的模型，需要迁移脚本
- **低风险**：API 格式调整需要同时更新服务器和客户端

### 5.2 实施风险

- **中风险**：断点续传实现需要仔细处理边界情况
- **低风险**：多文件下载和校验逻辑相对复杂，但已有 SHA256 校验基础

---

## 6. 总结

该技术方案**整体可行**，设计合理，与现有架构兼容。主要需要：

1. **服务器端**：调整 API 格式，实现文件下载服务
2. **客户端**：扩展 ModelManager，实现断点续传、进度推送、多文件支持

建议按照优先级逐步实施，先完成高优先级功能，再逐步完善中低优先级功能。

