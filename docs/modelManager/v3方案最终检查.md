# v3 æ–¹æ¡ˆæœ€ç»ˆæ£€æŸ¥æŠ¥å‘Š

## è¯„ä¼°ç»“è®º

**v3 æ–¹æ¡ˆå·²ç»éå¸¸å®Œå–„ï¼Œè§£å†³äº† v2 æ£€æŸ¥æ¸…å•ä¸­çš„å¤§éƒ¨åˆ†é—®é¢˜ã€‚ä½†ä»æœ‰ä¸€äº›ç»†èŠ‚éœ€è¦è¡¥å……ï¼š**

---

## âœ… v3 å·²è§£å†³çš„é—®é¢˜

1. âœ… **API æ ¼å¼å·²æ˜ç¡®** - æ‰€æœ‰ API çš„å“åº”æ ¼å¼éƒ½å·²è§„èŒƒåŒ–
2. âœ… **é”æœºåˆ¶ç»†èŠ‚å·²å®Œå–„** - é”æ–‡ä»¶æ ¼å¼ã€è¶…æ—¶æ—¶é—´éƒ½å·²æ˜ç¡®
3. âœ… **é”™è¯¯å¤„ç†ç­–ç•¥å·²æ˜ç¡®** - ModelNotAvailableError ç±»å‹å’Œä¸ŠæŠ¥æ ¼å¼å·²å®šä¹‰
4. âœ… **å¤šæ–‡ä»¶ä¸‹è½½ç­–ç•¥å·²æ˜ç¡®** - å¹¶å‘æ•°ã€é‡è¯•æ¬¡æ•°éƒ½å·²ç¡®å®š
5. âœ… **registry.json åŸå­å†™å…¥å·²æ˜ç¡®** - tmp + rename æ–¹æ¡ˆå·²ç¡®å®š
6. âœ… **çƒ­é—¨æ¨¡å‹æ’è¡Œ API å·²æ ‡å‡†åŒ–**

---

## âš ï¸ ä»éœ€è¡¥å……çš„ç»†èŠ‚

### 1. æ–‡ä»¶ä¸‹è½½æ¥å£çš„å®‰å…¨é˜²æŠ¤

**é—®é¢˜**ï¼šv3 æ–¹æ¡ˆæåˆ°äº†æ–‡ä»¶ä¸‹è½½æ¥å£ï¼Œä½†æœªæ˜ç¡®å®‰å…¨é˜²æŠ¤æªæ–½ã€‚

**éœ€è¦è¡¥å……**ï¼š
- è·¯å¾„éå†æ”»å‡»é˜²æŠ¤ï¼ˆé˜²æ­¢ `../../../etc/passwd` ç­‰ï¼‰
- æ–‡ä»¶ä¸å­˜åœ¨æ—¶çš„é”™è¯¯å“åº”æ ¼å¼
- æ˜¯å¦éœ€è¦è®¤è¯/æˆæƒï¼ˆè™½ç„¶æ–¹æ¡ˆè¯´å•ç¯å¢ƒï¼Œä½†å»ºè®®æ˜ç¡®ï¼‰

**å»ºè®®è¡¥å……**ï¼š
```python
# æœåŠ¡å™¨ç«¯æ–‡ä»¶ä¸‹è½½æ¥å£å®‰å…¨é˜²æŠ¤ç¤ºä¾‹
@app.get("/storage/models/{model_id}/{version}/{file_path:path}")
async def download_model_file(
    model_id: str,
    version: str,
    file_path: str
):
    # 1. è·¯å¾„è§„èŒƒåŒ–ï¼Œé˜²æ­¢è·¯å¾„éå†
    normalized_path = os.path.normpath(file_path)
    if normalized_path.startswith('..') or os.path.isabs(normalized_path):
        raise HTTPException(status_code=400, detail="Invalid file path")
    
    # 2. æ„å»ºå®Œæ•´è·¯å¾„
    full_path = os.path.join(MODELS_DIR, model_id, version, normalized_path)
    
    # 3. éªŒè¯è·¯å¾„åœ¨å…è®¸çš„ç›®å½•å†…
    if not full_path.startswith(os.path.abspath(MODELS_DIR)):
        raise HTTPException(status_code=403, detail="Access denied")
    
    # 4. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if not os.path.exists(full_path):
        raise HTTPException(status_code=404, detail="File not found")
    
    # 5. æ”¯æŒ Range è¯·æ±‚
    # ... å®ç° Range æ”¯æŒ
```

### 2. checksum.sha256 æ–‡ä»¶æ ¼å¼æœªæ˜ç¡®

**é—®é¢˜**ï¼šv3 æ–¹æ¡ˆæåˆ° `checksum.sha256` åŒ…å«æ‰€æœ‰æ–‡ä»¶çš„ SHA256ï¼Œä½†æœªæ˜ç¡®æ–‡ä»¶æ ¼å¼ã€‚

**éœ€è¦è¡¥å……**ï¼š
- checksum.sha256 æ–‡ä»¶çš„å…·ä½“æ ¼å¼
- å¦‚ä½•è§£æå’ŒéªŒè¯

**å»ºè®®è¡¥å……**ï¼š
```text
# checksum.sha256 æ–‡ä»¶æ ¼å¼ï¼ˆæ¯è¡Œä¸€ä¸ªæ–‡ä»¶ï¼‰
# æ ¼å¼ï¼š<sha256_hash>  <file_path>

a1b2c3d4e5f6...  model.onnx
f6e5d4c3b2a1...  tokenizer.json
1234567890ab...  config.json
```

æˆ–è€… JSON æ ¼å¼ï¼š
```json
{
  "model.onnx": "a1b2c3d4e5f6...",
  "tokenizer.json": "f6e5d4c3b2a1...",
  "config.json": "1234567890ab..."
}
```

### 3. è°ƒåº¦æœåŠ¡å™¨æ¶ˆæ¯æ ¼å¼éœ€è¦ç¡®è®¤

**é—®é¢˜**ï¼šv3 æ–¹æ¡ˆå®šä¹‰äº†å®¢æˆ·ç«¯ä¸ŠæŠ¥æ ¼å¼ï¼Œä½†éœ€è¦ç¡®è®¤æ˜¯å¦ä¸è°ƒåº¦æœåŠ¡å™¨çš„æ¶ˆæ¯åè®®ä¸€è‡´ã€‚

**å½“å‰ v3 å®šä¹‰**ï¼š
```json
{
  "type": "MODEL_NOT_AVAILABLE",
  "node_id": "node-23",
  "job_id": "job-88921",
  "model_id": "marian-zh-en",
  "version": "2.1.0",
  "reason": "not_installed"
}
```

**éœ€è¦ç¡®è®¤**ï¼š
- è¿™æ˜¯ä½œä¸º `job_result` æ¶ˆæ¯çš„ä¸€éƒ¨åˆ†ï¼ˆ`success: false, error: {...}`ï¼‰ï¼Ÿ
- è¿˜æ˜¯ä½œä¸ºç‹¬ç«‹çš„ `node_error` æ¶ˆæ¯ï¼Ÿ
- è¿˜æ˜¯éœ€è¦æ–°å¢æ¶ˆæ¯ç±»å‹ï¼Ÿ

**å»ºè®®**ï¼šæ ¹æ®ç°æœ‰åè®®è§„èŒƒï¼Œåº”è¯¥ä½¿ç”¨ `job_result` æ¶ˆæ¯ï¼š
```json
{
  "type": "job_result",
  "job_id": "job-88921",
  "node_id": "node-23",
  "session_id": "sess-123456",
  "utterance_index": 4,
  "success": false,
  "error": {
    "code": "MODEL_NOT_AVAILABLE",
    "message": "Required model marian-zh-en@2.1.0 is not installed",
    "details": {
      "model_id": "marian-zh-en",
      "version": "2.1.0",
      "reason": "not_installed"
    }
  }
}
```

### 4. é”æ–‡ä»¶æ¸…ç†ç­–ç•¥ç»†èŠ‚

**é—®é¢˜**ï¼šv3 æåˆ°"å¯åŠ¨å®¢æˆ·ç«¯æ—¶å¿…é¡»æ¸…ç†å­¤å„¿é”"ï¼Œä½†æœªæ˜ç¡®æ¸…ç†æ¡ä»¶ã€‚

**éœ€è¦è¡¥å……**ï¼š
- å¦‚ä½•åˆ¤æ–­é”æ˜¯å¦è¿‡æœŸï¼ˆåŸºäº timeout è¿˜æ˜¯å›ºå®šæ—¶é—´ï¼Ÿï¼‰
- å¦‚ä½•åˆ¤æ–­è¿›ç¨‹æ˜¯å¦è¿˜åœ¨è¿è¡Œï¼ˆæ£€æŸ¥ PIDï¼Ÿï¼‰
- æ¸…ç†é”åå¦‚ä½•å¤„ç†å¯¹åº”çš„ .part æ–‡ä»¶ï¼Ÿ

**å»ºè®®è¡¥å……**ï¼š
```typescript
// é”æ¸…ç†ç­–ç•¥
async cleanupOrphanLocks(): Promise<void> {
  const lockDir = path.join(this.modelsDir, 'in-progress-downloads');
  const locks = await fs.readdir(lockDir);
  
  for (const lockFile of locks) {
    const lockPath = path.join(lockDir, lockFile);
    const lockContent = JSON.parse(await fs.readFile(lockPath, 'utf-8'));
    
    // 1. æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¿˜åœ¨è¿è¡Œ
    const isProcessAlive = await this.isProcessAlive(lockContent.pid);
    
    // 2. æ£€æŸ¥æ˜¯å¦è¶…æ—¶
    const isTimeout = Date.now() - lockContent.timestamp > lockContent.timeout;
    
    // 3. å¦‚æœè¿›ç¨‹ä¸å­˜åœ¨æˆ–è¶…æ—¶ï¼Œæ¸…ç†é”
    if (!isProcessAlive || isTimeout) {
      await fs.unlink(lockPath);
      // å¯é€‰ï¼šæ¸…ç†å¯¹åº”çš„ .part æ–‡ä»¶
      // await this.cleanupPartFiles(lockContent.modelId, lockContent.version);
    }
  }
}
```

### 5. æµå¼ä¸‹è½½çš„å†…å­˜ç®¡ç†

**é—®é¢˜**ï¼šv3 æåˆ°"ä¼ è¾“å±‚ chunkï¼ˆä¾‹å¦‚æ¯æ¬¡ 1MBï¼‰"ï¼Œä½†æœªæ˜ç¡®å¦‚ä½•é¿å…å¤§æ–‡ä»¶å ç”¨è¿‡å¤šå†…å­˜ã€‚

**éœ€è¦è¡¥å……**ï¼š
- ä½¿ç”¨æµå¼ä¸‹è½½ï¼ˆ`responseType: 'stream'`ï¼‰è€Œä¸æ˜¯ `arraybuffer`
- æ˜ç¡® chunk å¤§å°å’Œç¼“å†²åŒºç®¡ç†

**å»ºè®®è¡¥å……**ï¼š
```typescript
// æµå¼ä¸‹è½½å®ç°
async downloadFileWithStream(
  url: string,
  filePath: string,
  totalSize: number
): Promise<void> {
  const partPath = filePath + '.part';
  let startByte = 0;
  
  // æ£€æŸ¥æ–­ç‚¹
  if (await this.fileExists(partPath)) {
    const stats = await fs.stat(partPath);
    startByte = stats.size;
  }
  
  // ä½¿ç”¨æµå¼ä¸‹è½½
  const response = await axios.get(url, {
    headers: { Range: `bytes=${startByte}-` },
    responseType: 'stream',  // å…³é”®ï¼šä½¿ç”¨ stream è€Œä¸æ˜¯ arraybuffer
    onDownloadProgress: (progress) => {
      this.emitProgress(progress);
    }
  });
  
  // è¿½åŠ å†™å…¥æµ
  const writer = fs.createWriteStream(partPath, { flags: 'a' });
  response.data.pipe(writer);
  
  await new Promise((resolve, reject) => {
    writer.on('finish', resolve);
    writer.on('error', reject);
  });
}
```

### 6. ç‰ˆæœ¬é€‰æ‹©ç­–ç•¥

**é—®é¢˜**ï¼šv3 æ–¹æ¡ˆæåˆ° `default_version`ï¼Œä½†æœªæ˜ç¡® `getModelPath()` çš„ç‰ˆæœ¬é€‰æ‹©é€»è¾‘ã€‚

**éœ€è¦è¡¥å……**ï¼š
- å¦‚æœè°ƒç”¨ `getModelPath(modelId)` ä¸æŒ‡å®šç‰ˆæœ¬ï¼Œä½¿ç”¨å“ªä¸ªç‰ˆæœ¬ï¼Ÿ
- å¦‚æœæŒ‡å®šç‰ˆæœ¬ä¸å­˜åœ¨ï¼Œå¦‚ä½•å¤„ç†ï¼Ÿ
- å¦‚æœ default_version ä¸å­˜åœ¨ï¼Œå¦‚ä½•å¤„ç†ï¼Ÿ

**å»ºè®®è¡¥å……**ï¼š
```typescript
async getModelPath(
  modelId: string,
  version?: string
): Promise<string> {
  // 1. å¦‚æœæœªæŒ‡å®šç‰ˆæœ¬ï¼Œä½¿ç”¨ default_version
  if (!version) {
    const modelInfo = await this.getModelInfo(modelId);
    version = modelInfo?.default_version;
    if (!version) {
      throw new ModelNotAvailableError(
        modelId,
        'latest',
        'not_installed',
        'No default version specified'
      );
    }
  }
  
  // 2. æ£€æŸ¥æ¨¡å‹æ˜¯å¦å·²å®‰è£…
  const installedModel = this.getInstalledModel(modelId, version);
  if (!installedModel) {
    throw new ModelNotAvailableError(modelId, version, 'not_installed');
  }
  
  // 3. æ£€æŸ¥çŠ¶æ€
  if (installedModel.status !== 'ready') {
    throw new ModelNotAvailableError(modelId, version, installedModel.status);
  }
  
  return installedModel.path;
}
```

### 7. ä¸‹è½½è¿›åº¦äº‹ä»¶æ¨é€æœºåˆ¶

**é—®é¢˜**ï¼šv3 æ–¹æ¡ˆæåˆ° UI éœ€è¦æ˜¾ç¤ºä¸‹è½½è¿›åº¦ï¼Œä½†æœªæ˜ç¡®å¦‚ä½•é€šè¿‡ IPC æ¨é€è¿›åº¦äº‹ä»¶ã€‚

**éœ€è¦è¡¥å……**ï¼š
- IPC äº‹ä»¶åç§°å’Œæ•°æ®ç»“æ„
- æ¨é€é¢‘ç‡ï¼ˆæ¯æ¬¡ chunk è¿˜æ˜¯å®šæ—¶ï¼Ÿï¼‰

**å»ºè®®è¡¥å……**ï¼š
```typescript
// ä¸»è¿›ç¨‹ä¸­
import { ipcMain, BrowserWindow } from 'electron';

// å‘é€è¿›åº¦äº‹ä»¶
function emitDownloadProgress(progress: {
  modelId: string;
  version: string;
  downloadedBytes: number;
  totalBytes: number;
  percent: number;
  state: 'downloading' | 'verifying' | 'installing';
}) {
  mainWindow?.webContents.send('models:progress', progress);
}

// æ¸²æŸ“è¿›ç¨‹ä¸­
ipcRenderer.on('models:progress', (_, progress) => {
  // æ›´æ–° UI
  updateDownloadProgress(progress);
});
```

### 8. é”™è¯¯é‡è¯•ç­–ç•¥ç»†èŠ‚

**é—®é¢˜**ï¼šv3 æåˆ°"æ¯ä¸ªæ–‡ä»¶é‡è¯•æœ€å¤š 3 æ¬¡"ï¼Œä½†æœªæ˜ç¡®é‡è¯•æ¡ä»¶ã€‚

**éœ€è¦è¡¥å……**ï¼š
- å“ªäº›é”™è¯¯éœ€è¦é‡è¯•ï¼ˆç½‘ç»œé”™è¯¯ï¼Ÿæ ¡éªŒå¤±è´¥ï¼Ÿï¼‰
- é‡è¯•é—´éš”ï¼ˆç«‹å³é‡è¯•è¿˜æ˜¯æŒ‡æ•°é€€é¿ï¼Ÿï¼‰
- é‡è¯•å¤±è´¥åçš„å¤„ç†

**å»ºè®®è¡¥å……**ï¼š
```typescript
// é‡è¯•ç­–ç•¥
const MAX_RETRIES = 3;
const RETRY_DELAYS = [1000, 2000, 5000]; // æŒ‡æ•°é€€é¿

async downloadFileWithRetry(url: string, filePath: string): Promise<void> {
  for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
    try {
      await this.downloadFile(url, filePath);
      return; // æˆåŠŸ
    } catch (error) {
      // åˆ¤æ–­æ˜¯å¦å¯é‡è¯•
      if (!this.isRetryableError(error)) {
        throw error; // ä¸å¯é‡è¯•çš„é”™è¯¯ç›´æ¥æŠ›å‡º
      }
      
      // æœ€åä¸€æ¬¡å°è¯•å¤±è´¥
      if (attempt === MAX_RETRIES - 1) {
        throw error;
      }
      
      // ç­‰å¾…åé‡è¯•
      await this.sleep(RETRY_DELAYS[attempt]);
    }
  }
}

function isRetryableError(error: any): boolean {
  // ç½‘ç»œé”™è¯¯ã€è¶…æ—¶é”™è¯¯å¯é‡è¯•
  return error.code === 'ECONNRESET' ||
         error.code === 'ETIMEDOUT' ||
         error.code === 'ENOTFOUND';
}
```

---

## ğŸ“‹ å¼€å‘å‰æ£€æŸ¥æ¸…å•

åœ¨å¼€å§‹å¼€å‘å‰ï¼Œå»ºè®®ç¡®è®¤ä»¥ä¸‹äº‹é¡¹ï¼š

### æœåŠ¡å™¨ç«¯
- [ ] å®ç°æ–‡ä»¶ä¸‹è½½æ¥å£çš„å®‰å…¨é˜²æŠ¤ï¼ˆè·¯å¾„éå†é˜²æŠ¤ï¼‰
- [ ] æ˜ç¡® checksum.sha256 æ–‡ä»¶æ ¼å¼
- [ ] å®ç° Range è¯·æ±‚æ”¯æŒ
- [ ] å®ç°çƒ­é—¨æ¨¡å‹æ’è¡Œ API

### å®¢æˆ·ç«¯
- [ ] ç¡®è®¤è°ƒåº¦æœåŠ¡å™¨æ¶ˆæ¯æ ¼å¼ï¼ˆjob_result vs node_errorï¼‰
- [ ] å®ç°é”æ–‡ä»¶æ¸…ç†ç­–ç•¥
- [ ] å®ç°æµå¼ä¸‹è½½ï¼ˆé¿å…å†…å­˜é—®é¢˜ï¼‰
- [ ] å®ç°ç‰ˆæœ¬é€‰æ‹©é€»è¾‘
- [ ] å®ç° IPC è¿›åº¦äº‹ä»¶æ¨é€
- [ ] å®ç°é”™è¯¯é‡è¯•ç­–ç•¥

### æµ‹è¯•
- [ ] å‡†å¤‡æµ‹è¯•ç”¨çš„æ¨¡å‹æ–‡ä»¶
- [ ] å‡†å¤‡ç½‘ç»œä¸­æ–­æ¨¡æ‹Ÿå·¥å…·
- [ ] å‡†å¤‡å¤§æ–‡ä»¶ä¸‹è½½æµ‹è¯•åœºæ™¯

---

## æ€»ç»“

v3 æ–¹æ¡ˆå·²ç»éå¸¸å®Œå–„ï¼Œä¸»è¦çš„æŠ€æœ¯å†³ç­–å’Œæ¶æ„è®¾è®¡éƒ½å·²æ˜ç¡®ã€‚ä¸Šè¿°è¡¥å……ç‚¹ä¸»è¦æ˜¯**å®ç°ç»†èŠ‚**ï¼Œå¯ä»¥åœ¨å¼€å‘è¿‡ç¨‹ä¸­é€æ­¥å®Œå–„ï¼Œä¸ä¼šå½±å“æ•´ä½“æ¶æ„ã€‚

**å»ºè®®**ï¼š
1. å…ˆå®ç°æ ¸å¿ƒåŠŸèƒ½ï¼ˆä¸‹è½½ã€æ ¡éªŒã€å®‰è£…ï¼‰
2. å†å®Œå–„ç»†èŠ‚ï¼ˆå®‰å…¨é˜²æŠ¤ã€é”™è¯¯å¤„ç†ã€è¿›åº¦æ¨é€ï¼‰
3. æœ€åè¿›è¡Œæµ‹è¯•å’Œä¼˜åŒ–

v3 æ–¹æ¡ˆå·²ç»å¯ä»¥å¼€å§‹å¼€å‘äº†ï¼ğŸ‰

