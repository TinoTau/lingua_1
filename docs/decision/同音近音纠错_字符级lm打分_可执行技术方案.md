# 同音/近音纠错：字符级 LM 打分（内置模型）

> 目标：解决 **ASR 识别出同音字/近音字** 且 **语义修复服务无法有效纠正** 的问题。
>
> 冻结原则：
> - **不引入人工维护的词表（错误→正确映射）**
> - **不采用 C2（让语义修复模型自评分）**，避免额外耗时与输出格式控制流
> - 节点端安装包可 **内置 LM 文件**
> - **不考虑兼容**；保持代码简洁；避免新增重复路径/兜底链

---

## 1. 根因与方案选择

### 1.1 根因（已确认）
- 同音候选生成可以做到，但在“无词表、无打分器”的约束下 **无法从多候选中选优**，因此当前后处理只能“恒返回原文”。
- 语义修复服务当前不提供可靠的可比较分数（confidence 固定值/占位），因此也无法充当候选排序器。

### 1.2 本方案（选择 C1）
引入 **字符级 n-gram 语言模型（char LM）** 作为“非词表打分器”，用于同音候选选优。

- 不存业务词表，仅对候选句做概率/似然打分。
- 以 **最少新增路径** 的方式把“候选→打分→选优”插入到现有后处理链中。

---

## 2. 设计目标（必须满足）

1. **只新增一个可控步骤**：`PHONETIC_LM_RESCORE`（可开关）
2. 不改变现有 ASR / 语义修复服务的接口契约
3. 只在必要场景触发（中文文本 + 具备同音歧义）
4. 候选空间严格受限，避免指数爆炸
5. 输出必须可解释、可观测：日志能说明“为何改/不改”

---

## 3. 系统边界与数据

### 3.1 输入/输出

- **输入**：ASR 文本 `asrText`（中文为主），可选携带简单元数据（语言、segmentIndex 等）
- **输出**：`bestText`（用于后续语义修复/翻译的输入，或直接作为最终 ASR 文本）

### 3.2 内置资源

- `char_lm.bin`（或 `char_lm.jsonl` / `char_lm.arpa`）——内置在节点端安装包中
- `pinyin_map.bin`（可选）：拼音→候选汉字集合（高频汉字子集）
  - 注意：这是语言资源，不是“错误→正确”的业务词表

> 若你们当前已有 `SAME_PINYIN_GROUPS` 常量/资源，可直接复用，优先减少新增文件。

---

## 4. 算法与约束（核心）

### 4.1 触发条件（必须严格）
仅在同时满足以下条件时触发 `PHONETIC_LM_RESCORE`：

1. 文本语言为 `zh`（或检测到中文字占比超过阈值，如 ≥ 0.3）
2. 文本长度在合理范围（建议 2–120 字符）
3. 文本中存在可替换位点（见 4.2），否则直接返回原文

> 不引入“猜测性触发”（例如复杂正则规则）；触发条件越少越好。

### 4.2 可替换位点的选择（限制候选空间）

为了避免对整句做暴力替换，本方案只允许替换 **极少数位点**。

推荐的最小策略（简单、可实现）：

- 对每个中文字符 `c`：若 `c` 存在同音候选集合 `H(c)`（来自 SAME_PINYIN_GROUPS 或 pinyin_map）
- 取 **最多 M 个位点** 作为可替换位点（建议 `M=1` 或 `M=2`）
- 位点选择规则（从简）：
  1) 优先选择“候选集合大小 ≥ 2”的字符
  2) 若超过 M 个，选靠后（接近句尾）或靠前（接近句首）固定策略之一即可（保持确定性）

> 不依赖 token logprob（因为 faster-whisper n-best 不可用且你们当前未稳定提供 token-level 置信度）。

### 4.3 候选生成（受限枚举）

- 若 `M=1`：候选数 ≤ `|H(c)|`（建议截断到 `K=8`）
- 若 `M=2`：候选数 ≤ `|H(c1)| * |H(c2)|`（建议总数上限 `K=24`，超出则截断）

生成规则：
- 始终包含原句（baseline）
- 每个候选只替换 1–2 个字符
- 不修改标点/空格/英文/数字

### 4.4 打分与选优（char LM）

对每个候选句 `s` 计算：

- `score(s) = -NLL_charLM(s)`（或 logprob，总之越大越好）

选优：

- 取 `s_best = argmax score(s)`
- 只有当 `score(s_best) - score(s_original) ≥ delta` 时才替换
  - 建议 `delta` 初值 1.0（按你们 LM 的尺度调整）

> `delta` 是唯一“安全阀”，用于避免 LM 微弱偏好导致过度改写。
> 这不是补丁链，只是单步决策阈值。

---

## 5. 与现有流程的集成点（最小侵入）

### 5.1 插入位置（推荐）

在节点端文本后处理链中：

```text
ASR 输出文本
  → (可选) 简单清洗/标点规范化
  → PHONETIC_LM_RESCORE   (新增一步)
  → 语义修复（如已启用/强制）
  → 翻译 / 下游
```

理由：
- 同音纠错的目标是把“更合理的文本”交给语义修复
- 语义修复对同音错误通常偏保守，先纠错更能帮助后续修复

> 注意：你已明确“本阶段不做 utterance 级完整合并/完整修复/完整翻译”。
> 本步骤作用于 **当前 ASR 文本**（5 秒切片/segment 输出）即可。

### 5.2 代码结构建议（单一入口）

新增模块（示例命名）：
- `main/src/text-postprocess/phonetic_lm_rescore.ts`

暴露单一函数：

```ts
export function phoneticLmRescore(
  text: string,
  lang: string,
  opts?: { maxPositions?: number; maxCandidates?: number; delta?: number }
): { text: string; changed: boolean; debug?: DebugInfo }
```

并在现有 postprocess pipeline 中 **只调用一次**。

---

## 6. 模型文件与加载方式（内置）

### 6.1 打包
- 将 `char_lm.bin` 放入节点端安装包的只读资源目录（如 `assets/models/char_lm.bin`）
- 若需要 `pinyin_map.bin`，同样内置（或复用已有 `SAME_PINYIN_GROUPS`）

### 6.2 加载
- 节点端启动时懒加载一次（第一次调用时加载），缓存于内存
- 失败策略：
  - LM 文件缺失/损坏 → 记录错误日志并 **直接跳过本步骤**（返回原文）

> 这是必要的“可运行性保障”，不引入额外路径：只是单步 fail-open。

---

## 7. 可观测性（必须）

每次触发时记录一条结构化日志（debug 级别）：
- `originalText`
- `bestText`
- `changed`
- `deltaScore`
- `candidatesCount`
- `replacedPositions`（最多 2 个）

若未触发：
- 记录一次原因（lang 非 zh / 无可替换位点 / 超长 / LM 不可用）

目的：
- 让“为何不改/为何改”可直接从日志判断

---

## 8. 风险与边界（必须写死）

1. 本步骤 **不会**引入人工可维护词表（错误→正确映射）
2. 本步骤只做 **字符级同音候选选优**，不承担语义重写
3. 本步骤不改变 job/turn 的控制流，不参与合并与 finalize
4. 若出现误改：通过调整 `delta`、`M`、`K` 进行收敛（不增加新流程）

---

## 9. 执行检查清单（不含最小 patch/tasklist，仅验收标准）

1. 中文 ASR 文本中含同音歧义时：候选数受控（≤K），且日志可见候选评分差
2. LM 不可用时：系统不崩溃，跳过步骤并记录原因
3. 非中文文本：永不触发
4. 不出现重复调用/双重后处理路径（grep 只存在 1 处调用入口）

---

## 10. 需要补充材料（若缺失将阻塞落地）

请开发部门确认并提供（任选其一即可）：

- A) 当前代码里 `SAME_PINYIN_GROUPS` 的来源与结构（是否已包含足够候选）
- B) 若候选不足：是否允许内置 `pinyin_map.bin`（高频字集合即可）
- C) 当前文本后处理 pipeline 的实际入口文件与调用链（以便把新增步骤插入到唯一位置）

> 除以上三项外，不需要新增任何外部依赖或服务。

