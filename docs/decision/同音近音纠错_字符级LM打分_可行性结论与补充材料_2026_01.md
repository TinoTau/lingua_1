# 同音/近音纠错（字符级 LM 打分）— 可行性结论与补充材料

> 对应技术方案：[同音近音纠错_字符级lm打分_可执行技术方案.md](./同音近音纠错_字符级lm打分_可执行技术方案.md)  
> 本文档供决策部门审议时使用，补充「是否可行」结论及方案 §10 所需材料。

---

## 1. 可行性结论

**结论：可行。**

- 技术方案中的约束（无词表、不采用语义修复自评分、内置 LM、单步可开关、最小侵入）与当前代码与部署方式兼容。
- 节点端已具备：
  - **同音字组**（SAME_PINYIN_GROUPS）及 字→[同音字] 的混淆集；
  - **单一后处理步骤** PHONETIC_CORRECTION，位于 AGGREGATION 与 SEMANTIC_REPAIR 之间，且**唯一调用点**即为该步骤；
  - 输入/输出契约：读写 `ctx.segmentForJobResult`，不改动 ASR/语义修复接口。
- 落地时只需：**在现有 PHONETIC_CORRECTION 步骤内**接入「候选生成 + 字符级 LM 打分 + 选优」（LM 文件存在时启用，缺失时保持当前行为：返回原文），无需新增步骤或重复调用链。
- 唯一需事先确定的**未决项**：字符级 n-gram LM 的**文件格式**（见下文 §4）及首版模型的**来源/构建方式**（自建脚本或现成工具），不影响「方案是否可行」的结论。

---

## 2. 方案 §10 所需补充材料（逐项答复）

### A) SAME_PINYIN_GROUPS 的来源与结构，是否已包含足够候选

- **来源与位置**：节点端代码内嵌常量，路径为  
  `electron_node/electron-node/main/src/phonetic-correction/confusion-set.ts`。
- **结构**：`string[][]`，即「同音字组」数组，每组内字符视为同音/近音，例如：
  - `['余','语','鱼','于','与','雨','宇','羽','玉','遇']`
  - `['英','音','应','鹰','婴','樱','迎','营','影','映']`
  - `['识','试','式','事','世','势','市','示','视','适']`
  - 等约 50 组；模块加载时据此构建 `Map<字, 同音字数组>`，供候选生成使用。
- **是否足够**：  
  - 已覆盖常见 ASR 同音/近音错误（如 余/语、英/音、识/试/式、系/细、现/线、在/再、结/节/接 等），可作为首版「可替换位点」的候选来源。  
  - 若后续发现漏字或漏组，只需在该常量中**追加同音字组**，无需新增词表或错误→正确映射；  
  - 若希望与方案中的「pinyin_map」一致，可视为对 SAME_PINYIN_GROUPS 的扩展（更多字、更多组），当前结构已支持。

**结论**：可直接复用，无需额外 pinyin_map 即可落地首版；后续按需扩展同音字组即可。

---

### B) 若候选不足，是否允许内置 pinyin_map.bin（高频字集合）

- 当前**不依赖** pinyin_map.bin；同音候选**全部来自 SAME_PINYIN_GROUPS**。
- 若未来需要更大候选集（例如按拼音码表生成同音字）：  
  - **允许**在安装包中内置 pinyin_map（或等价资源），视为**语言资源**，不是「错误→正确」业务词表，符合方案边界。  
  - 实现上可选：  
    - 继续在代码中扩展 SAME_PINYIN_GROUPS；或  
    - 增加可选资源文件（如 `pinyin_map.json` / `pinyin_map.bin`），在 LM 打分步骤中与 SAME_PINYIN_GROUPS 合并使用（未提供时仅用现有常量）。

**结论**：方案允许内置 pinyin_map；当前首版可不内置，仅用 SAME_PINYIN_GROUPS 即可。

---

### C) 当前文本后处理 pipeline 的实际入口与调用链（以便把新增逻辑插入到唯一位置）

- **入口**：节点端唯一与「同音/近音后处理」相关的调用点为 **Pipeline 步骤** `PHONETIC_CORRECTION` 的执行函数  
  `runPhoneticCorrectionStep`，定义在  
  `electron_node/electron-node/main/src/pipeline/steps/phonetic-correction-step.ts`。
- **调用链**：
  1. `job-pipeline.ts` 的 `runJobPipeline` 按模式顺序执行步骤；
  2. 步骤序列（含 ASR 的流程）为：  
     `ASR → AGGREGATION → PHONETIC_CORRECTION → SEMANTIC_REPAIR → DEDUP → …`
  3. 执行到 `PHONETIC_CORRECTION` 时，由 `pipeline-step-registry.ts` 调用  
     `runPhoneticCorrectionStep(job, ctx, services)`；
  4. 该步骤**只做一件事**：读取 `ctx.segmentForJobResult`，调用 `correct(segment)`（当前为 `phonetic-correction` 模块的 `correct`，恒返回原文），将结果写回 `ctx.segmentForJobResult`。
- **数据流**：  
  - 输入：`ctx.segmentForJobResult`（本 job 的本段 ASR 文本，可能已做聚合）；  
  - 输出：同一字段被覆盖为「同音/近音纠错后」的文本；  
  - 下游：SEMANTIC_REPAIR 只读 `ctx.segmentForJobResult`，不感知是否经过 LM 打分。

**结论**：**无需新增步骤或第二处调用**；在 `runPhoneticCorrectionStep` 内，将当前对 `correct(segment)` 的调用改为「若已配置/存在 char LM，则调用 phoneticLmRescore(text, lang, opts)，否则继续调用现有 correct(text)」即可，保证全链路仅此一处同音/LM 后处理。

---

## 3. 与方案条文的对应关系（简要）

| 方案要求 | 当前状态 / 落地方式 |
|----------|----------------------|
| 只新增一个可控步骤，可开关 | 不新增步骤；在既有 PHONETIC_CORRECTION 内按「LM 是否可用」分支，LM 不可用时等价于当前行为（返回原文），可通过配置/资源是否存在实现「可开关」。 |
| 不改变 ASR/语义修复接口 | 仅读写 `ctx.segmentForJobResult`，不改任何服务接口。 |
| 仅必要场景触发（中文 + 同音歧义） | 沿用现有 `shouldExecuteStep` 对 PHONETIC_CORRECTION 的条件（中文等）；在步骤内部再判「是否存在可替换位点」，无则直接返回原文。 |
| 候选空间受控（M=1/2，K 上限） | 在 phonetic-correction 模块（或新子模块 phonetic_lm_rescore）内实现：按 SAME_PINYIN_GROUPS 选最多 M 个位点、生成最多 K 个候选，与方案一致。 |
| LM 内置、懒加载、缺失时跳过 | char_lm 文件置于节点安装包资源目录，首次调用时加载并缓存；缺失或损坏时打日志并返回原文，不抛错。 |
| 可观测（为何改/不改） | 在步骤内/ phoneticLmRescore 返回值中输出 debug 信息，打结构化日志（originalText / bestText / changed / deltaScore / candidatesCount / replacedPositions 等），与方案 §7 一致。 |

---

## 4. 落地前需决策的未决项（建议写入决议）

以下两项**不阻塞「方案可行」结论**，但阻塞**具体实现与发布**，建议由决策部门拍板或授权技术选型：

1. **字符级 n-gram LM 的文件格式**  
   - 方案中列举：`char_lm.bin` / `char_lm.jsonl` / `char_lm.arpa`。  
   - 建议：优先采用**实现简单、易生成**的格式（例如 JSON 或 JSONL 形式的 n-gram 计数或概率表），便于用现成脚本从中文语料生成；若需体积与加载速度，再考虑二进制格式。  
   - 需在决议中明确：首版采用的格式及「由谁、用何工具/脚本」生成首版 LM 文件。

2. **首版 LM 模型的来源与部署方式**  
   - 选项大致包括：  
     - 用开源中文语料（如新闻/百科）自建字符级 n-gram，导出为上述格式，随节点安装包内置；  
     - 使用现成工具（如 KenLM、srilm 等）生成 .arpa 或等价格式，再转换为节点端可读格式。  
   - 需在决议中明确：是否允许节点安装包内置该 LM 文件、体积上限（若有）、以及由哪方负责生成/维护首版。

---

## 5. 小结（可直接摘入决议）

- **可行性**：同音/近音纠错（字符级 LM 打分）方案在现有节点端架构下**可行**，且可与「无词表」约束并存。
- **补充材料**：  
  - A) SAME_PINYIN_GROUPS 已存在且结构清晰，可直接复用，首版无需 pinyin_map。  
  - B) 允许在候选不足时内置 pinyin_map 类资源；首版不强制。  
  - C) 唯一插入点为现有 PHONETIC_CORRECTION 步骤，无需新增步骤或重复调用链。
- **建议决议内容**：  
  - 确认采纳「字符级 LM 打分」作为同音候选选优手段；  
  - 明确首版 LM 文件格式与首版模型来源/构建/部署责任；  
  - 确认 LM 缺失时「跳过本步、返回原文」为可接受的 fail-open 行为。
