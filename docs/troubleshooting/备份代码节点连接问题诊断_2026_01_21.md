# 备份代码节点连接问题诊断

**日期**: 2026-01-21 04:10  
**问题**: 调度服务器提示"节点连接不存在"  
**节点ID**: node-82FC8BCE

---

## 🔴 错误信息

```
WARN 节点 node-82FC8BCE 的连接不存在
WARN 本地直发失败，尝试跨实例投递 node_id=node-82FC8BCE
WARN 消息发送失败：无法解析节点所有者 node_id=node-82FC8BCE
WARN Failed to send job to node
  trace_id=b952dd8e-8b6a-439a-b9cd-55e3eee8c72c
  session_id=s-2640E5B7
  job_id=s-2640E5B7:89
  node_id=node-82FC8BCE
  utterance_index=9
```

---

## 🔍 问题分析

### 可能的原因

#### 1. WebSocket连接已断开

**症状**:
- 节点注册成功（有 node-82FC8BCE ID）
- 但WebSocket连接已断开
- 调度服务器尝试发送任务时找不到连接

**原因**:
- 网络不稳定
- 节点端重启但未重新注册
- WebSocket超时断开但未重连

---

#### 2. 端口配置不匹配

**检查结果**:
- 节点端配置: `ws://127.0.0.1:5010/ws/node` ✅
- 调度服务器配置: `port = 5010` ✅
- **端口匹配，不是配置问题**

---

#### 3. 节点端窗口关闭了

**可能情况**:
- Electron窗口被关闭
- 节点端进程结束
- WebSocket连接断开
- 但调度服务器仍认为节点在线

---

## ✅ 解决方案

### 方案1: 检查节点端是否运行（推荐）

#### 检查Electron窗口

**是否看到节点端窗口？**
- ✅ 窗口打开 → 检查连接状态
- ❌ 窗口关闭 → 重新启动节点端

**查看窗口状态**:
- 左上角是否显示 "已连接"？
- 节点ID是否显示为 `node-82FC8BCE`？

---

#### 重新启动节点端

```powershell
cd D:\Programs\github\lingua_1\expired\lingua_1-main\electron_node\electron-node
npm start
```

**预期**:
- Electron窗口打开
- 自动连接到调度服务器
- 显示 "已连接" 状态
- 获得新的节点ID或重用旧ID

---

### 方案2: 检查节点端日志

```powershell
# 查看最新日志
Get-ChildItem "D:\Programs\github\lingua_1\expired\lingua_1-main\electron_node\electron-node\logs" -Filter "*.log" | Sort-Object LastWriteTime -Descending | Select-Object -First 1 | Get-Content -Tail 50
```

**查找关键信息**:
- "Connected to scheduler server" → 连接成功
- "WebSocket error" / "Connection closed" → 连接断开
- "Node registered successfully" → 注册成功
- 最后一条日志的时间戳 → 判断进程是否还在运行

---

### 方案3: 检查WebSocket连接状态

#### 在节点端Electron窗口中

1. **按 `Ctrl+Shift+I` 打开开发者工具**
2. **切换到 Console 标签**
3. **输入**:
   ```javascript
   window.electronAPI.getNodeStatus()
   ```

**预期输出**:
```javascript
{
  connected: true,
  nodeId: "node-82FC8BCE",
  // ...
}
```

---

### 方案4: 强制重新连接

#### 在节点端窗口中

**如果有"重新连接"按钮**:
- 点击重新连接

**或者重启节点端**:
1. 关闭Electron窗口
2. 重新运行 `npm start`

---

## 🔧 调度服务器端操作

### 清理过期节点（如果节点确实已关闭）

**调度服务器会自动处理**:
- 心跳超时后自动移除节点
- 默认超时时间通常是 30-60 秒

**手动清理**（如果需要）:
- 通常调度服务器有自动清理机制
- 不需要手动干预

---

## 📊 诊断步骤

### 步骤1: 检查节点端进程

```powershell
# 检查是否有 Electron 进程
Get-Process electron -ErrorAction SilentlyContinue
```

**如果没有输出**:
- 节点端未运行
- 需要重新启动

---

### 步骤2: 查看节点端日志

```powershell
$logFile = Get-ChildItem "D:\Programs\github\lingua_1\expired\lingua_1-main\electron_node\electron-node\logs" -Filter "*.log" | Sort-Object LastWriteTime -Descending | Select-Object -First 1

Write-Host "日志文件: $($logFile.FullName)"
Write-Host "最后修改: $($logFile.LastWriteTime)"
Write-Host ""
Write-Host "最近10行:"
Get-Content $logFile.FullName -Tail 10
```

**检查**:
- 最后修改时间是否是最近（1分钟内）？
- 是否有 "Connected to scheduler" 日志？
- 是否有 "WebSocket error" 或 "Connection closed"？

---

### 步骤3: 测试WebSocket连接

```powershell
# 测试调度服务器WebSocket端口
Test-NetConnection localhost -Port 5010
```

**预期**:
```
TcpTestSucceeded : True
```

**如果失败**:
- 调度服务器未运行
- 或端口被占用

---

## 💡 常见情况

### 情况1: 节点端窗口被关闭了

**症状**:
- 调度服务器显示 "连接不存在"
- 找不到 Electron 进程
- 日志文件最后修改时间较早

**解决**:
```powershell
cd D:\Programs\github\lingua_1\expired\lingua_1-main\electron_node\electron-node
npm start
```

---

### 情况2: WebSocket连接断开但未重连

**症状**:
- Electron窗口打开
- 显示 "未连接" 或 "连接中"
- 日志显示 "Connection closed"

**解决**:
1. 检查网络连接
2. 重启节点端
3. 或在窗口中点击"重新连接"

---

### 情况3: 节点端白屏无法操作

**症状**:
- Electron窗口是白屏
- 无法看到连接状态
- 无法操作

**解决**:
- 参考之前的白屏修复方案
- 重新构建 renderer
- 确保 vite.config.ts 有 `base: './'`

---

## ⚠️ 重要说明

### WebSocket连接的生命周期

1. **节点端启动** → 连接到调度服务器
2. **注册成功** → 获得 node ID (如 node-82FC8BCE)
3. **保持连接** → 定期发送心跳
4. **连接断开** → 调度服务器标记节点离线
5. **心跳超时** → 调度服务器移除节点

### 当前问题

- 调度服务器尝试发送任务到 node-82FC8BCE
- 但找不到 WebSocket 连接
- **说明节点已注册但连接已断开**

---

## ✅ 立即执行的解决方案

### 最简单的方法

**重新启动节点端**:

```powershell
cd D:\Programs\github\lingua_1\expired\lingua_1-main\electron_node\electron-node
npm start
```

**预期**:
1. Electron窗口打开
2. 自动连接到调度服务器
3. 显示新的节点ID或重用ID
4. 显示 "已连接" 状态
5. 可以正常接收任务

---

### 然后在Web端重新开始任务

1. 打开浏览器访问 `http://localhost:9001/`
2. 开始新的语音识别任务
3. 观察是否还有连接错误

---

## 📋 检查清单

- [ ] 节点端Electron窗口是否打开？
- [ ] 窗口是否显示 "已连接"？
- [ ] 节点ID是否正确显示？
- [ ] 调度服务器是否运行？
- [ ] 端口 5010 是否可访问？
- [ ] 日志是否显示最近的活动？

---

**建议**: 最直接的解决方法是重新启动节点端，确保WebSocket连接处于活跃状态。
