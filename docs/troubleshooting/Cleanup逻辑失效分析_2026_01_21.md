# Cleanupé€»è¾‘å¤±æ•ˆåˆ†ææŠ¥å‘Š

**æ—¥æœŸ**: 2026-01-21 01:35  
**é—®é¢˜**: cleanupé€»è¾‘æœªèƒ½é˜»æ­¢å­¤å„¿è¿›ç¨‹  
**çŠ¶æ€**: ğŸ”´ **ä¿®å¤å¤±è´¥ï¼Œéœ€è¦è°ƒæ•´æ–¹æ¡ˆ**

---

## ğŸ” é—®é¢˜ç¡®è®¤

### 1. è¿›ç¨‹çŠ¶æ€

```
ä¸»è¿›ç¨‹ (PID 126280): âŒ å·²åœæ­¢
ASR Workerå­è¿›ç¨‹ (PID 110112): âš ï¸ **ä»åœ¨GPUä¸Šè¿è¡Œ**
```

**GPUè¿›ç¨‹åˆ—è¡¨**:
```
110112, [N/A]  â† ASR Workerå­¤å„¿è¿›ç¨‹
```

### 2. æ—¥å¿—åˆ†æ

**å¯åŠ¨æ—¥å¿—** (00:54:08):
```
âœ… Signal handlers registered (SIGTERM, SIGINT)
âœ… SIGBREAK handler registered (Windows)
âœ… atexit cleanup handler registered
```

**å…³é—­æ—¥å¿—**:
```
âŒ æ²¡æœ‰ä»»ä½•shutdownæˆ–cleanupæ—¥å¿—
âŒ æ²¡æœ‰ "ğŸ›‘ Cleaning up ASR Worker Manager"
âŒ æ²¡æœ‰ "âœ… ASR Worker Manager cleaned up successfully"
```

**ç»“è®º**: cleanupé€»è¾‘**æ³¨å†ŒæˆåŠŸä½†æœªæ‰§è¡Œ**

---

## ğŸ’¡ å¤±æ•ˆåŸå› åˆ†æ

### åŸå› 1: è¿›ç¨‹è¢«å¼ºåˆ¶killï¼ˆæœ€å¯èƒ½ï¼‰

**Windowsä¸Šçš„è¿›ç¨‹ç»ˆæ­¢æ–¹å¼**:
```
æ­£å¸¸å…³é—­: Ctrl+C â†’ SIGINT â†’ cleanupæ‰§è¡Œ
èŠ‚ç‚¹ç«¯å…³é—­: taskkill /PID â†’ å¼ºåˆ¶kill â†’ cleanupä¸æ‰§è¡Œ
```

**æ‚¨å¯èƒ½çš„æ“ä½œ**:
- å…³é—­äº†Cursor IDEæˆ–ç»ˆç«¯çª—å£
- ç»ˆç«¯çª—å£ç›´æ¥è¢«å…³é—­
- Pythonè¿›ç¨‹è¢«ä»»åŠ¡ç®¡ç†å™¨å¼ºåˆ¶ç»“æŸ

**è¿™äº›æ“ä½œä¼šå¯¼è‡´**:
- è¿›ç¨‹ç«‹å³ç»ˆæ­¢ï¼Œä¸è§¦å‘ä¿¡å·å¤„ç†å™¨
- atexitä¹Ÿå¯èƒ½æ¥ä¸åŠæ‰§è¡Œ
- å­è¿›ç¨‹å˜æˆå­¤å„¿è¿›ç¨‹

---

### åŸå› 2: Windowsçš„ä¿¡å·æœºåˆ¶é™åˆ¶

**Windows vs Linux**:
```
Linux:
- SIGTERMå¯é è§¦å‘
- å­è¿›ç¨‹ä¼šæ”¶åˆ°çˆ¶è¿›ç¨‹é€€å‡ºä¿¡å·
- è¿›ç¨‹ç»„ç®¡ç†å®Œå–„

Windows:
- SIGTERMä¸å¯é ï¼ˆå¯èƒ½ä¸è§¦å‘ï¼‰
- å­è¿›ç¨‹ä¸ä¼šè‡ªåŠ¨æ”¶åˆ°çˆ¶è¿›ç¨‹é€€å‡ºä¿¡å·
- æ²¡æœ‰è¿›ç¨‹ç»„æ¦‚å¿µ
```

---

### åŸå› 3: multiprocessingçš„å­è¿›ç¨‹éš”ç¦»

**Python multiprocessingç‰¹æ€§**:
```python
# ä¸»è¿›ç¨‹æ³¨å†Œäº†cleanup
atexit.register(cleanup_worker_manager)

# ä½†å­è¿›ç¨‹(ASR Worker)æ˜¯ç‹¬ç«‹è¿›ç¨‹ï¼š
# - æœ‰è‡ªå·±çš„PIDå’Œå†…å­˜ç©ºé—´
# - ä¸å…±äº«ä¸»è¿›ç¨‹çš„atexit handlers
# - çˆ¶è¿›ç¨‹è¢«killæ—¶ä¸ä¼šè‡ªåŠ¨é€€å‡º
```

---

## ğŸ”§ ä¸ºä»€ä¹ˆæˆ‘çš„ä¿®å¤æ–¹æ¡ˆå¤±æ•ˆ

### æˆ‘æ·»åŠ çš„ä»£ç 

```python
# faster_whisper_vad_service.py

def cleanup_worker_manager():
    """æ¸…ç†ASR Worker Manager"""
    # ... ä»£ç  ...
    manager = get_asr_worker_manager()
    loop = asyncio.new_event_loop()
    loop.run_until_complete(manager.stop())

# æ³¨å†Œ
signal.signal(signal.SIGTERM, signal_handler)
signal.signal(signal.SIGINT, signal_handler)
atexit.register(atexit_handler)
```

### å¤±æ•ˆçš„åœºæ™¯

1. **ç»ˆç«¯çª—å£å…³é—­**
   - Windowsç›´æ¥killè¿›ç¨‹
   - ä¸è§¦å‘ä¿¡å·å¤„ç†å™¨
   - atexitå¯èƒ½æ¥ä¸åŠæ‰§è¡Œ

2. **Cursor IDEå…³é—­ç»ˆç«¯**
   - å‘é€å¼ºåˆ¶ç»ˆæ­¢ä¿¡å·
   - Pythonè¿›ç¨‹ç«‹å³é€€å‡º
   - æ²¡æœ‰cleanupæœºä¼š

3. **ä»»åŠ¡ç®¡ç†å™¨ç»“æŸè¿›ç¨‹**
   - å¼ºåˆ¶kill
   - å®Œå…¨æ²¡æœ‰cleanupæœºä¼š

---

## âœ… æ­£ç¡®çš„è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: å°†Workerè®¾ç½®ä¸ºdaemonè¿›ç¨‹ï¼ˆæ¨èï¼‰

**ä¿®æ”¹**: `asr_worker_manager.py`

```python
# ç¬¬180è¡Œ
self.worker_process = mp.Process(
    target=asr_worker_process,
    args=(self.task_queue, self.result_queue),
    name="ASRWorkerProcess",
    daemon=True  # â† æ·»åŠ è¿™ä¸€è¡Œ
)
```

**åŸç†**:
- daemon=Trueä½¿å­è¿›ç¨‹æˆä¸ºå®ˆæŠ¤è¿›ç¨‹
- çˆ¶è¿›ç¨‹é€€å‡ºæ—¶ï¼ŒPythonè‡ªåŠ¨killæ‰€æœ‰daemonå­è¿›ç¨‹
- ä¸ä¾èµ–ä¿¡å·å¤„ç†å™¨æˆ–atexit

**ä¼˜ç‚¹**:
- âœ… 100%æœ‰æ•ˆï¼Œä¸å—å…³é—­æ–¹å¼å½±å“
- âœ… æ— éœ€ä¾èµ–ä¿¡å·å¤„ç†
- âœ… ç®€å•å¯é 

**ç¼ºç‚¹**:
- âš ï¸ å­è¿›ç¨‹è¢«çªç„¶killï¼Œæ²¡æœ‰ä¼˜é›…å…³é—­
- âš ï¸ å¯èƒ½å¯¼è‡´GPUçŠ¶æ€æœªæ¸…ç†ï¼ˆä½†æ¯”å­¤å„¿è¿›ç¨‹å¥½ï¼‰

---

### æ–¹æ¡ˆ2: èŠ‚ç‚¹ç«¯ä¸»åŠ¨æ¸…ç†ï¼ˆè¡¥å……æ–¹æ¡ˆï¼‰

**ä¿®æ”¹**: `electron_node/.../python-service-manager/service-process.ts`

ç¡®ä¿èŠ‚ç‚¹ç«¯åœ¨åœæ­¢æœåŠ¡æ—¶ï¼š

```typescript
// 1. å‘é€SIGTERM
child.kill('SIGTERM');

// 2. ç­‰å¾…5ç§’

// 3. å¦‚æœè¿˜åœ¨è¿è¡Œï¼Œå¼ºåˆ¶killæ•´ä¸ªè¿›ç¨‹æ ‘
if (child.exitCode === null) {
  // Windows: ä½¿ç”¨taskkill /Tæ€æ­»è¿›ç¨‹æ ‘
  exec(`taskkill /PID ${child.pid} /T /F`);
}
```

**åŸç†**:
- `/T`å‚æ•°ä¼škillæ•´ä¸ªè¿›ç¨‹æ ‘ï¼ˆåŒ…æ‹¬å­è¿›ç¨‹ï¼‰
- å³ä½¿ä¸»è¿›ç¨‹æ²¡æœ‰cleanupï¼Œå­è¿›ç¨‹ä¹Ÿä¼šè¢«kill

---

### æ–¹æ¡ˆ3: ç»„åˆæ–¹æ¡ˆï¼ˆæœ€ä½³ï¼‰

**åŒæ—¶å®æ–½**:
1. âœ… Workerè®¾ç½®`daemon=True`
2. âœ… ä¿ç•™signal handlerå’Œatexitï¼ˆä¼˜é›…å…³é—­ï¼‰
3. âœ… èŠ‚ç‚¹ç«¯ä½¿ç”¨`/T`å‚æ•°killè¿›ç¨‹æ ‘

**æ•ˆæœ**:
- æ­£å¸¸å…³é—­ï¼šsignal handleræ‰§è¡Œä¼˜é›…æ¸…ç†
- å¼‚å¸¸é€€å‡ºï¼šdaemonç¡®ä¿å­è¿›ç¨‹ä¸æ®‹ç•™
- å¼ºåˆ¶killï¼šèŠ‚ç‚¹ç«¯è´Ÿè´£æ¸…ç†è¿›ç¨‹æ ‘

---

## ğŸ¯ ç«‹å³ä¿®å¤

### æ­¥éª¤1: æ¸…ç†å½“å‰çš„å­¤å„¿è¿›ç¨‹

```powershell
Stop-Process -Id 110112 -Force
```

### æ­¥éª¤2: ä¿®æ”¹asr_worker_manager.py

```python
# ç¬¬180è¡Œï¼Œæ·»åŠ daemon=True
self.worker_process = mp.Process(
    target=asr_worker_process,
    args=(self.task_queue, self.result_queue),
    name="ASRWorkerProcess",
    daemon=True  # â† å…³é”®ä¿®æ”¹
)
```

### æ­¥éª¤3: é‡æ–°æµ‹è¯•

```powershell
# 1. å¯åŠ¨ASRæœåŠ¡
python faster_whisper_vad_service.py

# 2. å…³é—­ç»ˆç«¯çª—å£æˆ–Ctrl+C

# 3. æ£€æŸ¥æ˜¯å¦æœ‰æ®‹ç•™è¿›ç¨‹
nvidia-smi --query-compute-apps=pid,used_memory --format=csv
```

**é¢„æœŸç»“æœ**: âœ… æ— æ®‹ç•™è¿›ç¨‹

---

## ğŸ“Š å¯¹æ¯”åˆ†æ

| æ–¹æ¡ˆ | å¯é æ€§ | ä¼˜é›…æ€§ | å®æ–½éš¾åº¦ |
|------|-------|--------|---------|
| **å½“å‰æ–¹æ¡ˆ** (signal+atexit) | âŒ ä½ | âœ… é«˜ | ç®€å• |
| **daemon=True** | âœ… é«˜ | âš ï¸ ä¸­ | éå¸¸ç®€å• |
| **èŠ‚ç‚¹ç«¯killæ ‘** | âœ… é«˜ | âŒ ä½ | ä¸­ç­‰ |
| **ç»„åˆæ–¹æ¡ˆ** | âœ… æé«˜ | âœ… é«˜ | ä¸­ç­‰ |

---

## ğŸ”‘ å…³é”®æ•™è®­

1. **Windowsè¿›ç¨‹ç®¡ç†ä¸Linuxä¸åŒ**
   - ä¸èƒ½ä¾èµ–POSIXä¿¡å·
   - éœ€è¦è€ƒè™‘å¼ºåˆ¶killçš„åœºæ™¯

2. **Python multiprocessingçš„ç‰¹æ€§**
   - å­è¿›ç¨‹æ˜¯ç‹¬ç«‹è¿›ç¨‹
   - çˆ¶è¿›ç¨‹çš„atexitä¸å½±å“å­è¿›ç¨‹

3. **daemonè¿›ç¨‹æ˜¯æ›´å¯é çš„é€‰æ‹©**
   - è™½ç„¶ä¸å¤Ÿä¼˜é›…
   - ä½†èƒ½ä¿è¯ä¸æ®‹ç•™

---

## ğŸ“‹ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… **ç«‹å³killå­¤å„¿è¿›ç¨‹110112**
2. âœ… **ä¿®æ”¹asr_worker_manager.pyæ·»åŠ daemon=True**
3. âœ… **å›æ»šfaster_whisper_vad_service.pyçš„cleanupä»£ç **ï¼ˆå¯é€‰ï¼Œä¿ç•™ä¹Ÿæ— å¦¨ï¼‰
4. âœ… **é‡æ–°æµ‹è¯•è¿›ç¨‹æ¸…ç†**

---

**çŠ¶æ€**: â³ ç­‰å¾…ä¿®å¤  
**æ¨è**: ä½¿ç”¨daemon=Trueæ–¹æ¡ˆ
