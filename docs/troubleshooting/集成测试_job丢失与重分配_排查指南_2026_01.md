# 集成测试：Job 丢失与「不停重分配」排查指南（2026-01）

**现象**：返回结果只有 [0]、[2]，job 2 前半句丢失，之后无任何 job 返回；调度器终端显示每个 job 都在不停地被重分配。

---

## 一、先确认：是调度器无法分配，还是节点无法处理？

| 情况 | 调度器侧表现 | 节点端表现 | 结论 |
|------|-------------|-----------|------|
| **调度器无法把 job 分给节点** | Job 从未成功派发：终端出现 **「Job pending 超时」** 或 **NO_AVAILABLE_NODE**、**「无法解析节点所有者」**。不会出现「Job failover 重派成功下发」。 | 节点日志里**收不到**或只收到很少的 `job_assign`；对应 utterance_index 的 ASR/聚合/NMT 等日志缺失。 | 问题在**调度侧**：选不到节点或消息发不出去。 |
| **节点收到了但没在规定时间内完成/回报** | Job 已派发：终端反复出现 **「Job dispatched 超时，尝试 cancel + failover」**、**「Job failover 重派成功下发」**。同一 job 被多次重派到（可能不同）节点。 | 节点日志里**能收到**多次 `job_assign`（同一 job_id 可能被 cancel 后又重派）；有 ASR/聚合等处理日志，但调度器在超时前没收到 job_result。 | 问题在**节点侧**：处理太慢、崩溃或未正确回传结果。 |

**操作建议**：看调度器终端最近几屏输出。

- 若以 **「Job pending 超时」** 为主 → 偏向**调度器无法分配**（无可用节点或路由失败）。
- 若以 **「Job dispatched 超时，尝试 cancel + failover」**、**「Job failover 重派成功下发」** 为主 → 偏向**节点无法在规定时间内完成/回报**。

---

## 二、节点端日志：每个 job 在各服务中的处理过程

在**项目根目录**（即包含 `scripts` 的 `lingua_1` 目录）执行：

```powershell
# 默认分析 utterance_index = 0,2,5,7,9；若需覆盖你本次的 0,1,2,3... 可指定
.\scripts\analyze_job_processing.ps1 -NodeLogPath "electron_node\electron-node\logs\electron-main.log" -UtteranceIndices @(0,1,2,3,4,5,6,7,8,9) -Lines 8000
```

- `-NodeLogPath`：你的节点端主进程日志路径（相对项目根）。
- `-UtteranceIndices`：要分析的 utterance 下标，按你本次测试覆盖的句数改。
- `-Lines`：从日志末尾往前读的行数，日志大时可适当加大。

脚本会按每个 utterance_index 输出：

1. **AudioAggregator**：输入音频时长、是否 Buffer not found、段数等。
2. **音频质量**：RMS、是否「Audio quality too low」被拒。
3. **ASR**：输入时长/大小、输出 asrText。
4. **Aggregation**：action（NEW_STREAM/MERGE）、聚合文本。
5. **NMT**：输入文本、翻译输出。
6. **最终结果**：textAsr、textTranslated。

据此可判断：某个 job 是**没到节点**（无对应日志）、**在节点被拒**（如 RMS 拒绝）、**在节点被合并未发出**（如 shouldWaitForMerge）、还是**NMT/TTS 空**等。

---

## 三、结合你本次现象的可查点

1. **Job 2 前半句丢失**  
   在节点日志里搜该 job 的 `utterance_index`（例如 2）和对应 `job_id`：看 ASR 输入是否只有后半段、是否被 MaxDuration/Timeout 提前截断、或 Aggregation 是否把前半句合到上一 job 且本 job 以空/短句发出。

2. **之后没有任何 job 返回**  
   - **若是调度器无法分配**：节点日志里 3、4、5… 的 job_assign 很少或没有；调度器终端会有「Job pending 超时」或 NO_AVAILABLE_NODE。  
   - **若是节点无法处理**：节点日志里能看到 3、4、5… 的 job_assign 与 ASR/聚合等，但调度器侧一直「Job dispatched 超时」+ failover；需看节点是否处理过慢、报错、或未把 job_result 发回。

3. **调度器「不停重分配」**  
   即 job 已派发 → 超时 → cancel → 选新节点 → 再派发 → 再超时…。说明**调度器能选到节点并能下发**，但**未在超时内收到结果**，多为**节点处理/回传**问题；再结合上面节点日志确认是哪一阶段慢或失败。

---

## 四、参考

- 节点端各 job 输入/输出分析脚本：`scripts/analyze_job_processing.ps1`  
- 类似案例（job 3–6 丢失、RMS/前向合并）：`electron_node/electron-node/logs/docs/asr_performance/JOB_3_6_LOSS_ANALYSIS_S743C998D_2026_01.md`  
- 调度器 job 超时与 failover：`central_server/scheduler/src/timeout/job_timeout.rs`
