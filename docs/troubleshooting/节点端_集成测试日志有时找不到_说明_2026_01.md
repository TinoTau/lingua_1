# 节点端：集成测试日志「有时有、有时没有」说明（2026-01）

**现象**：集成测试总是一次有日志、一次没日志，不知道日志到底写到哪里去了。

---

## 一、原因归纳

| 原因 | 说明 | 如何确认 |
|------|------|----------|
| **1. 清缓存脚本删除了日志** | `electron_node/electron-node/scripts/clear-cache.ps1` 第 4 步会**删除** `logs` 目录下所有 `*.log`。若在测试前后跑过清缓存，`electron-main.log` 会被删掉。 | 回忆是否执行过 `clear-cache.ps1` 或包含它的流程。 |
| **2. 测试环境写的是另一个文件** | 当 `NODE_ENV=test` 或 Jest 子进程（`JEST_WORKER_ID` 有值）时，主进程 logger 写的是 **`electron-main.test.log`**，不是 `electron-main.log`。 | 若用 `npm test` / Jest 跑集成相关用例，到 `logs/electron-main.test.log` 找。 |
| **3. 启动目录不同导致路径不同** | 日志目录由 **findProjectRoot(__dirname)** 决定，一般等于「electron-node 项目根」下的 `logs/`。若打包或特殊启动导致找不到项目根，会回退到 **process.cwd()**，日志会写到「当前工作目录/logs/」。 | 看**启动时控制台**第一屏 `[Logger] Log file: ...`，以该路径为准。 |
| **4. 上一轮进程仍占用日志文件** | 若上一轮 Electron/Node 未退出仍占用 `electron-main.log`，**当前逻辑下进程会直接启动失败**（打开日志文件失败即退出），不会静默切到「仅控制台」。结束残留进程后再启动即可。 | 启动时报错（如 EACCES、文件被占用）或进程立即退出 → 到任务管理器结束残留 Electron/Node 进程后重试。 |

---

## 二、建议做法

1. **每次关窗后确认进程已退出**  
   - 关掉节点端窗口后，到**任务管理器**确认没有残留的 **Electron** 或 **Node** 进程。  
   - 关窗**不会**自动退出，需在运行节点的终端按 **Ctrl+C** 退出，或手动结束进程。若有残留且未结束就再次启动，新进程会因打不开日志文件而**直接退出**。

2. **启动时看控制台**  
   - 主进程启动时会打印 `[Logger] Log file: ...`，即本次写入的日志文件路径。  
   - 若启动失败（报错或立即退出），多半是上一轮进程仍占用该文件，结束残留进程后重试。

3. **要做集成测试、需要保留日志时**  
   - 跑完测试后**不要**再执行 clear-cache，或先**复制** `logs/electron-main.log` 到别处再清。

4. **区分「界面集成测试」和「Jest 集成测试」**  
   - **界面集成测试**（npm start 后用人声/界面操作）：日志在 **`electron-main.log`**。  
   - **Jest 里跑集成**：可能写 **`electron-main.test.log`**，到该文件查看。

---

## 三、clear-cache.ps1 与日志

- **设计意图**：清缓存**同时清理日志**是正确的——每次集成测试**之前**执行 clear-cache，可统一清理代码与日志，确保当次测试结果不受旧代码/旧日志干扰。  
- **当前行为**：`clear-cache.ps1` 第 4 步会删除项目根下 `logs` 目录中的全部 `*.log`。  
- **若需保留当次测试日志**：跑完集成测试、需要分析日志时，**不要再执行** clear-cache；或先复制 `logs/electron-main.log` 到别处再清缓存。

---

**参考**：节点端日志路径逻辑见 `electron_node/electron-node/main/src/logger.ts`（findProjectRoot、isTestEnv、logFile）。
