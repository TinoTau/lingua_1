# NMT 哨兵序列（Sentinel Sequence）设计与落地方案

## 1. 背景与问题说明

在当前 NMT（如 Marian / M2M100）增量翻译架构中，系统通过在 **上下文文本（context）** 与 **当前输入文本（current）** 之间插入分隔符，用于在翻译结果中定位并提取“当前句翻译结果”。

### 1.1 现存问题

- 现有分隔符（如 `^^`）**经常被 NMT 模型忽略、吞掉或替换为空格**
- 导致：
  - 无法定位 current translation
  - 返回空字符串
  - TTS 阶段无音频输出（级联故障）

该问题并非实现 Bug，而是 **NMT 在生成阶段的概率行为** 所致。

---

## 2. 设计目标

本方案的目标并非“强制 NMT 识别分隔符语义”，而是：

1. **显著提高分隔标记被原样保留的概率**
2. 在不修改模型、不新增词表、不重新导出 ONNX 的前提下落地
3. 与现有 fallback / 对齐切割机制完全兼容
4. 明确其概率性边界，避免被误用为唯一依赖

---

## 3. 哨兵序列（Sentinel Sequence）定义

### 3.1 定义

**哨兵序列（Sentinel Sequence）** 是一段：

- 非自然语言
- 非常规 Unicode
- 结构完整
- 长度足够

的特殊字符序列，用于在 NMT 翻译结果中作为“高保留概率锚点（anchor）”。

其目标是：

> 让 NMT 更倾向于“原样拷贝该序列”，而不是尝试翻译或删除它。

---

## 4. 哨兵序列的设计原则（核心）

### 4.1 原则一：低语言相似性（Out-of-Distribution）

- 不应像任何自然语言单词
- 不应像常见标点（`, . : ; - ^ *` 等）
- 不应像数学 / 编程符号

**原因**：
模型若“看不懂”，更可能选择复制而不是替换。

---

### 4.2 原则二：足够长度（推荐 ≥ 6–12 字符）

- 过短序列（如 `^^`）极易被吞掉
- 中等长度序列在 beam search 中更容易整体保留

---

### 4.3 原则三：结构完整性（成对 / 对称）

推荐使用：

- 左右成对符号
- 视觉上明确的“块结构”

**原因**：
- 模型更容易把其视为一个不可分割的整体
- 降低“删一半 / 合并为空格”的概率

---

### 4.4 原则四：与正文强区隔

- 哨兵左右必须加空格
- 不得紧贴自然语言 token

示意：
```
<CONTEXT_TEXT> ⟪⟪SENTINEL⟫⟫ <CURRENT_TEXT>
```

---

## 5. 推荐实现方式（工程落地）

### 5.1 哨兵序列形态（示意，不强制）

> 实际字符由实现方选择，下列仅用于说明结构特征

- 包含非常规 Unicode 括号
- 包含固定字母标识
- 长度 ≥ 8 字符

例如（示意）：

```
 ⟪⟪SEP_MARKER⟫⟫ 
```

⚠️ 注意：
- 不要求模型“理解”该标记
- 只依赖其被 **原样输出**

---

### 5.2 哨兵 + 多候选匹配策略

在提取阶段：

- 主哨兵：规范形态
- 候选变体：
  - 空格缺失
  - 全角/半角差异
  - Unicode normalization 后的等价形式

匹配前建议：
- 对翻译结果与哨兵统一做 normalization

---

## 6. 系统集成策略（强烈建议）

### 6.1 正确定位哨兵的角色

> 哨兵序列是 **Fast Path Hint**，而不是 **Correctness Guarantee**。

因此必须与 fallback 机制共存。

---

### 6.2 推荐三段式提取流程

1. **哨兵序列提取（优先）**
   - 成功：快速、低成本、高置信度

2. **上下文翻译对齐切割（Fallback）**
   - 使用 context_translation 在 full_translation 中定位
   - 清理重复与重叠

3. **最终不为空兜底**
   - current-only translation 或 full translation
   - 禁止返回空字符串

---

## 7. 可观测性与质量标记（必须）

建议在结果中附带：

```json
{
  "extraction_mode": "SENTINEL | ALIGN_FALLBACK | SINGLE_ONLY | FULL_ONLY",
  "extraction_confidence": "HIGH | MEDIUM | LOW"
}
```

用于：
- 线上质量监控
- 回退比例统计
- 后续优化决策

---

## 8. 风险与边界说明（必须告知）

- 哨兵序列 **不能 100% 防止** 被吞掉
- 在极短句 / 高频口语 / 特定语言下仍可能失败

因此：

> **任何情况下都不得以“哨兵必然存在”为系统假设**

---

## 9. 验收标准（建议写入测试）

1. 任意输入场景下：
   - 提取结果不得为空字符串
2. 指定失败样例回归：
   - 哨兵提取成功率显著高于 `^^`
3. extraction_mode 指标可观测

---

## 10. 总结

- 哨兵序列是概率增强手段，而非银弹
- 能显著降低分隔符被吞掉的概率
- 必须与 fallback / 不为空兜底机制配合

**在不改模型的前提下，这是当前最稳妥、可交付、可演