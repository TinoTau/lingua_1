# 会议室模式（Room）
## 需求细节与整体架构设计（冻结版）

> 本文档用于向开发部门明确 **会议室模式的业务需求、核心概念与架构边界**。
> 本版本为冻结版，不涉及具体代码实现，仅用于指导后续调度服务器与节点端的正确演进方向。

---

## 1. 设计目标

构建一个支持 **多用户、多语言实时交流** 的会议室（Room）系统，满足：

- 同一会议室中可同时存在多种语言
- 每个用户在任一时刻 **只能说 / 听一种语言**
- 用户允许在运行过程中 **动态切换语言**（对后续发言生效）
- 调度服务器作为唯一的 **语言路由与任务 fan-out 中心**
- 节点端只处理 **单 Job、单语言对**，不感知会议室整体状态

明确不做：
- 客户端直连翻译节点
- 节点端多语言 fan-out
- 节点端语言可用性兜底
- session / room 级 buffer 扫描与聚合

---

## 2. 核心概念定义

### 2.1 Room（会议室）

- 由调度服务器创建与维护
- 是语言路由与用户管理的语义边界

```ts
Room {
  roomId
  state: ACTIVE | CLOSED
  users: Map<userId, UserState>
}
```

---

### 2.2 User（用户）

```ts
UserState {
  userId
  activeLanguage        // 当前说/听的语言
  languageReady         // 该语言是否有可用 Node Pool
}
```

约束：
- activeLanguage 任一时刻只能有一个
- 用户语言切换是调度层事件，不影响已派发 Job

---

### 2.3 Job（调度作业，最小调度单位）

> **Job 是调度服务器分配任务的最小单位，而不是 chunk。**

```ts
Job {
  jobId
  roomId
  speakerUserId
  sourceLanguage
  targetLanguage
  turnId                // 所属发言容器
  segmentIndex          // turn 内的分段序号
}
```

语义约定：
- 一个 Job = 单个用户的一次发言片段 × 一个翻译方向
- 一个 Job 内可能包含多个音频 chunk
- Job 之间互相独立，失败互不影响

---

## 3. 发言（Turn）与 Job 切分规则

### 3.1 Turn（一次发言容器）

- Turn 表示用户一次连续发言的语义容器
- 一个 Turn 可包含多个连续 Job

```ts
Turn {
  turnId
  roomId
  speakerUserId
}
```

---

### 3.2 Turn 的开始与结束

Turn 开始：
- 用户开始送音频（push-to-talk / VAD speaking_start）

Turn 结束条件（满足任一即可）：
- 手动截断
- 静音 ≥ 3 秒
- 用户断线 / 离开房间

---

### 3.3 Job 的切分规则

- 在同一个 Turn 内：
  - 每累计音频 ≥ 10 秒，强制切分为新的 Job
  - 新 Job 共享同一个 turnId
  - segmentIndex 递增
- Turn 未结束时，切分不会创建新 turnId

---

## 4. 多人抢话与插话处理

- 每个 speaker 在 Room 内拥有 **独立的 activeTurnId**
- 用户 B 插话不会自动结束用户 A 的 turn
- 是否结束 turn 只由 **静音 / 手动结束 / 断线** 决定

效果：
- A 的 Job 序列与 B 的 Job 序列通过 turnId 完全隔离
- 不依赖“连续 job”或“按 userId 猜测”来拼接发言

---

## 5. 多语言路由与翻译 fan-out

### 5.1 用户发言时的目标语言计算

```text
目标语言集合 =
  Room.users
    .filter(user.activeLanguage != sourceLanguage)
    .map(user.activeLanguage)
    .unique()
```

---

### 5.2 Job fan-out 规则

- 每个 (sourceLang → targetLang) 创建独立 Job
- 若无对应 Node Pool：
  - 不创建 Job
  - 在语言选择阶段已提前提示用户

---

## 6. EN → EN 的处理（会议室模式）

- EN → EN 不进入翻译节点
- 原文音频通过 WebRTC 直传
- 翻译音频到达后 Web 端切换播放

目的：
- 提升实时体验
- 对短反馈（yes / ok）快速响应

---

## 7. 节点分配与隐私原则

- 节点分配以 **Job 生命周期** 为边界
- 每个 Job 随机选择节点
- 不做 Room/User → Node 的长期绑定
- 节点端不保存房间成员表或用户偏好

---

## 8. bufferKey 的最终定义（节点端）

> **bufferKey = jobId（或其不可逆映射）**

说明：
- bufferKey 仅用于节点端 Audio Aggregator 的内部聚合
- bufferKey 不包含 roomId / userId / language 等业务语义
- 所有聚合、清理、状态查询均按 bufferKey 精确操作

---

## 9. 架构总结

- 复杂度集中在调度服务器
- 节点端保持最小职责与单路径控制流
- turnId 解决多人抢话与连续 Job 拼接问题
- bufferKey 与 Job 语义对齐，避免未来补丁

---

## 10. 冻结结论

本设计在不增加节点端控制流复杂度的前提下，
能够稳定支持多用户、多语言、多人插话的会议室场景，
可作为后续开发的唯一参考架构文档。

