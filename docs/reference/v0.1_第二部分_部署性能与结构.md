# Lingua 项目架构与技术报告（第二部分：部署、性能与结构）

**生成日期**: 2025-01-27  
**项目版本**: v0.1.0  
**报告版本**: 1.0

> **注意**: 这是报告的第二部分，包含部署架构、性能指标、项目结构、技术亮点、已知问题、开发维护等内容。  
> 完整报告还包括：[第一部分：概述、架构与技术](./v0.1_第一部分_概述架构与技术.md)

---

## 目录

7. [部署架构](#7-部署架构)
8. [性能指标](#8-性能指标)
9. [项目结构](#9-项目结构)
10. [技术亮点](#10-技术亮点)
11. [已知问题与限制](#11-已知问题与限制)
12. [开发与维护](#12-开发与维护)
13. [相关文档](#13-相关文档)
14. [版本历史](#14-版本历史)
15. [联系方式](#15-联系方式)

---

## 7. 部署架构

### 7.1 服务部署

```
┌─────────────────────────────────────────┐
│         Windows 主系统                   │
│                                         │
│  ┌───────────────────────────────────┐ │
│  │  CoreEngine Service (Rust)        │ │
│  │  Port: 5009                       │ │
│  │  GPU: CUDA 12.4                   │ │
│  └───────────────────────────────────┘ │
│                                         │
│  ┌───────────────────────────────────┐ │
│  │  NMT Service (Python)             │ │
│  │  Port: 5008                       │ │
│  │  GPU: PyTorch CUDA 12.1           │ │
│  └───────────────────────────────────┘ │
│                                         │
└─────────────────────────────────────────┘
              │
              │ WSL2
              ▼
┌─────────────────────────────────────────┐
│         WSL2 (Ubuntu)                   │
│                                         │
│  ┌───────────────────────────────────┐ │
│  │  TTS Service (Piper HTTP)         │ │
│  │  Port: 5005                       │ │
│  │  GPU: 未启用                      │ │
│  └───────────────────────────────────┘ │
│                                         │
└─────────────────────────────────────────┘
```

### 7.2 配置文件

**主配置**: `lingua_core_config.toml`

```toml
[nmt]
url = "http://127.0.0.1:5008"

[tts]
url = "http://127.0.0.1:5005/tts"

[asr]
url = "http://127.0.0.1:6006"

[engine]
port = 5009
whisper_model_path = "models/asr/whisper-base"
silero_vad_model_path = "models/vad/silero/silero_vad_official.onnx"
```

### 7.3 启动脚本

**一键启动**: `start_all_services_simple.ps1`  
**一键停止**: `stop_all_services.ps1`

**启动流程**:
1. 设置 CUDA 环境变量
2. 启动 NMT 服务（Python）
3. 启动 CoreEngine（Rust）
4. 验证服务健康状态

---

## 8. 性能指标

### 8.1 GPU 加速效果

| 组件 | CPU 耗时 | GPU 耗时 | 提升倍数 |
|------|---------|---------|---------|
| ASR (Whisper) | 6-7 秒 | 1-2 秒 | 3-4x |
| NMT (M2M100) | 3-4 秒 | 0.5-1 秒 | 3-4x |
| **端到端总计** | **13-15 秒** | **4.5-7 秒** | **2-3x** |

### 8.2 系统要求

**最低要求**:
- CPU: 4 核以上
- 内存: 8 GB
- 存储: 5 GB（模型文件）
- GPU: NVIDIA GPU（可选，但强烈推荐）

**推荐配置**:
- CPU: 8 核以上
- 内存: 16 GB
- 存储: 10 GB（模型文件）
- GPU: NVIDIA RTX 3060 或更高

### 8.3 延迟指标

- **ASR 延迟**: 1-2 秒（GPU）
- **NMT 延迟**: 0.5-1 秒（GPU）
- **TTS 延迟**: 0.5-1 秒
- **端到端延迟**: 4.5-7 秒（GPU）

---

## 9. 项目结构

```
lingua/
├── core/
│   ├── engine/                    # 核心引擎 (Rust)
│   │   ├── src/                   # 源代码
│   │   │   ├── bootstrap/         # 核心引擎启动
│   │   │   ├── asr_whisper/       # ASR 模块
│   │   │   ├── nmt_incremental/   # NMT 模块
│   │   │   ├── tts_streaming/     # TTS 模块
│   │   │   ├── emotion_adapter/   # 情感分析
│   │   │   ├── persona_adapter/   # 个性化适配
│   │   │   ├── vad/               # VAD 模块
│   │   │   └── ...                # 其他模块
│   │   ├── models/                # 模型文件
│   │   │   ├── asr/               # ASR 模型
│   │   │   ├── nmt/               # NMT 模型
│   │   │   ├── tts/               # TTS 模型
│   │   │   ├── vad/               # VAD 模型
│   │   │   └── emotion/           # Emotion 模型
│   │   ├── Cargo.toml             # Rust 依赖
│   │   └── docs/                  # 文档
│   └── bindings/                  # 绑定（WASM 等）
│
├── services/
│   └── nmt_m2m100/                # NMT 服务 (Python)
│       ├── nmt_service.py         # FastAPI 服务
│       ├── requirements.txt       # Python 依赖
│       └── venv/                  # 虚拟环境
│
├── clients/                       # 客户端
│   ├── chrome_extension/          # Chrome 扩展
│   ├── electron/                  # Electron 应用
│   ├── mobile/                    # 移动端
│   └── web_pwa/                   # Web PWA
│
├── docs/                          # 文档
│   ├── architecture/              # 架构文档
│   ├── operational/               # 运维文档
│   ├── models/                    # 模型文档
│   └── product/                   # 产品文档
│
├── scripts/                       # 脚本工具
│   ├── *.ps1                      # PowerShell 脚本
│   └── *.py                       # Python 脚本
│
├── third_party/                   # 第三方库
│   ├── whisper.cpp/               # Whisper C++ 实现
│   ├── piper/                     # Piper TTS
│   └── esaxx-rs/                  # 补丁库
│
├── config.toml                    # 配置文件
├── lingua_core_config.toml        # 核心配置
├── start_all_services_simple.ps1  # 一键启动脚本
└── stop_all_services.ps1          # 一键停止脚本
```

---

## 10. 技术亮点

### 10.1 架构设计

- ✅ **模块化设计**: 各组件通过 Trait 接口解耦，易于替换和测试
- ✅ **事件驱动**: 通过 EventBus 实现模块间异步通信
- ✅ **微服务架构**: 核心服务与客户端分离，支持多端接入

### 10.2 性能优化

- ✅ **GPU 加速**: ASR 和 NMT 支持 CUDA GPU 加速，性能提升 3-4 倍
- ✅ **KV Cache**: NMT 模块使用 KV Cache 优化，减少重复计算
- ✅ **增量处理**: 支持增量翻译和增量语音合成，降低延迟

### 10.3 技术选型

- ✅ **Rust**: 核心引擎使用 Rust，保证性能和安全性
- ✅ **ONNX Runtime**: 统一的模型推理框架，支持多模型
- ✅ **流式处理**: 支持实时流式处理，提升用户体验

---

## 11. 已知问题与限制

### 11.1 当前问题

1. **Emotion 模块**: 存在 ONNX IR 版本兼容性问题（需要 IR ≤ 9，但部分模型为 IR 10）
2. **TTS GPU 加速**: 暂未启用 GPU 加速
3. **WSL2 依赖**: 中文 TTS 依赖 WSL2 环境，增加部署复杂度

### 11.2 技术债务

1. **ONNX Runtime 版本锁定**: 当前使用 ort 1.16.3（仅支持 IR ≤ 9），限制了可用的模型版本
2. **Windows 链接器问题**: 已通过修改 esaxx-rs 解决，但需要维护本地补丁

### 11.3 待完成功能

- ⚠️ WASM 构建（浏览器集成）
- ⚠️ Chrome 扩展完整集成
- ⚠️ 移动端应用开发
- ⚠️ 更多语言对支持

---

## 12. 开发与维护

### 12.1 开发环境

- **操作系统**: Windows 10/11
- **Rust**: Edition 2021
- **Python**: 3.10+
- **CUDA**: 12.4 (ASR), 12.1 (NMT)
- **IDE**: Visual Studio Code / Cursor

### 12.2 构建命令

```powershell
# 编译核心引擎（Release）
cd core/engine
cargo build --release

# 编译核心引擎（CUDA 支持）
cargo build --release --features cuda
```

### 12.3 测试命令

```powershell
# 运行单元测试
cd core/engine
cargo test

# 运行集成测试
cargo test --test integration_test
```

### 12.4 启动服务

```powershell
# 一键启动所有服务
.\start_all_services_simple.ps1

# 一键停止所有服务
.\stop_all_services.ps1
```

---

## 13. 相关文档

### 13.1 核心文档

- `docs/PROJECT_OVERVIEW.md` - 项目总览
- `docs/DOCUMENTATION_INDEX.md` - 文档索引
- `docs/product/Lingua_Core_Runtime_一键启动与服务设计说明.md` - 服务设计说明

### 13.2 架构文档

- `core/engine/docs/SYSTEM_ARCHITECTURE_OVERVIEW.md` - 系统架构总览
- `docs/architecture/` - 架构相关文档

### 13.3 运维文档

- `docs/operational/编译和启动命令参考.md` - 编译和启动命令
- `docs/GPU_启用指南.md` - GPU 配置指南

---

## 14. 版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| v0.1.0 | 2025-01-27 | 初始版本，核心功能完成 |

---

## 15. 联系方式

**项目名称**: Lingua  
**项目类型**: 语音转语音翻译系统  
**开发状态**: 活跃开发中  
**最后更新**: 2025-01-27

---

**报告版本**: 1.0  
**生成日期**: 2025-01-27  
**维护者**: 开发团队

**相关文档**:
- [第一部分：概述、架构与技术](./v0.1_第一部分_概述架构与技术.md)

