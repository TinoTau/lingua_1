# 节点端架构更新总结

## 更新日期

2024年（聚合和去重逻辑迁移完成）

## 架构变更概述

已将聚合和去重逻辑从 `PostProcessCoordinator` 迁移到 `PipelineOrchestrator`，统一了处理流程，避免了重复处理。

## 新的架构流程

### 完整处理流程

```
调度服务器
    ↓ (WebSocket: job_assign)
NodeAgent.handleJob()
    ↓
JobProcessor.processJob()
    ├─ 按需启动服务（如 speaker_embedding）
    ├─ 设置流式 ASR 部分结果回调（如果启用）
    ↓
InferenceService.processJob()
    ├─ 首次任务检查（等待服务就绪）
    ├─ 刷新服务端点（带缓存，TTL 1000ms）
    ↓
PipelineOrchestrator.processJob()  [ASR阶段]
    ├─ 检查 use_asr（如果 false，返回空结果）
    ├─ AudioAggregator (音频聚合)
    │   └─ 8秒阈值判断，延迟3秒等待合并
    ├─ ASRHandler (ASR识别)
    │   └─ TaskRouter.routeASRTask()
    ├─ ASRResultProcessor (ASR结果处理)
    │   ├─ 空文本检查
    │   └─ 无意义文本检查
    ├─ AggregationStage (文本聚合) ← 已迁移
    │   ├─ AggregatorManager.processUtterance()
    │   ├─ TextForwardMergeManager (向前合并)
    │   └─ DeduplicationHandler (去重)
    ├─ MergeHandler (合并处理) ← 已迁移
    │   └─ 取消被合并的 GPU 任务
    ├─ TextFilter (文本过滤) ← 已迁移
    │   ├─ shouldDiscard (< 6字符)
    │   └─ shouldWaitForMerge (6-16字符)
    ├─ detectInternalRepetition (内部重复检测)
    ├─ SemanticRepairStage (语义修复)
    │   └─ TaskRouter.routeSemanticRepairTask()
    └─ DedupStage (job_id去重) ← 已迁移
        └─ 基于 job_id，30秒 TTL
    ↓
PostProcessCoordinator.process()  [后处理阶段]
    ├─ 检查 should_send（如果 false，直接返回）
    ├─ 检查文本是否为空（如果为空，返回空结果）
    ├─ TranslationStage (NMT翻译)
    │   ├─ 检查 use_nmt
    │   ├─ 如果 use_asr=false，使用 job.input_text
    │   └─ TaskRouter.routeNMTTask()
    ├─ TTSStage (TTS语音生成)
    │   ├─ 检查 use_tts
    │   └─ TaskRouter.routeTTSTask()
    └─ TONEStage (TONE音色配音)
        ├─ 检查 use_tone
        └─ TaskRouter.routeTONETask()
    ↓
ResultSender.sendJobResult()
    ├─ lastSentText检查 (文本去重，最终防线)
    ├─ 更新 lastSentText（通过 DeduplicationHandler）
    ├─ 标记 job_id 为已发送（通过 DedupStage）
    └─ 发送到调度服务器
```

## 迁移的组件

### 从 PostProcessCoordinator 迁移到 PipelineOrchestrator

1. ✅ **AggregationStage**：文本聚合逻辑
2. ✅ **DedupStage**：基于 job_id 的去重检查
3. ✅ **PostProcessMergeHandler**：合并逻辑处理（取消被合并的 GPU 任务）
4. ✅ **PostProcessTextFilter**：文本过滤逻辑（shouldDiscard、shouldWaitForMerge）

### PipelineOrchestrator 的处理顺序

1. 音频聚合（AudioAggregator）
2. ASR 识别（ASRHandler）
3. 文本聚合（AggregationStage）
4. 合并处理（MergeHandler）
5. 文本过滤（TextFilter）
6. 内部重复检测（detectInternalRepetition）
7. 语义修复（SemanticRepairStage）
8. 去重检查（DedupStage）

### PostProcessCoordinator 的简化

**之前**：
- 聚合（AggregationStage）
- 合并处理（MergeHandler）
- 文本过滤（TextFilter）
- 语义修复（SemanticRepairStage）
- 去重检查（DedupStage）
- 翻译（TranslationStage）
- TTS（TTSStage）
- TONE（TONEStage）

**现在**：
- 检查 should_send（如果 false，直接返回）
- 翻译（TranslationStage）
- TTS（TTSStage）
- TONE（TONEStage）

## 更新的文档

### 架构文档

1. ✅ **节点端架构优化决策文档.md**
   - 更新了架构图和流程说明
   - 添加了架构优化完成说明

2. ✅ **节点端Job处理完整流程.md**
   - 更新了完整流程图
   - 更新了各阶段的详细说明
   - 更新了关键组件说明

3. ✅ **服务调用流程说明.md**
   - 更新了各场景的服务调用流程
   - 更新了 PostProcessCoordinator 的职责说明

4. ✅ **按需服务选择功能实现方案.md**
   - 更新了实现状态说明
   - 添加了架构优化说明

5. ✅ **节点端流程评价.md**
   - 更新了职责重叠问题的状态（已优化）
   - 更新了优化后的流程说明

6. ✅ **文本聚合与ASR绑定实现说明.md**
   - 更新了改动概述
   - 更新了调用流程
   - 更新了文本流程说明

7. ✅ **语义修复与ASR绑定实现说明.md**
   - 更新了改动概述
   - 更新了调用流程
   - 更新了关键代码示例

8. ✅ **SYSTEM_ARCHITECTURE.md**
   - 更新了节点端处理流程

### 新增文档

1. ✅ **聚合与去重逻辑迁移说明.md**
   - 详细的迁移说明
   - 新的处理流程
   - 代码变更说明
   - 优势分析

2. ✅ **节点端架构更新总结.md**（本文档）
   - 架构变更概述
   - 更新的文档列表

## 关键变更

### JobResult 接口

**新增字段**：
```typescript
should_send?: boolean;  // 是否应该发送（去重检查结果）
dedup_reason?: string;  // 去重原因（如果 should_send=false）
```

### PipelineOrchestrator

**新增组件**：
- `dedupStage: DedupStage`
- `mergeHandler: PostProcessMergeHandler`
- `textFilter: PostProcessTextFilter`

**新增方法**：
- `getDedupStage()`: 获取 DedupStage 实例

### PostProcessCoordinator

**移除组件**：
- `dedupStage: DedupStage`
- `mergeHandler: PostProcessMergeHandler`
- `textFilter: PostProcessTextFilter`

**简化逻辑**：
- 不再需要构建 `AggregationStageResult`
- 直接使用 `result.should_send` 判断是否应该处理
- 直接使用 `result.text_asr`（已经是聚合和语义修复后的文本）

## 优势

1. **统一处理流程**：所有 ASR 相关的处理（聚合、去重、语义修复）都在 PipelineOrchestrator 中完成
2. **避免重复处理**：不再在 PostProcessCoordinator 中重复处理聚合和去重
3. **职责更清晰**：
   - PipelineOrchestrator：ASR 相关处理
   - PostProcessCoordinator：翻译和音频生成
4. **性能提升**：减少了不必要的处理步骤

## 相关文件

### 代码文件

- `electron_node/electron-node/main/src/pipeline-orchestrator/pipeline-orchestrator.ts`
- `electron_node/electron-node/main/src/agent/postprocess/postprocess-coordinator.ts`
- `electron_node/electron-node/main/src/inference/inference-service.ts`
- `electron_node/electron-node/main/src/agent/node-agent.ts`
- `electron_node/electron-node/main/src/agent/node-agent-result-sender.ts`

### 文档文件

- `docs/architecture/节点端架构优化决策文档.md`
- `docs/architecture/节点端Job处理完整流程.md`
- `docs/architecture/服务调用流程说明.md`
- `docs/architecture/按需服务选择功能实现方案.md`
- `docs/architecture/节点端流程评价.md`
- `docs/architecture/文本聚合与ASR绑定实现说明.md`
- `docs/architecture/语义修复与ASR绑定实现说明.md`
- `docs/architecture/聚合与去重逻辑迁移说明.md`
- `docs/architecture/节点端架构更新总结.md`
- `docs/SYSTEM_ARCHITECTURE.md`
