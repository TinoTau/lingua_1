# 双向互译模式实现说明

## 概述

双向互译模式是系统的核心功能，支持双方轮流说话的面对面交流场景。系统会自动识别语音语言，并将语音翻译到另一种语言。

## 核心特性

1. **自动语言检测**：ASR 服务会检测语音的语言
2. **动态目标语言确定**：根据检测到的语言自动确定目标语言
   - 检测到语言 A → 翻译到语言 B
   - 检测到语言 B → 翻译到语言 A
3. **聚合器模式**：使用 `two_way` 模式进行文本聚合

## 实现细节

### 1. Web 端

**文件**：`webapp/web-client/src/ui/session_mode.ts`

- 用户选择语言 A 和语言 B
- 连接时使用 `app.connectTwoWay(langA, langB)`
- 所有会话都使用双向互译模式，不再有单向翻译

### 2. 节点端

#### ASR 步骤

**文件**：`electron_node/electron-node/main/src/pipeline/steps/asr-step.ts`

- 从 ASR 结果中获取 `language_probabilities`
- 使用 `determineDetectedLanguage` 函数确定检测到的语言
- 根据检测到的语言确定目标语言：
  ```typescript
  if (detectedLang === job.lang_a) {
    ctx.detectedTargetLang = job.lang_b;
  } else {
    ctx.detectedTargetLang = job.lang_a;
  }
  ```
- **重要**：只使用 `job.lang_a` 和 `job.lang_b`，不考虑回退到 `src_lang` 和 `tgt_lang`

#### 翻译步骤

**文件**：`electron_node/electron-node/main/src/pipeline/steps/translation-step.ts`

- 优先使用 `ctx.detectedTargetLang`（如果已确定）
- 否则使用 `job.tgt_lang` 作为回退

#### 聚合器

**文件**：
- `electron_node/electron-node/main/src/agent/postprocess/aggregation-stage.ts`
- `electron_node/electron-node/main/src/agent/aggregator-middleware.ts`

- 始终使用 `'two_way'` 模式
- `'two_way'` 模式使用与 `'room'` 模式相同的聚合参数（但功能不同）

### 3. 聚合器模式定义

**文件**：`electron_node/electron-node/main/src/aggregator/aggregator-decision.ts`

**模式类型**：
```typescript
export type Mode = "offline" | "room" | "two_way";
```

**模式说明**：
- `offline`：离线模式（已废弃，保留用于兼容）
- `room`：会议室模式（尚未实现）
- `two_way`：双向互译模式（当前使用的模式）

**参数配置**：
- `two_way` 模式使用与 `room` 模式相同的聚合参数
- 包括：`strongMergeMs`、`softGapMs`、`commitIntervalMs` 等

## 工作流程

1. 用户在 Web 端选择语言 A 和语言 B
2. 用户选择服务模式（如"语音转译"）
3. 系统自动连接服务器（使用 `connectTwoWay`）
4. 用户说话，音频发送到节点端
5. 节点端执行 ASR，获取语言检测结果
6. 节点端根据检测到的语言确定目标语言
7. 节点端使用确定的目标语言进行翻译
8. 返回翻译结果和 TTS 音频

## 注意事项

1. **必须提供 lang_a 和 lang_b**：
   - 节点端不会回退到 `src_lang` 和 `tgt_lang`
   - 如果 `job` 中没有 `lang_a` 和 `lang_b`，会记录错误日志

2. **语言检测失败处理**：
   - 如果无法确定检测到的语言，使用默认目标语言（`lang_b`）
   - 记录警告日志

3. **模式区分**：
   - `two_way` 模式：双向互译（当前实现）
   - `room` 模式：会议室模式（尚未实现，功能不同）

## 相关文件

- Web 端 UI：`webapp/web-client/src/ui/session_mode.ts`
- ASR 步骤：`electron_node/electron-node/main/src/pipeline/steps/asr-step.ts`
- 翻译步骤：`electron_node/electron-node/main/src/pipeline/steps/translation-step.ts`
- 聚合器阶段：`electron_node/electron-node/main/src/agent/postprocess/aggregation-stage.ts`
- 聚合器中间件：`electron_node/electron-node/main/src/agent/aggregator-middleware.ts`
- 聚合器决策：`electron_node/electron-node/main/src/aggregator/aggregator-decision.ts`
- JobContext：`electron_node/electron-node/main/src/pipeline/context/job-context.ts`
