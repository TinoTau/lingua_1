# æŒ‰éœ€æœåŠ¡é€‰æ‹©è®¾è®¡é—®é¢˜è§£ç­”

## é—®é¢˜1ï¼šä¸ºä»€ä¹ˆ node-inference æœåŠ¡è¿˜åœ¨æ›´æ–°ï¼Ÿ

### ç°çŠ¶åˆ†æ

**`electron_node/services/node-inference`** æ˜¯ Rust æœåŠ¡ï¼Œä½†**æ–°æ¶æ„å·²ç»ä¸å†ç›´æ¥ä½¿ç”¨å®ƒ**ã€‚

### æ–°æ¶æ„çš„å®é™…æµç¨‹

1. **`InferenceService`**ï¼ˆTypeScript ç±»ï¼‰ï¼š
   - ä½ç½®ï¼š`electron_node/electron-node/main/src/inference/inference-service.ts`
   - åŠŸèƒ½ï¼šè°ƒç”¨æ–°çš„ `runJobPipeline`ï¼Œè€Œä¸æ˜¯ç›´æ¥è°ƒç”¨ Rust æœåŠ¡
   - ä»£ç ï¼š`await runJobPipeline(...)`ï¼ˆç¬¬ 150+ è¡Œï¼‰

2. **`node-inference` æœåŠ¡çš„ä½œç”¨**ï¼š
   - ä»ç„¶å¯ä»¥ä½œä¸º **ASR æœåŠ¡**ä½¿ç”¨ï¼ˆé€šè¿‡ TaskRouter è·¯ç”±ï¼‰
   - ä½†æ–°æ¶æ„é»˜è®¤ä½¿ç”¨ `faster-whisper-vad` ä½œä¸º ASR æœåŠ¡
   - `node-inference` åªæ˜¯ä½œä¸º**å¤‡é€‰ ASR æœåŠ¡**å­˜åœ¨

### ç»“è®º

- âœ… **æ–°æ¶æ„ä¸ä¾èµ– `node-inference`**ï¼šæ‰€æœ‰æŒ‰éœ€æœåŠ¡æµç¨‹éƒ½é€šè¿‡ TypeScript Pipeline å®ç°
- âš ï¸ **`node-inference` ä»å¯ä½œä¸º ASR æœåŠ¡**ï¼šé€šè¿‡ TaskRouter è·¯ç”±ï¼Œä½†ä¸æ˜¯å¿…éœ€çš„
- ğŸ“ **å»ºè®®**ï¼šå¦‚æœç¡®è®¤ä¸å†ä½¿ç”¨ï¼Œå¯ä»¥æ ‡è®°ä¸ºåºŸå¼ƒï¼Œä½†ä¿ç•™ä»£ç ä½œä¸ºå‚è€ƒ

---

## é—®é¢˜2ï¼šASR å¤„ç†å®Œçš„éŸ³é¢‘æ ¼å¼æ˜¯å¦æ˜¯ PCM16ï¼Ÿèƒ½å¦ç»™ embedding ç›´æ¥ä½¿ç”¨ï¼Ÿ

### å…³é”®ç†è§£

**ASR æ­¥éª¤æœ¬èº«ä¸è¿”å›éŸ³é¢‘**ï¼Œå®ƒåªè¿”å›æ–‡æœ¬ï¼ˆ`asrText`ï¼‰ã€‚

### éŸ³é¢‘æµç¨‹

1. **è¾“å…¥éŸ³é¢‘**ï¼ˆ`job.audio`ï¼‰ï¼š
   - æ ¼å¼ï¼š**Opus**ï¼ˆbase64 ç¼–ç ï¼‰
   - ä½ç½®ï¼š`JobAssignMessage.audio`

2. **ASR æ­¥éª¤å¤„ç†**ï¼š
   - è§£ç  Opus â†’ PCM16ï¼ˆåœ¨ `PipelineOrchestratorAudioProcessor` ä¸­ï¼‰
   - å‘é€ PCM16 ç»™ ASR æœåŠ¡
   - **ASR æœåŠ¡åªè¿”å›æ–‡æœ¬ï¼Œä¸è¿”å›éŸ³é¢‘**

3. **Embedding æ­¥éª¤éœ€è¦çš„éŸ³é¢‘**ï¼š
   - éœ€è¦ï¼š**åŸå§‹éŸ³é¢‘**ï¼ˆä» `job.audio` æˆ– `ctx.audio` è·å–ï¼‰
   - æ ¼å¼ï¼š**Opus**ï¼ˆéœ€è¦å…ˆè§£ç ä¸º PCM16ï¼Œå†è½¬æ¢ä¸º f32ï¼‰

### å®é™…å®ç°

**Opus è§£ç å·²åœ¨ ASR æ­¥éª¤ä¸­å®Œæˆ**ï¼š

1. **ASR æ­¥éª¤**ï¼ˆ`asr-step.ts`ï¼‰ï¼š
   - `PipelineOrchestratorAudioProcessor` å°† Opus è§£ç ä¸º PCM16
   - è§£ç åçš„ PCM16 éŸ³é¢‘å­˜å‚¨åˆ° `ctx.audio` å’Œ `ctx.audioFormat = 'pcm16'`

2. **Embedding æ­¥éª¤**ï¼ˆ`embedding-step.ts`ï¼‰ï¼š
   - ç›´æ¥ä» `ctx.audio` è·å– PCM16 æ ¼å¼çš„éŸ³é¢‘
   - è½¬æ¢ä¸º f32 æ ¼å¼åè°ƒç”¨ speaker-embedding æœåŠ¡

**ä»£ç å®ç°**ï¼š
```typescript
// ASR æ­¥éª¤ä¸­
ctx.audio = Buffer.from(audioForASR, 'base64'); // PCM16 Buffer
ctx.audioFormat = 'pcm16';

// Embedding æ­¥éª¤ä¸­
const audioF32 = convertPcm16ToF32(ctx.audio); // ç›´æ¥ä½¿ç”¨ PCM16
```

---

## é—®é¢˜3ï¼šä¸ºä»€ä¹ˆ YourTTS æœåŠ¡å¯èƒ½éœ€è¦å…ˆæ³¨å†Œ speakerï¼Ÿ

### YourTTS æœåŠ¡çš„å·¥ä½œæœºåˆ¶

ä» `yourtts_service.py` çš„ä»£ç çœ‹ï¼š

```python
# /synthesize ç«¯ç‚¹
if speaker_id:
    with speaker_cache_lock:
        cached_entry = speaker_cache.get(speaker_id)
        if cached_entry:
            cached_ref_audio = cached_entry["reference_audio"]
            cached_sample_rate = cached_entry["sample_rate"]
            # ä½¿ç”¨ç¼“å­˜çš„å‚è€ƒéŸ³é¢‘
```

### ä¸¤ç§ä½¿ç”¨æ–¹å¼

#### æ–¹å¼1ï¼šä½¿ç”¨ç¼“å­˜çš„ speakerï¼ˆéœ€è¦å…ˆæ³¨å†Œï¼‰

1. **æ³¨å†Œ speaker**ï¼ˆ`/register_speaker`ï¼‰ï¼š
   - æä¾› `speaker_id` å’Œ `reference_audio`
   - æœåŠ¡å°† `reference_audio` ç¼“å­˜åˆ°å†…å­˜ä¸­

2. **åˆæˆè¯­éŸ³**ï¼ˆ`/synthesize`ï¼‰ï¼š
   - æä¾› `speaker_id`
   - æœåŠ¡ä»ç¼“å­˜ä¸­è·å– `reference_audio`ï¼Œç”¨äºéŸ³è‰²å…‹éš†

#### æ–¹å¼2ï¼šç›´æ¥æä¾› reference_audioï¼ˆä¸éœ€è¦æ³¨å†Œï¼‰

1. **åˆæˆè¯­éŸ³**ï¼ˆ`/synthesize`ï¼‰ï¼š
   - æä¾› `reference_audio` å‚æ•°ï¼ˆä¸æä¾› `speaker_id`ï¼‰
   - æœåŠ¡ç›´æ¥ä½¿ç”¨æä¾›çš„ `reference_audio`

### ä½¿ç”¨ job_id ä½œä¸º speaker_id çš„é—®é¢˜

å¦‚æœä½¿ç”¨ `job_id` ä½œä¸º `speaker_id`ï¼š

- âŒ **é—®é¢˜**ï¼šæ¯ä¸ª `job_id` éƒ½æ˜¯å”¯ä¸€çš„ï¼Œç¼“å­˜ä¸­ä¸ä¼šæœ‰å¯¹åº”çš„ `reference_audio`
- âœ… **è§£å†³æ–¹æ¡ˆ1**ï¼šåœ¨ Embedding æ­¥éª¤åï¼Œè‡ªåŠ¨æ³¨å†Œ speakerï¼ˆä½¿ç”¨ `job_id` å’Œæå–çš„éŸ³é¢‘ï¼‰
- âœ… **è§£å†³æ–¹æ¡ˆ2**ï¼šåœ¨ YourTTS æ­¥éª¤ä¸­ï¼Œç›´æ¥æä¾› `reference_audio`ï¼ˆä¸ä½¿ç”¨ `speaker_id`ï¼‰

### å·²å®ç°æ–¹æ¡ˆ

**ä½¿ç”¨æ–¹æ¡ˆ2ï¼ˆç›´æ¥æä¾› reference_audioï¼‰**ï¼š

```typescript
// yourtts-step.ts
// ä» JobContext è·å– PCM16 éŸ³é¢‘ï¼ˆASR æ­¥éª¤å·²è§£ç ï¼‰
const audioF32 = convertPcm16ToF32(ctx.audio);

const response = await axios.post(
  `${endpoint.baseUrl}/synthesize`,
  {
    text: textToTts,
    language: job.tgt_lang || 'zh',
    reference_audio: audioF32, // ç›´æ¥æä¾›åŸå§‹éŸ³é¢‘ï¼ˆf32 æ ¼å¼ï¼‰
    reference_sample_rate: job.sample_rate || 16000,
  }
);
```

**ä¼˜ç‚¹**ï¼š
- âœ… ä¸éœ€è¦æ³¨å†Œæ­¥éª¤
- âœ… æ¯ä¸ª job ä½¿ç”¨è‡ªå·±çš„éŸ³é¢‘ä½œä¸ºå‚è€ƒ
- âœ… æ›´ç¬¦åˆ"æ¯æ®µéŸ³é¢‘ä½¿ç”¨è‡ªå·±çš„éŸ³è‰²"çš„éœ€æ±‚
- âœ… èŠ‚ç‚¹ç«¯çš„ä»»åŠ¡æµæ˜¯å®Œæ•´çš„ï¼Œå¯ä»¥ç›´æ¥ä¼ é€’ reference_audio

---

## æ€»ç»“

1. **`node-inference` æœåŠ¡**ï¼šæ–°æ¶æ„ä¸ä¾èµ–å®ƒï¼Œä½†å¯ä»¥ä½œä¸ºå¤‡é€‰ ASR æœåŠ¡ã€‚å»ºè®®æ ‡è®°ä¸ºåºŸå¼ƒï¼Œä¿ç•™ä»£ç ä½œä¸ºå‚è€ƒã€‚

2. **ASR éŸ³é¢‘æ ¼å¼**ï¼š
   - âœ… Opus è§£ç å·²åœ¨ ASR æ­¥éª¤ä¸­å®Œæˆï¼ˆ`PipelineOrchestratorAudioProcessor`ï¼‰
   - âœ… è§£ç åçš„ PCM16 éŸ³é¢‘å­˜å‚¨åˆ° `ctx.audio` å’Œ `ctx.audioFormat = 'pcm16'`
   - âœ… Embedding æ­¥éª¤ç›´æ¥ä» `ctx.audio` è·å– PCM16 æ ¼å¼çš„éŸ³é¢‘ï¼Œè½¬æ¢ä¸º f32 åä½¿ç”¨

3. **YourTTS speaker æ³¨å†Œ**ï¼š
   - âœ… å·²å®ç°æ–¹æ¡ˆ2ï¼šç›´æ¥ä¼ é€’ `reference_audio`ï¼Œä¸ä½¿ç”¨ `speaker_id`
   - âœ… ä» `ctx.audio` è·å– PCM16 éŸ³é¢‘ï¼Œè½¬æ¢ä¸º f32 åä¼ é€’ç»™ YourTTS æœåŠ¡
   - âœ… æ¯ä¸ª job ä½¿ç”¨è‡ªå·±çš„éŸ³é¢‘ä½œä¸ºå‚è€ƒï¼Œä¸éœ€è¦æ³¨å†Œæ­¥éª¤
