# 聚合与去重逻辑迁移说明

## 迁移概述

已将 `PostProcessCoordinator` 中的聚合和去重逻辑迁移到 `PipelineOrchestrator`，统一了处理流程，避免了重复处理。

## 迁移内容

### 1. 迁移的组件

- ✅ **AggregationStage**：文本聚合逻辑（已在 PipelineOrchestrator 中）
- ✅ **DedupStage**：基于 job_id 的去重检查
- ✅ **PostProcessMergeHandler**：合并逻辑处理（取消被合并的 GPU 任务）
- ✅ **PostProcessTextFilter**：文本过滤逻辑（shouldDiscard、shouldWaitForMerge）

### 2. 新的处理流程

```
PipelineOrchestrator.processJob():
  1. 音频聚合（AudioAggregator）
  2. ASR 识别（ASRHandler）
  3. 文本聚合（AggregationStage）
  4. 合并处理（MergeHandler）- 处理合并逻辑，取消被合并的 GPU 任务
  5. 文本过滤（TextFilter）- 处理文本过滤逻辑（太短、等待合并等）
  6. 语义修复（SemanticRepairStage）
  7. 去重检查（DedupStage）- 基于 job_id 去重
  8. 返回 JobResult（包含 should_send 和 dedup_reason）

PostProcessCoordinator.process():
  1. 检查 should_send（如果 false，直接返回）
  2. 翻译（TranslationStage）
  3. TTS（TTSStage）
  4. TONE（TONEStage）
  5. 返回最终结果
```

## 代码变更

### PipelineOrchestrator

**新增**：
- `dedupStage: DedupStage`
- `mergeHandler: PostProcessMergeHandler`
- `textFilter: PostProcessTextFilter`
- `getDedupStage()`: 获取 DedupStage 实例

**处理流程**：
- 在聚合之后执行 `mergeHandler.process()` 和 `textFilter.process()`
- 在语义修复之后执行 `dedupStage.process()`
- 在 `JobResult` 中添加 `should_send` 和 `dedup_reason` 字段

### PostProcessCoordinator

**移除**：
- `dedupStage: DedupStage`
- `mergeHandler: PostProcessMergeHandler`
- `textFilter: PostProcessTextFilter`
- `getDedupStage()` 方法

**简化**：
- 不再需要构建 `AggregationStageResult`
- 不再需要处理合并和过滤逻辑
- 直接使用 `result.should_send` 判断是否应该处理

### JobResult 接口

**新增字段**：
```typescript
should_send?: boolean;  // 是否应该发送（去重检查结果）
dedup_reason?: string;  // 去重原因（如果 should_send=false）
```

## 优势

1. **统一处理流程**：所有 ASR 相关的处理（聚合、去重、语义修复）都在 PipelineOrchestrator 中完成
2. **避免重复处理**：不再在 PostProcessCoordinator 中重复处理聚合和去重
3. **职责更清晰**：
   - PipelineOrchestrator：ASR 相关处理
   - PostProcessCoordinator：翻译和音频生成
4. **性能提升**：减少了不必要的处理步骤

## 注意事项

1. **ResultSender**：需要从 `InferenceService.getDedupStage()` 获取 DedupStage 实例，用于在成功发送后记录 job_id
2. **向后兼容**：`should_send` 默认为 `true`，如果未设置则视为应该发送
3. **空结果处理**：如果 `should_send=false`，PostProcessCoordinator 会直接返回空结果，不进行翻译和 TTS 处理

## 相关文件

- `electron_node/electron-node/main/src/pipeline-orchestrator/pipeline-orchestrator.ts`
- `electron_node/electron-node/main/src/agent/postprocess/postprocess-coordinator.ts`
- `electron_node/electron-node/main/src/inference/inference-service.ts`
- `electron_node/electron-node/main/src/agent/node-agent.ts`
- `electron_node/electron-node/main/src/agent/node-agent-result-sender.ts`
