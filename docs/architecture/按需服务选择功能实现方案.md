# æŒ‰éœ€æœåŠ¡é€‰æ‹©åŠŸèƒ½å®ç°æ–¹æ¡ˆ

## éœ€æ±‚æ¦‚è¿°

å®ç°ç”± web ç«¯é€‰æ‹©æ¯ä¸ªä»»åŠ¡éœ€è¦å“ªäº›æœåŠ¡è¿›è¡Œå¤„ç†ï¼Œè€Œä¸æ˜¯èŠ‚ç‚¹ç«¯æœ‰ä»€ä¹ˆå°±å…¨éƒ¨èµ°ä¸€éæµç¨‹ã€‚

**åœºæ™¯**ï¼š
1. **ASR+NMT+TTS+TONE**ï¼šä¸ªäººä¸“å±è¯­éŸ³å¤„ç†ï¼ˆéŸ³è‰²é…éŸ³ï¼‰
2. **ASR+NMT+TTS**ï¼šè¯­éŸ³è½¬è¯‘
3. **ASR+NMT**ï¼šå­—å¹•æ¨¡å¼
4. **åªé€‰æ‹© NMT**ï¼šæ–‡æœ¬ç¿»è¯‘ï¼ˆä¸éœ€è¦ ASRï¼‰
5. **åªé€‰æ‹© ASR**ï¼šåªéœ€è¦ ASR è¯†åˆ«ï¼Œä¸éœ€è¦ç”Ÿæˆè¯­éŸ³ï¼ˆTTSï¼‰

**å…³é”®è¦æ±‚**ï¼š
- å¦‚æœç”¨æˆ·é€‰æ‹©äº† ASRï¼Œå°±å¿…é¡»ä½¿ç”¨è¯­ä¹‰ä¿®å¤æœåŠ¡æ¥å¤„ç†æ–‡æœ¬
- æ”¯æŒ TONE éŸ³è‰²é…éŸ³åŠŸèƒ½

## å½“å‰çŠ¶æ€

### å·²æœ‰çš„åŸºç¡€è®¾æ–½

âœ… **JobAssignMessage å·²æœ‰ `pipeline` å­—æ®µ**ï¼š
```typescript
pipeline: {
  use_asr: boolean;
  use_nmt: boolean;
  use_tts: boolean;
  use_tone?: boolean;  // æ˜¯å¦ä½¿ç”¨ TONE æœåŠ¡ï¼ˆéŸ³è‰²é…éŸ³ï¼‰
}
```

âœ… **TONE æœåŠ¡å·²å­˜åœ¨**ï¼š
- `TaskRouterTONEHandler` å’Œ `routeTONETask` å·²å®ç°
- TONE æœåŠ¡æ”¯æŒ `embed` å’Œ `clone` ä¸¤ç§æ¨¡å¼

âœ… **è¯­ä¹‰ä¿®å¤æœåŠ¡å·²å­˜åœ¨**ï¼š
- `TaskRouterSemanticRepairHandler` å’Œ `routeSemanticRepairTask` å·²å®ç°
- è¯­ä¹‰ä¿®å¤åœ¨ `PostProcessCoordinator` ä¸­è°ƒç”¨

### å®ç°çŠ¶æ€

âœ… **å·²å®ç°çš„åŠŸèƒ½**ï¼š
- `PipelineOrchestrator`ï¼šæ”¯æŒè·³è¿‡ ASRï¼ˆ`use_asr: false`ï¼‰
- `PostProcessCoordinator`ï¼šæ”¯æŒè·³è¿‡ç¿»è¯‘ï¼ˆ`use_nmt: false`ï¼‰å’Œ TTSï¼ˆ`use_tts: false`ï¼‰
- `PostProcessCoordinator`ï¼šå¦‚æœ `use_asr === true`ï¼Œå¿…é¡»æ‰§è¡Œè¯­ä¹‰ä¿®å¤
- `PostProcessCoordinator`ï¼šæ”¯æŒ TONE éŸ³è‰²é…éŸ³ï¼ˆ`use_tone: true`ï¼‰
- `PostProcessCoordinator`ï¼šæ”¯æŒåªé€‰æ‹© NMTï¼ˆæ–‡æœ¬ç¿»è¯‘æ¨¡å¼ï¼Œ`use_asr: false, use_nmt: true`ï¼‰
- `TONEStage`ï¼šæ–°å¢ TONE é˜¶æ®µï¼Œå¤„ç†éŸ³è‰²é…éŸ³

---

## å·²å®ç°çš„æ”¹åŠ¨

### 1. âœ… æ›´æ–° JobAssignMessage æ¥å£

**æ–‡ä»¶**ï¼š
- `electron_node/shared/protocols/messages.ts`
- `central_server/shared/protocols/messages.ts`
- `webapp/shared/protocols/messages.ts`

**æ”¹åŠ¨**ï¼š
- åœ¨ `pipeline` å¯¹è±¡ä¸­æ·»åŠ  `use_tone?: boolean` å­—æ®µ

---

### 2. âœ… PipelineOrchestrator - æ”¯æŒè·³è¿‡ ASR

**æ–‡ä»¶**ï¼š`electron_node/electron-node/main/src/pipeline-orchestrator/pipeline-orchestrator.ts`

**æ”¹åŠ¨**ï¼š
- åœ¨ `processJob()` å¼€å§‹æ—¶æ£€æŸ¥ `job.pipeline.use_asr`
- å¦‚æœ `use_asr === false`ï¼Œè·³è¿‡ ASR å¤„ç†ï¼Œè¿”å›ç©ºç»“æœ

---

### 3. âœ… PostProcessCoordinator - è¯­ä¹‰ä¿®å¤ä¸ ASR ç»‘å®š

**æ–‡ä»¶**ï¼š`electron_node/electron-node/main/src/agent/postprocess/postprocess-coordinator.ts`

**æ”¹åŠ¨**ï¼š
- å¦‚æœ `use_asr === true`ï¼Œå¿…é¡»æ‰§è¡Œè¯­ä¹‰ä¿®å¤
- å¦‚æœ `use_asr === false`ï¼Œè·³è¿‡è¯­ä¹‰ä¿®å¤

---

### 4. âœ… PostProcessCoordinator - æ”¯æŒè·³è¿‡ç¿»è¯‘å’Œ TTS

**æ–‡ä»¶**ï¼š`electron_node/electron-node/main/src/agent/postprocess/postprocess-coordinator.ts`

**æ”¹åŠ¨**ï¼š
- åœ¨ç¿»è¯‘é˜¶æ®µæ£€æŸ¥ `job.pipeline.use_nmt`
- åœ¨ TTS é˜¶æ®µæ£€æŸ¥ `job.pipeline.use_tts`
- æ”¯æŒåªé€‰æ‹© NMTï¼ˆæ–‡æœ¬ç¿»è¯‘æ¨¡å¼ï¼‰ï¼šå¦‚æœ `use_asr === false`ï¼Œä½¿ç”¨ `job.input_text` ä½œä¸ºè¾“å…¥

---

### 5. âœ… PostProcessCoordinator - æ”¯æŒ TONE éŸ³è‰²é…éŸ³

**æ–‡ä»¶**ï¼š`electron_node/electron-node/main/src/agent/postprocess/postprocess-coordinator.ts`

**æ”¹åŠ¨**ï¼š
- æ·»åŠ  `TONEStage` æ”¯æŒ
- åœ¨ TTS ä¹‹åæ‰§è¡Œ TONE å¤„ç†ï¼ˆå¦‚æœ `use_tone === true`ï¼‰
- è¿”å›ç»“æœä¸­åŒ…å« `toneAudio`ã€`toneFormat` å’Œ `speakerId`

---

### 6. âœ… åˆ›å»º TONEStage ç±»

**æ–‡ä»¶**ï¼š`electron_node/electron-node/main/src/agent/postprocess/tone-stage.ts`ï¼ˆæ–°å»ºï¼‰

**åŠŸèƒ½**ï¼š
- å¤„ç† TONE éŸ³è‰²é…éŸ³æœåŠ¡è°ƒç”¨
- æ”¯æŒä» `job` ä¸­æå– `speaker_id` æˆ– `voice_id`
- ä½¿ç”¨ `SequentialExecutor` ç¡®ä¿é¡ºåºæ‰§è¡Œ
- ä½¿ç”¨ GPU ç§Ÿçº¦æœºåˆ¶

---

## è¯¦ç»†æ”¹åŠ¨æ–¹æ¡ˆ

### æ”¹åŠ¨1ï¼šPipelineOrchestrator - æ”¯æŒè·³è¿‡ ASR

**æ–‡ä»¶**ï¼š`pipeline-orchestrator.ts`

**æ”¹åŠ¨ä½ç½®**ï¼š`processJob()` æ–¹æ³•å¼€å§‹å¤„

```typescript
async processJob(
  job: JobAssignMessage,
  partialCallback?: PartialResultCallback,
  asrCompletedCallback?: (asrCompleted: boolean) => void
): Promise<JobResult> {
  const startTime = Date.now();

  // æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰§è¡Œ ASR
  if (job.pipeline?.use_asr === false) {
    logger.info(
      { jobId: job.job_id, sessionId: job.session_id },
      'PipelineOrchestrator: ASR disabled by pipeline config, returning empty result'
    );
    return this.resultBuilder.buildEmptyResult();
  }

  try {
    // ... åŸæœ‰é€»è¾‘
  }
}
```

**å½±å“**ï¼š
- å¦‚æœ `use_asr === false`ï¼Œè¿”å›ç©ºç»“æœ
- `text_asr` ä¸ºç©ºå­—ç¬¦ä¸²
- åç»­çš„ PostProcessCoordinator ä»ç„¶ä¼šæ‰§è¡Œï¼ˆä½†å¯èƒ½å› ä¸ºæ–‡æœ¬ä¸ºç©ºè€Œè·³è¿‡æŸäº›é˜¶æ®µï¼‰

---

### æ”¹åŠ¨2ï¼šPostProcessCoordinator - æ”¯æŒè·³è¿‡ç¿»è¯‘

**æ–‡ä»¶**ï¼š`postprocess-coordinator.ts`

**æ”¹åŠ¨ä½ç½®**ï¼šç¿»è¯‘é˜¶æ®µï¼ˆç¬¬312-396è¡Œï¼‰

```typescript
// Stage 2: ç¿»è¯‘ï¼ˆå”¯ä¸€ NMT å…¥å£ï¼‰
let translationResult: TranslationStageResult = {
  translatedText: '',
};

// æ£€æŸ¥æ˜¯å¦éœ€è¦ç¿»è¯‘
const shouldTranslate = job.pipeline?.use_nmt !== false;  // é»˜è®¤ trueï¼Œå¦‚æœæ˜ç¡®è®¾ç½®ä¸º false åˆ™è·³è¿‡

// å¦‚æœæ–‡æœ¬è¢«èšåˆï¼Œæˆ–è€… Pipeline NMT å·²ç¦ç”¨ï¼Œéœ€è¦ç¿»è¯‘
const needsTranslation = shouldTranslate && (
  aggregationResult.aggregationChanged || 
  !result.text_translated || 
  result.text_translated.trim().length === 0
);

if (needsTranslation && this.translationStage) {
  // ... åŸæœ‰ç¿»è¯‘é€»è¾‘
} else if (result.text_translated && shouldTranslate) {
  // ä½¿ç”¨ Pipeline çš„ç¿»è¯‘ç»“æœï¼ˆå¦‚æœå­˜åœ¨ä¸”æ–‡æœ¬æœªè¢«èšåˆï¼‰
  translationResult = {
    translatedText: result.text_translated,
    fromCache: false,
  };
} else {
  // å¦‚æœ use_nmt === falseï¼Œä¿æŒ translatedText ä¸ºç©º
  logger.info(
    { jobId: job.job_id, sessionId: job.session_id },
    'PostProcessCoordinator: NMT disabled by pipeline config, skipping translation'
  );
}
```

**å½±å“**ï¼š
- å¦‚æœ `use_nmt === false`ï¼Œè·³è¿‡ç¿»è¯‘
- `translatedText` ä¸ºç©ºå­—ç¬¦ä¸²
- TTS é˜¶æ®µä»ç„¶ä¼šæ‰§è¡Œï¼ˆä½†å¯èƒ½å› ä¸ºæ–‡æœ¬ä¸ºç©ºè€Œè·³è¿‡ï¼‰

---

### æ”¹åŠ¨3ï¼šPostProcessCoordinator - æ”¯æŒè·³è¿‡ TTS

**æ–‡ä»¶**ï¼š`postprocess-coordinator.ts`

**æ”¹åŠ¨ä½ç½®**ï¼šTTS é˜¶æ®µï¼ˆç¬¬405-450è¡Œï¼‰

```typescript
// Stage 4: TTS éŸ³é¢‘ç”Ÿæˆï¼ˆåœ¨ç¿»è¯‘å®Œæˆåï¼Œä½†åªåœ¨å»é‡æ£€æŸ¥é€šè¿‡æ—¶ç”Ÿæˆï¼‰
let ttsResult: TTSStageResult = {
  ttsAudio: '',
  ttsFormat: 'opus',  // å¼ºåˆ¶ä½¿ç”¨ opus æ ¼å¼
};

// æ£€æŸ¥æ˜¯å¦éœ€è¦ç”Ÿæˆ TTS
const shouldGenerateTTS = job.pipeline?.use_tts !== false && dedupResult.shouldSend;  // é»˜è®¤ trueï¼Œå¦‚æœæ˜ç¡®è®¾ç½®ä¸º false åˆ™è·³è¿‡

if (shouldGenerateTTS && this.ttsStage) {
  // ... åŸæœ‰ TTS é€»è¾‘
} else {
  logger.info(
    { 
      jobId: job.job_id, 
      sessionId: job.session_id,
      useTts: job.pipeline?.use_tts,
      shouldSend: dedupResult.shouldSend
    },
    'PostProcessCoordinator: TTS disabled by pipeline config or dedup check failed, skipping TTS'
  );
}
```

**å½±å“**ï¼š
- å¦‚æœ `use_tts === false`ï¼Œè·³è¿‡ TTS
- `ttsAudio` ä¸ºç©ºå­—ç¬¦ä¸²
- ç»“æœä»ç„¶ä¼šå‘é€ï¼ˆä½† `tts_audio` ä¸ºç©ºï¼‰

---

### æ”¹åŠ¨4ï¼šTTSStage - æ”¯æŒè·³è¿‡ TTS

**æ–‡ä»¶**ï¼š`tts-stage.ts`

**æ”¹åŠ¨ä½ç½®**ï¼š`process()` æ–¹æ³•å¼€å§‹å¤„

```typescript
async process(
  job: JobAssignMessage,
  translatedText: string
): Promise<TTSStageResult> {
  const startTime = Date.now();

  // æ£€æŸ¥æ˜¯å¦éœ€è¦ç”Ÿæˆ TTS
  if (job.pipeline?.use_tts === false) {
    logger.info(
      { jobId: job.job_id, sessionId: job.session_id },
      'TTSStage: TTS disabled by pipeline config, skipping TTS'
    );
    return {
      ttsAudio: '',
      ttsFormat: 'opus',
    };
  }

  // æ£€æŸ¥æ˜¯å¦éœ€è¦ç”Ÿæˆ TTSï¼ˆæ–‡æœ¬ä¸ºç©ºï¼‰
  if (isEmptyText(translatedText)) {
    // ... åŸæœ‰é€»è¾‘
  }

  // ... åŸæœ‰é€»è¾‘
}
```

**å½±å“**ï¼š
- å¦‚æœ `use_tts === false`ï¼Œç›´æ¥è¿”å›ç©ºç»“æœ
- é¿å…ä¸å¿…è¦çš„æœåŠ¡è°ƒç”¨

---

### æ”¹åŠ¨5ï¼šInferenceService - æ”¯æŒè·³è¿‡ ASR

**æ–‡ä»¶**ï¼š`inference-service.ts`

**æ”¹åŠ¨ä½ç½®**ï¼š`processJob()` æ–¹æ³•ä¸­ï¼Œè°ƒç”¨ PipelineOrchestrator ä¹‹å‰

```typescript
async processJob(
  job: JobAssignMessage,
  partialCallback?: PartialResultCallback
): Promise<JobResult> {
  // é¦–æ¬¡ä»»åŠ¡æ£€æŸ¥
  if (this.currentJobs.size === 0) {
    await this.waitForServicesReady();
    if (this.onTaskStartCallback) {
      this.onTaskStartCallback();
    }
  }

  // æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰§è¡Œ ASR
  if (job.pipeline?.use_asr === false) {
    logger.info(
      { jobId: job.job_id, sessionId: job.session_id },
      'InferenceService: ASR disabled by pipeline config, returning empty result'
    );
    return {
      text_asr: '',
      text_translated: '',
      tts_audio: '',
      tts_format: 'pcm16',
    };
  }

  // æœåŠ¡ç«¯ç‚¹åˆ·æ–°ï¼ˆå¸¦ç¼“å­˜ï¼‰
  await this.taskRouter.refreshServiceEndpoints();

  // ... åŸæœ‰é€»è¾‘
}
```

**å½±å“**ï¼š
- å¦‚æœ `use_asr === false`ï¼Œç›´æ¥è¿”å›ç©ºç»“æœ
- è·³è¿‡ PipelineOrchestrator è°ƒç”¨
- åç»­çš„ PostProcessCoordinator ä»ç„¶ä¼šæ‰§è¡Œï¼ˆä½†å¯èƒ½å› ä¸ºæ–‡æœ¬ä¸ºç©ºè€Œè·³è¿‡æŸäº›é˜¶æ®µï¼‰

---

## æ”¹åŠ¨æ€»ç»“

### éœ€è¦æ”¹åŠ¨çš„æ–‡ä»¶ï¼ˆ5ä¸ªï¼‰

1. âœ… **PipelineOrchestrator** (`pipeline-orchestrator.ts`)
   - æ£€æŸ¥ `job.pipeline.use_asr`
   - å¦‚æœ `false`ï¼Œè¿”å›ç©ºç»“æœ

2. âœ… **PostProcessCoordinator** (`postprocess-coordinator.ts`)
   - æ£€æŸ¥ `job.pipeline.use_nmt`ï¼ˆç¿»è¯‘é˜¶æ®µï¼‰
   - æ£€æŸ¥ `job.pipeline.use_tts`ï¼ˆTTS é˜¶æ®µï¼‰

3. âœ… **TTSStage** (`tts-stage.ts`)
   - æ£€æŸ¥ `job.pipeline.use_tts`
   - å¦‚æœ `false`ï¼Œè¿”å›ç©ºç»“æœ

4. âœ… **InferenceService** (`inference-service.ts`)
   - æ£€æŸ¥ `job.pipeline.use_asr`
   - å¦‚æœ `false`ï¼Œè¿”å›ç©ºç»“æœï¼ˆå¯é€‰ï¼Œå› ä¸º PipelineOrchestrator å·²ç»å¤„ç†ï¼‰

5. âš ï¸ **JobProcessor** (`node-agent-job-processor.ts`)
   - å¯èƒ½éœ€è¦æ ¹æ® `pipeline` å­—æ®µå†³å®šæ˜¯å¦è°ƒç”¨ PostProcessCoordinatorï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

### æ”¹åŠ¨å¤æ‚åº¦

**è¯„ä¼°**ï¼šğŸŸ¢ **ä½å¤æ‚åº¦**

- **æ”¹åŠ¨æ–‡ä»¶æ•°**ï¼š5ä¸ªæ–‡ä»¶
- **æ”¹åŠ¨ä»£ç è¡Œæ•°**ï¼šçº¦ 50-80 è¡Œ
- **æ”¹åŠ¨ç±»å‹**ï¼šæ·»åŠ æ¡ä»¶åˆ¤æ–­ï¼Œä¸æ”¹å˜ç°æœ‰é€»è¾‘
- **é£é™©**ï¼šä½ï¼ˆå‘åå…¼å®¹ï¼Œé»˜è®¤è¡Œä¸ºä¸å˜ï¼‰

---

## å®ç°æ­¥éª¤

### æ­¥éª¤1ï¼šPipelineOrchestrator æ”¯æŒè·³è¿‡ ASR

1. åœ¨ `processJob()` å¼€å§‹å¤„æ·»åŠ  `use_asr` æ£€æŸ¥
2. å¦‚æœ `false`ï¼Œè¿”å›ç©ºç»“æœ
3. æ·»åŠ æ—¥å¿—è®°å½•

### æ­¥éª¤2ï¼šPostProcessCoordinator æ”¯æŒè·³è¿‡ç¿»è¯‘

1. åœ¨ç¿»è¯‘é˜¶æ®µæ·»åŠ  `use_nmt` æ£€æŸ¥
2. å¦‚æœ `false`ï¼Œè·³è¿‡ç¿»è¯‘é€»è¾‘
3. ä¿æŒ `translatedText` ä¸ºç©ºå­—ç¬¦ä¸²
4. æ·»åŠ æ—¥å¿—è®°å½•

### æ­¥éª¤3ï¼šPostProcessCoordinator æ”¯æŒè·³è¿‡ TTS

1. åœ¨ TTS é˜¶æ®µæ·»åŠ  `use_tts` æ£€æŸ¥
2. å¦‚æœ `false`ï¼Œè·³è¿‡ TTS é€»è¾‘
3. ä¿æŒ `ttsAudio` ä¸ºç©ºå­—ç¬¦ä¸²
4. æ·»åŠ æ—¥å¿—è®°å½•

### æ­¥éª¤4ï¼šTTSStage æ”¯æŒè·³è¿‡ TTS

1. åœ¨ `process()` å¼€å§‹å¤„æ·»åŠ  `use_tts` æ£€æŸ¥
2. å¦‚æœ `false`ï¼Œç›´æ¥è¿”å›ç©ºç»“æœ
3. æ·»åŠ æ—¥å¿—è®°å½•

### æ­¥éª¤5ï¼šInferenceService æ”¯æŒè·³è¿‡ ASRï¼ˆå¯é€‰ï¼‰

1. åœ¨ `processJob()` ä¸­æ·»åŠ  `use_asr` æ£€æŸ¥
2. å¦‚æœ `false`ï¼Œè¿”å›ç©ºç»“æœï¼ˆå¯é€‰ï¼Œå› ä¸º PipelineOrchestrator å·²ç»å¤„ç†ï¼‰

---

## æµ‹è¯•åœºæ™¯

### åœºæ™¯1ï¼šåªæ‰§è¡Œ ASR
```json
{
  "pipeline": {
    "use_asr": true,
    "use_nmt": false,
    "use_tts": false
  }
}
```
**é¢„æœŸ**ï¼š
- âœ… æ‰§è¡Œ ASRï¼Œè¿”å› `text_asr`
- âœ… è·³è¿‡ç¿»è¯‘ï¼Œ`text_translated` ä¸ºç©º
- âœ… è·³è¿‡ TTSï¼Œ`tts_audio` ä¸ºç©º

### åœºæ™¯2ï¼šåªæ‰§è¡Œ ASR + NMT
```json
{
  "pipeline": {
    "use_asr": true,
    "use_nmt": true,
    "use_tts": false
  }
}
```
**é¢„æœŸ**ï¼š
- âœ… æ‰§è¡Œ ASRï¼Œè¿”å› `text_asr`
- âœ… æ‰§è¡Œç¿»è¯‘ï¼Œè¿”å› `text_translated`
- âœ… è·³è¿‡ TTSï¼Œ`tts_audio` ä¸ºç©º

### åœºæ™¯3ï¼šæ‰§è¡Œå®Œæ•´æµç¨‹
```json
{
  "pipeline": {
    "use_asr": true,
    "use_nmt": true,
    "use_tts": true
  }
}
```
**é¢„æœŸ**ï¼š
- âœ… æ‰§è¡Œ ASRï¼Œè¿”å› `text_asr`
- âœ… æ‰§è¡Œç¿»è¯‘ï¼Œè¿”å› `text_translated`
- âœ… æ‰§è¡Œ TTSï¼Œè¿”å› `tts_audio`

### åœºæ™¯4ï¼šè·³è¿‡ ASRï¼ˆè¾¹ç¼˜æƒ…å†µï¼‰
```json
{
  "pipeline": {
    "use_asr": false,
    "use_nmt": true,
    "use_tts": true
  }
}
```
**é¢„æœŸ**ï¼š
- âœ… è·³è¿‡ ASRï¼Œ`text_asr` ä¸ºç©º
- âœ… è·³è¿‡ç¿»è¯‘ï¼ˆå› ä¸ºæ²¡æœ‰ ASR æ–‡æœ¬ï¼‰ï¼Œ`text_translated` ä¸ºç©º
- âœ… è·³è¿‡ TTSï¼ˆå› ä¸ºæ²¡æœ‰ç¿»è¯‘æ–‡æœ¬ï¼‰ï¼Œ`tts_audio` ä¸ºç©º

---

## éŸ³è‰²é…éŸ³åŠŸèƒ½æ‰©å±•

### å½“å‰ TTS å‚æ•°

æŸ¥çœ‹ `TTSTask` æ¥å£ï¼Œäº†è§£å½“å‰æ”¯æŒçš„ TTS å‚æ•°ï¼š

```typescript
interface TTSTask {
  text: string;
  tgt_lang: string;
  voice_id?: string;  // éŸ³è‰²ID
  emotion?: string;   // æƒ…æ„Ÿ
  speech_rate?: number;  // è¯­é€Ÿ
  voice_style?: string;  // éŸ³è‰²é£æ ¼
  // ...
}
```

### æ‰©å±•æ–¹æ¡ˆ

å¦‚æœéœ€è¦æ”¯æŒæ›´å¤šéŸ³è‰²é…éŸ³å‚æ•°ï¼Œå¯ä»¥åœ¨ `JobAssignMessage` ä¸­æ·»åŠ ï¼š

```typescript
export interface JobAssignMessage {
  // ... ç°æœ‰å­—æ®µ
  pipeline: {
    use_asr: boolean;
    use_nmt: boolean;
    use_tts: boolean;
  };
  tts_config?: {  // æ–°å¢ï¼šTTS é…ç½®
    voice_id?: string;
    emotion?: string;
    speech_rate?: number;
    voice_style?: string;
    // ... å…¶ä»– TTS å‚æ•°
  };
}
```

**æ”¹åŠ¨**ï¼š
1. æ›´æ–° `JobAssignMessage` æ¥å£å®šä¹‰ï¼ˆ3ä¸ªæ–‡ä»¶ï¼‰
2. åœ¨ `TTSStage.process()` ä¸­ä¼ é€’ `job.tts_config` åˆ° `TTSTask`
3. åœ¨ `TaskRouter.routeTTSTask()` ä¸­ä½¿ç”¨è¿™äº›å‚æ•°

---

## å®ç°æ€»ç»“

### å·²å®Œæˆçš„æ”¹åŠ¨

- **æ”¹åŠ¨æ–‡ä»¶æ•°**ï¼š7ä¸ªæ–‡ä»¶ï¼ˆ3ä¸ªæ¥å£å®šä¹‰ + 4ä¸ªæ ¸å¿ƒå®ç°ï¼‰
- **æ–°å¢æ–‡ä»¶æ•°**ï¼š1ä¸ªï¼ˆ`tone-stage.ts`ï¼‰
- **æ”¹åŠ¨ä»£ç è¡Œæ•°**ï¼šçº¦ 200-250 è¡Œ
- **æ”¹åŠ¨å¤æ‚åº¦**ï¼šğŸŸ¢ ä¸­ç­‰ï¼ˆæ·»åŠ æ¡ä»¶åˆ¤æ–­å’Œæ–°çš„ TONE é˜¶æ®µï¼‰
- **é£é™©**ï¼šğŸŸ¢ ä½ï¼ˆå‘åå…¼å®¹ï¼Œé»˜è®¤è¡Œä¸ºä¸å˜ï¼‰
- **æµ‹è¯•å·¥ä½œé‡**ï¼šä¸­ç­‰ï¼ˆéœ€è¦æµ‹è¯•å„ç§ pipeline ç»„åˆï¼‰

### å®ç°çš„åŠŸèƒ½

1. âœ… **ASR+NMT+TTS+TONE**ï¼šä¸ªäººä¸“å±è¯­éŸ³å¤„ç†ï¼ˆéŸ³è‰²é…éŸ³ï¼‰
2. âœ… **ASR+NMT+TTS**ï¼šè¯­éŸ³è½¬è¯‘
3. âœ… **ASR+NMT**ï¼šå­—å¹•æ¨¡å¼
4. âœ… **åªé€‰æ‹© NMT**ï¼šæ–‡æœ¬ç¿»è¯‘ï¼ˆä½¿ç”¨ `input_text` å­—æ®µï¼‰
5. âœ… **åªé€‰æ‹© ASR**ï¼šåªéœ€è¦ ASR è¯†åˆ«ï¼Œä¸éœ€è¦ç”Ÿæˆè¯­éŸ³
6. âœ… **è¯­ä¹‰ä¿®å¤ä¸ ASR ç»‘å®š**ï¼šå¦‚æœ `use_asr === true`ï¼Œå¿…é¡»æ‰§è¡Œè¯­ä¹‰ä¿®å¤

### å…³é”®å®ç°ç»†èŠ‚

1. **è¯­ä¹‰ä¿®å¤ä¸ ASR ç»‘å®š**ï¼š
   - å¦‚æœ `use_asr === true`ï¼Œå¿…é¡»æ‰§è¡Œè¯­ä¹‰ä¿®å¤
   - å¦‚æœ `use_asr === false`ï¼Œè·³è¿‡è¯­ä¹‰ä¿®å¤

2. **åªé€‰æ‹© NMT æ¨¡å¼**ï¼š
   - å¦‚æœ `use_asr === false` ä¸” `use_nmt === true`ï¼Œä½¿ç”¨ `job.input_text` ä½œä¸ºè¾“å…¥
   - éœ€è¦ web ç«¯åœ¨ `JobAssignMessage` ä¸­æä¾› `input_text` å­—æ®µ

3. **TONE éŸ³è‰²é…éŸ³**ï¼š
   - åœ¨ TTS ä¹‹åæ‰§è¡Œ TONE å¤„ç†
   - ä» `job.speaker_id` æˆ– `job.voice_id` æå–éŸ³è‰²ID
   - è¿”å›ç»“æœä¸­ `ttsAudio` ä¼˜å…ˆä½¿ç”¨ TONE éŸ³é¢‘ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

### å‘åå…¼å®¹

- å¦‚æœ `pipeline` å­—æ®µä¸å­˜åœ¨ï¼Œé»˜è®¤æ‰€æœ‰æœåŠ¡éƒ½å¯ç”¨ï¼ˆ`use_asr: true, use_nmt: true, use_tts: true, use_tone: false`ï¼‰
- å¦‚æœ `use_tone` å­—æ®µä¸å­˜åœ¨ï¼Œé»˜è®¤ä¸º `false`ï¼ˆä¸æ‰§è¡Œ TONEï¼‰

### æµ‹è¯•åœºæ™¯

éœ€è¦æµ‹è¯•çš„ pipeline ç»„åˆï¼š

1. âœ… `use_asr: true, use_nmt: true, use_tts: true, use_tone: false` - å®Œæ•´æµç¨‹ï¼ˆè¯­éŸ³è½¬è¯‘ï¼‰
2. âœ… `use_asr: true, use_nmt: true, use_tts: true, use_tone: true` - ä¸ªäººä¸“å±è¯­éŸ³å¤„ç†
3. âœ… `use_asr: true, use_nmt: true, use_tts: false, use_tone: false` - å­—å¹•æ¨¡å¼
4. âœ… `use_asr: true, use_nmt: false, use_tts: false, use_tone: false` - åª ASR
5. âœ… `use_asr: false, use_nmt: true, use_tts: false, use_tone: false` - åª NMTï¼ˆæ–‡æœ¬ç¿»è¯‘ï¼‰
6. âœ… `use_asr: false, use_nmt: true, use_tts: true, use_tone: false` - NMT + TTSï¼ˆè¾¹ç¼˜æƒ…å†µï¼‰
7. âœ… `use_asr: false, use_nmt: true, use_tts: true, use_tone: true` - NMT + TTS + TONEï¼ˆè¾¹ç¼˜æƒ…å†µï¼‰

### åç»­å»ºè®®

1. **Web ç«¯æ”¯æŒ**ï¼š
   - åœ¨ `JobAssignMessage` ä¸­æ·»åŠ  `input_text` å­—æ®µï¼ˆç”¨äºåªé€‰æ‹© NMT æ¨¡å¼ï¼‰
   - åœ¨ `JobAssignMessage` ä¸­æ·»åŠ  `speaker_id` æˆ– `voice_id` å­—æ®µï¼ˆç”¨äº TONE éŸ³è‰²é…éŸ³ï¼‰

2. **æ—¥å¿—è®°å½•**ï¼š
   - å·²åœ¨æ¯ä¸ªè·³è¿‡ç‚¹æ·»åŠ æ—¥å¿—ï¼Œæ–¹ä¾¿è°ƒè¯•å’Œç›‘æ§

3. **æµ‹è¯•è¦†ç›–**ï¼š
   - æµ‹è¯•æ‰€æœ‰ pipeline ç»„åˆï¼ˆ7ç§ç»„åˆï¼‰
   - æµ‹è¯•è¾¹ç¼˜æƒ…å†µï¼ˆå¦‚ `use_asr: false` æ—¶çš„æ–‡æœ¬ç¿»è¯‘æ¨¡å¼ï¼‰
