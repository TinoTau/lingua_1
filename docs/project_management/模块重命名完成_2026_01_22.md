# æ¨¡å—é‡å‘½åå®ŒæˆæŠ¥å‘Š

**å®Œæˆæ—¥æœŸ**: 2026å¹´1æœˆ22æ—¥  
**é‡å‘½åç±»å‹**: æ ¸å¿ƒæ¨¡å—é‡å‘½å  
**å½±å“èŒƒå›´**: è°ƒåº¦æœåŠ¡å™¨ (scheduler)

---

## ğŸ“‹ é‡å‘½åæ¦‚è¿°

å°†è°ƒåº¦æœåŠ¡å™¨ä¸­ä½¿ç”¨ä»£å·çš„æ¨¡å—åç§°æ”¹ä¸ºæ›´æœ‰æ„ä¹‰çš„åç§°ï¼Œæé«˜ä»£ç å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

### é‡å‘½åæ˜ å°„

| åŸåç§° | æ–°åç§° | è¯´æ˜ |
|--------|--------|------|
| `phase2.rs` | `redis_runtime.rs` | Redisè¿è¡Œæ—¶å’Œå¤šå®ä¾‹é€šä¿¡æ¨¡å— |
| `phase3.rs` | `pool_hashing.rs` | Poolé€‰æ‹©çš„Hashç®—æ³•æ¨¡å— |
| `phase2/` ç›®å½• | `redis_runtime/` ç›®å½• | åŒ…å«æ‰€æœ‰Redisè¿è¡Œæ—¶å­æ¨¡å— |
| `job_result_phase2.rs` | `job_result_routing.rs` | ä»»åŠ¡ç»“æœè·¯ç”±æ¨¡å— |

---

## âœ… å®Œæˆçš„å·¥ä½œ

### 1. æ–‡ä»¶å’Œç›®å½•é‡å‘½å âœ…

```bash
# ä¸»æ¨¡å—æ–‡ä»¶
central_server/scheduler/src/phase2.rs 
  â†’ central_server/scheduler/src/redis_runtime.rs

central_server/scheduler/src/phase3.rs 
  â†’ central_server/scheduler/src/pool_hashing.rs

# å­ç›®å½•
central_server/scheduler/src/phase2/ 
  â†’ central_server/scheduler/src/redis_runtime/

# ç‰¹æ®Šæ–‡ä»¶
websocket/node_handler/message/job_result/job_result_phase2.rs
  â†’ websocket/node_handler/message/job_result/job_result_routing.rs
```

### 2. æ¨¡å—å£°æ˜æ›´æ–° âœ…

**æ–‡ä»¶**: `src/lib.rs` å’Œ `src/main.rs`

```rust
// ä¿®æ”¹å‰
pub mod phase2;
pub mod phase3;

// ä¿®æ”¹å
pub mod redis_runtime;
pub mod pool_hashing;
```

### 3. Includeè·¯å¾„æ›´æ–° âœ…

**æ–‡ä»¶**: `src/redis_runtime.rs`

æ›´æ–°äº†17ä¸ª `include!` è¯­å¥ï¼š

```rust
// ä¿®æ”¹å‰
include!("phase2/runtime_init.rs");
include!("phase2/runtime_routing.rs");
// ... æ›´å¤šæ–‡ä»¶

// ä¿®æ”¹å
include!("redis_runtime/runtime_init.rs");
include!("redis_runtime/runtime_routing.rs");
// ... æ›´å¤šæ–‡ä»¶
```

### 4. å¯¼å…¥è·¯å¾„æ‰¹é‡æ›´æ–° âœ…

ä½¿ç”¨Pythonè„šæœ¬æ‰¹é‡æ›´æ–°äº† **30ä¸ªæ–‡ä»¶** ä¸­çš„å¯¼å…¥è·¯å¾„ï¼š

```rust
// ä¿®æ”¹å‰
use crate::phase2::RedisHandle;
use crate::phase2::Phase2Runtime;
crate::phase2::send_node_message_routed()

// ä¿®æ”¹å
use crate::redis_runtime::RedisHandle;
use crate::redis_runtime::Phase2Runtime;
crate::redis_runtime::send_node_message_routed()
```

```rust
// ä¿®æ”¹å‰
crate::phase3::pool_id_for_key()
crate::phase3::pick_index_for_key()

// ä¿®æ”¹å
crate::pool_hashing::pool_id_for_key()
crate::pool_hashing::pick_index_for_key()
```

### 5. å—å½±å“çš„æ–‡ä»¶åˆ—è¡¨

#### Redis Runtime ç›¸å…³ (29ä¸ªæ–‡ä»¶)

**æ ¸å¿ƒæ¨¡å—**:
- `src/app/startup.rs`
- `src/core/app_state.rs`
- `src/core/dispatcher/dispatcher.rs`
- `src/core/job_idempotency.rs`

**èŠ‚ç‚¹æ³¨å†Œå’Œç®¡ç†**:
- `src/node_registry/core.rs`
- `src/node_registry/node_redis_repository.rs`
- `src/node_registry/lockless/redis_client.rs`
- `src/node_registry/selection/node_selection.rs`

**Poolç®¡ç†**:
- `src/pool/pool_service.rs`
- `src/pool/node_index.rs`

**WebSocketæ¶ˆæ¯å¤„ç†**:
- `src/websocket/node_handler/message/job_progress.rs`
- `src/websocket/node_handler/message/job_result/*.rs` (6ä¸ªæ–‡ä»¶)
- `src/websocket/session_actor/actor/actor_finalize.rs`
- `src/websocket/session_message_handler/utterance.rs`

**è¶…æ—¶å’Œé”™è¯¯å¤„ç†**:
- `src/timeout/job_timeout.rs`
- `src/model_not_available/model_not_available.rs`

**æµ‹è¯•æ–‡ä»¶** (redis_runtime/tests/):
- `node_capacity_sync.rs`
- `node_snapshot.rs`
- `redis_unavailable_test.rs`
- `reservation_exception_test.rs`
- `reservation_redis.rs`

#### Pool Hashing ç›¸å…³ (1ä¸ªæ–‡ä»¶)

- `src/node_registry/selection/pool_selection.rs`

---

## ğŸ” éªŒè¯ç»“æœ

### ç¼–è¯‘éªŒè¯ âœ…

```bash
$ cargo check
   Compiling scheduler v0.1.0
    Checking scheduler v0.1.0
    Finished check [unoptimized + debuginfo] target(s)
```

**ç»“æœ**: âœ… ç¼–è¯‘é€šè¿‡ï¼Œæ— é”™è¯¯

**è­¦å‘Š**: ä»…æœ‰ä¸€ä¸ªæ— å…³çš„ä¾èµ–è­¦å‘Šï¼ˆredis v0.25.4å°†åœ¨æœªæ¥ç‰ˆæœ¬è¢«æ‹’ç»ï¼‰

---

## ğŸ“Š ç»Ÿè®¡æ•°æ®

| é¡¹ç›® | æ•°é‡ |
|------|------|
| é‡å‘½åçš„æ–‡ä»¶ | 4ä¸ª |
| é‡å‘½åçš„ç›®å½• | 1ä¸ª |
| æ›´æ–°çš„æºæ–‡ä»¶ | 30ä¸ª |
| æ›´æ–°çš„include!è¯­å¥ | 17ä¸ª |
| æ€»ä»£ç è¡Œæ•°å½±å“ | ~100è¡Œ |

---

## ğŸ’¡ é‡å‘½åçš„æ„ä¹‰

### 1. **redis_runtime.rs** (åŸ phase2.rs)

**æ–°åç§°çš„ä¼˜åŠ¿**:
- âœ… æ˜ç¡®è¡¨ç¤ºè¿™æ˜¯Redisè¿è¡Œæ—¶æ¨¡å—
- âœ… ä½“ç°äº†å¤šå®ä¾‹é€šä¿¡çš„æ ¸å¿ƒåŠŸèƒ½
- âœ… ä¸å®é™…åŠŸèƒ½ï¼ˆRedisè¿æ¥ã€æ¶ˆæ¯è·¯ç”±ï¼‰ä¸€è‡´

**æ ¸å¿ƒåŠŸèƒ½**:
- Redisè¿æ¥ç®¡ç† (`RedisHandle`)
- å¤šå®ä¾‹è°ƒåº¦å™¨é€šä¿¡ (`InterInstanceEvent`)
- ä»»åŠ¡çŠ¶æ€æœº (`JobFsmState`)
- è·¨å®ä¾‹æ¶ˆæ¯è·¯ç”±

### 2. **pool_hashing.rs** (åŸ phase3.rs)

**æ–°åç§°çš„ä¼˜åŠ¿**:
- âœ… æ˜ç¡®è¡¨ç¤ºè¿™æ˜¯Poolé€‰æ‹©ç®—æ³•æ¨¡å—
- âœ… ä½“ç°äº†ä½¿ç”¨Hashè¿›è¡Œè´Ÿè½½å‡è¡¡çš„æ ¸å¿ƒæ€æƒ³
- âœ… ä¸å®é™…åŠŸèƒ½ï¼ˆç¨³å®šHashã€ä¸¤çº§è°ƒåº¦ï¼‰ä¸€è‡´

**æ ¸å¿ƒåŠŸèƒ½**:
- ç¨³å®šHashç®—æ³• (FNV-1a)
- Poolé€‰æ‹©é€»è¾‘
- ç¯å½¢æ¢æµ‹é¡ºåº
- ä¸¤çº§è°ƒåº¦ç®—æ³•

### 3. **job_result_routing.rs** (åŸ job_result_phase2.rs)

**æ–°åç§°çš„ä¼˜åŠ¿**:
- âœ… æ˜ç¡®è¡¨ç¤ºè¿™æ˜¯ä»»åŠ¡ç»“æœè·¯ç”±æ¨¡å—
- âœ… æ¶ˆé™¤äº†ä¸phase2çš„ç›´æ¥å…³è”
- âœ… æ›´ç¬¦åˆåŠŸèƒ½è¯­ä¹‰

---

## ğŸ› ï¸ ä½¿ç”¨çš„å·¥å…·

### 1. PowerShell å‘½ä»¤
- æ–‡ä»¶å’Œç›®å½•é‡å‘½å

### 2. Python æ‰¹é‡æ›¿æ¢è„šæœ¬
```python
# scripts/maintenance/rename_phase_modules.py
# è‡ªåŠ¨æŸ¥æ‰¾å¹¶æ›¿æ¢æ‰€æœ‰Rustæºæ–‡ä»¶ä¸­çš„å¼•ç”¨
```

### 3. æ‰‹åŠ¨ç¼–è¾‘
- æ¨¡å—å£°æ˜æ›´æ–°
- ç‰¹æ®Šæ–‡ä»¶é‡å‘½å

---

## ğŸ“ åç»­å»ºè®®

### 1. æ–‡æ¡£æ›´æ–°

éœ€è¦æ›´æ–°ä»¥ä¸‹æ–‡æ¡£ä¸­æåˆ° phase2/phase3 çš„éƒ¨åˆ†ï¼š
- æ¶æ„è®¾è®¡æ–‡æ¡£
- å¼€å‘æŒ‡å—
- APIæ–‡æ¡£
- æ³¨é‡Šå’ŒTODO

### 2. è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

å¯ä»¥è€ƒè™‘è¿›ä¸€æ­¥é‡å‘½åä¸€äº›ç±»å‹ï¼š

```rust
// Phase2Runtime å¯ä»¥æ”¹ä¸º RedisRuntime
pub struct Phase2Runtime { ... }
  â†’ pub struct RedisRuntime { ... }

// Phase3PoolConfig å¯ä»¥æ”¹ä¸º PoolHashingConfig  
pub struct Phase3PoolConfig { ... }
  â†’ pub struct PoolHashingConfig { ... }
```

### 3. æµ‹è¯•æ¢å¤

`redis_runtime.rs` ä¸­çš„æµ‹è¯•è¢«æ³¨é‡Šäº†ï¼š

```rust
// æš‚æ—¶å±è”½æ‰€æœ‰æµ‹è¯•ï¼ˆä¾èµ–æ—§çš„ APIï¼‰
// TODO: æ›´æ–°æµ‹è¯•ä»¥åŒ¹é…æ–°æ¶æ„
```

å»ºè®®åœ¨æœªæ¥æ¢å¤å¹¶æ›´æ–°è¿™äº›æµ‹è¯•ã€‚

---

## ğŸ¯ å½±å“åˆ†æ

### å¯¹ç°æœ‰åŠŸèƒ½çš„å½±å“

**æ— åŠŸèƒ½å½±å“** âœ…
- è¿™æ˜¯çº¯ç²¹çš„é‡å‘½åæ“ä½œ
- ä¸æ”¹å˜ä»»ä½•ä¸šåŠ¡é€»è¾‘
- ä¸å½±å“Redisæ•°æ®ç»“æ„
- ä¸å½±å“WebSocketåè®®

### å¯¹å¼€å‘çš„å½±å“

**æ­£é¢å½±å“** âœ…
- ä»£ç æ›´æ˜“è¯»
- æ–°å¼€å‘è€…æ›´å®¹æ˜“ç†è§£æ¨¡å—ç”¨é€”
- å‡å°‘äº†"phase2/phase3æ˜¯ä»€ä¹ˆï¼Ÿ"çš„å›°æƒ‘
- ç¬¦åˆè¯­ä¹‰åŒ–å‘½ååŸåˆ™

### å¯¹éƒ¨ç½²çš„å½±å“

**æ— éƒ¨ç½²å½±å“** âœ…
- ä»…æ¶‰åŠæºç å˜æ›´
- ä¸å½±å“ç¼–è¯‘äº§ç‰©
- ä¸éœ€è¦æ•°æ®è¿ç§»
- ä¸éœ€è¦é…ç½®å˜æ›´

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

- [x] é‡å‘½å phase2.rs â†’ redis_runtime.rs
- [x] é‡å‘½å phase3.rs â†’ pool_hashing.rs  
- [x] é‡å‘½å phase2/ ç›®å½• â†’ redis_runtime/ ç›®å½•
- [x] æ›´æ–° lib.rs å’Œ main.rs ä¸­çš„æ¨¡å—å£°æ˜
- [x] æ›´æ–° redis_runtime.rs ä¸­çš„ include! è·¯å¾„
- [x] æ‰¹é‡æ›´æ–°æ‰€æœ‰æ–‡ä»¶ä¸­çš„ use è¯­å¥
- [x] é‡å‘½å job_result_phase2.rs â†’ job_result_routing.rs
- [x] éªŒè¯ç¼–è¯‘é€šè¿‡
- [x] åˆ›å»ºé‡å‘½åæŠ¥å‘Šæ–‡æ¡£

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Redisç›´æŸ¥æ¶æ„æ–‡æ¡£](../../central_server/docs/scheduler/redis_architecture/)
- [Poolç³»ç»Ÿæ–‡æ¡£](../../central_server/docs/scheduler/pool_system/)
- [è°ƒåº¦æœåŠ¡å™¨æ¶æ„](../../central_server/docs/scheduler/ARCHITECTURE.md)

---

**æ‰§è¡Œäººå‘˜**: AI Assistant  
**å®¡æ ¸çŠ¶æ€**: å·²å®Œæˆ  
**ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2026-01-22

---

## é™„å½•ï¼šæ‰¹é‡æ›¿æ¢è„šæœ¬

è„šæœ¬ä½ç½®: `scripts/maintenance/rename_phase_modules.py`

è¯¥è„šæœ¬è‡ªåŠ¨å®Œæˆäº†ä»¥ä¸‹æ›¿æ¢ï¼š
- `use crate::phase2::` â†’ `use crate::redis_runtime::`
- `use crate::phase3::` â†’ `use crate::pool_hashing::`
- `crate::phase2::` â†’ `crate::redis_runtime::`
- `crate::phase3::` â†’ `crate::pool_hashing::`

æˆåŠŸæ›´æ–°äº†30ä¸ªæ–‡ä»¶ï¼Œè·³è¿‡äº†130ä¸ªæ— å…³æ–‡ä»¶ã€‚
