# 下一步开发内容

## 当前完成状态

### ✅ 已完成的功能

1. **Gate-A (Context Reset)** ✅
   - SessionContextManager 已完整实现
   - 单元测试全部通过（9个测试）

2. **Gate-B (Rerun Metrics)** ✅
   - TaskRouter.getRerunMetrics() 已实现
   - 单元测试全部通过（4个测试）

3. **OBS-1: 埋点指标** ✅
   - ASR 端到端延迟（p50/p95/p99）
   - 语言置信度分布统计
   - 坏段检测率
   - 重跑触发率

4. **OBS-2: reason_codes 和 quality_score 透传** ✅
   - 接口定义已更新（3个地方）
   - 节点端填充字段
   - 调度服务器端透传字段
   - 数据流：Node → Scheduler → Web Client

5. **OBS-3: 限频/超时机制配置** ✅
   - 配置结构已添加
   - 支持 max_rerun_count、rerun_timeout_ms、conference_mode_strict

6. **RERUN-2: Top-2 语言重跑** ✅
   - 已确认实现
   - 支持强制语言重跑
   - 支持超时保护

7. **Jest/Babel 配置修复** ✅
   - ts-jest 配置已修复
   - 所有单元测试通过

---

## 下一步开发建议

根据 `ASR_NEXT_PHASE_DEVELOPMENT_PLAN.md` 和 `ASR_P1_ENTRY_GATE_CHECKLIST.md`，建议按以下优先级进行：

### 优先级 1: 完善 RERUN-3 质量评分选择器（可选优化）

**当前状态**: 
- `qualityScore` 已实现，但使用的是简单的减法模式（从 1.0 开始减去）
- 开发计划中建议使用加权公式

**建议**:
- 如果当前实现已经能够正常工作，可以暂时不优化
- 如果发现质量评分不够准确，可以考虑优化为加权公式：
  ```typescript
  qualityScore = 
    baseScore * 0.3 +           // 基础分（文本长度）
    langProbScore * 0.3 +       // 语言置信度分
    garbagePenalty * 0.2 +      // 乱码惩罚
    segmentPenalty * 0.1 +      // segments 异常惩罚
    overlapPenalty * 0.1        // 重叠惩罚
  ```

**预计工期**: 0.5 天（如果需要优化）

---

### 优先级 2: 集成测试和端到端验证

**目标**: 确保所有功能在实际环境中正常工作

**需要验证的内容**:
1. **OBS-2 数据透传完整性**
   - 验证从 Node → Scheduler → Web Client 的数据流
   - 确认所有字段正确传递

2. **OBS-1 指标记录准确性**
   - 验证指标是否正确记录
   - 检查指标计算逻辑

3. **OBS-3 配置生效**
   - 验证配置是否正确加载
   - 测试 max_rerun_count 和 rerun_timeout_ms 是否生效

4. **RERUN-2 重跑逻辑**
   - 验证 Top-2 语言重跑是否正常工作
   - 测试质量评分选择器是否选择最佳结果

**预计工期**: 1-2 天

---

### 优先级 3: 性能优化和监控

**目标**: 确保新功能不影响系统性能

**需要关注的点**:
1. **延迟影响**
   - 监控重跑带来的延迟增量
   - 确保 p95 延迟增量在可接受范围内（< 200ms）

2. **资源消耗**
   - 监控重跑对 CPU/内存的影响
   - 确保不会导致资源耗尽

3. **触发率**
   - 监控重跑触发率
   - 确保会议室模式 < 5%，线下模式 < 10%

**预计工期**: 1 天

---

### 优先级 4: 文档和总结

**目标**: 完善文档，便于后续维护和扩展

**需要完成的内容**:
1. **API 文档**
   - 更新接口文档
   - 添加配置说明

2. **测试报告**
   - 整理测试结果
   - 记录已知问题和限制

3. **部署指南**
   - 配置说明
   - 监控指标说明

**预计工期**: 0.5 天

---

## 推荐开发顺序

1. **第一步**: 集成测试和端到端验证（优先级 2）
   - 确保所有功能在实际环境中正常工作
   - 发现并修复潜在问题

2. **第二步**: 性能优化和监控（优先级 3）
   - 确保系统性能不受影响
   - 建立监控机制

3. **第三步**: 完善 RERUN-3（优先级 1，如果需要）
   - 根据实际使用情况决定是否需要优化

4. **第四步**: 文档和总结（优先级 4）
   - 完善文档
   - 准备进入下一阶段

---

## 进入 P1 阶段的条件

根据 `ASR_P1_ENTRY_GATE_CHECKLIST.md`：

- ✅ **Gate-A**: Context Reset 真正生效 - 已完成
- ✅ **Gate-B**: Rerun 指标可观测 - 已完成
- ✅ **Gate-C**: P0.5 行为稳定性回归 - 已完成
- ✅ **Gate-D**: P1 触发样本可收集 - 已完成

**结论**: 所有 Gate 条件已满足，可以进入 P1 阶段开发。

---

## 建议

1. **先进行集成测试**，确保所有功能在实际环境中正常工作
2. **建立监控机制**，持续观察系统性能和指标
3. **根据实际使用情况**，决定是否需要优化 RERUN-3
4. **完善文档**，为后续开发做好准备

如果集成测试和性能验证都通过，可以考虑开始 P1 阶段的开发。

---

## 相关文档

- [未完成的改造任务清单](./PENDING_REFACTORING_TASKS.md) - 详细的待完成任务列表

