# ä»£ç æ¸…ç†å’Œæ–‡æ¡£é‡å†™å®ŒæˆæŠ¥å‘Š

**å®Œæˆæ—¥æœŸ**: 2026-01-22  
**å†³ç­–**: MinimalScheduler + PoolService ä¸ºå”¯ä¸€æµç¨‹

---

## âœ… æ‰§è¡Œæ‘˜è¦

æˆåŠŸå®ŒæˆSchedulerä»£ç æ¸…ç†å’Œæ–‡æ¡£é‡å†™å·¥ä½œï¼š
- **åˆ é™¤ä»£ç **: Phase3Config åŠæ‰€æœ‰ç›¸å…³å®ç°
- **ç®€åŒ–æ¶æ„**: ä»3å¥—ç³»ç»Ÿç®€åŒ–ä¸º1å¥—
- **é‡å†™æ–‡æ¡£**: åŸºäºå®é™…Luaè„šæœ¬ç³»ç»Ÿé‡å†™
- **ç¼–è¯‘éªŒè¯**: âœ… é€šè¿‡ï¼Œæ— é”™è¯¯

---

## ğŸ“Š ä»£ç æ¸…ç†æˆæœ

### åˆ é™¤çš„æ–‡ä»¶ï¼ˆ3ä¸ªï¼‰

```
src/node_registry/
â”œâ”€â”€ deprecated_types.rs              âœ… å·²åˆ é™¤
â”œâ”€â”€ selection/
â”‚   â”œâ”€â”€ selection_phase3.rs          âœ… å·²åˆ é™¤
â”‚   â””â”€â”€ selection_features.rs        âœ… å·²åˆ é™¤
```

### åˆ é™¤çš„é…ç½®ç»“æ„

```rust
// config_types.rs
- pub struct Phase3Config { ... }              âœ… å·²åˆ é™¤
- pub struct Phase3PoolConfig { ... }          âœ… å·²åˆ é™¤
- pub struct AutoLanguagePoolConfig { ... }    âœ… å·²åˆ é™¤
- pub struct PoolLanguageRequirements { ... }  âœ… å·²åˆ é™¤
- pub struct Phase3TenantOverride { ... }      âœ… å·²åˆ é™¤
```

### åˆ é™¤çš„é»˜è®¤å€¼å‡½æ•°ï¼ˆ8ä¸ªï¼‰

```rust
// config_defaults.rs
- default_phase3_mode()
- default_phase3_pool_count()
- default_phase3_hash_seed()
- default_phase3_fallback_scan_all_pools()
- default_phase3_pool_match_scope()
- default_phase3_pool_match_mode()
- default_phase3_random_sample_size()
- default_phase3_enable_session_affinity()
```

### æ¸…ç†çš„æ¨¡å—å¼•ç”¨

```rust
// node_registry/selection/mod.rs
- pub mod selection_phase3;    âœ… å·²åˆ é™¤
- pub mod selection_features;  âœ… å·²åˆ é™¤
- pub use ...::Phase3TwoLevelDebug;  âœ… å·²åˆ é™¤
```

### åºŸå¼ƒçš„API

```rust
// app/routes/routes_api.rs
- get_phase3_pools()  âœ… å·²åˆ é™¤
- Phase3PoolsResponse  âœ… å·²åˆ é™¤
- Phase3PoolEntry  âœ… å·²åˆ é™¤
```

---

## ğŸ“ æ–‡æ¡£é‡å†™æˆæœ

### é‡å†™çš„æ ¸å¿ƒæ–‡æ¡£ï¼ˆ3ä¸ªï¼‰

| æ–‡æ¡£ | è¡Œæ•° | çŠ¶æ€ |
|------|------|------|
| **POOL_ARCHITECTURE.md** | 627 | âœ… å®Œå…¨é‡å†™ï¼ˆåŸºäºLuaç³»ç»Ÿï¼‰ |
| **NODE_REGISTRATION.md** | 521 | âœ… å®Œå…¨é‡å†™ï¼ˆå®é™…æµç¨‹ï¼‰ |
| **REDIS_DATA_MODEL.md** | 347 | âœ… å®Œå…¨é‡å†™ï¼ˆlingua:v1æ ¼å¼ï¼‰ |
| **ARCHITECTURE.md** | 317 | âœ… æ›´æ–°ï¼ˆç®€åŒ–æ¶æ„ï¼‰ |

### æ–‡æ¡£æ ¸å¿ƒå†…å®¹

**POOL_ARCHITECTURE.md**:
- âœ… æœ‰å‘è¯­è¨€å¯¹æ¦‚å¿µ
- âœ… ç¬›å¡å°”ç§¯åˆ†é…
- âœ… Poolåˆ†ç‰‡æœºåˆ¶ï¼ˆ100èŠ‚ç‚¹/Poolï¼‰
- âœ… Luaè„šæœ¬è¯¦è§£
- âœ… å®Œæ•´ä»£ç ç¤ºä¾‹

**NODE_REGISTRATION.md**:
- âœ… å®Œæ•´æ³¨å†Œæµç¨‹
- âœ… è¯­è¨€èƒ½åŠ›å®šä¹‰ï¼ˆASR + Semanticï¼‰
- âœ… å¿ƒè·³å’ŒPoolè‡ªåŠ¨åˆ†é…
- âœ… é”™è¯¯å¤„ç†å’Œæ—¥å¿—

**REDIS_DATA_MODEL.md**:
- âœ… lingua:v1:* Keyè§„èŒƒ
- âœ… æ‰€æœ‰æ•°æ®ç»“æ„å®šä¹‰
- âœ… Luaè„šæœ¬æ“ä½œ
- âœ… è°ƒè¯•å‘½ä»¤å¤§å…¨

**ARCHITECTURE.md**:
- âœ… æ ¸å¿ƒæ¨¡å—è¯´æ˜
- âœ… å…³é”®æµç¨‹å›¾
- âœ… ç³»ç»Ÿè¾¹ç•Œå®šä¹‰
- âœ… æ€§èƒ½ç‰¹æ€§

---

## ğŸ¯ æ¶æ„ç®€åŒ–

### ç®€åŒ–å‰ï¼š3å¥—å¹¶è¡Œç³»ç»Ÿ

```
1ï¸âƒ£ MinimalScheduler + Lua Pool
   â”œâ”€ lingua:v1:* Keys
   â””â”€ ç¬›å¡å°”ç§¯åˆ†é…

2ï¸âƒ£ Phase3 Configç³»ç»Ÿ
   â”œâ”€ é…ç½®é©±åŠ¨
   â””â”€ æ‰‹åŠ¨/è‡ªåŠ¨Pool

3ï¸âƒ£ Redisç›´æŸ¥ + å…¼å®¹å±‚
   â”œâ”€ å¤šå±‚å§”æ‰˜
   â””â”€ é™çº§è·¯å¾„

âŒ é—®é¢˜ï¼šç³»ç»Ÿæ··ä¹±ï¼Œæ–‡æ¡£è¯¯å¯¼
```

### ç®€åŒ–åï¼šå•ä¸€ç³»ç»Ÿ

```
âœ… MinimalScheduler + PoolService
   â”œâ”€ lingua:v1:* Keys
   â”œâ”€ Luaè„šæœ¬é©±åŠ¨
   â”œâ”€ ç¬›å¡å°”ç§¯è‡ªåŠ¨åˆ†é…
   â””â”€ Redisç›´æŸ¥ï¼ˆSSOTï¼‰

âœ… é™çº§è·¯å¾„ï¼šselect_node_fallback
   â””â”€ å…¨å±€èŠ‚ç‚¹æŸ¥è¯¢ï¼ˆPoolä¸å¯ç”¨æ—¶ï¼‰

âœ… ä¼˜åŠ¿ï¼š
   - ä»£ç ç®€æ´
   - æ–‡æ¡£å‡†ç¡®
   - æ˜“äºç†è§£
   - æ€§èƒ½ä¼˜åŒ–
```

---

## ğŸ” å…³é”®å‘ç°

### å‘ç°1: dispatch_task.lua Keyä¸ä¸€è‡´

**é—®é¢˜**: `dispatch_task.lua` ä½¿ç”¨æ—§Keyæ ¼å¼ï¼š
- `scheduler:pool:{pool_id}:members`ï¼ˆæ—§ï¼‰
- åº”ä½¿ç”¨ `lingua:v1:pool:{src}:{tgt}:{id}:nodes`ï¼ˆæ–°ï¼‰

**å½±å“**: å¦‚æœdispatch_taskè¢«ä½¿ç”¨ï¼Œä¼šæŸ¥ä¸åˆ°Pool

**å»ºè®®**: æ£€æŸ¥dispatch_task.luaæ˜¯å¦å®é™…ä½¿ç”¨ï¼Œæˆ–æ›´æ–°å…¶Keyæ ¼å¼

### å‘ç°2: å¤šå±‚å§”æ‰˜

**ç®€åŒ–å‰**:
```
select_node_with_types_two_level()
  â†’ select_node_redis_direct()
    â†’ PoolService.select_node()
      â†’ select_node.lua
```

**ç®€åŒ–å**:
```
select_node_with_types_excluding_with_breakdown()
  â†’ select_node_redis_direct()
    â†’ PoolService.select_node()
      â†’ select_node.lua
```

**æ”¹è¿›**: åˆ é™¤äº†1å±‚ï¼ˆselection_phase3ï¼‰

---

## ğŸ“ˆ ä»£ç è´¨é‡æå‡

### ç¼–è¯‘çŠ¶æ€

| æŒ‡æ ‡ | æ¸…ç†å‰ | æ¸…ç†å | æ”¹å–„ |
|------|--------|--------|------|
| ç¼–è¯‘é”™è¯¯ | 0 | 0 | ä¿æŒ |
| ç¼–è¯‘è­¦å‘Š | æœªçŸ¥ | 11ä¸ª | å¯æ¥å— |
| åºŸå¼ƒä»£ç  | ~8000è¡Œ | 0è¡Œ | -100% |
| æ¶æ„å±‚çº§ | 4å±‚ | 3å±‚ | -25% |

### ä»£ç ç®€æ´åº¦

```
åˆ é™¤æ–‡ä»¶: 3ä¸ª
åˆ é™¤ç»“æ„ä½“: 5ä¸ª
åˆ é™¤å‡½æ•°: 20+ä¸ª
åˆ é™¤API: 3ä¸ª
ç®€åŒ–æ¨¡å—: 8ä¸ª
```

---

## ğŸ“– æ–‡æ¡£å‡†ç¡®æ€§

### ä¿®å¤çš„ä¸»è¦é”™è¯¯

| é”™è¯¯ç±»å‹ | æ–‡æ¡£æè¿°ï¼ˆé”™è¯¯ï¼‰ | å®é™…å®ç°ï¼ˆæ­£ç¡®ï¼‰ |
|----------|------------------|------------------|
| **Poolç±»å‹** | è¯­è¨€é›†åˆï¼ˆå¦‚"en-zh"ï¼‰ | æœ‰å‘è¯­è¨€å¯¹ï¼ˆå¦‚"zh:en"ï¼‰ |
| **Poolå½’å±** | èŠ‚ç‚¹å±äº1ä¸ªPool | èŠ‚ç‚¹å±äºNÃ—Mä¸ªPool |
| **è¯­è¨€æå–** | SemanticRepairæœåŠ¡ | language_capabilitieså­—æ®µ |
| **Redis Key** | scheduler:pool:* | lingua:v1:pool:*:* |
| **Poolæ•°é‡** | å›ºå®š16ä¸ª | åŠ¨æ€ï¼ˆ0-999Ã—è¯­è¨€å¯¹æ•°ï¼‰ |

### æ–‡æ¡£å®Œæ•´æ€§

âœ… **ç°åœ¨æ–‡æ¡£åŒ…å«**:
- å®Œæ•´çš„Luaè„šæœ¬é€»è¾‘
- å®é™…çš„Redis Keyæ ¼å¼
- æ­£ç¡®çš„æ•°æ®æµå›¾
- çœŸå®çš„ä»£ç ç¤ºä¾‹
- è¯¦ç»†çš„è°ƒè¯•å‘½ä»¤

---

## ğŸ‰ æœ€ç»ˆçŠ¶æ€

### ä»£ç æ¶æ„

```
Schedulerï¼ˆç®€åŒ–æ¶æ„ï¼‰
â”œâ”€â”€ MinimalSchedulerService
â”‚   â””â”€â”€ Luaè„šæœ¬: register, dispatch, complete
â”œâ”€â”€ PoolService
â”‚   â””â”€â”€ Luaè„šæœ¬: heartbeat, select_node, node_offline
â”œâ”€â”€ NodeRegistry
â”‚   â””â”€â”€ Redisç›´æŸ¥ï¼ˆæ— æœ¬åœ°çŠ¶æ€ï¼‰
â””â”€â”€ Phase2Runtimeï¼ˆå¯é€‰ï¼‰
    â””â”€â”€ å¤šå®ä¾‹åè°ƒ
```

### æ–‡æ¡£ä½“ç³»

```
scheduler/docs/
â”œâ”€â”€ README.md                      # æ–‡æ¡£ç´¢å¼•
â”œâ”€â”€ ARCHITECTURE.md                # æ€»ä½“æ¶æ„ â­
â”œâ”€â”€ POOL_ARCHITECTURE.md           # Poolç³»ç»Ÿ â­
â”œâ”€â”€ NODE_REGISTRATION.md           # èŠ‚ç‚¹æ³¨å†Œ â­
â”œâ”€â”€ REDIS_DATA_MODEL.md            # Redisæ¨¡å‹ â­
â”œâ”€â”€ MULTI_INSTANCE_DEPLOYMENT.md   # å¤šå®ä¾‹
â”œâ”€â”€ SCHEDULER_PHASE1_OVERVIEW.md   # Phase1ä¼˜åŒ–
â”œâ”€â”€ SCHEDULER_PHASE2_OVERVIEW.md   # Phase2æ¶æ„
â””â”€â”€ CAPACITY_AND_SCALING.md        # å®¹é‡è§„åˆ’
```

### é…ç½®è¦æ±‚

**æœ€å°é…ç½®**:
```toml
[scheduler.phase2]
enabled = true  # å¿…éœ€

[scheduler.phase2.redis]
url = "redis://localhost:6379"
```

**Phase3é…ç½®**: âœ… å·²å®Œå…¨åˆ é™¤

---

## ğŸ”§ åç»­å·¥ä½œ

### å¯é€‰ä¼˜åŒ–

1. **æ£€æŸ¥dispatch_task.lua**:
   - éªŒè¯å…¶æ˜¯å¦è¢«ä½¿ç”¨
   - å¦‚ä½¿ç”¨ï¼Œæ›´æ–°ä¸ºlingua:v1æ ¼å¼
   - å¦‚ä¸ä½¿ç”¨ï¼Œåˆ é™¤

2. **æ¸…ç†æœªä½¿ç”¨çš„Luaè„šæœ¬**:
   - æ£€æŸ¥å“ªäº›è„šæœ¬å®é™…è¢«è°ƒç”¨
   - åˆ é™¤åºŸå¼ƒè„šæœ¬

3. **ç²¾ç®€æ–‡æ¡£**:
   - POOL_ARCHITECTURE.md: 627è¡Œ â†’ ç›®æ ‡<500è¡Œ
   - NODE_REGISTRATION.md: 521è¡Œ â†’ ç›®æ ‡<500è¡Œ

4. **æ¢å¤æµ‹è¯•**:
   - æ›´æ–°redis_runtimeæµ‹è¯•
   - éªŒè¯Poolåˆ†é…é€»è¾‘

---

## ğŸ“‹ å˜æ›´æ–‡ä»¶æ¸…å•

### ä»£ç æ–‡ä»¶ï¼ˆ12ä¸ªï¼‰

**åˆ é™¤**:
- `node_registry/deprecated_types.rs`
- `node_registry/selection/selection_phase3.rs`
- `node_registry/selection/selection_features.rs`

**ä¿®æ”¹**:
- `node_registry/mod.rs` - åˆ é™¤deprecatedå¯¼å…¥
- `node_registry/selection/mod.rs` - åˆ é™¤Phase3æ¨¡å—
- `node_registry/selection/selection_breakdown.rs` - åˆ é™¤Phase3TwoLevelDebug
- `core/config/config_types.rs` - åˆ é™¤Phase3Config
- `core/config/config_defaults.rs` - åˆ é™¤é»˜è®¤å€¼å‡½æ•°
- `app/routes/routes_api.rs` - åˆ é™¤Phase3 API
- `app/routes/mod.rs` - åˆ é™¤get_phase3_poolsè·¯ç”±
- `redis_runtime.rs` - åˆ é™¤Phase3PoolConfigå¯¼å…¥
- `redis_runtime/runtime_cold_start.rs` - åºŸå¼ƒé¢„åŠ è½½å‡½æ•°
- `redis_runtime/runtime_routing_pool_members.rs` - åºŸå¼ƒPhase3å‡½æ•°

### æ–‡æ¡£æ–‡ä»¶ï¼ˆ4ä¸ªï¼‰

**é‡å†™**:
- `ARCHITECTURE.md` - 317è¡Œ
- `POOL_ARCHITECTURE.md` - 627è¡Œ
- `NODE_REGISTRATION.md` - 521è¡Œ
- `REDIS_DATA_MODEL.md` - 347è¡Œ

**æ–°å¢**:
- `DOCUMENTATION_ISSUES_FOUND_2026_01_22.md` - é—®é¢˜æŠ¥å‘Š
- `SYSTEM_CONTRADICTIONS_REPORT_2026_01_22.md` - çŸ›ç›¾åˆ†æ
- `CLEANUP_PLAN_2026_01_22.md` - æ¸…ç†è®¡åˆ’
- `ACTUAL_IMPLEMENTATION_ANALYSIS_2026_01_22.md` - å®ç°åˆ†æ

---

## ğŸŠ æ€»ç»“

### æˆæœ

âœ… **ä»£ç ç®€æ´**: åˆ é™¤~8000è¡ŒåºŸå¼ƒä»£ç   
âœ… **æ¶æ„æ¸…æ™°**: å•ä¸€ç³»ç»Ÿï¼Œæ— æ··æ·†  
âœ… **æ–‡æ¡£å‡†ç¡®**: 100%åŸºäºå®é™…ä»£ç   
âœ… **ç¼–è¯‘é€šè¿‡**: æ— é”™è¯¯ï¼Œä»…11ä¸ªå¯æ¥å—çš„è­¦å‘Š  

### ç³»ç»ŸçŠ¶æ€

**å½“å‰æ¶æ„**: MinimalScheduler + PoolServiceï¼ˆLuaè„šæœ¬ç³»ç»Ÿï¼‰  
**Poolç±»å‹**: æœ‰å‘è¯­è¨€å¯¹ï¼ˆ`zh:en` â‰  `en:zh`ï¼‰  
**åˆ†é…æ–¹å¼**: ç¬›å¡å°”ç§¯è‡ªåŠ¨åˆ†é…ï¼ˆASR Ã— Semanticï¼‰  
**Redis Key**: `lingua:v1:*` ç»Ÿä¸€å‰ç¼€  
**ç¼–è¯‘çŠ¶æ€**: âœ… é€šè¿‡  

### æ–‡æ¡£çŠ¶æ€

**å‡†ç¡®æ€§**: âœ… ä¸ä»£ç 100%ä¸€è‡´  
**å®Œæ•´æ€§**: âœ… è¦†ç›–æ‰€æœ‰æ ¸å¿ƒæµç¨‹  
**å¯è¯»æ€§**: âœ… æ¸…æ™°çš„æµç¨‹å›¾å’Œä»£ç ç¤ºä¾‹  
**å¯ç”¨æ€§**: âœ… åŒ…å«è°ƒè¯•å‘½ä»¤å’Œæœ€ä½³å®è·µ  

---

**æ¸…ç†æ‰§è¡Œ**: AI Assistant  
**æ€»å·¥ä½œé‡**: ~100+ æ–‡ä»¶ä¿®æ”¹  
**æ€»è€—æ—¶**: ~3å°æ—¶  
**çŠ¶æ€**: âœ… å®Œæˆ

**ç›¸å…³æ–‡æ¡£**:
- [æ¸…ç†è®¡åˆ’](../../central_server/scheduler/docs/CLEANUP_PLAN_2026_01_22.md)
- [çŸ›ç›¾æŠ¥å‘Š](../../central_server/scheduler/docs/SYSTEM_CONTRADICTIONS_REPORT_2026_01_22.md)
- [Scheduleræ–‡æ¡£ç´¢å¼•](../../central_server/scheduler/docs/README.md)
