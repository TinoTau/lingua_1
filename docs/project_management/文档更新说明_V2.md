# 文档更新说明 - V2 版本

**更新日期**: 2026-01-22  
**参考文档**: [NODE_MANAGEMENT_FINAL_REFACTOR_NOTES_REVIEW_VERSION.md](./NODE_MANAGEMENT_FINAL_REFACTOR_NOTES_REVIEW_VERSION.md)

---

## ✅ 已完成的更新

### 1. 创建新的决策文档 V2

**文件**: [决策部门最终审议文档_新架构V2.md](./决策部门最终审议文档_新架构V2.md)

**新增内容**:

#### 📋 核心架构原则

- **原则 1: 单一真实来源（SSOT）** ⭐⭐⭐
  - 所有节点状态必须在 Redis
  - 本地结构只是"缓存"
  - 不可依赖本地状态做决策

- **原则 2: 去状态化（Stateless）** ⭐⭐⭐
  - 禁止维护本地 pool 索引
  - 禁止维护本地 pool_ids
  - 禁止维护本地语言索引

- **原则 3: 异常路径可预测**
  - Redis TTL 行为明确
  - 下线清理逻辑符合预期
  - 可追踪的快照

#### 🏗️ 架构分层

```
MinimalSchedulerService → 只做写（Redis）
PoolService / NodeIndex → 只做读（Redis）
SnapshotManager         → 无 Pool 状态（UI 用）
```

#### ⚠️ 待完成任务清单

**任务组 1: 删除本地状态** （高优先级）
- [ ] 删除 `NodeState.pool_ids`
- [ ] 删除 `NodeSnapshot.pool_ids`
- [ ] 删除任何 pool 相关本地缓存

**任务组 2: 调整节点管理逻辑**
- [ ] MinimalSchedulerService：取消本地 pool 更新
- [ ] ManagementRegistry：明确 `online` 字段语义
- [ ] SnapshotManager：从 Redis 查询 Pool 信息

#### 📊 分阶段部署建议

**阶段 1（立即）**: 部署已完成优化 ✅
- Redis Lua 原子操作
- 批量定期更新
- 代码清理

**阶段 2（3-5天）**: 完成节点管理重构 ⚠️
- 删除本地 pool_ids
- 职责分离
- UI 调整

**阶段 3（长期）**: 可选增强
- LangSet 多语言支持
- region × gpu_tier 分层

---

### 2. 更新导航文档

#### 更新文件 1: [请从这里开始.md](./请从这里开始.md)

- ✅ 指向新的 V2 版本
- ✅ 说明 V2 与旧版的区别
- ✅ 更新审批事项（增加 SSOT 原则）
- ✅ 更新分阶段部署说明

#### 更新文件 2: [决策部门文档索引.md](./决策部门文档索引.md)

- ✅ 添加 V2 版本到核心文档
- ✅ 添加节点管理重构方案的引用
- ✅ 标记旧版本为已过期

---

## 🔑 关键变化对比

### V1 vs V2

| 方面 | V1（已完成优化） | V2（整合重构方案） |
|------|------------------|-------------------|
| **架构原则** | 未明确 | ✅ SSOT + 去状态化 |
| **本地状态** | 部分保留 pool_ids | ✅ 明确要求删除 |
| **在线判定** | 未分离 | ✅ 职责分离（WebSocket vs 可调度） |
| **部署策略** | 全量部署 | ✅ 分阶段（立即 + 3-5天） |
| **风险评估** | 低风险 | ✅ 中风险（待完成任务） |
| **审批方式** | 一次性批准 | ✅ 分阶段批准 |

---

## 📚 文档结构

### 决策部门应该阅读的顺序

1. **[请从这里开始.md](./请从这里开始.md)** (1 分钟)
   - 快速导航

2. **[优化完成_请审阅.md](./优化完成_请审阅.md)** (3 分钟)
   - 已完成成果概览

3. **[决策部门最终审议文档_新架构V2.md](./决策部门最终审议文档_新架构V2.md)** (12 分钟) ⭐
   - **核心审批文档**
   - SSOT + 去状态化原则
   - 分阶段部署建议
   - 待完成任务清单

4. **[节点管理最终重构方案](./NODE_MANAGEMENT_FINAL_REFACTOR_NOTES_REVIEW_VERSION.md)** (10 分钟)
   - 技术参考文档
   - 详细设计说明

---

## 🎯 关键信息

### 已完成（可立即部署）✅

- Redis Lua 原子操作
- 批量定期更新
- 废弃方法清理
- 代码简化 35%
- 性能提升 30%
- 异步任务 -95%

**风险**: 🟢 低  
**建议**: 立即灰度部署

---

### 待完成（需 3-5 天开发）⚠️

- 删除本地 pool_ids
- 职责分离（在线状态）
- UI 调整（从 Redis 获取 Pool）
- 明确 ManagementRegistry 语义

**风险**: 🟡 中  
**建议**: 完成后再部署

---

### 可选增强（长期规划）⭐

- LangSet 多语言支持
- region × gpu_tier 分层
- 在线状态对账任务

**风险**: 🟢 低  
**时间**: 1-2 周

---

## 📝 审批建议

### 推荐方案：分阶段批准 ✅

#### 第一次审批（现在）

**批准内容**:
- ✅ 阶段 1：已完成优化的灰度部署
- ✅ 阶段 2：节点管理重构的开发计划（3-5 天）
- ✅ 资源投入

**签署位置**: [决策部门最终审议文档_新架构V2.md](./决策部门最终审议文档_新架构V2.md)

---

#### 第二次审批（3-5 天后）

**批准内容**:
- ✅ 阶段 2：节点管理重构的生产部署
- ✅ UI 调整验收
- ✅ 完整系统验证

---

### 不推荐方案：立即全量部署 ❌

**原因**:
- 仍存在双源冲突（Redis vs 本地 pool_ids）
- pool_ids 容易过期、误导
- 未来维护成本高

---

## ⚠️ 重要提醒

### 对决策部门

1. **阶段 1 可立即部署** ✅
   - 已完成优化
   - 低风险
   - 可快速回滚

2. **阶段 2 必须完成** ⚠️
   - 否则遗留技术债务
   - 状态不一致问题
   - 未来维护成本高

3. **推荐方案** ✅
   - 先部署阶段 1（立即）
   - 同时开发阶段 2（3-5 天）
   - 完成后部署阶段 2

---

### 对技术团队

1. **阶段 1 任务** ✅
   - 准备灰度部署
   - 监控指标
   - 回滚方案

2. **阶段 2 任务** ⚠️
   - 删除 `NodeState.pool_ids`
   - 删除 `NodeSnapshot.pool_ids`
   - 调整 UI（从 PoolService API 获取）
   - 明确 `ManagementRegistry.online` 语义
   - 实现职责分离

3. **时间估算** ⏱️
   - 开发：2-3 天
   - 测试：1 天
   - 部署：1 天
   - **总计：3-5 天**

---

## 📞 联系方式

**技术问题**: 技术团队  
**架构咨询**: 技术负责人  
**审批流程**: 项目经理

---

**更新完成**: ✅  
**状态**: 等待决策部门审批  
**建议**: 阅读 [决策部门最终审议文档_新架构V2.md](./决策部门最终审议文档_新架构V2.md) 并签署
