
# ASR 调度流程优化建议（可交付开发版）

本文件基于当前《调度服务器 → ASR 模块流程》文档（2026-01-16 版本），
整理出在不改变现有业务逻辑、不引入新的状态机、并保持“可接受风险”的前提下，
可以进一步提升系统稳定性、资源均衡性与未来可维护性的 **优化项集合**。

本文件不改变既有行为，仅在“边界、负载、可维护性、可扩展性”层面提出优化方向，
供开发部门按优先级执行。

---

## 1. 调度器节点选择策略优化

### 问题背景
当前节点选择逻辑在 Lua 脚本中实现为：

```
遍历 pool → 取第一个在线节点
```

但文档描述为“随机分配”，实现与文档存在轻微偏差。

### 潜在影响
- 容易造成节点负载倾斜  
- 某些节点永远不会被选到  
- 随 pool 列表顺序变化而产生非预期行为  

### 优化建议（任选一种即可）
#### 1.1 轮询（Round-robin）
- 不改变池结构  
- 每次选择下一个节点  
- 最低成本的均衡方式

#### 1.2 随机选择在线节点（真正随机）
- 修改 Lua，改为从在线列表内随机取一个  
- 简单但均衡度依赖概率

#### 1.3 最少任务优先（Least Tasks）
- 在 Redis 中维护每节点当前任务数  
- 选任务数最少的节点  
- 最均衡，但开发成本略高

**优先级：中**

---

## 2. timeout_node_id TTL 调整（降低潜在遗留缓存）

### 当前行为
- timeout_node_id TTL = **30 分钟**

### 潜在影响
- Session 已结束时仍保留旧的节点 affinity  
- Redis 累积大量 session key（特别是高并发时）  
- 未来节点扩容或缩容后，会出现跨版本遗留 affinity  

### 优化建议
将 TTL 调整为：

- **默认值：2–5 分钟**
- 符合“Pause ≈ 用户思考超过 3 秒 → 新句子”的业务逻辑
- 足够保护 AudioAggregator 的连续性  
- 不会产生不必要的长期缓存

**优先级：中**

---

## 3. 建议加入 utterance_id / sequence_id（仅作为元数据）

### 背景
当前调度 → 节点 → Web 全链路依赖：
- timestamp  
- utterance_index  
作为分段顺序依据。

在节点切换或任务延迟时，可能出现：
- 顺序乱序  
- 同 session 的句子交换顺序  
- Web 侧需要根据时间戳重排  

### 优化建议
在 Job 内增加：

```
sequence_id （全局递增或 per-session 递增）
```

该字段：
- 不改变现有逻辑  
- 不参与调度或 ASR  
- 纯粹用于排序与日志追踪  
- 对未来长链路排查特别重要

**优先级：低（可选）**

---

## 4. 对 pause / finalize 行为的边界说明写入正式文档

你已确认：

- “Pause > 3s = 用户思考 → 上一句结束”  
- “不考虑 ASR 连续性”  
- “连续 finalize（用户快速点发送）属于预期行为”  

为避免后续开发误解“pause 是否会打断语言连续性”，
建议在 ASR 文档正式写明：

```
本系统不做连续语义建模；
pause finalize 被视为真实句边界；
无跨 job ASR 连续性要求；
多次快速 finalize 不会合并。
```

这样未来开发人员不会误以为需要：
- session-level RNN 状态保存  
- 多 Job 拼接上下文  
- 语义修复跨 Job 合并  

**优先级：高（文档一致性）**

---

## 5. Lua 节点选择逻辑中的“候选 pool 遍历顺序”建议固定化

### 背景
当前写法：

```
遍历 pools → 第一个在线节点
```

如果 pool 列表是：
- 来自 Redis 的无序集合  
- 或按语言索引动态排序  

则不同环境下会产生：
- 不同的节点倾向性  
- Debug 困难  
- 多实例间不一致

### 优化建议
在 Lua 中新增：

```
对 pools 按字符串排序（table.sort）
对 nodes 按字符串排序（table.sort）
```

保证：
- 多实例一致  
- pool 结构变化时仍行为稳定  
- 不额外引入随机因素  

**优先级：中**

---

## 6. MinimalScheduler 的异常分支建议补充两条日志

### 当前行为
当遇到以下情况时：

- timeout_node_id 存在但节点 offline  
- pool 找不到任何在线节点  
- Redis 中 pool 信息损坏  

调度会自动 fallback，但文档未明确，这会造成排查困难。

### 优化建议
补充三类日志：

```
[AffinityFallback] timeout_node_id not usable → fallback
[PoolEmpty] no online nodes in pool
[PoolCorrupt] invalid pools_json / Redis record missing
```

这些日志不会改变行为，但能极大提升可观测性。

**优先级：中**

---

## 7. JobAssign → 节点的“路由跨实例”逻辑建议记录 instance_id

当前跨实例转发机制功能正常，但建议补充字段：

```
dispatch_instance_id
deliver_instance_id
```

用于追踪：

- Job 由哪个调度实例创建  
- 最终由哪个实例送达节点  

可用于未来：
- 分布式调度调优  
- 故障定位  
- 追踪网络延迟链路

**优先级：低（可追踪性增强）**

---

## 8. AudioAggregator 的“5 秒流式切分”建议写入稳定期望（optional）

当前行为：
- 5 秒流式切分 → 触发 ASR  
- >=10 秒 / >=20 秒 → 强制切分 → finalize  

建议正式写入：

```
5 秒流式切分属于稳定期望，不会调整；
10 秒 / 20 秒切分属于强制期望。
```

原因：
- 后端调度行为依赖此稳定性  
- 避免未来多方开发修改参数  
- 文档统一预期

**优先级：低**

---

# 最终总结（可读给开发部门）

本文件提出的优化均为 **“不改变现有业务逻辑，不改变现有行为”** 的提升项，
包括负载均衡、Affinity 缓存清理、可追踪性增强、边界说明明确等。

**无强制修改项，所有建议均为增量优化，不会影响现有调度 → ASR 行为。**

如需 docx 版本或附带任务列表版本，可继续生成。
