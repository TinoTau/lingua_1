# Utterance Group åŠŸèƒ½è¯¦ç»†è§„èŒƒ

**ç‰ˆæœ¬**: v1.0  
**çŠ¶æ€**: ğŸ“‹ è®¾è®¡é˜¶æ®µ  
**ä¼˜å…ˆçº§**: â­â­â­â­â­ **æœ€é«˜ä¼˜å…ˆçº§**  
**æ‰€å±é˜¶æ®µ**: é˜¶æ®µ 2.1.3  
**æœ€åæ›´æ–°**: 2025-01-XX

---

## ç›®å½•

1. [åŠŸèƒ½æ¦‚è¿°](#1-åŠŸèƒ½æ¦‚è¿°)
2. [äº§å“éœ€æ±‚](#2-äº§å“éœ€æ±‚)
3. [æŠ€æœ¯æ¶æ„](#3-æŠ€æœ¯æ¶æ„)
4. [æ•°æ®ç»“æ„è®¾è®¡](#4-æ•°æ®ç»“æ„è®¾è®¡)
5. [åè®®æ‰©å±•](#5-åè®®æ‰©å±•)
6. [åç«¯å®ç°éœ€æ±‚](#6-åç«¯å®ç°éœ€æ±‚)
7. [å‰ç«¯å®ç°éœ€æ±‚](#7-å‰ç«¯å®ç°éœ€æ±‚)
8. [å®ç°æ­¥éª¤](#8-å®ç°æ­¥éª¤)
9. [æµ‹è¯•è®¡åˆ’](#9-æµ‹è¯•è®¡åˆ’)
10. [æ€§èƒ½ä¸æ‰©å±•](#10-æ€§èƒ½ä¸æ‰©å±•)

---

## 1. åŠŸèƒ½æ¦‚è¿°

### 1.1 èƒŒæ™¯

åœ¨å®æ—¶è¯­éŸ³ç¿»è¯‘åœºæ™¯ä¸­ï¼Œç”¨æˆ·ç»å¸¸éœ€è¦å›´ç»•åŒä¸€è¯é¢˜è¿›è¡Œå¤šè½®è¡¥å……å‘è¨€ã€‚ä¾‹å¦‚ï¼š

- **ç¬¬ä¸€è½®**: "æˆ‘æƒ³è®¢ä¸€å¼ æ˜å¤©å»å¥¥å…‹å…°çš„æœºç¥¨ã€‚"
- **ç¬¬äºŒè½®**: "æœ€å¥½æ˜¯æ—©ä¸Šåç‚¹ä»¥å‰å‡ºå‘çš„ã€‚"
- **ç¬¬ä¸‰è½®**: "å¦‚æœå¯ä»¥çš„è¯é çª—åº§ä½æ›´å¥½ã€‚"

è¿™ä¸‰è½®å‘è¨€åœ¨è¯­ä¹‰ä¸Šå±äºåŒä¸€è¯é¢˜ï¼Œåº”è¯¥ä½œä¸ºä¸€ä¸ªæ•´ä½“è¿›è¡Œç¿»è¯‘ï¼Œä»¥ä¿æŒä¸Šä¸‹æ–‡è¿è´¯æ€§å’Œç¿»è¯‘è‡ªç„¶åº¦ã€‚

### 1.2 æ ¸å¿ƒä»·å€¼

**Utterance Groupï¼ˆè¯è¯­ç»„ï¼‰** åŠŸèƒ½çš„æ ¸å¿ƒä»·å€¼ï¼š

1. **è¯­ä¹‰è¿è´¯æ€§**: å°†å›´ç»•åŒä¸€è¯é¢˜çš„å¤šè½®å‘è¨€å½’ä¸ºä¸€ç»„ï¼Œç¿»è¯‘æ—¶ä½¿ç”¨å®Œæ•´ä¸Šä¸‹æ–‡
2. **ç¿»è¯‘è‡ªç„¶åº¦**: ç¿»è¯‘å¼•æ“èƒ½å¤Ÿç†è§£ä¸Šä¸‹æ–‡ï¼Œç”Ÿæˆæ›´è‡ªç„¶ã€æ›´å‡†ç¡®çš„ç›®æ ‡è¯­è¨€è¡¨è¾¾
3. **ç”¨æˆ·ä½“éªŒ**: ç”¨æˆ·å¯ä»¥åœ¨æ’­æ”¾ç»“æŸåç»§ç»­è¡¥å……å†…å®¹ï¼Œç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«å¹¶åˆå¹¶åˆ°åŒä¸€è¯é¢˜ç»„
4. **ASR å‡†ç¡®æ€§**: åˆ©ç”¨ä¸Šä¸‹æ–‡ä¿¡æ¯æé«˜è¯­éŸ³è¯†åˆ«çš„å‡†ç¡®æ€§ï¼Œé¿å…å› æ–­å¥å¯¼è‡´çš„è¯†åˆ«åå·®

### 1.3 è®¾è®¡åŸåˆ™

- **æ–‡æœ¬å±‚æ‹¼æ¥**: ä¸æ‹¼æ¥éŸ³é¢‘æ³¢å½¢ï¼Œåªåœ¨æ–‡æœ¬å±‚é¢è¿›è¡Œä¸Šä¸‹æ–‡æ‹¼æ¥
- **è‡ªåŠ¨åˆ†ç»„**: åŸºäºæ—¶é—´é—´éš”å’Œè¯­ä¹‰ç›¸ä¼¼åº¦è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦å±äºåŒä¸€ç»„
- **å‘åå…¼å®¹**: ä¸å½±å“ç°æœ‰çš„å•è½®ç¿»è¯‘æµç¨‹ï¼Œå¯ä»¥é€æ­¥å¯ç”¨
- **å¯é…ç½®**: æ”¯æŒé…ç½®è¶…æ—¶æ—¶é—´ç­‰å‚æ•°ï¼Œé€‚åº”ä¸åŒåœºæ™¯éœ€æ±‚

---

## 2. äº§å“éœ€æ±‚

### 2.1 åŠŸèƒ½éœ€æ±‚

#### FR-UG-01: Group è‡ªåŠ¨åˆ›å»º

**æè¿°**: ç³»ç»Ÿåº”èƒ½å¤Ÿè‡ªåŠ¨åˆ›å»ºæ–°çš„ Utterance Groupã€‚

**è§¦å‘æ¡ä»¶**:
- ä¼šè¯é¦–æ¬¡å‘è¨€
- è·ç¦»ä¸Šä¸€æ¬¡ TTS æ’­æ”¾ç»“æŸæ—¶é—´è¶…è¿‡ `group_timeout_sec`ï¼ˆé»˜è®¤ 30 ç§’ï¼‰
- ç”¨æˆ·åœ¨ UI ä¸Šç‚¹å‡»"å¼€å§‹æ–°è¯é¢˜"æŒ‰é’®
- åç«¯é€šè¿‡è¯­ä¹‰åˆ†æåˆ¤æ–­å½“å‰å‘è¨€ä¸ºå…¨æ–°è¯é¢˜ï¼ˆå¯é€‰ï¼Œv1 å¯æš‚ä¸å®ç°ï¼‰

**éªŒæ”¶æ ‡å‡†**:
- æ–° Group åˆ›å»ºæ—¶ç”Ÿæˆå”¯ä¸€çš„ `group_id`
- Group åˆ›å»ºæ—¶é—´æˆ³è¢«è®°å½•
- Group ä¸ Session æ­£ç¡®å…³è”

#### FR-UG-02: Group è‡ªåŠ¨å½’å±

**æè¿°**: ç³»ç»Ÿåº”èƒ½å¤Ÿè‡ªåŠ¨åˆ¤æ–­æ–°çš„ utterance æ˜¯å¦å±äºç°æœ‰ Groupã€‚

**åˆ¤æ–­è§„åˆ™**:
- å½“å‰æ—¶é—´ä¸ä¸Šä¸€æ¬¡ TTS æ’­æ”¾ç»“æŸæ—¶é—´çš„é—´éš” < `group_timeout_sec`ï¼ˆé»˜è®¤ 30 ç§’ï¼‰
- å½“å‰å‘è¨€åœ¨è¯­ä¹‰ä¸Šæ˜¯å¯¹ä¸Šä¸€è½®çš„ç»§ç»­/è¡¥å……ï¼ˆv1 å¯æš‚ä¸å®ç°è¯­ä¹‰åˆ†æï¼Œä»…åŸºäºæ—¶é—´ï¼‰
- æ²¡æœ‰æ˜¾å¼"æ–°è¯é¢˜"æŒ‡ç¤º

**éªŒæ”¶æ ‡å‡†**:
- æ»¡è¶³æ¡ä»¶æ—¶ï¼Œæ–° utterance è‡ªåŠ¨å½’å±åˆ°ä¸Šä¸€ Group
- ä¸æ»¡è¶³æ¡ä»¶æ—¶ï¼Œåˆ›å»ºæ–° Group
- å½’å±åˆ¤æ–­é€»è¾‘å¯é…ç½®

#### FR-UG-03: ä¸Šä¸‹æ–‡æ‹¼æ¥

**æè¿°**: ç¿»è¯‘æ—¶åº”ä½¿ç”¨ Group å†…æ‰€æœ‰ part çš„æ–‡æœ¬ä½œä¸ºä¸Šä¸‹æ–‡ã€‚

**æ‹¼æ¥æ–¹å¼**:
- ä¸æ‹¼æ¥éŸ³é¢‘æ³¢å½¢
- åœ¨æ–‡æœ¬å±‚é¢å°† Group å†…æ‰€æœ‰ part çš„ ASR æ–‡æœ¬æ‹¼æ¥
- ç¿»è¯‘å¼•æ“æ¥æ”¶å®Œæ•´ä¸Šä¸‹æ–‡è¿›è¡Œç¿»è¯‘

**éªŒæ”¶æ ‡å‡†**:
- ç¿»è¯‘æ—¶èƒ½å¤Ÿè®¿é—® Group å†…æ‰€æœ‰å†å²æ–‡æœ¬
- ç¿»è¯‘ç»“æœä½“ç°ä¸Šä¸‹æ–‡è¿è´¯æ€§
- ä¸å½±å“å•è½®ç¿»è¯‘çš„æ€§èƒ½

#### FR-UG-04: Group ä¿¡æ¯ä¼ é€’

**æè¿°**: ç³»ç»Ÿåº”åœ¨æ¶ˆæ¯åè®®ä¸­ä¼ é€’ Group ç›¸å…³ä¿¡æ¯ã€‚

**ä¿¡æ¯åŒ…æ‹¬**:
- `group_id`: Group å”¯ä¸€æ ‡è¯†
- `part_index`: å½“å‰ utterance åœ¨ Group ä¸­çš„åºå·
- `is_new_group`: æ˜¯å¦ä¸ºæ–°å»º Group

**éªŒæ”¶æ ‡å‡†**:
- æ‰€æœ‰ç›¸å…³æ¶ˆæ¯éƒ½åŒ…å« Group ä¿¡æ¯
- Group ä¿¡æ¯åœ¨ Web â†’ Scheduler â†’ Node ä¹‹é—´æ­£ç¡®ä¼ é€’
- å‰ç«¯èƒ½å¤Ÿæ˜¾ç¤º Group ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰

### 2.2 éåŠŸèƒ½éœ€æ±‚

#### NFR-UG-01: æ€§èƒ½è¦æ±‚

- Group åˆ›å»ºå’Œå½’å±åˆ¤æ–­å»¶è¿Ÿ < 10ms
- ä¸Šä¸‹æ–‡æ‹¼æ¥ä¸å½±å“ç¿»è¯‘å»¶è¿Ÿï¼ˆå¢åŠ  < 50msï¼‰
- æ”¯æŒæ¯ä¸ª Session æœ€å¤š 100 ä¸ª Groupï¼ˆå¯é…ç½®ï¼‰

#### NFR-UG-02: å¯é…ç½®æ€§

- `group_timeout_sec` å¯é…ç½®ï¼ˆé»˜è®¤ 30 ç§’ï¼‰
- Group æœ€å¤§ part æ•°é‡å¯é…ç½®ï¼ˆé»˜è®¤ 10ï¼Œé˜²æ­¢æ— é™å¢é•¿ï¼‰
- æ”¯æŒé€šè¿‡é…ç½®æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡é…ç½®

#### NFR-UG-03: å‘åå…¼å®¹

- ä¸å¯ç”¨ Group åŠŸèƒ½æ—¶ï¼Œç³»ç»Ÿè¡Œä¸ºä¸ç°æœ‰ç‰ˆæœ¬å®Œå…¨ä¸€è‡´
- ç°æœ‰å®¢æˆ·ç«¯æ— éœ€ä¿®æ”¹å³å¯ç»§ç»­ä½¿ç”¨
- æ–°åŠŸèƒ½é€šè¿‡å¯é€‰å­—æ®µå®ç°ï¼Œä¸å½±å“ç°æœ‰æ¶ˆæ¯è§£æ

---

## 3. æŠ€æœ¯æ¶æ„

### 3.1 ç³»ç»Ÿç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Web å®¢æˆ·ç«¯                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  State Machine (è®°å½• TTS æ’­æ”¾ç»“æŸæ—¶é—´)                â”‚  â”‚
â”‚  â”‚  WebSocket Client (å‘é€ group_id, is_new_group)      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ WebSocket
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   è°ƒåº¦æœåŠ¡å™¨ (Scheduler)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Group Manager (ç®¡ç† Group ç”Ÿå‘½å‘¨æœŸ)                  â”‚  â”‚
â”‚  â”‚  - create_group()                                    â”‚  â”‚
â”‚  â”‚  - get_or_create_group()                             â”‚  â”‚
â”‚  â”‚  - get_group_context()                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Session Manager (æ‰©å±•æ”¯æŒ Group)                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ WebSocket (JobAssign with context)
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 èŠ‚ç‚¹æ¨ç†æœåŠ¡ (Node Inference)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  NMT Engine (æ”¯æŒä¸Šä¸‹æ–‡è¾“å…¥)                          â”‚  â”‚
â”‚  â”‚  - translate_with_context(context, current_text)     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ•°æ®æµ

```
1. Web å®¢æˆ·ç«¯å‘é€ Utterance
   â””â”€> åŒ…å«: session_id, utterance_index, group_id (å¯é€‰), is_new_group (å¯é€‰)

2. Scheduler æ¥æ”¶ Utterance
   â”œâ”€> Group Manager åˆ¤æ–­æ˜¯å¦åˆ›å»ºæ–° Group æˆ–å½’å±ç°æœ‰ Group
   â”œâ”€> è·å– Group ä¸Šä¸‹æ–‡ï¼ˆæ‰€æœ‰å†å² part çš„æ–‡æœ¬ï¼‰
   â””â”€> åˆ›å»º Jobï¼ŒåŒ…å«ä¸Šä¸‹æ–‡ä¿¡æ¯

3. Scheduler å‘é€ JobAssign åˆ° Node
   â””â”€> åŒ…å«: job_id, session_id, utterance_index, group_id, context_texts[]

4. Node å¤„ç† Job
   â”œâ”€> ASR: è¯†åˆ«å½“å‰éŸ³é¢‘
   â”œâ”€> NMT: ä½¿ç”¨ context_texts[] + current_text è¿›è¡Œç¿»è¯‘
   â””â”€> TTS: åˆæˆç¿»è¯‘ç»“æœ

5. Node è¿”å› JobResult
   â””â”€> åŒ…å«: job_id, session_id, utterance_index, group_id, text_asr, text_translated

6. Scheduler æ›´æ–° Group çŠ¶æ€
   â”œâ”€> ä¿å­˜å½“å‰ part çš„ ASR æ–‡æœ¬å’Œç¿»è¯‘æ–‡æœ¬
   â””â”€> è®°å½• TTS æ’­æ”¾ç»“æŸæ—¶é—´ï¼ˆç”±å‰ç«¯é€šçŸ¥æˆ–ä¼°ç®—ï¼‰

7. Scheduler è½¬å‘ç»“æœåˆ° Web å®¢æˆ·ç«¯
   â””â”€> åŒ…å«: session_id, utterance_index, group_id, text_asr, text_translated, tts_audio
```

---

## 4. æ•°æ®ç»“æ„è®¾è®¡

### 4.1 Scheduler æ•°æ®ç»“æ„

#### 4.1.1 UtteranceGroup

```rust
// scheduler/src/group.rs

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct UtteranceGroup {
    /// Group å”¯ä¸€æ ‡è¯†
    pub group_id: String,
    /// æ‰€å± Session ID
    pub session_id: String,
    /// Group åˆ›å»ºæ—¶é—´
    pub created_at: chrono::DateTime<chrono::Utc>,
    /// æœ€åä¸€æ¬¡ TTS æ’­æ”¾ç»“æŸæ—¶é—´
    pub last_tts_end_time: Option<chrono::DateTime<chrono::Utc>>,
    /// Group å†…çš„æ‰€æœ‰ part
    pub parts: Vec<GroupPart>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct GroupPart {
    /// Part åºå·ï¼ˆä» 1 å¼€å§‹ï¼‰
    pub part_index: u32,
    /// å¯¹åº”çš„ utterance_index
    pub utterance_index: u64,
    /// ASR è¯†åˆ«æ–‡æœ¬
    pub asr_text: String,
    /// ç¿»è¯‘æ–‡æœ¬
    pub translated_text: String,
    /// åˆ›å»ºæ—¶é—´
    pub created_at: chrono::DateTime<chrono::Utc>,
}

impl UtteranceGroup {
    /// è·å–æ‰€æœ‰ part çš„ ASR æ–‡æœ¬ï¼ˆç”¨äºä¸Šä¸‹æ–‡æ‹¼æ¥ï¼‰
    pub fn get_context_texts(&self) -> Vec<String> {
        self.parts.iter()
            .map(|p| p.asr_text.clone())
            .collect()
    }
    
    /// è·å–æ‰€æœ‰ part çš„ç¿»è¯‘æ–‡æœ¬ï¼ˆå¯é€‰ï¼Œç”¨äºæŸäº›ç¿»è¯‘å¼•æ“ï¼‰
    pub fn get_translated_texts(&self) -> Vec<String> {
        self.parts.iter()
            .map(|p| p.translated_text.clone())
            .collect()
    }
    
    /// æ·»åŠ æ–°çš„ part
    pub fn add_part(&mut self, utterance_index: u64, asr_text: String, translated_text: String) {
        let part_index = (self.parts.len() + 1) as u32;
        self.parts.push(GroupPart {
            part_index,
            utterance_index,
            asr_text,
            translated_text,
            created_at: chrono::Utc::now(),
        });
    }
    
    /// æ›´æ–°æœ€å TTS æ’­æ”¾ç»“æŸæ—¶é—´
    pub fn update_last_tts_end_time(&mut self, end_time: chrono::DateTime<chrono::Utc>) {
        self.last_tts_end_time = Some(end_time);
    }
    
    /// åˆ¤æ–­æ˜¯å¦åº”è¯¥åˆ›å»ºæ–° Groupï¼ˆåŸºäºæ—¶é—´é—´éš”ï¼‰
    pub fn should_create_new_group(&self, timeout_sec: u64) -> bool {
        if let Some(last_end) = self.last_tts_end_time {
            let now = chrono::Utc::now();
            let elapsed = (now - last_end).num_seconds();
            elapsed > timeout_sec as i64
        } else {
            // å¦‚æœæ²¡æœ‰è®°å½• TTS ç»“æŸæ—¶é—´ï¼Œé»˜è®¤ä¸åˆ›å»ºæ–° Group
            false
        }
    }
}
```

#### 4.1.2 GroupManager

```rust
// scheduler/src/group.rs

use std::collections::HashMap;
use std::sync::Arc;
use tokio::sync::RwLock;
use uuid::Uuid;

#[derive(Clone)]
pub struct GroupManager {
    /// session_id -> group_id -> UtteranceGroup
    groups: Arc<RwLock<HashMap<String, HashMap<String, UtteranceGroup>>>>,
    /// session_id -> å½“å‰æ´»è·ƒçš„ group_id
    active_groups: Arc<RwLock<HashMap<String, String>>>,
    /// Group è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
    group_timeout_sec: u64,
    /// Group æœ€å¤§ part æ•°é‡
    max_parts_per_group: u32,
}

impl GroupManager {
    pub fn new(group_timeout_sec: u64, max_parts_per_group: u32) -> Self {
        Self {
            groups: Arc::new(RwLock::new(HashMap::new())),
            active_groups: Arc::new(RwLock::new(HashMap::new())),
            group_timeout_sec,
            max_parts_per_group,
        }
    }
    
    /// åˆ›å»ºæ–° Group
    pub async fn create_group(&self, session_id: String) -> String {
        let group_id = format!("g-{}", Uuid::new_v4().to_string()[..8].to_uppercase());
        let group = UtteranceGroup {
            group_id: group_id.clone(),
            session_id: session_id.clone(),
            created_at: chrono::Utc::now(),
            last_tts_end_time: None,
            parts: Vec::new(),
        };
        
        let mut groups = self.groups.write().await;
        groups.entry(session_id.clone())
            .or_insert_with(HashMap::new)
            .insert(group_id.clone(), group);
        
        let mut active_groups = self.active_groups.write().await;
        active_groups.insert(session_id, group_id.clone());
        
        group_id
    }
    
    /// è·å–æˆ–åˆ›å»º Groupï¼ˆæ ¹æ®æ—¶é—´é—´éš”åˆ¤æ–­ï¼‰
    pub async fn get_or_create_group(&self, session_id: String, force_new: bool) -> (String, bool) {
        if force_new {
            let group_id = self.create_group(session_id).await;
            return (group_id, true);
        }
        
        let active_groups = self.active_groups.read().await;
        if let Some(current_group_id) = active_groups.get(&session_id) {
            let groups = self.groups.read().await;
            if let Some(session_groups) = groups.get(&session_id) {
                if let Some(group) = session_groups.get(current_group_id) {
                    // æ£€æŸ¥æ˜¯å¦åº”è¯¥åˆ›å»ºæ–° Group
                    if !group.should_create_new_group(self.group_timeout_sec) {
                        // æ£€æŸ¥ part æ•°é‡æ˜¯å¦è¶…è¿‡é™åˆ¶
                        if group.parts.len() < self.max_parts_per_group as usize {
                            return (current_group_id.clone(), false);
                        }
                    }
                }
            }
        }
        
        // éœ€è¦åˆ›å»ºæ–° Group
        drop(active_groups);
        let group_id = self.create_group(session_id).await;
        (group_id, true)
    }
    
    /// è·å– Group ä¸Šä¸‹æ–‡æ–‡æœ¬
    pub async fn get_group_context(&self, session_id: &str, group_id: &str) -> Option<Vec<String>> {
        let groups = self.groups.read().await;
        groups.get(session_id)?
            .get(group_id)
            .map(|g| g.get_context_texts())
    }
    
    /// æ·»åŠ  part åˆ° Group
    pub async fn add_part_to_group(
        &self,
        session_id: &str,
        group_id: &str,
        utterance_index: u64,
        asr_text: String,
        translated_text: String,
    ) -> bool {
        let mut groups = self.groups.write().await;
        if let Some(session_groups) = groups.get_mut(session_id) {
            if let Some(group) = session_groups.get_mut(group_id) {
                group.add_part(utterance_index, asr_text, translated_text);
                return true;
            }
        }
        false
    }
    
    /// æ›´æ–° Group çš„æœ€å TTS æ’­æ”¾ç»“æŸæ—¶é—´
    pub async fn update_tts_end_time(
        &self,
        session_id: &str,
        group_id: &str,
        end_time: chrono::DateTime<chrono::Utc>,
    ) -> bool {
        let mut groups = self.groups.write().await;
        if let Some(session_groups) = groups.get_mut(session_id) {
            if let Some(group) = session_groups.get_mut(group_id) {
                group.update_last_tts_end_time(end_time);
                return true;
            }
        }
        false
    }
    
    /// æ¸…ç†è¿‡æœŸçš„ Groupï¼ˆå¯é€‰ï¼Œç”¨äºå†…å­˜ç®¡ç†ï¼‰
    pub async fn cleanup_expired_groups(&self, max_age_hours: u64) {
        let mut groups = self.groups.write().await;
        let cutoff = chrono::Utc::now() - chrono::Duration::hours(max_age_hours as i64);
        
        for session_groups in groups.values_mut() {
            session_groups.retain(|_, group| {
                group.created_at > cutoff
            });
        }
    }
}
```

### 4.2 Session æ‰©å±•

```rust
// scheduler/src/session.rs (æ‰©å±•)

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Session {
    // ... ç°æœ‰å­—æ®µ ...
    
    /// å½“å‰æ´»è·ƒçš„ Group IDï¼ˆå¯é€‰ï¼‰
    #[serde(skip_serializing_if = "Option::is_none")]
    pub current_group_id: Option<String>,
}
```

### 4.3 Job æ‰©å±•

```rust
// scheduler/src/dispatcher.rs (æ‰©å±•)

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Job {
    // ... ç°æœ‰å­—æ®µ ...
    
    /// Group IDï¼ˆå¯é€‰ï¼‰
    #[serde(skip_serializing_if = "Option::is_none")]
    pub group_id: Option<String>,
    
    /// Group ä¸Šä¸‹æ–‡æ–‡æœ¬ï¼ˆç”¨äºç¿»è¯‘ï¼‰
    #[serde(skip_serializing_if = "Option::is_none")]
    pub group_context: Option<Vec<String>>,
    
    /// æ˜¯å¦ä¸ºæ–°å»º Group
    #[serde(skip_serializing_if = "Option::is_none")]
    pub is_new_group: Option<bool>,
}
```

---

## 5. åè®®æ‰©å±•

### 5.1 WebSocket æ¶ˆæ¯æ‰©å±•

#### 5.1.1 Utterance æ¶ˆæ¯æ‰©å±•

```typescript
// shared/protocols/messages.ts

export interface UtteranceMessage {
  type: 'utterance';
  session_id: string;
  utterance_index: number;
  // ... ç°æœ‰å­—æ®µ ...
  
  /** Group IDï¼ˆå¯é€‰ï¼Œå®¢æˆ·ç«¯æä¾›æˆ–ç”± Scheduler ç”Ÿæˆï¼‰ */
  group_id?: string;
  
  /** æ˜¯å¦å¼ºåˆ¶åˆ›å»ºæ–° Groupï¼ˆå¯é€‰ï¼Œç”¨æˆ·ç‚¹å‡»"å¼€å§‹æ–°è¯é¢˜"æ—¶è®¾ç½®ä¸º trueï¼‰ */
  is_new_group?: boolean;
  
  /** TTS æ’­æ”¾ç»“æŸæ—¶é—´æˆ³ï¼ˆå¯é€‰ï¼Œç”¨äº Group å½’å±åˆ¤æ–­ï¼‰ */
  tts_end_timestamp?: number;
}
```

#### 5.1.2 JobAssign æ¶ˆæ¯æ‰©å±•

```rust
// scheduler/src/messages.rs

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct JobAssign {
    // ... ç°æœ‰å­—æ®µ ...
    
    /// Group IDï¼ˆå¯é€‰ï¼‰
    #[serde(skip_serializing_if = "Option::is_none")]
    pub group_id: Option<String>,
    
    /// Group ä¸Šä¸‹æ–‡æ–‡æœ¬ï¼ˆç”¨äºç¿»è¯‘ï¼‰
    #[serde(skip_serializing_if = "Option::is_none")]
    pub group_context: Option<Vec<String>>,
    
    /// æ˜¯å¦ä¸ºæ–°å»º Group
    #[serde(skip_serializing_if = "Option::is_none")]
    pub is_new_group: Option<bool>,
}
```

#### 5.1.3 TranslationResult æ¶ˆæ¯æ‰©å±•

```typescript
// shared/protocols/messages.ts

export interface TranslationResultMessage {
  type: 'translation_result';
  session_id: string;
  utterance_index: number;
  // ... ç°æœ‰å­—æ®µ ...
  
  /** Group ID */
  group_id?: string;
  
  /** Part åºå·ï¼ˆåœ¨ Group ä¸­çš„ä½ç½®ï¼Œä» 1 å¼€å§‹ï¼‰ */
  part_index?: number;
  
  /** æ˜¯å¦ä¸ºæ–°å»º Group */
  is_new_group?: boolean;
}
```

#### 5.1.4 TTS æ’­æ”¾ç»“æŸé€šçŸ¥ï¼ˆæ–°å¢ï¼‰

```typescript
// shared/protocols/messages.ts

export interface TtsEndMessage {
  type: 'tts_end';
  session_id: string;
  utterance_index: number;
  group_id?: string;
  /** TTS æ’­æ”¾ç»“æŸæ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ */
  end_timestamp: number;
}
```

### 5.2 Node æ¨ç†æœåŠ¡æ‰©å±•

#### 5.2.1 InferenceRequest æ‰©å±•

```rust
// node-inference/src/inference.rs

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct InferenceRequest {
    // ... ç°æœ‰å­—æ®µ ...
    
    /// Group IDï¼ˆå¯é€‰ï¼‰
    #[serde(skip_serializing_if = "Option::is_none")]
    pub group_id: Option<String>,
    
    /// Group ä¸Šä¸‹æ–‡æ–‡æœ¬ï¼ˆç”¨äºç¿»è¯‘ï¼‰
    #[serde(skip_serializing_if = "Option::is_none")]
    pub group_context: Option<Vec<String>>,
}
```

#### 5.2.2 NMT Engine æ‰©å±•

```rust
// node-inference/src/nmt.rs

impl NMTEngine {
    /// ä½¿ç”¨ä¸Šä¸‹æ–‡è¿›è¡Œç¿»è¯‘
    pub async fn translate_with_context(
        &self,
        text: &str,
        src_lang: &str,
        tgt_lang: &str,
        context: Option<&[String]>,
    ) -> Result<String> {
        if let Some(ctx) = context {
            // æ‹¼æ¥ä¸Šä¸‹æ–‡æ–‡æœ¬
            let full_context = ctx.join(" ") + " " + text;
            // è°ƒç”¨ç¿»è¯‘æœåŠ¡ï¼Œä¼ å…¥å®Œæ•´ä¸Šä¸‹æ–‡
            self.translate(&full_context, src_lang, tgt_lang).await
        } else {
            // æ— ä¸Šä¸‹æ–‡ï¼Œä½¿ç”¨åŸæœ‰é€»è¾‘
            self.translate(text, src_lang, tgt_lang).await
        }
    }
}
```

---

## 6. åç«¯å®ç°éœ€æ±‚

### 6.1 è°ƒåº¦æœåŠ¡å™¨ (Scheduler)

#### 6.1.1 æ–°å¢æ¨¡å—

1. **Group Manager** (`scheduler/src/group.rs`)
   - å®ç° `GroupManager` ç»“æ„ä½“
   - å®ç° Group åˆ›å»ºã€å½’å±åˆ¤æ–­ã€ä¸Šä¸‹æ–‡è·å–ç­‰åŠŸèƒ½
   - å®ç° Group ç”Ÿå‘½å‘¨æœŸç®¡ç†

2. **Group é…ç½®** (`scheduler/src/config.rs` æ‰©å±•)
   - `group_timeout_sec`: Group è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤ 30 ç§’ï¼‰
   - `max_parts_per_group`: Group æœ€å¤§ part æ•°é‡ï¼ˆé»˜è®¤ 10ï¼‰

#### 6.1.2 ä¿®æ”¹ç°æœ‰æ¨¡å—

1. **Session Manager** (`scheduler/src/session.rs`)
   - æ‰©å±• `Session` ç»“æ„ä½“ï¼Œæ·»åŠ  `current_group_id` å­—æ®µ
   - å¯é€‰ï¼šæ·»åŠ  Group ç›¸å…³æŸ¥è¯¢æ–¹æ³•

2. **Dispatcher** (`scheduler/src/dispatcher.rs`)
   - æ‰©å±• `Job` ç»“æ„ä½“ï¼Œæ·»åŠ  `group_id`ã€`group_context`ã€`is_new_group` å­—æ®µ
   - ä¿®æ”¹ `create_job` æ–¹æ³•ï¼Œé›†æˆ Group Manager é€»è¾‘
   - åœ¨åˆ›å»º Job æ—¶ï¼š
     - è°ƒç”¨ `GroupManager::get_or_create_group` è·å–æˆ–åˆ›å»º Group
     - è°ƒç”¨ `GroupManager::get_group_context` è·å–ä¸Šä¸‹æ–‡
     - å°† Group ä¿¡æ¯æ·»åŠ åˆ° Job

3. **Session Handler** (`scheduler/src/websocket/session_handler.rs`)
   - å¤„ç† `Utterance` æ¶ˆæ¯æ—¶ï¼š
     - æå– `group_id`ã€`is_new_group`ã€`tts_end_timestamp` å­—æ®µ
     - å¦‚æœæä¾›äº† `tts_end_timestamp`ï¼Œæ›´æ–° Group çš„æœ€å TTS ç»“æŸæ—¶é—´
     - å°† Group ä¿¡æ¯ä¼ é€’ç»™ `create_job`
   - å¤„ç† `TtsEnd` æ¶ˆæ¯æ—¶ï¼š
     - æ›´æ–°å¯¹åº” Group çš„æœ€å TTS ç»“æŸæ—¶é—´

4. **Node Handler** (`scheduler/src/websocket/node_handler.rs`)
   - å¤„ç† `JobResult` æ—¶ï¼š
     - æå– `group_id`
     - è°ƒç”¨ `GroupManager::add_part_to_group` ä¿å­˜ part ä¿¡æ¯
   - åˆ›å»º `TranslationResult` æ¶ˆæ¯æ—¶ï¼š
     - åŒ…å« `group_id`ã€`part_index`ã€`is_new_group` ä¿¡æ¯

#### 6.1.3 å®ç°æ­¥éª¤

1. **ç¬¬ä¸€æ­¥ï¼šæ•°æ®ç»“æ„å®ç°**
   - [ ] åˆ›å»º `group.rs` æ¨¡å—
   - [ ] å®ç° `UtteranceGroup` å’Œ `GroupPart` ç»“æ„ä½“
   - [ ] å®ç° `GroupManager` ç»“æ„ä½“å’Œæ–¹æ³•
   - [ ] æ·»åŠ å•å…ƒæµ‹è¯•

2. **ç¬¬äºŒæ­¥ï¼šåè®®æ‰©å±•**
   - [ ] æ‰©å±• `Utterance` æ¶ˆæ¯ï¼Œæ·»åŠ  Group ç›¸å…³å­—æ®µ
   - [ ] æ‰©å±• `JobAssign` æ¶ˆæ¯ï¼Œæ·»åŠ  Group ç›¸å…³å­—æ®µ
   - [ ] æ‰©å±• `TranslationResult` æ¶ˆæ¯ï¼Œæ·»åŠ  Group ç›¸å…³å­—æ®µ
   - [ ] æ·»åŠ  `TtsEnd` æ¶ˆæ¯ç±»å‹

3. **ç¬¬ä¸‰æ­¥ï¼šä¸šåŠ¡é€»è¾‘é›†æˆ**
   - [ ] åœ¨ `SessionHandler` ä¸­é›†æˆ Group Manager
   - [ ] åœ¨ `Dispatcher` ä¸­é›†æˆ Group ä¸Šä¸‹æ–‡è·å–
   - [ ] åœ¨ `NodeHandler` ä¸­é›†æˆ Group part ä¿å­˜
   - [ ] æ·»åŠ é›†æˆæµ‹è¯•

4. **ç¬¬å››æ­¥ï¼šé…ç½®å’Œä¼˜åŒ–**
   - [ ] æ·»åŠ  Group ç›¸å…³é…ç½®é¡¹
   - [ ] å®ç° Group æ¸…ç†æœºåˆ¶ï¼ˆå¯é€‰ï¼‰
   - [ ] æ€§èƒ½ä¼˜åŒ–å’Œå‹åŠ›æµ‹è¯•

### 6.2 èŠ‚ç‚¹æ¨ç†æœåŠ¡ (Node Inference)

#### 6.2.1 ä¿®æ”¹ç°æœ‰æ¨¡å—

1. **Inference Service** (`node-inference/src/inference.rs`)
   - æ‰©å±• `InferenceRequest` ç»“æ„ä½“ï¼Œæ·»åŠ  `group_id` å’Œ `group_context` å­—æ®µ
   - ä¿®æ”¹ `process` æ–¹æ³•ï¼Œåœ¨è°ƒç”¨ NMT æ—¶ä¼ é€’ä¸Šä¸‹æ–‡

2. **NMT Engine** (`node-inference/src/nmt.rs`)
   - æ·»åŠ  `translate_with_context` æ–¹æ³•
   - æ”¯æŒæ¥æ”¶ä¸Šä¸‹æ–‡æ–‡æœ¬åˆ—è¡¨
   - å®ç°ä¸Šä¸‹æ–‡æ‹¼æ¥é€»è¾‘ï¼ˆæ–‡æœ¬æ‹¼æ¥æˆ– Prompt æ³¨å…¥ï¼‰

#### 6.2.2 å®ç°æ­¥éª¤

1. **ç¬¬ä¸€æ­¥ï¼šåè®®æ‰©å±•**
   - [ ] æ‰©å±• `InferenceRequest`ï¼Œæ·»åŠ  Group ç›¸å…³å­—æ®µ
   - [ ] æ›´æ–°æ¶ˆæ¯è§£æé€»è¾‘

2. **ç¬¬äºŒæ­¥ï¼šNMT å¼•æ“æ‰©å±•**
   - [ ] å®ç° `translate_with_context` æ–¹æ³•
   - [ ] æµ‹è¯•ä¸Šä¸‹æ–‡æ‹¼æ¥é€»è¾‘
   - [ ] éªŒè¯ç¿»è¯‘è´¨é‡æå‡

3. **ç¬¬ä¸‰æ­¥ï¼šé›†æˆæµ‹è¯•**
   - [ ] ç«¯åˆ°ç«¯æµ‹è¯• Group åŠŸèƒ½
   - [ ] æ€§èƒ½æµ‹è¯•ï¼ˆä¸Šä¸‹æ–‡æ‹¼æ¥å¯¹å»¶è¿Ÿçš„å½±å“ï¼‰

---

## 7. å‰ç«¯å®ç°éœ€æ±‚

### 7.1 Web å®¢æˆ·ç«¯

#### 7.1.1 çŠ¶æ€æœºæ‰©å±•

```typescript
// web-client/src/state_machine.ts

interface StateMachine {
  // ... ç°æœ‰çŠ¶æ€ ...
  
  /** å½“å‰ Group ID */
  currentGroupId?: string;
  
  /** æœ€å TTS æ’­æ”¾ç»“æŸæ—¶é—´ */
  lastTtsEndTime?: number;
  
  /** è®°å½• TTS æ’­æ”¾ç»“æŸæ—¶é—´ */
  recordTtsEnd(groupId?: string): void;
  
  /** åˆ¤æ–­æ˜¯å¦åº”è¯¥åˆ›å»ºæ–° Group */
  shouldCreateNewGroup(timeoutSec: number): boolean;
}
```

#### 7.1.2 WebSocket å®¢æˆ·ç«¯æ‰©å±•

```typescript
// web-client/src/websocket_client.ts

// å‘é€ Utterance æ—¶åŒ…å« Group ä¿¡æ¯
async sendUtterance(audioData: ArrayBuffer, isNewGroup: boolean = false) {
  const message: UtteranceMessage = {
    type: 'utterance',
    session_id: this.sessionId,
    utterance_index: this.utteranceIndex,
    // ... å…¶ä»–å­—æ®µ ...
    group_id: this.stateMachine.currentGroupId,
    is_new_group: isNewGroup,
    tts_end_timestamp: this.stateMachine.lastTtsEndTime,
  };
  
  this.ws.send(JSON.stringify(message));
}

// å¤„ç† TTS æ’­æ”¾ç»“æŸ
onTtsEnd(utteranceIndex: number, groupId?: string) {
  const message: TtsEndMessage = {
    type: 'tts_end',
    session_id: this.sessionId,
    utterance_index: utteranceIndex,
    group_id: groupId,
    end_timestamp: Date.now(),
  };
  
  this.ws.send(JSON.stringify(message));
  
  // æ›´æ–°çŠ¶æ€æœº
  this.stateMachine.recordTtsEnd(groupId);
}
```

#### 7.1.3 UI æ‰©å±•ï¼ˆå¯é€‰ï¼‰

```typescript
// web-client/src/components/TranslationView.tsx

// æ˜¾ç¤º Group ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
{result.group_id && (
  <div className="group-indicator">
    {result.is_new_group ? 'æ–°è¯é¢˜' : `è¯é¢˜ ${result.group_id.slice(-4)} - ç¬¬ ${result.part_index} éƒ¨åˆ†`}
  </div>
)}

// "å¼€å§‹æ–°è¯é¢˜" æŒ‰é’®
<button onClick={() => this.handleNewTopic()}>
  å¼€å§‹æ–°è¯é¢˜
</button>
```

#### 7.1.4 å®ç°æ­¥éª¤

1. **ç¬¬ä¸€æ­¥ï¼šçŠ¶æ€ç®¡ç†**
   - [ ] æ‰©å±•çŠ¶æ€æœºï¼Œæ·»åŠ  Group ç›¸å…³çŠ¶æ€
   - [ ] å®ç° TTS æ’­æ”¾ç»“æŸæ—¶é—´è®°å½•
   - [ ] å®ç° Group å½’å±åˆ¤æ–­é€»è¾‘

2. **ç¬¬äºŒæ­¥ï¼šæ¶ˆæ¯åè®®**
   - [ ] æ›´æ–° `UtteranceMessage` ç±»å‹å®šä¹‰
   - [ ] æ›´æ–° `TranslationResultMessage` ç±»å‹å®šä¹‰
   - [ ] æ·»åŠ  `TtsEndMessage` ç±»å‹å®šä¹‰

3. **ç¬¬ä¸‰æ­¥ï¼šä¸šåŠ¡é€»è¾‘**
   - [ ] åœ¨å‘é€ Utterance æ—¶åŒ…å« Group ä¿¡æ¯
   - [ ] åœ¨ TTS æ’­æ”¾ç»“æŸæ—¶å‘é€ `TtsEnd` æ¶ˆæ¯
   - [ ] å¤„ç† `TranslationResult` ä¸­çš„ Group ä¿¡æ¯

4. **ç¬¬å››æ­¥ï¼šUI å¢å¼ºï¼ˆå¯é€‰ï¼‰**
   - [ ] æ˜¾ç¤º Group ä¿¡æ¯
   - [ ] æ·»åŠ "å¼€å§‹æ–°è¯é¢˜"æŒ‰é’®
   - [ ] ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ

---

## 8. å®ç°æ­¥éª¤

### 8.1 é˜¶æ®µåˆ’åˆ†

#### é˜¶æ®µ 1: åç«¯æ ¸å¿ƒåŠŸèƒ½ï¼ˆ1-2 å‘¨ï¼‰

**ç›®æ ‡**: å®ç° Scheduler çš„ Group ç®¡ç†åŠŸèƒ½

- [ ] åˆ›å»º `group.rs` æ¨¡å—ï¼Œå®ç° `GroupManager`
- [ ] æ‰©å±•æ¶ˆæ¯åè®®ï¼ˆ`Utterance`ã€`JobAssign`ã€`TranslationResult`ï¼‰
- [ ] é›†æˆ Group Manager åˆ° Session Handler å’Œ Dispatcher
- [ ] å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

#### é˜¶æ®µ 2: èŠ‚ç‚¹æ¨ç†æœåŠ¡æ‰©å±•ï¼ˆ1 å‘¨ï¼‰

**ç›®æ ‡**: å®ç° NMT å¼•æ“çš„ä¸Šä¸‹æ–‡æ”¯æŒ

- [ ] æ‰©å±• `InferenceRequest`ï¼Œæ·»åŠ  Group ç›¸å…³å­—æ®µ
- [ ] å®ç° `NMTEngine::translate_with_context` æ–¹æ³•
- [ ] æµ‹è¯•ä¸Šä¸‹æ–‡æ‹¼æ¥å¯¹ç¿»è¯‘è´¨é‡çš„å½±å“

#### é˜¶æ®µ 3: å‰ç«¯é›†æˆï¼ˆ1 å‘¨ï¼‰

**ç›®æ ‡**: å‰ç«¯æ”¯æŒ Group åŠŸèƒ½

- [ ] æ‰©å±•çŠ¶æ€æœºï¼Œè®°å½• TTS æ’­æ”¾ç»“æŸæ—¶é—´
- [ ] æ›´æ–° WebSocket æ¶ˆæ¯ï¼ŒåŒ…å« Group ä¿¡æ¯
- [ ] å®ç° TTS æ’­æ”¾ç»“æŸé€šçŸ¥
- [ ] å¯é€‰ï¼šUI æ˜¾ç¤º Group ä¿¡æ¯

#### é˜¶æ®µ 4: ç«¯åˆ°ç«¯æµ‹è¯•å’Œä¼˜åŒ–ï¼ˆ1 å‘¨ï¼‰

**ç›®æ ‡**: éªŒè¯å®Œæ•´æµç¨‹ï¼Œä¼˜åŒ–æ€§èƒ½

- [ ] ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆWeb â†’ Scheduler â†’ Node â†’ Webï¼‰
- [ ] æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–
- [ ] æ–‡æ¡£å®Œå–„

### 8.2 ä¾èµ–å…³ç³»

```
é˜¶æ®µ 1 (Scheduler) 
    â†“
é˜¶æ®µ 2 (Node Inference) â”€â”€â†’ é˜¶æ®µ 3 (Web Client)
    â†“                           â†“
é˜¶æ®µ 4 (E2E Testing & Optimization)
```

### 8.3 é£é™©ä¸ç¼“è§£

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| Group å½’å±åˆ¤æ–­ä¸å‡†ç¡® | ä¸­ | v1 ä»…åŸºäºæ—¶é—´é—´éš”ï¼Œåç»­å¯åŠ å…¥è¯­ä¹‰åˆ†æ |
| ä¸Šä¸‹æ–‡æ‹¼æ¥å½±å“ç¿»è¯‘å»¶è¿Ÿ | ä¸­ | ä¼˜åŒ– NMT å¼•æ“ï¼Œæ”¯æŒæ‰¹é‡ä¸Šä¸‹æ–‡å¤„ç† |
| Group æ•°é‡æ— é™å¢é•¿ | ä½ | å®ç° Group æ¸…ç†æœºåˆ¶ï¼Œé™åˆ¶æœ€å¤§ part æ•°é‡ |
| å‘åå…¼å®¹æ€§é—®é¢˜ | é«˜ | æ‰€æœ‰ Group ç›¸å…³å­—æ®µè®¾ä¸ºå¯é€‰ï¼Œç°æœ‰å®¢æˆ·ç«¯æ— éœ€ä¿®æ”¹ |

---

## 9. æµ‹è¯•è®¡åˆ’

### 9.1 å•å…ƒæµ‹è¯•

#### 9.1.1 Group Manager æµ‹è¯•

```rust
// scheduler/tests/stage2.1.3/group_manager_test.rs

#[tokio::test]
async fn test_create_group() {
    // æµ‹è¯• Group åˆ›å»º
}

#[tokio::test]
async fn test_get_or_create_group_timeout() {
    // æµ‹è¯•åŸºäºæ—¶é—´é—´éš”çš„ Group å½’å±åˆ¤æ–­
}

#[tokio::test]
async fn test_get_group_context() {
    // æµ‹è¯•ä¸Šä¸‹æ–‡è·å–
}

#[tokio::test]
async fn test_add_part_to_group() {
    // æµ‹è¯•æ·»åŠ  part åˆ° Group
}

#[tokio::test]
async fn test_max_parts_per_group() {
    // æµ‹è¯• Group æœ€å¤§ part æ•°é‡é™åˆ¶
}
```

#### 9.1.2 NMT Engine æµ‹è¯•

```rust
// node-inference/tests/stage2.1.3/nmt_context_test.rs

#[tokio::test]
async fn test_translate_with_context() {
    // æµ‹è¯•å¸¦ä¸Šä¸‹æ–‡çš„ç¿»è¯‘
}

#[tokio::test]
async fn test_translate_without_context() {
    // æµ‹è¯•æ— ä¸Šä¸‹æ–‡çš„ç¿»è¯‘ï¼ˆå‘åå…¼å®¹ï¼‰
}
```

### 9.2 é›†æˆæµ‹è¯•

#### 9.2.1 Scheduler é›†æˆæµ‹è¯•

```rust
// scheduler/tests/stage2.1.3/integration_test.rs

#[tokio::test]
async fn test_utterance_group_flow() {
    // æµ‹è¯•å®Œæ•´çš„ Group æµç¨‹ï¼š
    // 1. åˆ›å»º Session
    // 2. å‘é€ç¬¬ä¸€ä¸ª Utteranceï¼ˆåˆ›å»ºæ–° Groupï¼‰
    // 3. å‘é€ç¬¬äºŒä¸ª Utteranceï¼ˆå½’å±åˆ°åŒä¸€ Groupï¼‰
    // 4. éªŒè¯ä¸Šä¸‹æ–‡æ­£ç¡®ä¼ é€’
}
```

#### 9.2.2 ç«¯åˆ°ç«¯æµ‹è¯•

```typescript
// web-client/tests/stage2.1.3/e2e_test.ts

describe('Utterance Group E2E', () => {
  it('should create new group on first utterance', async () => {
    // æµ‹è¯•é¦–æ¬¡å‘è¨€åˆ›å»ºæ–° Group
  });
  
  it('should add utterance to existing group within timeout', async () => {
    // æµ‹è¯•åœ¨è¶…æ—¶æ—¶é—´å†…å‘è¨€å½’å±åˆ°ç°æœ‰ Group
  });
  
  it('should create new group after timeout', async () => {
    // æµ‹è¯•è¶…æ—¶ååˆ›å»ºæ–° Group
  });
});
```

### 9.3 æ€§èƒ½æµ‹è¯•

- **Group åˆ›å»ºå»¶è¿Ÿ**: < 10ms
- **ä¸Šä¸‹æ–‡è·å–å»¶è¿Ÿ**: < 5ms
- **ä¸Šä¸‹æ–‡æ‹¼æ¥å¯¹ç¿»è¯‘å»¶è¿Ÿçš„å½±å“**: < 50ms
- **å†…å­˜ä½¿ç”¨**: æ¯ä¸ª Group < 1KBï¼ˆå‡è®¾å¹³å‡æ¯ä¸ª part 100 å­—ç¬¦ï¼‰

### 9.4 å…¼å®¹æ€§æµ‹è¯•

- **å‘åå…¼å®¹**: ç°æœ‰å®¢æˆ·ç«¯ï¼ˆä¸å‘é€ Group ä¿¡æ¯ï¼‰åº”èƒ½æ­£å¸¸å·¥ä½œ
- **æ¸è¿›å¼å¯ç”¨**: æ”¯æŒéƒ¨åˆ†å®¢æˆ·ç«¯å¯ç”¨ Group åŠŸèƒ½ï¼Œéƒ¨åˆ†ä¸å¯ç”¨

---

## 10. æ€§èƒ½ä¸æ‰©å±•

### 10.1 æ€§èƒ½ä¼˜åŒ–

1. **Group å­˜å‚¨ä¼˜åŒ–**
   - ä½¿ç”¨å†…å­˜ç¼“å­˜ï¼Œå®šæœŸæ¸…ç†è¿‡æœŸ Group
   - å¯¹äºé•¿æœŸä¼šè¯ï¼Œå¯è€ƒè™‘æŒä¹…åŒ–åˆ°æ•°æ®åº“

2. **ä¸Šä¸‹æ–‡æ‹¼æ¥ä¼˜åŒ–**
   - é™åˆ¶ä¸Šä¸‹æ–‡é•¿åº¦ï¼ˆä¾‹å¦‚æœ€å¤š 500 å­—ç¬¦ï¼‰
   - å¯¹äºè¿‡é•¿çš„ä¸Šä¸‹æ–‡ï¼Œåªä½¿ç”¨æœ€è¿‘çš„ N ä¸ª part

3. **NMT å¼•æ“ä¼˜åŒ–**
   - æ”¯æŒæ‰¹é‡ä¸Šä¸‹æ–‡å¤„ç†
   - ç¼“å­˜å¸¸ç”¨ä¸Šä¸‹æ–‡ç»„åˆ

### 10.2 æœªæ¥æ‰©å±•

1. **è¯­ä¹‰åˆ†æ**
   - ä½¿ç”¨ LLM æˆ–è¯­ä¹‰ç›¸ä¼¼åº¦æ¨¡å‹åˆ¤æ–­æ˜¯å¦å±äºåŒä¸€è¯é¢˜
   - æé«˜ Group å½’å±åˆ¤æ–­çš„å‡†ç¡®æ€§

2. **Group å¯è§†åŒ–**
   - å‰ç«¯æ˜¾ç¤º Group ç»“æ„
   - å…è®¸ç”¨æˆ·æ‰‹åŠ¨åˆå¹¶æˆ–æ‹†åˆ† Group

3. **Group æŒä¹…åŒ–**
   - æ”¯æŒ Group è·¨ä¼šè¯ä¿å­˜
   - æ”¯æŒ Group å¯¼å‡ºå’Œå¯¼å…¥

4. **å¤šè¯­è¨€ Group**
   - æ”¯æŒå¤šè¯­è¨€æ··åˆçš„ Group
   - æ”¯æŒ Group å†…è¯­è¨€åˆ‡æ¢

---

## é™„å½•

### A. é…ç½®å‚æ•°

| å‚æ•°å | é»˜è®¤å€¼ | è¯´æ˜ | å¯é…ç½®ä½ç½® |
|--------|--------|------|------------|
| `group_timeout_sec` | 30 | Group è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ | ç¯å¢ƒå˜é‡ã€é…ç½®æ–‡ä»¶ |
| `max_parts_per_group` | 10 | Group æœ€å¤§ part æ•°é‡ | ç¯å¢ƒå˜é‡ã€é…ç½®æ–‡ä»¶ |
| `max_context_length` | 500 | ä¸Šä¸‹æ–‡æœ€å¤§é•¿åº¦ï¼ˆå­—ç¬¦ï¼‰ | ç¯å¢ƒå˜é‡ã€é…ç½®æ–‡ä»¶ |
| `group_cleanup_interval_hours` | 24 | Group æ¸…ç†é—´éš”ï¼ˆå°æ—¶ï¼‰ | ç¯å¢ƒå˜é‡ã€é…ç½®æ–‡ä»¶ |

### B. é”™è¯¯å¤„ç†

| é”™è¯¯åœºæ™¯ | å¤„ç†æ–¹å¼ |
|----------|----------|
| Group ä¸å­˜åœ¨ | åˆ›å»ºæ–° Group |
| Group å·²æ»¡ï¼ˆè¾¾åˆ°æœ€å¤§ part æ•°é‡ï¼‰ | åˆ›å»ºæ–° Group |
| ä¸Šä¸‹æ–‡è·å–å¤±è´¥ | ä½¿ç”¨ç©ºä¸Šä¸‹æ–‡ï¼Œè®°å½•è­¦å‘Šæ—¥å¿— |
| TTS ç»“æŸæ—¶é—´æ›´æ–°å¤±è´¥ | è®°å½•è­¦å‘Šæ—¥å¿—ï¼Œä¸å½±å“ä¸»æµç¨‹ |

### C. ç›¸å…³æ–‡æ¡£

- [Web ç«¯å®æ—¶è¯­éŸ³ç¿»è¯‘ç»Ÿä¸€è®¾è®¡æ–¹æ¡ˆ v3](./Web_ç«¯å®æ—¶è¯­éŸ³ç¿»è¯‘_ç»Ÿä¸€è®¾è®¡æ–¹æ¡ˆ_v3.md)
- [Web ç«¯åŠåŒå·¥å®æ—¶è¯­éŸ³ç¿»è¯‘äº¤äº’ä¸ä¸Šä¸‹æ–‡æ‹¼æ¥è®¾è®¡è¯´æ˜ v2](./Web_ç«¯åŠåŒå·¥å®æ—¶è¯­éŸ³ç¿»è¯‘äº¤äº’ä¸ä¸Šä¸‹æ–‡æ‹¼æ¥è®¾è®¡è¯´æ˜_v2.md)
- [å¼€å‘è®¡åˆ’ - é˜¶æ®µ 2.1.3](../project_management/DEVELOPMENT_PLAN.md#é˜¶æ®µ-213utterance-groupéœ€è¦åç«¯æ”¯æŒ)

---

**æ–‡æ¡£ç‰ˆæœ¬å†å²**:
- v1.0 (2025-01-XX): åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæ•´çš„åŠŸèƒ½è§„èŒƒ

