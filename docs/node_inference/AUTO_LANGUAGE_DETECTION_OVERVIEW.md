# 自动语种识别设计概述与需求分析

本文档是 [自动语种识别与双向模式设计](./AUTO_LANGUAGE_DETECTION_AND_TWO_WAY_MODE.md) 的子文档，包含功能概述、需求分析和架构改动总览。

**返回**: [自动语种识别主文档](./AUTO_LANGUAGE_DETECTION_AND_TWO_WAY_MODE.md)

---

## 1. 功能概述（需求说明）

本设计文档补充当前系统的核心能力：  
**自动识别输入语音属于中文 / 英文 / 日文 / 韩文（大语种识别），并根据识别结果自动选择翻译方向。**

同时满足以下特殊使用场景：

- **老年人只会说方言** → 输入只需归类到"中文"，不需要识别具体方言。  
- **双向实时会话** → 对话双方可随时切换说中文或英文，系统自动判断并翻译成对方语言。  
- **方言只影响输入，不影响输出** → 输出始终使用目标语的官方语言 TTS（普通话、标准英文、标准日文、标准韩文）。

---

## 2. 需求分析

### 2.1 大语种自动识别（Language ID, LID）

系统必须能自动判断输入语音是否属于以下语种：

- zh（中文及其方言）
- en（英语）
- ja（日语）
- ko（韩语）

**识别精度要求**：
- 准确率 > 95%（在清晰语音条件下）
- 识别延迟 < 500ms（在已有 ASR 结果基础上）
- 支持方言（中文方言统一识别为 zh）

### 2.2 方言处理需求

- **输入阶段**：方言统一归类为"中文"（zh），不区分具体方言
- **输出阶段**：始终使用目标语的官方语言 TTS（普通话、标准英文等）
- **ASR 阶段**：使用支持方言的 ASR 模型（如 Whisper）

### 2.3 双向会话需求（Two-way Auto Mode）

**使用场景**：两人面对面使用同一设备，交替说话，系统自动识别说话语言并翻译。

**工作流程**：
1. 用户配置两种语言（如：中文和英文）
2. 系统自动检测当前说话语言
3. 根据检测结果自动选择翻译方向
4. 翻译结果使用对方语言播放

**示例**：
- 用户 A 说中文 → 系统检测到 zh → 翻译成英文 → 播放英文 TTS
- 用户 B 说英文 → 系统检测到 en → 翻译成中文 → 播放中文 TTS

---

## 3. 架构改动总览

### 3.1 改动程度评估

**改动量**：中等

- **节点推理服务**：新增 LanguageDetector 模块（中等）
- **调度服务器**：扩展消息协议和 Session 结构（小）
- **客户端**：扩展消息协议和 UI（小）

### 3.2 新增模块：LanguageDetector（节点侧）

**位置**：`node-inference/src/language_detector.rs`

**职责**：
- 接收音频数据或 ASR 文本
- 判断输入语言（zh/en/ja/ko）
- 返回语言检测结果和置信度

**实现方式**：
- 方案 A：使用 Whisper 的语言检测能力（推荐）
- 方案 B：使用独立的语言检测模型（备选）

### 3.3 SessionConfig 改动

**新增字段**：
- `mode: "one_way" | "two_way_auto"` - 翻译模式
- `lang_a: String` - 双向模式的语言 A
- `lang_b: String` - 双向模式的语言 B
- `auto_langs: Vec<String>` - 自动识别时限制的语言范围

### 3.4 WebSocket 协议改动（可选）

**SessionInit 消息扩展**：
- 添加 `mode` 字段
- 添加 `lang_a`、`lang_b` 字段
- 添加 `auto_langs` 字段

**新增消息类型**：
- `LanguageDetected` - 语言检测结果通知（可选）

---

## 4. 可行性评估

### 4.1 技术可行性

#### ✅ 语言检测（LID）实现方案

**方案 A：使用 Whisper 的语言检测能力（推荐）**
- ✅ Whisper 模型内置语言检测能力
- ✅ 准确率高（>95%）
- ✅ 无需额外模型
- ✅ 延迟低（复用 ASR 结果）

**方案 B：使用独立的语言检测模型（备选）**
- ⚠️ 需要额外的模型文件
- ⚠️ 增加推理延迟
- ✅ 可以更精确控制检测范围

#### ✅ 双向模式实现

- ✅ 消息协议扩展简单
- ✅ 调度服务器改动小
- ✅ 节点推理服务改动中等
- ✅ 客户端改动小

#### ✅ 方言处理

- ✅ Whisper 支持多种中文方言
- ✅ 输出统一使用官方语言 TTS
- ✅ 无需额外处理

### 4.2 兼容性分析

#### ✅ 向后兼容性

- ✅ 新增字段均为可选字段
- ✅ 默认行为保持不变（单向模式）
- ✅ 不影响现有功能

#### ⚠️ 需要处理的情况

- ⚠️ 语言检测失败时的回退策略
- ⚠️ 双向模式下的语言切换延迟
- ⚠️ 方言识别准确率

### 4.3 总体评估

**✅ 高度可行，可直接开发**

该功能在技术上完全可行，与现有系统兼容性良好，实现难度中等。

---

**返回**: [自动语种识别主文档](./AUTO_LANGUAGE_DETECTION_AND_TWO_WAY_MODE.md) | [实现设计详情](./AUTO_LANGUAGE_DETECTION_IMPLEMENTATION.md)

